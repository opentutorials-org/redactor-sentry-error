Redactor.add("plugin","ai",{translations:{en:{ai:{"placeholder-image":"Describe the image you want to generate.","placeholder-text":"Tell me what you want to write.",send:"Send",stop:"Stop",discard:"Discard",insert:"Insert",prompt:"Prompt","image-style":"Image style","change-tone":"Change tone"}}},dropdowns:{items:{improve:{title:"Improve it",command:"ai.set",params:{prompt:"Improve it"}},simplify:{title:"Simplify it",command:"ai.set",params:{prompt:"Simplify it"}},fix:{title:"Fix any mistakes",command:"ai.set",params:{prompt:"Fix any mistakes"}},shorten:{title:"Make it shorter",command:"ai.set",params:{prompt:"Make it shorter"}},detailed:{title:"Make it more detailed",command:"ai.set",params:{prompt:"Make it more detailed"}},complete:{title:"Complete sentence",command:"ai.set",params:{prompt:"Complete sentence"}},tone:{title:"Change tone",command:"ai.popupTone"},translate:{title:"Translate",command:"ai.popupTranslate"}}},defaults:{tone:["Academic","Assertive","Casual","Confident","Constructive","Empathetic","Exciting","Fluent","Formal","Friendly","Inspirational","Professional"],style:["3d model","Digital art","Isometric","Line art","Photorealistic","Pixel art"],translate:["Arabic","Chinese","English","French","German","Greek","Italian","Japanese","Korean","Portuguese","Russian","Spanish","Swedish","Ukrainian"],size:{"1792x1024":"Landscape","1024x1792":"Portrait","1024x1024":"Square"},text:{stream:!0},image:{save:!1},makeit:"Make it",translateto:"Translate to",spinner:'<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><style>.spinner_nOfF{animation:spinner_qtyZ 2s cubic-bezier(0.36,.6,.31,1) infinite}.spinner_fVhf{animation-delay:-.5s}.spinner_piVe{animation-delay:-1s}.spinner_MSNs{animation-delay:-1.5s}@keyframes spinner_qtyZ{0%{r:0}25%{r:3px;cx:4px}50%{r:3px;cx:12px}75%{r:3px;cx:20px}100%{r:0;cx:20px}}</style><circle class="spinner_nOfF" cx="4" cy="12" r="3"/><circle class="spinner_nOfF spinner_fVhf" cx="4" cy="12" r="3"/><circle class="spinner_nOfF spinner_piVe" cx="4" cy="12" r="3"/><circle class="spinner_nOfF spinner_MSNs" cx="4" cy="12" r="3"/></svg>'},observe(t,e,s){if(("ai-tools"!==e||this.opts.is("ai.text.url"))&&("ai-image"!==e||this.opts.is("ai.image.url")))return t},popup(t,e){"addbar"!==this.app.ui.getState().type?(this.app.dropdown.create("ai-tools",{items:this.opts.get("ai.items")||this.dropdowns.items}),this.app.dropdown.open(t,e)):this._buildPrompt()},promptImage(t,e){this._buildPrompt({image:!0})},popupTone(t,e){let s={},i=this.opts.get("ai.tone")||this.defaults.tone;const a=this.opts.get("ai.makeit")||this.defaults.makeit;for(let t=0;t<i.length;t++)s[t]={title:i[t],command:"ai.set",params:{prompt:a+" "+i[t]}};this.app.dropdown.create("ai-tone",{items:s}),this.app.dropdown.open(t,e)},popupTranslate(t,e){let s={},i=this.opts.get("ai.translate")||this.defaults.translate;const a=this.opts.get("ai.translateto")||this.defaults.translateto;for(let t=0;t<i.length;t++)s[t]={title:i[t],command:"ai.set",params:{prompt:a+" "+i[t]}};this.app.dropdown.create("ai-translate",{items:s}),this.app.dropdown.open(t,e)},set(t,e){this.promptButton=e;let s=this._getText(),i=this._getHtml();""!==s&&!0!==t.empty&&this.promptButton.setIcon(this.defaults.spinner),t.empty&&(s="",i="",this.promptButton.setIcon(this.defaults.spinner));let a=t.prompt;a=this.app.broadcast("ai.create",{prompt:a}).get("prompt"),this.modifiedValue=a,this._setPrompt(s,i,a,t.empty)},sendPrompt(t){t.preventDefault(),t.stopPropagation();let e=this.opts.get("ai."+this.promptType+".model"),s=this._getMessage();if(s=this.app.broadcast("ai.create",{prompt:s}).get("prompt"),this.modifiedValue=s,""===s)return;let i=this._getTone(s);"text"===this.promptType&&(this.conversation.push({role:"user",content:s}),i&&this.conversation.push({role:"user",content:i}));let a={model:e,stream:this.opts.get("ai.text.stream"),messages:this.conversation},r="1024x1024";"image"===this.promptType&&(r=this.$size.val()),a="image"===this.promptType?{model:e,n:1,size:r,prompt:s}:a,this.$progress.html(this.defaults.spinner),"image"!==this.promptType&&this.opts.is("ai.text.stream")?this._sendStream(this.$preview,s,!0):this._sendPrompt(a,"_complete")},insertPrompt(t){t.preventDefault(),t.stopPropagation();let e=this.app.create("insertion"),s=this.$preview.html();if("image"===this.promptType){const t=this.opts.get("image.tag");s=`<${t}>${s}</${t}>`}let i=this.app.broadcast("ai.before.insert",{html:s});s=i.get("html");let a=this.savedInstance?this.savedInstance.getBlock():this.$prompt,r=this.savedInstance?"after":"before",o=!this.savedInstance;setTimeout(function(){this.app.block.setTool(!1);let t=e.insert({html:s,target:a,position:r,remove:o});this.$prompt.remove(),this.conversation=[],this.app.broadcast("ai.insert",{nodes:t})}.bind(this),3)},stopPrompt(t,e){t&&(t.preventDefault(),t.stopPropagation(),e=this.$preview.text(),this.isEvent&&this.isEvent.close()),this.$preview.css({"white-space":""}),this.$preview.html(this._parseReply(e)),this.$insert.show(),this.$stop.hide(),this.$generate.show();let s=t?"ai.stop":"ai.complete",i=this.$previewLabel.text(),a=t?{prompt:i}:{prompt:i,response:this._parseReply(e)};this.app.broadcast(s,a)},closePrompt(t){t.preventDefault(),t.stopPropagation(),this.app.block.setTool(!1),this.$prompt.remove(),this.conversation=[],this.isEvent&&this.isEvent.close(),this.app.broadcast("ai.discard")},_getTone(t){let e=this.$select.val();return"0"!==e&&"1"!==e&&`${this.opts.get("ai.makeit")||this.defaults.makeit} ${e}`},_getHtml(){let t="",e=this.app.blocks.get({selected:!0,instances:!0}),s=this.app.block.get();0===e.length&&s&&(e=[s]);for(let s=0;s<e.length;s++)t+=e[s].getOuterHtml();return t},_getText(){let t="",e=this.app.blocks.get({selected:!0,instances:!0}),s=this.app.block.get();0===e.length&&s&&(e=[s]);for(let s=0;s<e.length;s++)if(e[s].isEditable()){t=t+("listitem"===e[s].getType()?"- ":"")+e[s].getPlainText()+"\n"}return t=(t=t.trim()).replace(/\n$/,"")},_getMessage(){return this.$textarea.val().trim()},_getNode(){let t=this.app.block.create().getBlock();return t=this._buildNode(t,{traverse:!0})},_getInsertedNode(){let t=this.dom('<div class="rx-inserted-node" style="white-space: pre-wrap;">');return t.html(this.opts.get("ai.spinner")),t=this._buildNode(t,{traverse:!1})},_setPrompt(t,e,s,i){if(""===t&&!0!==i)return;this.promptType="text",this.promptText=t,this.promptHtml=e;let a=[{role:"user",content:t},{role:"user",content:s}],r={model:this.opts.get("ai."+this.promptType+".model"),messages:a};if(this.opts.is("ai.text.stream")){let t=this._getInsertedNode();t.html(this.defaults.spinner),this.app.dropdown.close(),this.app.context.close(),this._sendStream(t,a)}else this._sendPrompt(r,"_insert")},_sendPrompt(t,e){let s={url:this.opts.get("ai."+this.promptType+".endpoint"),data:JSON.stringify(t)};const i=this.app.create("utils");s=i.extendData(s,this.opts.get("ai."+this.promptType+".data")),this.ajax.request("post",{url:this.opts.get("ai."+this.promptType+".url"),data:s,before:function(t){if(this.app.broadcast("ai.before.send",{xhr:t,data:s}).isStopped())return!1}.bind(this),success:this[e].bind(this),error:this._error.bind(this)})},_sendStream(t,e,s){const i=this.opts.get("ai."+this.promptType+".model"),a=this.opts.get("ai."+this.promptType+".endpoint"),r=this.opts.get("ai."+this.promptType+".url");let o={model:i,stream:this.opts.get("ai.text.stream"),messages:s?this.conversation:e},p={url:a,data:JSON.stringify(o)};p=this.app.create("utils").extendData(p,this.opts.get("ai."+this.promptType+".data"));let n="",h=this._createSource(r,p);this.isEvent=h,this.currentIndex=0;let l=this.app.scroll.getTarget();t.removeClass("rx-inserted-node-started"),h.addEventListener("message",function(e){this.app.dropdown.close(),this.app.context.close();let i=e.data,a=i.indexOf(": ","data")+2,r=i.slice(a,i.length);if("[DONE]"===r)this._sendStreamDone(h,t,n,s);else{if((r=JSON.parse(r)).notification)return void this._sendStreamDone(h,t,r.notification,s);const e=r.choices;if(e&&e.length>0){let i=e[0].delta.content;i&&(t.hasClass("rx-inserted-node-started")||(t.html(""),this._sendStreamPreviewSet(s)),n+=i,this._typeCharacter(t,n),this._isElementBottomBeyond(t.get())&&(t.get().scrollIntoView(!1),l.scrollTop(l.scrollTop()+20)),t.addClass("rx-inserted-node-started"))}}}.bind(this)),h.addEventListener("error",function(t){this._error(t),h.close(),this.isEvent=!1}.bind(this))},_sendStreamDone(t,e,s,i){if(i){let t=setInterval(function(){this.currentIndex===s.length&&(clearInterval(t),this.stopPrompt(!1,s),this.conversation.push({role:"assistant",content:s}))}.bind(this),100)}else this._insertAfterNode(e,s);t.close(),this.isEvent=!1},_sendStreamPreviewSet(t){if(!t)return;let e=this.modifiedValue||this.$textarea.val();this.$progress.html(""),this.$previewLabel.html(this._sanitize(e)),this.$textarea.val(""),this.$preview.html(""),this.$preview.css({"white-space":"pre-wrap"}),this.$generate.hide(),this.$stop.show()},_buildNode(t,e){let s;if(this.instance=!1,this.app.blocks.is()){this.app.editor.isSelectAll()||(s=(s=this.app.blocks.get({first:!0,selected:!0})).closest("[data-rx-first-level]")).before(t);let e=this.app.editor.isSelectAll();s=this.app.blocks.removeAll(),e&&(t=s)}else{if(this.instance=this.app.block.get(),!this.instance){this.instance=this.app.block.create(),this.app.blocks.get({first:!0}).before(this.instance.getBlock())}this.instance.isType("listitem")?this.instance.getBlock().html("").append(t):this.instance.isType("todoitem")?this.instance.getContentItem().html("").append(t):(this.instance.getBlock().before(t),this.instance.remove(e))}return t},_buildPrompt(t){this.savedInstance=!1,this.conversation=[],this.$prompt=this._createPrompt(t),this.$textarea.on("input focus",function(){this.app.block.setTool("ai")}.bind(this));let e=this.app.block.get(),s=this.app.blocks.is();if(this.app.dropdown.close(),this.app.context.close(),e||s){s&&(e=this.app.blocks.get({last:!0,selected:!0,instances:!0}));const t=["layout","table","quote","list","todo","image","embed"];let i=e.getBlock().closest("[data-rx-type="+t.join("],[data-rx-type=")+"]"),a=e.getBlock().closest("[data-rx-type=column]");0!==i.length&&(0!==a.length&&(this.savedInstance=e),e=i.dataget("instance")),this._insertPrompt(this.$prompt,e),s&&this.app.blocks.unset()}else this._insertPrompt(this.$prompt);this.app.editor.adjustHeight()},_error(t,e){let s=this.app.editor.getEditor().find(".rx-inserted-node");if(0!==s.length){this.app.dropdown.close(),this.app.context.close(),this.app.create("insertion").insert({target:s,remove:!0,caret:"end",html:this.promptHtml})}this.$progress&&this.$progress.fadeOut(500,function(){this.$progress.html("").removeAttr("style")}.bind(this)),this.app.broadcast("ai.error",t||e)},_insert(t){if(this.promptButton.setIcon(""),t.error)return this._error(t.error.message,t);if(!t.choices)return this._error(t);let e,s=t.choices[0].message.content,i=this._parseReply(s),a=this.app.create("insertion");if(i=this.app.broadcast("ai.before.insert",{html:i}).get("html"),this.app.dropdown.close(),this.app.context.close(),this.instance&&this.instance.isType(["listitem","todoitem"]))this.instance.setContent(s),e=this.instance.getBlock();else{let t=this._getNode();this.app.block.set(t),e=a.insert({html:i,caret:"end"})}this.app.broadcast("ai.insert",{nodes:e})},_complete(t){let e,s,i,a,r=this.modifiedValue||this.$textarea.val();if(this.$progress.html(""),this.$previewLabel.html(""),t.error)return this._error(t.error.message,t);if(t.notification)this.$preview.html(t.notification+"<br>");else if(this.$previewLabel.html(this._sanitize(r)),this.$textarea.val(""),this.$textarea.focus(),"text"===this.promptType){if(!t.choices)return this._error(t);e=t.choices[0].message.content,this.conversation.push({role:"assistant",content:e}),a=s=this._parseReply(e),this.$preview.html(s),this.$insert.show();let i=this.$previewLabel.text();this.app.broadcast("ai.complete",{prompt:i,response:a}),this.app.editor.adjustHeight()}else if("image"===this.promptType){if(!t.data)return this._error(t);i=t.data[0].url;const e=this.opts.get("ai.image.save");if(e){const t=this.app.create("utils");let s={url:i};s=t.extendData(s,this.opts.get("ai."+this.promptType+".data")),this.ajax.request("post",{url:e,data:s,before:function(t){if(this.app.broadcast("ai.before.save",{xhr:t,data:s}).isStopped())return!1}.bind(this),success:function(t){this.app.broadcast("ai.save",t),this._completeImage(t.filename)}.bind(this),error:this._error.bind(this)})}else this._completeImage(i)}},_completeImage(t){let e=this.dom("<img>").attr("src",t),s=e.get().outerHTML;this.$preview.html(e),this.$insert.show();let i=this.$previewLabel.text();this.app.broadcast("ai.complete",{prompt:i,response:s}),this.app.editor.adjustHeight()},_parseReply(t){let e=this.app.create("utils"),s=this.app.create("cleaner"),i=e.parseMarkdown(t);return i=s.store(i,"lists"),i=s.store(i,"headings"),i=s.store(i,"images"),i=s.store(i,"links"),i=this._parseMarkdown(i),i=s.restore(i,"lists"),i=s.restore(i,"headings"),i=s.restore(i,"images"),i=(i=(i=(i=s.restore(i,"links")).replace(/<p><(ul|ol)>/g,"<$1>")).replace(/<\/(ul|ol)><\/p>/g,"</$1>")).replace(/<p><\/p>/g,"")},_createPrompt(t){t=Redactor.extend(!0,{},{image:!1},t),this.promptType=t.image?"image":"text";let e=this.lang.get("ai.placeholder-"+this.promptType);this.app.editor.getEditor().find(".rx-ai-main").remove();let s=this.dom('<div class="rx-in-tool rx-ai-main">').attr({contenteditable:!1}),i=this.dom('<div class="rx-ai-body">'),a=this.dom('<div class="rx-ai-footer">'),r=this.dom('<div class="rx-ai-buttons">');return this.$progress=this.dom('<div class="rx-ai-progress">'),this.$previewLabel=this.dom('<div class="rx-ai-preview-label">'),this.$preview=this.dom('<div class="rx-ai-preview">'),this.$prompt=this.dom('<div class="rx-ai-prompt">'),this.$label=this.dom('<label class="rx-ai-label">').html(this.lang.get("ai.prompt")),this.$textarea=this.dom('<textarea class="rx-ai-textarea rx-form-textarea">').attr({placeholder:e}),this.$select=this.dom('<select class="rx-ai-select rx-form-select">'),this.$size=this.dom('<select class="rx-ai-size rx-form-select">'),this._createPromptFooter(a,r),this.$prompt.append(this.$label),this.$prompt.append(this.$textarea),i.append(this.$progress),i.append(this.$previewLabel),i.append(this.$preview),i.append(this.$prompt),s.append(i),s.append(a),s},_createPromptFooter(t,e){this._createTone(this.$select),this._createSize(this.$size),this._createPromptButtons(e),t.append(this.$select),"image"===this.promptType&&t.append(this.$size),t.append(e)},_createPromptButton(t){return this.dom('<button class="rx-ai-button rx-form-button">').html(t)},_createSize(t){let e=this.opts.get("ai.size");for(let[s,i]of Object.entries(e)){let e=this.dom("<option>").val(s).html(i);t.append(e)}},_createTone(t){let e="image"===this.promptType?this.opts.get("ai.style")||this.defaults.style:this.opts.get("ai.tone")||this.defaults.tone,s="image"===this.promptType?this.lang.get("ai.image-style"):this.lang.get("ai.change-tone"),i=this.dom("<option>").val(0).html(s);t.append(i),i=this.dom("<option>").val(1).html("---"),t.append(i);for(let a=0;a<e.length;a++)s=this.lang.parse(e[a]),i=this.dom("<option>").val(s).html(s),t.append(i)},_createPromptButtons(t){this.$generate=this._createPromptButton(this.lang.get("ai.send")).addClass("rx-form-button-primary").on("click.rx-ai",this.sendPrompt.bind(this)),this.$stop=this._createPromptButton(this.lang.get("ai.stop")).addClass("rx-form-button-primary").on("click.rx-ai",this.stopPrompt.bind(this)).hide(),this.$discard=this._createPromptButton(this.lang.get("ai.discard")).addClass("rx-form-button-danger").on("click.rx-ai",this.closePrompt.bind(this)),this.$insert=this._createPromptButton(this.lang.get("ai.insert")).on("click.rx-ai",this.insertPrompt.bind(this)).hide(),t.append(this.$discard),t.append(this.$insert),t.append(this.$stop),t.append(this.$generate)},_createSource(t,e){const s=new EventTarget;let i=this.ajax.post({url:t,data:e,before:function(t){if(this.app.broadcast("ai.before.send",{xhr:t,data:e}).isStopped())return!1}.bind(this)}).xhr,a=this;var r=!1,o=0;return i.onprogress=function(){let t,e;if(r||(r=!0,s.dispatchEvent(new Event("open",{status:i.status,headers:i.getAllResponseHeaders(),url:i.responseUrl}))),a._isJsonString(i.responseText)){let t=JSON.parse(i.responseText);if(t.error)return a._error(t.error.message,t),void s.close()}for(;(t=i.responseText.indexOf("\n\n",o))>=0;)e=i.responseText.slice(o,t),o=t+2,e.length&&s.dispatchEvent(new MessageEvent("message",{data:e}))},s.close=function(){i.abort()},s},_isElementBottomBeyond(t){let e=this.app.scroll.getTarget(),s=t.getBoundingClientRect();return s.top+s.height>e.get().innerHeight},_isJsonString(t){try{JSON.parse(t)}catch(t){return!1}return!0},_insertAfterNode(t,e){let s,i=this.instance&&this.instance.isType(["listitem","todoitem"]);if(e=this.app.broadcast("ai.before.insert",{html:e}).get("html"),i)this.instance.setContent(e),s=this.instance.getBlock();else{let i=this.app.create("insertion"),a=this.app.block.create().getBlock();e=this._parseReply(e),t.after(a),t.remove(),this.app.block.set(a),s=i.insert({html:e,caret:"end"})}this.app.broadcast("ai.insert",{nodes:s})},_insertPrompt(t,e,s){let i=this.app.create("element"),a="after";e||("top"===this.opts.get("addPosition")?(e=this.app.blocks.get({first:!0,instances:!0}),a="before"):(e=this.app.blocks.get({last:!0,instances:!0}),a="after")),e.getBlock()[a](t),i.scrollTo(t),this.app.observer.observeUnset(),this.$textarea.focus(),this.$textarea.on("input.rx-ai-autoresize keyup.rx-ai-autoreize",this._resize.bind(this)),this.$textarea.on("keydown.rx-ai-event",this._promptKeydown.bind(this))},_promptKeydown(t){"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.sendPrompt(t))},_typeCharacter(t,e){this.currentIndex<e.length&&(t.get().textContent+=e.charAt(this.currentIndex),this.currentIndex++,this.app.editor.adjustHeight(),setTimeout(function(){this._typeCharacter(t,e)}.bind(this),100))},_resize(){this.$textarea.css("height","auto"),this.$textarea.css("height",this.$textarea.get().scrollHeight+"px"),this.app.editor.adjustHeight()},_sanitize:t=>t.replace(/[&<>"']/g,t=>{switch(t){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#39;"}}),_parseMarkdown(t){let e=!1,s="";const i=t.split("\n"),a=this.opts.get("replaceTags");for(const t of i)t.startsWith("```")?s+=(e=!e)?this._replaceCodeLine(t):"</code></pre>":t.startsWith("####_")?s+=t:s+=e?this._escapeHtml(t)+"\n":`<p>${this._escapeHtml(t)}</p>`;let r=a.b?a.b:"b",o=a.i?a.i:"i";return s=(s=(s=s.replace(/\*\*\_(.*?)\_\*\*/g,"<"+r+"><"+o+">$1</"+o+"></"+r+">")).replace(/\*\*(.*?)\*\*/g,"<"+r+">$1</"+r+">")).replace(/\*(.*?)\*/g,"<"+o+">$1</"+o+">")},_replaceCodeLine:t=>t.replace(/\`\`\`(([^\s]+))?/gm,function(t,e,s){return"<pre"+(s?' class="'+s+'"':"")+"><code>"}),_escapeHtml(t){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return t.replace(/[&<>"']/g,t=>e[t])}});