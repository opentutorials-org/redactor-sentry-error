Redactor.add("plugin","filelink",{translations:{en:{filelink:{file:"File",upload:"Upload",title:"Title",choose:"Choose",placeholder:"Drag to upload a file<br>or click to select"}}},defaults:{context:!0,states:!0,classname:!1,upload:!1,select:!1,multiple:!0,name:"file",data:!1,icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.2929 3.29289C11.6834 2.90237 12.3166 2.90237 12.7071 3.29289L17.7071 8.29289C18.0976 8.68342 18.0976 9.31658 17.7071 9.70711C17.3166 10.0976 16.6834 10.0976 16.2929 9.70711L13 6.41421V16C13 16.5523 12.5523 17 12 17C11.4477 17 11 16.5523 11 16V6.41421L7.70711 9.70711C7.31658 10.0976 6.68342 10.0976 6.29289 9.70711C5.90237 9.31658 5.90237 8.68342 6.29289 8.29289L11.2929 3.29289ZM4 16C4.55228 16 5 16.4477 5 17V19C5 19.2652 5.10536 19.5196 5.29289 19.7071C5.48043 19.8946 5.73478 20 6 20H18C18.2652 20 18.5196 19.8946 18.7071 19.7071C18.8946 19.5196 19 19.2652 19 19V17C19 16.4477 19.4477 16 20 16C20.5523 16 21 16.4477 21 17V19C21 19.7957 20.6839 20.5587 20.1213 21.1213C19.5587 21.6839 18.7957 22 18 22H6C5.20435 22 4.44129 21.6839 3.87868 21.1213C3.31607 20.5587 3 19.7956 3 19V17C3 16.4477 3.44772 16 4 16Z"/></svg>'},subscribe:{"editor.load, editor.build":function(){this.observeStates()}},modals:{create:{title:"## filelink.upload ##",width:"400px",form:{title:{type:"input",label:"## filelink.title ##"},file:{}}},choose:{title:"## filelink.choose ##",width:"400px"}},init(){this.dataStates=[]},start(){var t;this._is()&&(t={title:"## filelink.file ##",icon:this.opts.get("filelink.icon"),command:"filelink.popup",position:{after:"link"}},this.app.toolbar.add("file",t),this.opts.is("filelink.context"))&&this.app.context.add("file",t)},popup(t,e){let i="create",s=this.app.create("selection"),a=this.app.create("stack");var l;this.opts.is("filelink.upload")&&(i="add",l=s.is()?s.getText():"",a.create("filelink",this._buildPopupUpload(this.modals.create)),a.setData({title:l})),this.app.modal.open({name:"filelink",stack:a,button:e}),this.opts.is("filelink.select")&&("create"===i&&a.create("file-select",this.popups.choose),this.$sbox=a.getBody(),"string"==typeof(l=this.opts.get("filelink.select"))?this.ajax.get({url:l,success:this._parseList.bind(this)}):this._parseList(l))},insertByUpload(t){var e=this.app.modal.getStack().getData();this.app.modal.close(),this.app.context.close(),this._insert(t,e.title)},insertBySelect(t){t.preventDefault(),this.app.modal.close(),this.app.context.close();var e=this.app.create("selection"),e=e.is()?e.getText():"",t=this.dom(t.target).closest(".rx-dropdown-stack-item"),t=JSON.parse(decodeURI(t.attr("data-params")));this._insert({file:t},e,!0)},insertByDrop(t,e){var i;this.app.block.is()&&(i=this.app.block.get(),e.target,i.getType(),this.app.create("insertion").insertPoint(e)),this._insert(t)},drop(t,e){var i=[];for(let t=0;t<e.files.length;t++){var s=e.files[t]||e.items[t].getAsFile();s&&i.push(s)}var a,l={url:this.opts.get("filelink.upload"),name:this.opts.get("filelink.name"),data:this.opts.get("filelink.data"),multiple:this.opts.get("filelink.multiple"),success:"filelink.insertByDrop",error:"filelink.error"};0<i.length&&(0!==(a=this.dom(t.target).closest("[data-rx-type]")).length&&this.app.block.set(a),this.app.create("upload").send(t,i,l))},error(t){this.app.broadcast("file.upload.error",{response:t})},observeStates(){this._findFiles().each(this._addFileState.bind(this))},getStates(){var t,e,i=this._findFiles();for([t,e]of Object.entries(this.dataStates)){var s=i.is('[data-file="'+e.id+'"]');this._setFileState(e.id,s)}return this.dataStates},_is(){return this.opts.is("filelink.upload")||this.opts.is("filelink.select")},_insert(t,e,i){var s,a,l=this.app.create("caret"),o=this.app.create("insertion"),r=Object.keys(t).length;let p=0;for([s,a]of Object.entries(t)){p++;var n=this._createFileAndStore(a,e);this.app.broadcast("file."+(i?"select":"upload"),{response:t,$el:n}),1===r?l.set(n,"after"):(l.set(n,"after"),p<r&&o.insertText(" ","end",!0))}},_buildPopupUpload(t){return t.form.file={type:"upload",upload:{type:"file",box:!0,placeholder:this.lang.get("filelink.placeholder"),url:this.opts.get("filelink.upload"),name:this.opts.get("filelink.name"),data:this.opts.get("filelink.data"),multiple:this.opts.get("filelink.multiple"),success:"filelink.insertByUpload",error:"filelink.error"}},t},_findFiles(){return this.app.editor.getLayout().find("[data-file]")},_addFileState(t){var e=t.attr("data-file");this.dataStates[e]={type:"file",status:!0,url:t.attr("src"),$el:t,id:e}},_setFileState(t,e){this.dataStates[t].status=e},_parseList(t){var e,i,s,a,l=this.dom("<div>").addClass("rx-dropdown-stack");for([e,i]of Object.entries(t))"object"==typeof i&&((s=this.dom("<div>").addClass("rx-dropdown-stack-item")).attr("data-params",encodeURI(JSON.stringify(i))),(a=this.dom("<span>").addClass("rx-dropdown-stack-title")).text(i.title||i.name),s.append(a),(a=this.dom("<span>").addClass("rx-dropdown-stack-aside")).text(i.name),s.append(a),(a=this.dom("<span>").addClass("rx-dropdown-stack-aside")).text("("+i.size+")"),s.append(a),s.on("click",this.insertBySelect.bind(this)),l.append(s));this.$sbox.append(l),this.app.modal.updatePosition()},_createFileAndStore(t,e){var i=this.app.block.get(),s=this.app.create("utils"),a=this.app.create("selection"),l=this.app.create("insertion");let o,r;return i&&i.isEditable()&&a.is()?(o=this.app.inline.set({tag:"a",caret:"after"}),r=this.dom(o)):i&&!i.isEditable()?(r=this.dom("<a>"),(a=this.app.create("block.text")).getBlock().append(r),i.insert({instance:a,position:"after"})):(r=this.dom("<a>"),(i=this.app.create("block.text")).getBlock().append(r),l.insert({instance:i})),r.attr("href",t.url),r.attr("data-file",t.id||s.getRandomId()),r.attr("data-name",t.name),this.opts.is("filelink.classname")&&r.addClass(this.opts.get("filelink.classname")),e=e&&""!==e?e:this._truncateUrl(t.name),r.html(e),r},_truncateUrl(t){return-1!==t.search(/^http/)&&20<t.length?t.substring(0,20)+"...":t}});