if(void 0===CodeMirror)var CodeMirror;!function(){const t=[{}],e=`data${Date.now()}`;class s{constructor(t){t?t instanceof s?this.nodes=t.nodes:"string"==typeof t&&/^\s*<(\w+|!)[^>]*>/.test(t)?this.nodes=this.create(t):t instanceof NodeList||Array.isArray(t)?this.nodes=Array.from(t):t.nodeType&&11===t.nodeType?this.nodes=Array.from(t.childNodes):t.nodeType||this._isWindowNode(t)?this.nodes=[t]:this.nodes=this._slice(this._query(t)):this.nodes=[]}get length(){return this.nodes.length}create(t){const e=/^<(\w+)\s*\/?>(?:<\/\1>|)$/.exec(t);if(e)return[document.createElement(e[1])];const s=document.createElement("div");return s.innerHTML=t,Array.from(s.childNodes)}dataset(e,s){return this.each((i=>{const a=i.get();if(a){const i=this.dataindex(a);t[i][e]=s}}))}dataget(e){const s=this.get();if(s){const i=this.dataindex(s);return t[i][e]}}dataindex(s){if(!s)return null;let i=s[e];return i||(i=t.length,s[e]=i,t[i]={}),i}add(...t){return t.forEach((t=>{"string"==typeof t&&(t=new s(t).nodes),this.nodes=[...this.nodes,...this._array(t)]})),this}get(t=0){return this.nodes[t]||null}all(){return this.nodes}getAll(){return this.all()}eq(t){return new s(this.nodes[t]||null)}first(){return new s(this.nodes[0]||null)}last(){return new s(this.nodes[this.nodes.length-1]||null)}contents(){return this.get()?.childNodes||[]}each(t){return this.nodes.forEach(((e,i)=>t(new s(e),i))),this}map(t){return this.nodes.map(((e,i)=>t(new s(e),i)))}is(t){return this.filter(t).length>0}filter(t){if(void 0===t)return new s(this.nodes);const e="function"==typeof t?e=>t(new s(e)):e=>(t=t instanceof s?t.get():t)instanceof Node?t===e:"string"==typeof t&&(1===e.nodeType&&e.matches(t||"*"));return new s(this.nodes.filter(e))}not(t){return this.filter((e=>!new s(e).is(t||!0)))}find(t){const e=[];return this.each((s=>{e.push(...this._query(t,s.get()))})),new s(e)}children(t){const e=[];return this.each((t=>{e.push(...t.get().children||[])})),new s(e).filter(t)}parent(t){const e=this.get(),i=e?e.parentNode:null;return i?new s(i).filter(t):new s}parents(t,e){e=this._context(e);const i=[];return this.each((a=>{let r=a.get().parentNode;for(;r&&r!==e;)t&&!new s(r).is(t)||i.push(r),r=r.parentNode})),new s(i)}closest(t,e){e=this._context(e),t=t instanceof s?t.get():t;const i=[];return this.each((a=>{let r=a.get();for(;r&&r!==e;){if(t instanceof Node?r===t:new s(r).is(t)){i.push(r);break}r=r.parentNode}})),new s(i)}next(t){return this._sibling(t,"nextSibling")}nextElement(t){return this._sibling(t,"nextElementSibling")}prev(t){return this._sibling(t,"previousSibling")}prevElement(t){return this._sibling(t,"previousElementSibling")}addClass(t){return this._eachClass(t,"add")}removeClass(t){return this._eachClass(t,"remove")}toggleClass(t){return this._eachClass(t,"toggle")}hasClass(t){const e=this.get();return!!(t&&e&&e.classList)&&t.split(" ").every((t=>e.classList.contains(t)))}css(t,e){if(void 0===e&&"object"!=typeof t){const e=this.get();if(!e||!e.style)return;return"width"===t||"height"===t?this._getDimensions(t)+"px":getComputedStyle(e)[t]}const s="object"==typeof t?t:{[t]:e};return this.each((t=>{const e=t.get();e&&e.style&&Object.assign(e.style,s)}))}attr(t,e,s=!1){if(s=s?"data-":"",void 0===e&&"object"!=typeof t){const e=this.get();return e&&3!==e.nodeType?"checked"===t?e.checked:this._boolean(e.getAttribute(s+t)):void 0}return this.each((i=>{const a=i.get();if(!a||3===a.nodeType)return;const r="object"==typeof t?t:{[t]:e};Object.entries(r).forEach((([t,e])=>{"checked"===t?a.checked=e:a.setAttribute(s+t,e)}))}))}data(t,e){if(void 0===t||!0===t){const e=/^data-(.+)$/,s=this.get().attributes,i={};return Array.from(s).forEach((s=>{if(e.test(s.nodeName)){let a=s.nodeName.match(e)[1],r=s.value;!0!==t&&(a=a.replace(/-([a-z])/g,((t,e)=>e.toUpperCase()))),r=r.startsWith("{")?this._object(r):this._number(r)?parseFloat(r):this._boolean(r),i[a]=r}})),i}return this.attr(t,e,!0)}val(t){if(void 0===t){const t=this.get();return"checkbox"===t.type?t.checked:t.value}return this.each((e=>{const s=e.get();"checkbox"===s.type?s.checked=t:s.value=t}))}removeAttr(t){return this.each((e=>{const s=e.get();3!==s.nodeType&&t.split(" ").forEach((t=>s.removeAttribute(t)))}))}tag(t){let e=this.get();if(3===e.nodeType)return!1;let s=e.tagName.toLowerCase();return void 0===t?s:t.toLowerCase()===s}tagName(t){return this.tag(t)}empty(){return this.each((t=>{t.get().innerHTML=""}))}html(t){return void 0===t?this.get().innerHTML||"":this.empty().append(t)}text(t){return void 0===t?this.get().textContent||"":this.each((e=>{e.get().textContent=t}))}outer(){return this.get().outerHTML}after(t,e){return this._insert(t,"after")}before(t){return this._insert(t,"before")}append(t){return this._insert(t,"append")}prepend(t){return this._insert(t,"prepend")}wrap(t){return this._inject(t,((t,e)=>{const s="string"==typeof t||"number"==typeof t?this.create(t)[0]:t instanceof Node?t:this._array(t)[0];return e.parentNode&&e.parentNode.insertBefore(s,e),s.appendChild(e),s}))}unwrap(){return this.each((t=>{const e=t.get(),s=document.createDocumentFragment();for(;e.firstChild;)s.appendChild(e.firstChild);e.parentNode&&e.parentNode.replaceChild(s,e)}))}replaceWith(t){return this._inject(t,((t,e)=>{const s=document.createDocumentFragment();("string"==typeof t||"number"==typeof t?this.create(t):t instanceof Node?[t]:this._array(t)).forEach((t=>s.appendChild(t)));const i=s.firstChild;return e.parentNode&&e.parentNode.replaceChild(s,e),i}),!0)}replaceTag(t,e=!0){const i=this.nodes.map((s=>{const i=document.createElement(t);if(e)for(;s.firstChild;)i.appendChild(s.firstChild);return Array.from(s.attributes).forEach((t=>{i.setAttribute(t.name,t.value)})),s.parentNode&&s.parentNode.replaceChild(i,s),i}));return new s(i)}remove(){return this.each((t=>{t.get().remove()}))}clone(t){const e=[];return this.each((s=>{let i=s.get(),a=this._clone(i);t&&(a=this._cloneEvents(i,a)),e.push(a)})),new s(e)}cloneAttrs(t){const e=new s(t);return e.length?this.each((t=>{const s=t.get().attributes;for(const t of s)e.attr(t.name,t.value)})):this}cloneEmpty(){return new s(`<${this.tag()}>`)}show(){return this.each((t=>{const e=t.get();if(!e.style||!this._hasDisplayNone(e))return;const s=e.getAttribute("domTargetShow")||"block";e.style.setProperty("display",s,"important"),e.removeAttribute("domTargetShow")}))}hide(){return this.each((t=>{const e=t.get();if(!e.style||this._hasDisplayNone(e))return;const s=e.style.display;s&&"block"!==s&&e.setAttribute("domTargetShow",s),e.style.setProperty("display","none","important")}))}scrollTop(t){const e=this.get(),s=this._isWindowNode(e),i=9===e.nodeType?e.scrollingElement||e.documentElement:e;if(void 0!==t){const a=parseInt(t,10);return s?e.scrollTo(0,a):i.scrollTop=a,this}return s?e.pageYOffset:i.scrollTop}scroll(){this.get().scrollIntoView({behavior:"smooth"})}offset(){return this._getPos("offset")}position(){return this._getPos("position")}width(t){return void 0!==t?this.css("width",`${parseInt(t,10)}px`):this._getSize("width","Width")}height(t){return void 0!==t?this.css("height",`${parseInt(t,10)}px`):this._getSize("height","Height")}outerWidth(){return this._getSize("width","Width","outer")}outerHeight(){return this._getSize("height","Height","outer")}innerWidth(){return this._getSize("width","Width","inner")}innerHeight(){return this._getSize("height","Height","inner")}click(){return this._trigger("click")}focus(t={}){return this._trigger("focus",t)}blur(){return this._trigger("blur")}on(t,e,s=!1){return this.each((i=>{const a=i.get();t.split(" ").forEach((i=>{const r=this._getEventName(i),o=this._getEventNamespace(i),n=s?this._getOneHandler(e,t):e;a.addEventListener(r,n),a._e=a._e||{},a._e[o]=a._e[o]||{},a._e[o][r]=a._e[o][r]||[],a._e[o][r].push(n)}))}))}one(t,e){return this.on(t,e,!0)}off(t,e){const s=(t,e,s)=>t===s,i=(t,e,s,i)=>e===i,a=(t,e,s,i)=>t===s&&e===i,r=()=>!0;return void 0===t?this.each((t=>{this._offEvent(t.get(),!1,!1,e,r)})):this.each((r=>{const o=r.get();t.split(" ").forEach((t=>{const r=this._getEventName(t),n=this._getEventNamespace(t);"_events"===n?this._offEvent(o,r,n,e,s):r||"_events"===n?this._offEvent(o,r,n,e,a):this._offEvent(o,r,n,e,i)}))}))}serialize(t=!1){const e={},s=this.get().elements;return Array.from(s).forEach((t=>{/(checkbox|radio)/.test(t.type)&&!t.checked||!t.name||t.disabled||"file"===t.type||("select-multiple"===t.type?Array.from(t.options).forEach((s=>{s.selected&&(e[t.name]=s.value)})):e[t.name]=this._number(t.value)?parseFloat(t.value):this._boolean(t.value))})),t?e:this._params(e)}fadeIn(t,e){const s=this._anim(t,e,500);return this.each((t=>{t.css({display:"block",opacity:0,animation:`fadeIn ${s.speed}s ease-in-out`}).removeClass("hidden"),t.one("animationend",(()=>{t.css({opacity:"",animation:""}),s.fn&&s.fn(t)}))}))}fadeOut(t,e){const s=this._anim(t,e,300);return this.each((t=>{t.css({opacity:1,animation:`fadeOut ${s.speed}s ease-in-out`}),t.one("animationend",(()=>{t.css({display:"none",opacity:"",animation:""}),s.fn&&s.fn(t)}))}))}slideUp(t,e){const s=this._anim(t,e,300);return this.each((t=>{const e=t.height();t.height(e),t.css({overflow:"hidden",animation:`slideUp ${s.speed}s ease-out`}),t.one("animationend",(()=>{t.css({display:"none",height:"",animation:""}),s.fn&&s.fn(t)}))}))}slideDown(t,e){const s=this._anim(t,e,400);return this.each((t=>{const e=t.height();t.height(e),t.css({display:"block",overflow:"hidden",animation:`slideDown ${s.speed}s ease-in-out`}).removeClass("hidden"),t.one("animationend",(()=>{t.css({overflow:"",height:"",animation:""}),s.fn&&s.fn(t)}))}))}_params(t){return Object.keys(t).map((e=>`${this._encodeUri(e)}=${this._encodeUri(t[e])}`)).join("&")}_encodeUri(t){return encodeURIComponent(t).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")}_getOneHandler(t,e){return(...s)=>{t.apply(this,s),this.off(e,t)}}_getEventNamespace(t){const[e,s="_events",i]=t.split(".");return i?`${s}${i}`:s}_getEventName(t){return t.split(".")[0]}_offEvent(t,e,s,i,a){Object.keys(t._e||{}).forEach((r=>{Object.keys(t._e[r]).forEach((o=>{if(a(o,r,e,s)){const e=t._e[r][o];for(let s=e.length-1;s>=0;s--)i&&e[s].toString()!==i.toString()||(t.removeEventListener(o,e[s]),e.splice(s,1));0===e.length&&delete t._e[r][o],0===Object.keys(t._e[r]).length&&delete t._e[r]}}))}))}_trigger(t,e={}){const s=this.get();return s&&3!==s.nodeType&&"function"==typeof s[t]&&s[t](e),this}_hasDisplayNone(t){return"none"===(t.style.display||getComputedStyle(t).display)}_clone(t){if(void 0!==t)return"string"==typeof t?t:t instanceof Node?t.cloneNode(!0):"length"in t?Array.from(this._array(t)).map((t=>t.cloneNode(!0))):void 0}_cloneEvents(t,e){if(t._e){e._e={...t._e};for(const[s,i]of Object.entries(t._e._events||{}))i.forEach((t=>e.addEventListener(s,t)))}return e}_insert(t,e){return this._inject(t,((t,s)=>{const i={after:"afterend",before:"beforebegin",append:"beforeend",prepend:"afterbegin"};if("string"==typeof t||"number"==typeof t)s.insertAdjacentHTML(i[e],t);else{const i=t instanceof Node?[t]:this._array(t);"after"===e&&i.reverse(),i.forEach((t=>s[e](t)))}return s}))}_inject(t,e,i=!1){const a=this.nodes.map(((a,r)=>{const o=i?new s(a):a,n="function"==typeof t?t.call(this,o):t,l=0===r?n:this._clone(n);return e.call(this,l,a)}));return new s(a.filter((t=>t)))}_getSize(t,e,s=""){const i=this.get();return i?3===i.nodeType?0:9===i.nodeType?this._getDocSize(i,e):this._isWindowNode(i)?window[`inner${e}`]:"outer"===s?i[`offset${e}`]:"inner"===s?i[`client${e}`]:this._getDimensions(t):0}_getDocSize(t,e){const s=t.body,i=t.documentElement;return Math.max(s[`scroll${e}`],s[`offset${e}`],i[`client${e}`],i[`scroll${e}`],i[`offset${e}`])}_getPos(t){const e=this.get(),s={top:0,left:0};if(3===e.nodeType||this._isWindowNode(e)||9===e.nodeType)return s;if("position"===t)return{top:e.offsetTop,left:e.offsetLeft};if("offset"===t){const t=e.getBoundingClientRect(),s=e.ownerDocument,i=s.documentElement,a=s.defaultView;return{top:Math.round(t.top+a.pageYOffset-i.clientTop),left:Math.round(t.left+a.pageXOffset-i.clientLeft)}}return s}_getDimensions(t){const e=t.charAt(0).toUpperCase()+t.slice(1),s=this.get();if(!s)return 0;const i=getComputedStyle(s);let a=0;const r=this.parents().filter((t=>{const e=t.get();return 1===e.nodeType&&"none"===getComputedStyle(e).display}));if("none"===i.display&&r.add(s),0!==r.length){const t="visibility: hidden !important; display: block !important;",i=[];r.each(((e,s)=>{const a=e.attr("style");i[s]=null!==a?a:"",e.attr("style",a?a+";"+t:t)})),a=s[`offset${e}`],r.each(((t,e)=>{i[e]?t.attr("style",i[e]):t.removeAttr("style")}))}else a=s[`offset${e}`];return a}_boolean(t){return"true"===t||"false"!==t&&t}_number(t){return!isNaN(t)&&!isNaN(parseFloat(t))}_object(t){try{const e=t.replace(/(\w+)\s*:/g,'"$1":');return JSON.parse(e)}catch(t){return null}}_eachClass(t,e){return this.each(((s,i)=>{const a=s.get();if("function"==typeof t){const s=t(a.className);s&&s.split(" ").forEach((t=>a.classList[e](t)))}else t&&t.split(" ").forEach((t=>a.classList[e](t)))}))}_sibling(t,e){let i=null;return this.each((a=>{let r=a.get();for(;r=r[e];)if(t instanceof Node?r===t:new s(r).is(t)){i=r;break}})),new s(i)}_array(t){return void 0===t?[]:t instanceof NodeList?Array.from(t):t instanceof s?t.nodes:Array.isArray(t)?t:[t]}_slice(t){return Array.from(t?.nodes||t||[])}_query(t,e){return e?this._queryContext(t,e):this._simpleQuery(t)}_simpleQuery(t){const e=document;return/^[.#]?[\w-]*$/.test(t)?"#"===t[0]?[e.getElementById(t.slice(1))].filter(Boolean):"."===t[0]?e.getElementsByClassName(t.slice(1)):e.getElementsByTagName(t):e.querySelectorAll(t)}_queryContext(t,e){return 3!==(e=this._context(e)).nodeType&&"function"==typeof e.querySelectorAll?e.querySelectorAll(t):[]}_context(t){return t?"string"==typeof t?document.querySelector(t):t:document}_isWindowNode(t){return t===window||t?.parent===window}_anim(t,e,s){return"function"==typeof t?(e=t,t=s):t=t||s,{fn:e||null,speed:t/1e3}}}var i={settings:{},post:function(t){return new a("post",t)},get:function(t){return new a("get",t)},request:function(t,e){return new a(t,e)}},a=function(t,e){var s={method:t,url:"",before(){},success(){},error(){},data:!1,async:!0,headers:{}};this.p=this.extend(s,e),this.p=this.extend(this.p,i.settings),this.p.method=this.p.method.toUpperCase(),this.prepareData(),this.xhr=new XMLHttpRequest,this.xhr.open(this.p.method,this.p.url,this.p.async),this.setHeaders(),!1!==("function"!=typeof this.p.before||this.p.before(this.xhr))&&this.send()};a.prototype={extend:(t,e)=>(e&&Object.keys(e).forEach((function(s){t[s]=e[s]})),t),prepareData(){if(-1===["POST","PUT"].indexOf(this.p.method)||this.isFormData()||(this.p.headers["Content-Type"]="application/x-www-form-urlencoded"),"object"!=typeof this.p.data||this.isFormData()||(this.p.data=this.toParams(this.p.data)),"GET"===this.p.method){var t=-1!==this.p.url.search(/\?/)?"&":"?";this.p.url=this.p.data?this.p.url+t+this.p.data:this.p.url}},setHeaders(){this.xhr.setRequestHeader("X-Requested-With",this.p.headers["X-Requested-With"]||"XMLHttpRequest"),Object.keys(this.p.headers).forEach(function(t){this.xhr.setRequestHeader(t,this.p.headers[t])}.bind(this))},isFormData(){return void 0!==window.FormData&&this.p.data instanceof window.FormData},isComplete(){return!(this.xhr.status<200||this.xhr.status>=300&&304!==this.xhr.status)},send(){this.p.async?(this.xhr.onload=this.loaded.bind(this),this.xhr.send(this.p.data)):(this.xhr.send(this.p.data),this.loaded.call(this))},loaded(){var t;this.isComplete()?(t=this.parseResponse(),"function"==typeof this.p.success&&this.p.success(t,this.xhr)):(t=this.parseResponse(),"function"==typeof this.p.error&&this.p.error(t,this.xhr,this.xhr.status))},parseResponse(){var t=this.xhr.response,e=this.parseJson(t);return e||t},parseJson(t){try{var e=JSON.parse(t);if(e&&"object"==typeof e)return e}catch(t){return!1}return!1},toParams:t=>Object.keys(t).map((function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])})).join("&")};let r=0,o=function(t,e){let i,a=new s(t);return a.each((t=>{i=t.dataget(o.namespace),i||(i=new n(t,e,r),t.dataset(o.namespace,i),o.instances[r]=i,r++)})),a.length>1?o.instances:i};o.dom=function(t){return new s(t)},o.ajax=i,o.mapping={},o._mixins={},o.instances=[],o.namespace="redactor",o.version="4.2.4",o.settings={},o.lang={},o.triggers={},o.customTags=[],o.keycodes={BACKSPACE:8,DELETE:46,UP:38,DOWN:40,ENTER:13,SPACE:32,ESC:27,TAB:9,CTRL:17,META:91,SHIFT:16,ALT:18,RIGHT:39,LEFT:37},o.add=function(t,e,s){if(s.translations&&(o.lang=o.extend(!0,o.lang,s.translations)),"block"!==t&&s.defaults){let t={};t[e]=s.defaults,o.opts=o.extend(!0,o.opts,t)}if("block"===t&&s.props.custom&&o.customTags.push(s.props.custom),s.nested&&(o.opts.nested.push(e),o.opts.nestedValue.push(s.nested)),void 0!==s.parser&&!1===s.parser&&o.opts.nonparse.push(e),s.triggers&&(o.triggers=o.extend(!0,o.triggers,s.triggers)),"mixin"===t)o._mixins[e]=s;else{let i=function(){};if(i.prototype=s,s.mixins)for(let t=0;t<s.mixins.length;t++)o.inherit(i,o._mixins[s.mixins[t]]);void 0===o.mapping[t]&&(o.mapping[t]={}),o.mapping[t][e]={type:t,proto:i,obj:s}}},o.addLang=function(t,e){"object"==typeof t?o.lang=o.extend(!0,{},o.lang,t):(void 0===o.lang[t]&&(o.lang[t]={}),o.lang[t]=o.extend(!0,o.lang[t],e))},o.extend=function(){let t,e,s={},i=!1,a=0,r=arguments.length;for("[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(i=arguments[0],a++),e=function(e){for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(!e[t]||!0!==e[t].set&&!0!==e[t]._replace||(s[t]={}),i&&"[object Object]"===Object.prototype.toString.call(e[t])?s[t]=o.extend(!0,s[t],e[t]):s[t]=e[t],void 0!==s[t]&&(delete s[t].set,delete s[t]._replace))};a<r;a++){e(arguments[a])}return s},o.inherit=function(t,e){let s=function(){};s.prototype=e;let i=new s;for(let e in t.prototype)t.prototype.__lookupGetter__(e)?i.__defineGetter__(e,t.prototype.__lookupGetter__(e)):i[e]=t.prototype[e];return t.prototype=i,t.prototype.super=e,t},o.opts={plugins:[],focus:!1,tabindex:!1,content:!1,data:!1,output:!1,css:!1,cssFile:"redactor.min.css",frame:{lang:!1,dir:!1},doctype:"<!doctype html>",csscache:!1,custom:{css:!1,js:!1},lang:"en",breakline:!1,markup:"p",command:!0,nocontainer:!1,nostyle:!1,https:!1,clicktoedit:!1,theme:"auto",themeAttr:!1,placeholder:!1,readonly:!1,disabled:!1,dataBlock:"data-block",classname:"rx-content",dir:"ltr",reloadmarker:!0,addPosition:"top",spellcheck:!0,grammarly:!1,notranslate:!1,width:"100%",padding:"20px 28px",minHeight:"72px",maxHeight:!1,classes:!1,templateSyntax:!1,source:!0,enterKey:!0,drop:!0,draggable:!1,reorder:!0,scrollTarget:!1,scrollOverflow:!1,sync:!0,codemirror:!1,codemirrorSrc:!1,ai:!1,bsmodal:!1,paragraphize:!0,block:{outline:!0},colorpicker:{size:!1,wrap:!1,row:!1,width:!1},container:{border:!0},state:{limit:200},autosave:{url:!1,name:!1,data:!1,method:"post"},toolbar:{raised:!1,target:!1,sharedTarget:!1,sticky:!0,stickyMinHeight:200,stickyTopOffset:0},statusbar:{target:!1},pathbar:!1,control:!0,context:!1,clean:{comments:!1,enter:!0,enterinline:!0},tab:{key:!0,spaces:!1},format:!0,addbar:!0,extrabar:!0,addbarItems:{},inlineItems:{},formatItems:{},replaceTags:!1,buttons:{toolbar:["add","ai-tools","html","format","bold","italic","deleted","moreinline","list","link","image","table"],extrabar:["hotkeys"],control:["toggle"],context:["ai-tools","format","bold","italic","deleted","moreinline","link"],icons:!1},popups:{format:["text","h1","h2","h3","h4","quote","bulletlist","numberedlist","todo"],control:["add","move-up","move-down","duplicate","trash"],addbar:["ai-tools","ai-image","text","heading","image","todo","list","embed","table","quote","pre","line","layout","wrapper"],inline:["code","underline","sup","sub","highlight","removeinline"]},active:{tags:{b:["bold"],strong:["bold"],i:["italic"],em:["italic"],del:["deleted"],u:["underline"],a:["link"],code:["code"],mark:["mark"],sub:["subscript"],sup:["superscript"],h1:["h1"],h2:["h2"],h3:["h3"],h4:["h4"],h5:["h5"],h6:["h6"],ul:["bulletlist"],ol:["numberedlist"]},blocks:{listitem:["list"],list:["list"],pre:["pre"],table:["table"],cell:["table"],image:["image"],embed:["embed"],layout:["layout"],wrapper:["wrapper"],todo:["todo"],text:["text"],quote:["quote"]}},paste:{clean:!0,autoparse:!0,paragraphize:!0,paragraphizeLines:!1,plaintext:!1,linkTarget:!1,images:!0,links:!0,keepIdAttr:!1,keepNameAttr:!1,keepClass:[],keepStyle:[],keepAttrs:["td","th"],formTags:["form","input","button","select","textarea","legend","fieldset"],blockTags:["pre","h1","h2","h3","h4","h5","h6","table","tbody","thead","tfoot","th","tr","td","ul","ol","li","dl","dt","dd","blockquote","p","hr","figure","iframe","figcaption","address"],inlineTags:["a","svg","img","br","strong","ins","code","del","span","samp","kbd","sup","sub","mark","var","cite","small","b","u","em","i","abbr"]},link:{create:!1,edit:!1,truncate:24},image:{create:!1,edit:!1,states:!0,upload:!1,url:!0,select:!1,selectMethod:"get",name:"file",data:!1,drop:!0,multiple:!0,clipboard:!0,types:["image/*"],tag:"figure",newtab:!1,link:!0,width:!1},layout:{grid:!1,column:!1},layouts:{single:{title:"## layout.single-column ##",pattern:"100%"},"two-columns":{title:"## layout.two-columns ##",pattern:"50%|50%"},"three-columns":{title:"## layout.three-columns ##",pattern:"33%|33%|33%"},"four-columns":{title:"## layout.four-columns ##",pattern:"25%|25%|25%|25%"},"60-40":{title:"60/40",pattern:"60%|40%"},"40-60":{title:"40/60",pattern:"40%|60%"}},wrapper:{template:"<div></div>"},figcaption:{template:"<figcaption></figcaption>"},line:{template:"<hr>"},noneditable:{remove:!0,select:!0},pre:{template:"<pre></pre>",spaces:4},table:{template:"<table><tr><td></td><td></td></tr><tr><td></td><td></td></tr></table>",nowrap:"nowrap"},todo:{templateItem:"[ ]",templateItemDone:"[x]",templateInput:'<input type="checkbox">',templateContent:"<div></div>",template:!1},quote:{template:'<blockquote><p data-placeholder="Quote..."></p><p><cite data-placeholder="Attribution"></cite></p></blockquote>'},embed:{classname:"embed-content",responsive:!1,responsiveClassname:"embed-responsive",script:!0},outset:{none:"none",left:"outset-left",both:"outset-both",right:"outset-right"},wrapWithStyle:!1,wrap:{none:"none",left:"float-left",center:"wrap-center",right:"float-right"},colors:{base:["#000000","#ffffff"],gray:["#212529","#343a40","#495057","#868e96","#adb5bd","#ced4da","#dee2e6","#e9ecef","#f1f3f5","#f8f9fa"],red:["#c92a2a","#e03131","#f03e3e","#fa5252","#ff6b6b","#ff8787","#ffa8a8","#ffc9c9","#ffe3e3","#fff5f5"],pink:["#a61e4d","#c2255c","#d6336c","#e64980","#f06595","#f783ac","#faa2c1","#fcc2d7","#ffdeeb","#fff0f6"],grape:["#862e9c","#9c36b5","#ae3ec9","#be4bdb","#cc5de8","#da77f2","#e599f7","#eebefa","#f3d9fa","#f8f0fc"],violet:["#5f3dc4","#6741d9","#7048e8","#7950f2","#845ef7","#9775fa","#b197fc","#d0bfff","#e5dbff","#f3f0ff"],indigo:["#364fc7","#3b5bdb","#4263eb","#4c6ef5","#5c7cfa","#748ffc","#91a7ff","#bac8ff","#dbe4ff","#edf2ff"],blue:["#1864ab","#1971c2","#1c7ed6","#228be6","#339af0","#4dabf7","#74c0fc","#a5d8ff","#d0ebff","#e7f5ff"],cyan:["#0b7285","#0c8599","#1098ad","#15aabf","#22b8cf","#3bc9db","#66d9e8","#99e9f2","#c5f6fa","#e3fafc"],teal:["#087f5b","#099268","#0ca678","#12b886","#20c997","#38d9a9","#63e6be","#96f2d7","#c3fae8","#e6fcf5"],green:["#2b8a3e","#2f9e44","#37b24d","#40c057","#51cf66","#69db7c","#8ce99a","#b2f2bb","#d3f9d8","#ebfbee"],lime:["#5c940d","#66a80f","#74b816","#82c91e","#94d82d","#a9e34b","#c0eb75","#d8f5a2","#e9fac8","#f4fce3"],yellow:["#e67700","#f08c00","#f59f00","#fab005","#fcc419","#ffd43b","#ffe066","#ffec99","#fff3bf","#fff9db"],orange:["#d9480f","#e8590c","#f76707","#fd7e14","#ff922b","#ffa94d","#ffc078","#ffd8a8","#ffe8cc","#fff4e6"]},hotkeysAdd:!1,hotkeysRemove:!1,hotkeysBase:{"meta+z":"## hotkeys.meta-z ##","meta+shift+z":"## hotkeys.meta-shift-z ##","meta+a":"## hotkeys.meta-a ##","meta+shift+a":"## hotkeys.meta-shift-a ##"},hotkeys:{"ctrl+shift+o, meta+shift+o":{title:"## hotkeys.meta-shift-o ##",name:"meta+shift+o",command:"addbar.popup"},"ctrl+shift+d, meta+shift+d":{title:"## hotkeys.meta-shift-d ##",name:"meta+shift+d",command:"block.duplicate"},"ctrl+shift+up, meta+shift+up":{title:"## hotkeys.meta-shift-up ##",name:"meta+shift+&uarr;",command:"block.moveUp"},"ctrl+shift+down, meta+shift+down":{title:"## hotkeys.meta-shift-down ##",name:"meta+shift+&darr;",command:"block.moveDown"},"ctrl+shift+m, meta+shift+m":{title:"## hotkeys.meta-shift-m ##",name:"meta+shift+m",command:"inline.removeFormat"},"ctrl+b, meta+b":{title:"## hotkeys.meta-b ##",name:"meta+b",command:"inline.set",params:{tag:"b"}},"ctrl+i, meta+i":{title:"## hotkeys.meta-i ##",name:"meta+i",command:"inline.set",params:{tag:"i"}},"ctrl+u, meta+u":{title:"## hotkeys.meta-u ##",name:"meta+u",command:"inline.set",params:{tag:"u"}},"ctrl+h, meta+h":{title:"## hotkeys.meta-h ##",name:"meta+h",command:"inline.set",params:{tag:"sup"}},"ctrl+l, meta+l":{title:"## hotkeys.meta-l ##",name:"meta+l",command:"inline.set",params:{tag:"sub"}},"ctrl+alt+0, meta+alt+0":{title:"## hotkeys.meta-alt-0 ##",name:"meta+alt+0",command:"format.set",params:{tag:"p"}},"ctrl+alt+1, meta+alt+1":{title:"## hotkeys.meta-alt-1 ##",name:"meta+alt+1",command:"format.set",params:{tag:"h1"}},"ctrl+alt+2, meta+alt+2":{title:"## hotkeys.meta-alt-2 ##",name:"meta+alt+2",command:"format.set",params:{tag:"h2"}},"ctrl+alt+3, meta+alt+3":{title:"## hotkeys.meta-alt-3 ##",name:"meta+alt+3",command:"format.set",params:{tag:"h3"}},"ctrl+alt+4, meta+alt+4":{title:"## hotkeys.meta-alt-4 ##",name:"meta+alt+4",command:"format.set",params:{tag:"h4"}},"ctrl+alt+5, meta+alt+5":{title:"## hotkeys.meta-alt-5 ##",name:"meta+alt+5",command:"format.set",params:{tag:"h5"}},"ctrl+alt+6, meta+alt+6":{title:"## hotkeys.meta-alt-6 ##",name:"meta+alt+6",command:"format.set",params:{tag:"h6"}},"ctrl+shift+7, meta+shift+7":{title:"## hotkeys.meta-shift-7 ##",name:"meta+shift+7",command:"format.set",params:{tag:"ol"}},"ctrl+shift+8, meta+shift+8":{title:"## hotkeys.meta-shift-8 ##",name:"meta+shift+8",command:"format.set",params:{tag:"ul"}},"ctrl+], meta+]":{title:"## hotkeys.meta-indent ##",name:"meta+]",command:"list.indent"},"ctrl+[, meta+[, shift+tab":{title:"## hotkeys.meta-outdent ##",name:"meta+[",command:"list.outdent"},"ctrl+k, meta+k":{title:"## hotkeys.meta-k ##",name:"meta+k",command:"link.popup"}},markerChar:"\ufeff",containers:{main:["toolbox","editor","source","preview","statusbar"],toolbox:["pathbar","toolbar"]},modes:{nocontainer:{toolbar:!1,extrabar:!1,pathbar:!1,padding:"0"}},buttonsObj:{"ai-tools":{title:"## buttons.ai-tools ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M18 3C18.5523 3 19 3.44772 19 4C19 4.26522 19.1054 4.51957 19.2929 4.70711C19.4804 4.89464 19.7348 5 20 5C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7C19.7348 7 19.4804 7.10536 19.2929 7.29289C19.1054 7.48043 19 7.73478 19 8C19 8.55228 18.5523 9 18 9C17.4477 9 17 8.55228 17 8C17 7.73478 16.8946 7.48043 16.7071 7.29289C16.5196 7.10536 16.2652 7 16 7C15.4477 7 15 6.55228 15 6C15 5.44772 15.4477 5 16 5C16.2652 5 16.5196 4.89464 16.7071 4.70711C16.8946 4.51957 17 4.26522 17 4C17 3.44772 17.4477 3 18 3ZM9 5C9.55228 5 10 5.44772 10 6C10 7.32608 10.5268 8.59785 11.4645 9.53553C12.4021 10.4732 13.6739 11 15 11C15.5523 11 16 11.4477 16 12C16 12.5523 15.5523 13 15 13C13.6739 13 12.4021 13.5268 11.4645 14.4645C10.5268 15.4021 10 16.6739 10 18C10 18.5523 9.55228 19 9 19C8.44772 19 8 18.5523 8 18C8 16.6739 7.47322 15.4021 6.53553 14.4645C5.59785 13.5268 4.32608 13 3 13C2.44772 13 2 12.5523 2 12C2 11.4477 2.44772 11 3 11C4.32608 11 5.59785 10.4732 6.53553 9.53553C7.47322 8.59785 8 7.32608 8 6C8 5.44772 8.44772 5 9 5ZM9 9.60559C8.70843 10.0908 8.35673 10.5428 7.94975 10.9497C7.54276 11.3567 7.09082 11.7084 6.60559 12C7.09082 12.2916 7.54276 12.6433 7.94975 13.0503C8.35673 13.4572 8.70843 13.9092 9 14.3944C9.29157 13.9092 9.64327 13.4572 10.0503 13.0503C10.4572 12.6433 10.9092 12.2916 11.3944 12C10.9092 11.7084 10.4572 11.3567 10.0503 10.9497C9.64327 10.5428 9.29157 10.0908 9 9.60559ZM16.7071 16.7071C16.8946 16.5196 17 16.2652 17 16C17 15.4477 17.4477 15 18 15C18.5523 15 19 15.4477 19 16C19 16.2652 19.1054 16.5196 19.2929 16.7071C19.4804 16.8946 19.7348 17 20 17C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19C19.7348 19 19.4804 19.1054 19.2929 19.2929C19.1054 19.4804 19 19.7348 19 20C19 20.5523 18.5523 21 18 21C17.4477 21 17 20.5523 17 20C17 19.7348 16.8946 19.4804 16.7071 19.2929C16.5196 19.1054 16.2652 19 16 19C15.4477 19 15 18.5523 15 18C15 17.4477 15.4477 17 16 17C16.2652 17 16.5196 16.8946 16.7071 16.7071Z"/></svg>',observer:"ai.observe",command:"ai.popup"},"ai-image":{title:"## buttons.ai-image ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M18 3C18.5523 3 19 3.44772 19 4C19 4.26522 19.1054 4.51957 19.2929 4.70711C19.4804 4.89464 19.7348 5 20 5C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7C19.7348 7 19.4804 7.10536 19.2929 7.29289C19.1054 7.48043 19 7.73478 19 8C19 8.55228 18.5523 9 18 9C17.4477 9 17 8.55228 17 8C17 7.73478 16.8946 7.48043 16.7071 7.29289C16.5196 7.10536 16.2652 7 16 7C15.4477 7 15 6.55228 15 6C15 5.44772 15.4477 5 16 5C16.2652 5 16.5196 4.89464 16.7071 4.70711C16.8946 4.51957 17 4.26522 17 4C17 3.44772 17.4477 3 18 3ZM9 5C9.55228 5 10 5.44772 10 6C10 7.32608 10.5268 8.59785 11.4645 9.53553C12.4021 10.4732 13.6739 11 15 11C15.5523 11 16 11.4477 16 12C16 12.5523 15.5523 13 15 13C13.6739 13 12.4021 13.5268 11.4645 14.4645C10.5268 15.4021 10 16.6739 10 18C10 18.5523 9.55228 19 9 19C8.44772 19 8 18.5523 8 18C8 16.6739 7.47322 15.4021 6.53553 14.4645C5.59785 13.5268 4.32608 13 3 13C2.44772 13 2 12.5523 2 12C2 11.4477 2.44772 11 3 11C4.32608 11 5.59785 10.4732 6.53553 9.53553C7.47322 8.59785 8 7.32608 8 6C8 5.44772 8.44772 5 9 5ZM9 9.60559C8.70843 10.0908 8.35673 10.5428 7.94975 10.9497C7.54276 11.3567 7.09082 11.7084 6.60559 12C7.09082 12.2916 7.54276 12.6433 7.94975 13.0503C8.35673 13.4572 8.70843 13.9092 9 14.3944C9.29157 13.9092 9.64327 13.4572 10.0503 13.0503C10.4572 12.6433 10.9092 12.2916 11.3944 12C10.9092 11.7084 10.4572 11.3567 10.0503 10.9497C9.64327 10.5428 9.29157 10.0908 9 9.60559ZM16.7071 16.7071C16.8946 16.5196 17 16.2652 17 16C17 15.4477 17.4477 15 18 15C18.5523 15 19 15.4477 19 16C19 16.2652 19.1054 16.5196 19.2929 16.7071C19.4804 16.8946 19.7348 17 20 17C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19C19.7348 19 19.4804 19.1054 19.2929 19.2929C19.1054 19.4804 19 19.7348 19 20C19 20.5523 18.5523 21 18 21C17.4477 21 17 20.5523 17 20C17 19.7348 16.8946 19.4804 16.7071 19.2929C16.5196 19.1054 16.2652 19 16 19C15.4477 19 15 18.5523 15 18C15 17.4477 15.4477 17 16 17C16.2652 17 16.5196 16.8946 16.7071 16.7071Z"/></svg>',observer:"ai.observe",command:"ai.promptImage"},add:{title:"## buttons.add ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M13 3.75C13 3.19772 12.5523 2.75 12 2.75C11.4477 2.75 11 3.19772 11 3.75V11H3.75C3.19772 11 2.75 11.4477 2.75 12C2.75 12.5523 3.19772 13 3.75 13H11V20.25C11 20.8023 11.4477 21.25 12 21.25C12.5523 21.25 13 20.8023 13 20.25V13H20.25C20.8023 13 21.25 12.5523 21.25 12C21.25 11.4477 20.8023 11 20.25 11H13V3.75Z"/></svg>',command:"addbar.popup"},html:{title:"## buttons.html ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.9701 4.24253C15.1041 3.70673 14.7783 3.1638 14.2425 3.02985C13.7067 2.8959 13.1638 3.22166 13.0299 3.75746L9.02986 19.7575C8.89591 20.2933 9.22167 20.8362 9.75746 20.9701C10.2933 21.1041 10.8362 20.7783 10.9701 20.2425L14.9701 4.24253ZM7.70711 7.29289C8.09763 7.68341 8.09763 8.31658 7.70711 8.7071L4.41421 12L7.70711 15.2929C8.09763 15.6834 8.09763 16.3166 7.70711 16.7071C7.31658 17.0976 6.68342 17.0976 6.29289 16.7071L2.29289 12.7071C1.90237 12.3166 1.90237 11.6834 2.29289 11.2929L6.29289 7.29289C6.68342 6.90236 7.31658 6.90236 7.70711 7.29289ZM16.2929 7.29289C16.6834 6.90236 17.3166 6.90236 17.7071 7.29289L21.7071 11.2929C22.0976 11.6834 22.0976 12.3166 21.7071 12.7071L17.7071 16.7071C17.3166 17.0976 16.6834 17.0976 16.2929 16.7071C15.9024 16.3166 15.9024 15.6834 16.2929 15.2929L19.5858 12L16.2929 8.7071C15.9024 8.31658 15.9024 7.68341 16.2929 7.29289Z"/></svg>',command:"source.toggle"},format:{title:"## buttons.format ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.32413 6.98804C6.14654 7.2864 6 7.75331 6 8.5C6 9.24669 6.14654 9.7136 6.32413 10.012C6.49608 10.3008 6.73889 10.5026 7.06782 10.6511C7.58542 10.8849 8.24184 10.9625 9 10.9879V6.01213C8.24184 6.03755 7.58542 6.11512 7.06782 6.34887C6.73889 6.49742 6.49608 6.69917 6.32413 6.98804ZM6.24464 12.4739C7.10428 12.8621 8.10853 12.9642 9 12.9908V19C9 19.5523 9.44772 20 10 20C10.5523 20 11 19.5523 11 19V12V6H15V19C15 19.5523 15.4477 20 16 20C16.5523 20 17 19.5523 17 19V6H18C18.5523 6 19 5.55228 19 5C19 4.44772 18.5523 4 18 4H16H15C14.9996 4 14.9993 4 14.9989 4L10 4L9.99773 4L9.90325 3.99997C8.84701 3.99946 7.4124 3.99876 6.24464 4.52613C5.60483 4.81508 5.01952 5.26959 4.60554 5.96509C4.1972 6.65111 4 7.49669 4 8.5C4 9.50331 4.1972 10.3489 4.60554 11.0349C5.01952 11.7304 5.60483 12.1849 6.24464 12.4739Z"/></svg>',command:"format.popup"},bold:{title:"## buttons.bold ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 4C6.44772 4 6 4.44772 6 5V12V19C6 19.5523 6.44772 20 7 20H14C15.1935 20 16.3381 19.5259 17.182 18.682C18.0259 17.8381 18.5 16.6935 18.5 15.5C18.5 14.3065 18.0259 13.1619 17.182 12.318C16.9031 12.0391 16.5914 11.8006 16.2559 11.6063C17.0535 10.7703 17.5 9.65816 17.5 8.5C17.5 7.30653 17.0259 6.16193 16.182 5.31802C15.3381 4.47411 14.1935 4 13 4H7ZM13 13H8V18H14C14.663 18 15.2989 17.7366 15.7678 17.2678C16.2366 16.7989 16.5 16.163 16.5 15.5C16.5 14.837 16.2366 14.2011 15.7678 13.7322C15.2989 13.2634 14.663 13 14 13H13ZM13 11C13.663 11 14.2989 10.7366 14.7678 10.2678C15.2366 9.79893 15.5 9.16304 15.5 8.5C15.5 7.83696 15.2366 7.20107 14.7678 6.73223C14.2989 6.26339 13.663 6 13 6H8V11H13Z"/></svg>',command:"inline.set",params:{tag:"b"}},italic:{title:"## buttons.italic ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.0222 4H17C17.5523 4 18 4.44772 18 5C18 5.55228 17.5523 6 17 6H14.7543L11.3257 18H13C13.5523 18 14 18.4477 14 19C14 19.5523 13.5523 20 13 20H10.023C10.0081 20.0003 9.99304 20.0003 9.97798 20H7C6.44772 20 6 19.5523 6 19C6 18.4477 6.44772 18 7 18H9.24571L12.6743 6H11C10.4477 6 10 5.55228 10 5C10 4.44772 10.4477 4 11 4H13.9768C13.9919 3.99966 14.007 3.99965 14.0222 4Z"/></svg>',command:"inline.set",params:{tag:"i"}},deleted:{title:"## buttons.deleted ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.8776 4.46266C14.0175 4.14012 13.0023 3.98493 11.9923 3.99999H11C9.80652 3.99999 8.66193 4.4741 7.81802 5.31801C6.9741 6.16193 6.5 7.30652 6.5 8.49999C6.5 9.39648 6.76751 10.2654 7.25832 11H5C4.44772 11 4 11.4477 4 12C4 12.5523 4.44772 13 5 13H13.0058C13.6667 13.0015 14.3003 13.2647 14.7678 13.7322C15.2366 14.2011 15.5 14.837 15.5 15.5C15.5 16.163 15.2366 16.7989 14.7678 17.2678C14.2989 17.7366 13.663 18 13 18H11.5L11.4842 18.0001C10.6801 18.0128 9.9163 17.8865 9.32462 17.6647C8.70357 17.4318 8.45244 17.1652 8.38892 17.0419C8.13594 16.551 7.53288 16.3581 7.04194 16.6111C6.551 16.864 6.35809 17.4671 6.61107 17.9581C7.00105 18.7149 7.78931 19.2249 8.62237 19.5373C9.4825 19.8599 10.4977 20.0151 11.5077 20H13C14.1935 20 15.3381 19.5259 16.182 18.682C17.0259 17.8381 17.5 16.6935 17.5 15.5C17.5 14.6035 17.2325 13.7346 16.7417 13H19C19.5523 13 20 12.5523 20 12C20 11.4477 19.5523 11 19 11H13.0083C13.0055 11 13.0028 11 13 11H11C10.337 11 9.70107 10.7366 9.23223 10.2678C8.76339 9.79892 8.5 9.16303 8.5 8.49999C8.5 7.83695 8.76339 7.20107 9.23223 6.73223C9.70107 6.26338 10.337 5.99999 11 5.99999H12L12.0158 5.99987C12.8199 5.98715 13.5837 6.11344 14.1754 6.33532C14.7964 6.56822 15.0476 6.83478 15.1111 6.95805C15.3641 7.44899 15.9671 7.64189 16.4581 7.38892C16.949 7.13594 17.1419 6.53287 16.8889 6.04193C16.4989 5.28513 15.7107 4.77506 14.8776 4.46266Z"/></svg>',command:"inline.set",params:{tag:"del"}},moreinline:{title:"## buttons.more-formatting ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3 12C3 10.8954 3.89543 10 5 10C6.10457 10 7 10.8954 7 12C7 13.1046 6.10457 14 5 14C3.89543 14 3 13.1046 3 12ZM10 12C10 10.8954 10.8954 10 12 10C13.1046 10 14 10.8954 14 12C14 13.1046 13.1046 14 12 14C10.8954 14 10 13.1046 10 12ZM19 10C17.8954 10 17 10.8954 17 12C17 13.1046 17.8954 14 19 14C20.1046 14 21 13.1046 21 12C21 10.8954 20.1046 10 19 10Z"/></svg>',command:"inline.popup"},link:{title:"## buttons.link ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.1946 6.14687L11.7568 6.65369C11.3957 7.07164 10.7643 7.11778 10.3463 6.75676C9.92836 6.39573 9.88222 5.76425 10.2432 5.34631L10.7062 4.81031C10.7222 4.79189 10.7387 4.77405 10.7559 4.75684C11.8813 3.63165 13.4075 2.99958 14.9989 2.99969C16.5903 2.99981 18.1165 3.63209 19.2417 4.75744C20.3669 5.8828 20.9989 7.40904 20.9988 9.00042C20.9987 10.5918 20.3664 12.118 19.2411 13.2432C19.2246 13.2596 19.2075 13.2756 19.1899 13.2909L18.6559 13.7549C18.239 14.1171 17.6074 14.0728 17.2452 13.6559C16.8829 13.239 16.9272 12.6074 17.3441 12.2452L17.8502 11.8054C18.5859 11.0576 18.9987 10.0502 18.9988 9.00028C18.9989 7.93934 18.5775 6.92181 17.8273 6.17156C17.0772 5.4213 16.0597 4.99977 14.9988 4.99969C13.9493 4.99962 12.9424 5.41192 12.1946 6.14687ZM15.7071 8.29289C16.0976 8.68342 16.0976 9.31658 15.7071 9.70711L9.70711 15.7071C9.31658 16.0976 8.68342 16.0976 8.29289 15.7071C7.90237 15.3166 7.90237 14.6834 8.29289 14.2929L14.2929 8.29289C14.6834 7.90237 15.3166 7.90237 15.7071 8.29289ZM6.7494 10.3379C7.11509 10.7517 7.07603 11.3837 6.66216 11.7494L6.16037 12.1928C5.7956 12.5583 5.50555 12.9915 5.30653 13.4681C5.10411 13.953 4.99988 14.4731 4.99988 14.9985C4.99988 15.5239 5.10411 16.044 5.30653 16.5289C5.50895 17.0137 5.80554 17.4535 6.17913 17.8229L6.17916 17.8229C6.9407 18.576 7.96851 18.9984 9.03952 18.9984C10.0866 18.9984 11.0923 18.5947 11.8483 17.873L12.1975 17.4034C12.527 16.9602 13.1534 16.868 13.5966 17.1975C14.0399 17.527 14.132 18.1534 13.8025 18.5966L13.4055 19.1306C13.3754 19.1712 13.3421 19.2095 13.3062 19.2451C12.1702 20.3684 10.6371 20.9984 9.03952 20.9984C7.44197 20.9984 5.90886 20.3684 4.77291 19.2451C4.21121 18.6897 3.76528 18.0284 3.46093 17.2994C3.15659 16.5705 2.99988 15.7884 2.99988 14.9985C2.99988 14.2086 3.15659 13.4265 3.46093 12.6976C3.76528 11.9686 4.21121 11.3073 4.77291 10.7519C4.78621 10.7388 4.79987 10.726 4.81388 10.7136L5.33788 10.2506C5.75175 9.88493 6.38371 9.92399 6.7494 10.3379Z"/></svg>',observer:"link.observe",command:"link.popup"},"link-text":{title:"## buttons.link-text ##",command:"link.open"},unlink:{title:"## buttons.unlink ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 1C7.55228 1 8 1.44772 8 2V4C8 4.55228 7.55228 5 7 5C6.44772 5 6 4.55228 6 4V2C6 1.44772 6.44772 1 7 1ZM12.1946 6.14687L11.7568 6.65369C11.3957 7.07164 10.7643 7.11778 10.3463 6.75676C9.92836 6.39573 9.88222 5.76425 10.2432 5.34631L10.7062 4.81031C10.7222 4.79189 10.7387 4.77405 10.7559 4.75684C11.8813 3.63165 13.4075 2.99958 14.9989 2.99969C16.5903 2.99981 18.1165 3.63209 19.2417 4.75744C20.3669 5.8828 20.9989 7.40905 20.9988 9.00043C20.9987 10.5918 20.3664 12.118 19.2411 13.2432C19.2246 13.2596 19.2075 13.2756 19.1899 13.2909L18.6559 13.7549C18.239 14.1171 17.6074 14.0728 17.2452 13.6559C16.8829 13.239 16.9272 12.6074 17.3441 12.2452L17.8502 11.8054C18.5859 11.0576 18.9987 10.0502 18.9988 9.00028C18.9989 7.93934 18.5775 6.92181 17.8273 6.17156C17.0772 5.4213 16.0597 4.99977 14.9988 4.99969C13.9493 4.99962 12.9424 5.41192 12.1946 6.14687ZM1 7C1 6.44772 1.44772 6 2 6H4C4.55228 6 5 6.44772 5 7C5 7.55228 4.55228 8 4 8H2C1.44772 8 1 7.55228 1 7ZM15.7071 8.29289C16.0976 8.68342 16.0976 9.31658 15.7071 9.70711L9.70711 15.7071C9.31658 16.0976 8.68342 16.0976 8.29289 15.7071C7.90237 15.3166 7.90237 14.6834 8.29289 14.2929L14.2929 8.29289C14.6834 7.90237 15.3166 7.90237 15.7071 8.29289ZM6.7494 10.3379C7.11509 10.7517 7.07603 11.3837 6.66216 11.7494L6.16037 12.1928C5.7956 12.5583 5.50555 12.9915 5.30653 13.4681C5.10411 13.953 4.99988 14.4731 4.99988 14.9985C4.99988 15.5239 5.10411 16.044 5.30653 16.5289C5.50895 17.0137 5.80554 17.4535 6.17913 17.8229L6.17916 17.8229C6.9407 18.576 7.96851 18.9984 9.03952 18.9984C10.0866 18.9984 11.0923 18.5947 11.8483 17.873L12.1975 17.4034C12.527 16.9602 13.1534 16.868 13.5966 17.1975C14.0399 17.527 14.132 18.1534 13.8025 18.5966L13.4055 19.1306C13.3754 19.1712 13.3421 19.2095 13.3062 19.2451C12.1702 20.3684 10.6371 20.9984 9.03952 20.9984C7.44197 20.9984 5.90886 20.3684 4.77291 19.2451C4.21121 18.6897 3.76528 18.0284 3.46093 17.2994C3.15659 16.5705 2.99988 15.7884 2.99988 14.9985C2.99988 14.2086 3.15659 13.4265 3.46093 12.6976C3.76528 11.9686 4.21121 11.3073 4.77291 10.7519C4.78621 10.7388 4.79987 10.726 4.81388 10.7136L5.33788 10.2506C5.75175 9.88493 6.38371 9.92399 6.7494 10.3379ZM19 17C19 16.4477 19.4477 16 20 16H22C22.5523 16 23 16.4477 23 17C23 17.5523 22.5523 18 22 18H20C19.4477 18 19 17.5523 19 17ZM17 19C17.5523 19 18 19.4477 18 20V22C18 22.5523 17.5523 23 17 23C16.4477 23 16 22.5523 16 22V20C16 19.4477 16.4477 19 17 19Z"/></svg>',command:"link.unlink"},image:{title:"## buttons.image ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5 7C5 5.89543 5.89543 5 7 5H17C18.1046 5 19 5.89543 19 7V12.5858L18.7071 12.2929L18.6934 12.2794C18.091 11.6998 17.3358 11.3301 16.5 11.3301C15.6642 11.3301 14.909 11.6998 14.3066 12.2794L14.2929 12.2929L14 12.5858L11.7071 10.2929L11.6934 10.2794C11.091 9.6998 10.3358 9.33014 9.5 9.33014C8.66419 9.33014 7.909 9.6998 7.30662 10.2794L7.29289 10.2929L5 12.5858V7ZM15.4142 14L15.6997 13.7146C16.0069 13.4213 16.2841 13.3301 16.5 13.3301C16.7159 13.3301 16.9931 13.4213 17.3003 13.7146L19 15.4142V17C19 18.1046 18.1046 19 17 19H7C5.89543 19 5 18.1046 5 17V15.4142L8.69966 11.7146C9.0069 11.4213 9.28406 11.3301 9.5 11.3301C9.71594 11.3301 9.9931 11.4213 10.3003 11.7146L13.2929 14.7071L15.2929 16.7071C15.6834 17.0976 16.3166 17.0976 16.7071 16.7071C17.0976 16.3166 17.0976 15.6834 16.7071 15.2929L15.4142 14ZM21 15.001V17C21 19.2091 19.2091 21 17 21H7C4.79086 21 3 19.2091 3 17V15.0002V14.9998V7C3 4.79086 4.79086 3 7 3H17C19.2091 3 21 4.79086 21 7V14.999C21 14.9997 21 15.0003 21 15.001ZM15 7C14.4477 7 14 7.44772 14 8C14 8.55228 14.4477 9 15 9H15.01C15.5623 9 16.01 8.55228 16.01 8C16.01 7.44772 15.5623 7 15.01 7H15Z"/></svg>',observer:"image.observe",command:"image.popup"},unwrap:{title:"## buttons.unwrap ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2.29289 2.29289C2.68342 1.90237 3.31658 1.90237 3.70711 2.29289L21.7071 20.2929C22.0976 20.6834 22.0976 21.3166 21.7071 21.7071C21.3166 22.0976 20.6834 22.0976 20.2929 21.7071L18 19.4142V20C18 20.5523 17.5523 21 17 21C16.4477 21 16 20.5523 16 20V18H8V20C8 20.5523 7.55228 21 7 21C6.44772 21 6 20.5523 6 20V18H4C3.44772 18 3 17.5523 3 17C3 16.4477 3.44772 16 4 16H6V8H4C3.44772 8 3 7.55228 3 7C3 6.44772 3.44772 6 4 6H4.58579L2.29289 3.70711C1.90237 3.31658 1.90237 2.68342 2.29289 2.29289ZM8 9.41421L14.5858 16H8V9.41421ZM17 3C17.5523 3 18 3.44772 18 4V6H20C20.5523 6 21 6.44772 21 7C21 7.55228 20.5523 8 20 8H18V13C18 13.5523 17.5523 14 17 14C16.4477 14 16 13.5523 16 13V8H11C10.4477 8 10 7.55228 10 7C10 6.44772 10.4477 6 11 6H16V4C16 3.44772 16.4477 3 17 3Z"/></svg>',command:"block.unwrap"},outset:{title:"## buttons.outset ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 4C6 3.44772 6.44772 3 7 3H17C17.5523 3 18 3.44772 18 4C18 4.55229 17.5523 5 17 5L7 5C6.44772 5 6 4.55228 6 4ZM3.58579 7.58579C3.96086 7.21071 4.46957 7 5 7H19C19.5304 7 20.0391 7.21071 20.4142 7.58579C20.7893 7.96086 21 8.46957 21 9V15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H5C4.46957 17 3.96086 16.7893 3.58579 16.4142C3.21071 16.0391 3 15.5304 3 15V9C3 8.46957 3.21071 7.96086 3.58579 7.58579ZM19 9H5L5 15H19V9ZM7 19C6.44772 19 6 19.4477 6 20C6 20.5523 6.44772 21 7 21H17C17.5523 21 18 20.5523 18 20C18 19.4477 17.5523 19 17 19H7Z"/></svg>',observer:"image.observe",command:"image.popupOutset"},wrap:{title:"## buttons.wrap-image ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3.58579 4.58579C3.96086 4.21071 4.46957 4 5 4H9C9.53043 4 10.0391 4.21071 10.4142 4.58579C10.7893 4.96086 11 5.46957 11 6V10C11 10.5304 10.7893 11.0391 10.4142 11.4142C10.0391 11.7893 9.53043 12 9 12H5C4.46957 12 3.96086 11.7893 3.58579 11.4142C3.21071 11.0391 3 10.5304 3 10V6C3 5.46957 3.21071 4.96086 3.58579 4.58579ZM9 6L5 6L5 10H9V6ZM13 7C13 6.44772 13.4477 6 14 6H20C20.5523 6 21 6.44772 21 7C21 7.55228 20.5523 8 20 8H14C13.4477 8 13 7.55228 13 7ZM13 11C13 10.4477 13.4477 10 14 10H20C20.5523 10 21 10.4477 21 11C21 11.5523 20.5523 12 20 12H14C13.4477 12 13 11.5523 13 11ZM3 15C3 14.4477 3.44772 14 4 14H20C20.5523 14 21 14.4477 21 15C21 15.5523 20.5523 16 20 16H4C3.44772 16 3 15.5523 3 15ZM3 19C3 18.4477 3.44772 18 4 18H20C20.5523 18 21 18.4477 21 19C21 19.5523 20.5523 20 20 20H4C3.44772 20 3 19.5523 3 19Z"/></svg>',observer:"image.observe",command:"image.popupWrap"},"move-up":{title:"## buttons.move-up ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.2929 4.29289C11.6834 3.90237 12.3166 3.90237 12.7071 4.29289L16.7071 8.29289C17.0976 8.68342 17.0976 9.31658 16.7071 9.70711C16.3166 10.0976 15.6834 10.0976 15.2929 9.70711L13 7.41421V19C13 19.5523 12.5523 20 12 20C11.4477 20 11 19.5523 11 19V7.41421L8.70711 9.70711C8.31658 10.0976 7.68342 10.0976 7.29289 9.70711C6.90237 9.31658 6.90237 8.68342 7.29289 8.29289L11.2929 4.29289Z"/></svg>',command:"block.moveUp"},"move-down":{title:"## buttons.move-down ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 4C12.5523 4 13 4.44772 13 5V16.5858L15.2929 14.2929C15.6834 13.9024 16.3166 13.9024 16.7071 14.2929C17.0976 14.6834 17.0976 15.3166 16.7071 15.7071L12.7071 19.7071C12.3166 20.0976 11.6834 20.0976 11.2929 19.7071L7.29289 15.7071C6.90237 15.3166 6.90237 14.6834 7.29289 14.2929C7.68342 13.9024 8.31658 13.9024 8.70711 14.2929L11 16.5858V5C11 4.44772 11.4477 4 12 4Z"/></svg>',command:"block.moveDown"},list:{title:"## buttons.list ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 6C6 5.44772 5.55228 5 5 5C4.44772 5 4 5.44772 4 6V6.01C4 6.56228 4.44772 7.01 5 7.01C5.55228 7.01 6 6.56228 6 6.01V6ZM9 5C8.44772 5 8 5.44772 8 6C8 6.55228 8.44772 7 9 7H20C20.5523 7 21 6.55228 21 6C21 5.44772 20.5523 5 20 5H9ZM9 11C8.44772 11 8 11.4477 8 12C8 12.5523 8.44772 13 9 13H20C20.5523 13 21 12.5523 21 12C21 11.4477 20.5523 11 20 11H9ZM8 18C8 17.4477 8.44772 17 9 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H9C8.44772 19 8 18.5523 8 18ZM5 11C5.55228 11 6 11.4477 6 12V12.01C6 12.5623 5.55228 13.01 5 13.01C4.44772 13.01 4 12.5623 4 12.01V12C4 11.4477 4.44772 11 5 11ZM6 18C6 17.4477 5.55228 17 5 17C4.44772 17 4 17.4477 4 18V18.01C4 18.5623 4.44772 19.01 5 19.01C5.55228 19.01 6 18.5623 6 18.01V18Z"/></svg>',command:"list.popup"},numberedlist:{title:"## buttons.numbered-list ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.38267 3.07612C6.75635 3.2309 6.99999 3.59554 6.99999 4V10C6.99999 10.5523 6.55227 11 5.99999 11C5.44771 11 4.99999 10.5523 4.99999 10V6.41421L4.7071 6.70711C4.31657 7.09763 3.68341 7.09763 3.29288 6.70711C2.90236 6.31658 2.90236 5.68342 3.29288 5.29289L5.29288 3.29289C5.57888 3.00689 6.009 2.92134 6.38267 3.07612ZM9.99999 6C9.99999 5.44771 10.4477 5 11 5H20C20.5523 5 21 5.44771 21 6C21 6.55228 20.5523 7 20 7H11C10.4477 7 9.99999 6.55228 9.99999 6ZM9.99999 12C9.99999 11.4477 10.4477 11 11 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H11C10.4477 13 9.99999 12.5523 9.99999 12ZM5.99999 15C5.73477 15 5.48042 15.1054 5.29288 15.2929C5.10535 15.4804 4.99999 15.7348 4.99999 16C4.99999 16.5523 4.55227 17 3.99999 17C3.44771 17 2.99999 16.5523 2.99999 16C2.99999 15.2043 3.31606 14.4413 3.87867 13.8787C4.44128 13.3161 5.20434 13 5.99999 13C6.79564 13 7.5587 13.3161 8.12131 13.8787C8.68392 14.4413 8.99999 15.2043 8.99999 16C8.99999 16.6051 8.73548 17.0689 8.47379 17.402C8.28592 17.6411 8.03874 17.8824 7.84515 18.0714C7.79485 18.1205 7.74818 18.166 7.7071 18.2071C7.68572 18.2285 7.66339 18.2489 7.64017 18.2682L6.76204 19H7.99999C8.55228 19 8.99999 19.4477 8.99999 20C8.99999 20.5523 8.55228 21 7.99999 21H3.99999C3.57897 21 3.20304 20.7363 3.05972 20.3404C2.91639 19.9445 3.03637 19.5013 3.35981 19.2318L6.32564 16.7602C6.37812 16.7081 6.42975 16.6576 6.47777 16.6106L6.4872 16.6014C6.54925 16.5407 6.605 16.4861 6.65796 16.4328C6.76524 16.3249 6.84297 16.2404 6.90119 16.1663C6.95852 16.0933 6.98291 16.0478 6.99308 16.0238C7.00043 16.0064 7.00009 16.0014 7 16.0002C7 16.0001 6.99999 16.0001 6.99999 16C6.99999 15.7348 6.89463 15.4804 6.7071 15.2929C6.51956 15.1054 6.26521 15 5.99999 15ZM11 18C11 17.4477 11.4477 17 12 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H12C11.4477 19 11 18.5523 11 18Z"/></svg>',command:"format.set"},bulletlist:{title:"## buttons.bullet-list ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 6C6 5.44772 5.55228 5 5 5C4.44772 5 4 5.44772 4 6V6.01C4 6.56228 4.44772 7.01 5 7.01C5.55228 7.01 6 6.56228 6 6.01V6ZM9 5C8.44772 5 8 5.44772 8 6C8 6.55228 8.44772 7 9 7H20C20.5523 7 21 6.55228 21 6C21 5.44772 20.5523 5 20 5H9ZM9 11C8.44772 11 8 11.4477 8 12C8 12.5523 8.44772 13 9 13H20C20.5523 13 21 12.5523 21 12C21 11.4477 20.5523 11 20 11H9ZM8 18C8 17.4477 8.44772 17 9 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H9C8.44772 19 8 18.5523 8 18ZM5 11C5.55228 11 6 11.4477 6 12V12.01C6 12.5623 5.55228 13.01 5 13.01C4.44772 13.01 4 12.5623 4 12.01V12C4 11.4477 4.44772 11 5 11ZM6 18C6 17.4477 5.55228 17 5 17C4.44772 17 4 17.4477 4 18V18.01C4 18.5623 4.44772 19.01 5 19.01C5.55228 19.01 6 18.5623 6 18.01V18Z"/></svg>',command:"format.set"},indent:{title:"## buttons.indent ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 6C8 5.44772 8.44772 5 9 5H20C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7H9C8.44772 7 8 6.55228 8 6ZM3.29289 7.29289C3.68342 6.90237 4.31658 6.90237 4.70711 7.29289L8.70711 11.2929C9.09763 11.6834 9.09763 12.3166 8.70711 12.7071L4.70711 16.7071C4.31658 17.0976 3.68342 17.0976 3.29289 16.7071C2.90237 16.3166 2.90237 15.6834 3.29289 15.2929L6.58579 12L3.29289 8.70711C2.90237 8.31658 2.90237 7.68342 3.29289 7.29289ZM13 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H13C12.4477 13 12 12.5523 12 12C12 11.4477 12.4477 11 13 11ZM8 18C8 17.4477 8.44772 17 9 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H9C8.44772 19 8 18.5523 8 18Z"/></svg>',command:"list.indent"},outdent:{title:"## buttons.outdent ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 6C12 5.44772 12.4477 5 13 5H20C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7H13C12.4477 7 12 6.55228 12 6ZM8.70711 7.29289C9.09763 7.68342 9.09763 8.31658 8.70711 8.70711L5.41421 12L8.70711 15.2929C9.09763 15.6834 9.09763 16.3166 8.70711 16.7071C8.31658 17.0976 7.68342 17.0976 7.29289 16.7071L3.29289 12.7071C2.90237 12.3166 2.90237 11.6834 3.29289 11.2929L7.29289 7.29289C7.68342 6.90237 8.31658 6.90237 8.70711 7.29289ZM10 12C10 11.4477 10.4477 11 11 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H11C10.4477 13 10 12.5523 10 12ZM12 18C12 17.4477 12.4477 17 13 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H13C12.4477 19 12 18.5523 12 18Z"/></svg>',command:"list.outdent"},dlist:{title:"## buttons.definition-list ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5.5 5C5.36739 5 5.24021 5.05268 5.14645 5.14645C5.05268 5.24021 5 5.36739 5 5.5V7H6V5.5C6 5.36739 5.94732 5.24021 5.85355 5.14645C5.75979 5.05268 5.63261 5 5.5 5ZM8 5.5C8 4.83696 7.73661 4.20107 7.26777 3.73223C6.79893 3.26339 6.16304 3 5.5 3C4.83696 3 4.20107 3.26339 3.73223 3.73223C3.26339 4.20107 3 4.83696 3 5.5V10C3 10.5523 3.44772 11 4 11C4.55228 11 5 10.5523 5 10V9H6V10C6 10.5523 6.44772 11 7 11C7.55228 11 8 10.5523 8 10V5.5ZM10 6C10 5.44772 10.4477 5 11 5H20C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7H11C10.4477 7 10 6.55228 10 6ZM10 12C10 11.4477 10.4477 11 11 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H11C10.4477 13 10 12.5523 10 12ZM3 14C3 13.4477 3.44772 13 4 13H5.5C6.16304 13 6.79893 13.2634 7.26777 13.7322C7.73661 14.2011 8 14.837 8 15.5C8 16.044 7.82267 16.5698 7.50001 17C7.82267 17.4302 8 17.956 8 18.5C8 19.163 7.73661 19.7989 7.26777 20.2678C6.79893 20.7366 6.16304 21 5.5 21H4C3.44772 21 3 20.5523 3 20V14ZM5 18V19H5.5C5.63261 19 5.75978 18.9473 5.85355 18.8536C5.94732 18.7598 6 18.6326 6 18.5C6 18.3674 5.94732 18.2402 5.85355 18.1464C5.75978 18.0527 5.63261 18 5.5 18H5ZM5.5 16C5.63261 16 5.75978 15.9473 5.85355 15.8536C5.94732 15.7598 6 15.6326 6 15.5C6 15.3674 5.94732 15.2402 5.85355 15.1464C5.75979 15.0527 5.63261 15 5.5 15H5V16H5.5ZM10 18C10 17.4477 10.4477 17 11 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H11C10.4477 19 10 18.5523 10 18Z"/></svg>',command:"block.add"},hotkeys:{title:"## buttons.hotkeys ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3 8C3 7.44772 3.44772 7 4 7H20C20.5523 7 21 7.44772 21 8V16C21 16.5523 20.5523 17 20 17H4C3.44772 17 3 16.5523 3 16V8ZM4 5C2.34315 5 1 6.34315 1 8V16C1 17.6569 2.34315 19 4 19H20C21.6569 19 23 17.6569 23 16V8C23 6.34315 21.6569 5 20 5H4ZM7 14C7 13.4477 6.55228 13 6 13C5.44772 13 5 13.4477 5 14V14.01C5 14.5623 5.44772 15.01 6 15.01C6.55228 15.01 7 14.5623 7 14.01V14ZM6 9C6.55228 9 7 9.44772 7 10V10.01C7 10.5623 6.55228 11.01 6 11.01C5.44772 11.01 5 10.5623 5 10.01V10C5 9.44772 5.44772 9 6 9ZM11 10C11 9.44772 10.5523 9 10 9C9.44771 9 9 9.44772 9 10V10.01C9 10.5623 9.44771 11.01 10 11.01C10.5523 11.01 11 10.5623 11 10.01V10ZM14 9C14.5523 9 15 9.44772 15 10V10.01C15 10.5623 14.5523 11.01 14 11.01C13.4477 11.01 13 10.5623 13 10.01V10C13 9.44772 13.4477 9 14 9ZM19 10C19 9.44772 18.5523 9 18 9C17.4477 9 17 9.44772 17 10V10.01C17 10.5623 17.4477 11.01 18 11.01C18.5523 11.01 19 10.5623 19 10.01V10ZM18 13C18.5523 13 19 13.4477 19 14V14.01C19 14.5623 18.5523 15.01 18 15.01C17.4477 15.01 17 14.5623 17 14.01V14C17 13.4477 17.4477 13 18 13ZM10 13C9.44771 13 9 13.4477 9 14C9 14.5523 9.44771 15 10 15H14C14.5523 15 15 14.5523 15 14C15 13.4477 14.5523 13 14 13H10Z"/></svg>',command:"hotkeys.popup"},undo:{title:"## buttons.undo ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.70711 4.29289C10.0976 4.68342 10.0976 5.31658 9.70711 5.70711L7.41421 8H16C17.3261 8 18.5979 8.52678 19.5355 9.46447C20.4732 10.4021 21 11.6739 21 13C21 14.3261 20.4732 15.5979 19.5355 16.5355C18.5979 17.4732 17.3261 18 16 18H15C14.4477 18 14 17.5523 14 17C14 16.4477 14.4477 16 15 16H16C16.7956 16 17.5587 15.6839 18.1213 15.1213C18.6839 14.5587 19 13.7956 19 13C19 12.2044 18.6839 11.4413 18.1213 10.8787C17.5587 10.3161 16.7956 10 16 10H7.41421L9.70711 12.2929C10.0976 12.6834 10.0976 13.3166 9.70711 13.7071C9.31658 14.0976 8.68342 14.0976 8.29289 13.7071L4.29329 9.7075C4.29316 9.70737 4.29303 9.70724 4.29289 9.70711C4.29219 9.7064 4.29148 9.70569 4.29078 9.70498C4.19595 9.6096 4.12432 9.49986 4.07588 9.38278C4.02699 9.26488 4 9.13559 4 9C4 8.86441 4.02699 8.73512 4.07588 8.61722C4.12468 8.49927 4.19702 8.38877 4.29289 8.29289L8.29289 4.29289C8.68342 3.90237 9.31658 3.90237 9.70711 4.29289Z"/></svg>',command:"state.undo"},redo:{title:"## buttons.redo ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M15.2929 4.29289C14.9024 4.68342 14.9024 5.31658 15.2929 5.70711L17.5858 8H9C7.67392 8 6.40215 8.52678 5.46447 9.46447C4.52678 10.4021 4 11.6739 4 13C4 14.3261 4.52678 15.5979 5.46447 16.5355C6.40215 17.4732 7.67392 18 9 18H10C10.5523 18 11 17.5523 11 17C11 16.4477 10.5523 16 10 16H9C8.20435 16 7.44129 15.6839 6.87868 15.1213C6.31607 14.5587 6 13.7956 6 13C6 12.2044 6.31607 11.4413 6.87868 10.8787C7.44129 10.3161 8.20435 10 9 10H17.5858L15.2929 12.2929C14.9024 12.6834 14.9024 13.3166 15.2929 13.7071C15.6834 14.0976 16.3166 14.0976 16.7071 13.7071L20.7067 9.7075C20.7068 9.70737 20.707 9.70724 20.7071 9.70711C20.7078 9.7064 20.7085 9.70569 20.7092 9.70498C20.804 9.6096 20.8757 9.49986 20.9241 9.38278C20.973 9.26488 21 9.13559 21 9C21 8.86441 20.973 8.73512 20.9241 8.61722C20.8753 8.49927 20.803 8.38877 20.7071 8.29289L16.7071 4.29289C16.3166 3.90237 15.6834 3.90237 15.2929 4.29289Z"/></svg>',command:"state.redo"},toggle:{title:"## buttons.toggle ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M4 7C3.44772 7 3 7.44772 3 8C3 8.55228 3.44772 9 4 9H20C20.5523 9 21 8.55228 21 8C21 7.44772 20.5523 7 20 7H4ZM4 15C3.44772 15 3 15.4477 3 16C3 16.5523 3.44772 17 4 17H20C20.5523 17 21 16.5523 21 16C21 15.4477 20.5523 15 20 15H4Z"/></svg>',command:"control.popup"},duplicate:{title:"## buttons.duplicate ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 3C5.20435 3 4.44129 3.31607 3.87868 3.87868C3.31607 4.44129 3 5.20435 3 6V14C3 14.7956 3.31607 15.5587 3.87868 16.1213C4.44129 16.6839 5.20435 17 6 17H7V18C7 19.6569 8.34315 21 10 21H18C19.6569 21 21 19.6569 21 18V10C21 8.34315 19.6569 7 18 7H17V6C17 5.20435 16.6839 4.44129 16.1213 3.87868C15.5587 3.31607 14.7956 3 14 3H6ZM15 7V6C15 5.73478 14.8946 5.48043 14.7071 5.29289C14.5196 5.10536 14.2652 5 14 5H6C5.73478 5 5.48043 5.10536 5.29289 5.29289C5.10536 5.48043 5 5.73478 5 6V14C5 14.2652 5.10536 14.5196 5.29289 14.7071C5.48043 14.8946 5.73478 15 6 15H7V10C7 8.34315 8.34315 7 10 7H15ZM9 16V18C9 18.5523 9.44772 19 10 19H18C18.5523 19 19 18.5523 19 18V10C19 9.44772 18.5523 9 18 9H16H10C9.44772 9 9 9.44772 9 10V16Z"/></svg>',command:"block.duplicate"},trash:{title:"## buttons.delete ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M10 2C9.46957 2 8.96086 2.21071 8.58579 2.58579C8.21071 2.96086 8 3.46957 8 4V6H5.01218H4.99004H4C3.44772 6 3 6.44772 3 7C3 7.55229 3.44772 8 4 8H4.07986L5.00034 19.0458C5.01222 19.8249 5.32687 20.5695 5.87867 21.1213C6.44128 21.6839 7.20434 22 7.99999 22H16C16.7956 22 17.5587 21.6839 18.1213 21.1213C18.6731 20.5695 18.9878 19.8249 18.9996 19.0458L19.9201 8H20C20.5523 8 21 7.55229 21 7C21 6.44772 20.5523 6 20 6H19.0099H18.9878H16V4C16 3.46957 15.7893 2.96086 15.4142 2.58579C15.0391 2.21071 14.5304 2 14 2H10ZM14 6V4L10 4L10 6H14ZM9 8H6.08679L6.99654 18.9169C6.99884 18.9446 6.99999 18.9723 6.99999 19C6.99999 19.2652 7.10535 19.5196 7.29289 19.7071C7.48042 19.8946 7.73478 20 7.99999 20H16C16.2652 20 16.5196 19.8946 16.7071 19.7071C16.8946 19.5196 17 19.2652 17 19C17 18.9723 17.0011 18.9446 17.0034 18.9169L17.9132 8H15H9ZM10 10C10.5523 10 11 10.4477 11 11V17C11 17.5523 10.5523 18 10 18C9.44772 18 9 17.5523 9 17V11C9 10.4477 9.44772 10 10 10ZM15 11C15 10.4477 14.5523 10 14 10C13.4477 10 13 10.4477 13 11V17C13 17.5523 13.4477 18 14 18C14.5523 18 15 17.5523 15 17V11Z"/></svg>',danger:!0,command:"block.remove"},table:{title:"## buttons.table ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5 4C4.73478 4 4.48043 4.10536 4.29289 4.29289C4.10536 4.48043 4 4.73478 4 5V9H9V4H5ZM5 2C4.20435 2 3.44129 2.31607 2.87868 2.87868C2.31607 3.44129 2 4.20435 2 5V19C2 19.7957 2.31607 20.5587 2.87868 21.1213C3.44129 21.6839 4.20435 22 5 22H19C19.7957 22 20.5587 21.6839 21.1213 21.1213C21.6839 20.5587 22 19.7957 22 19V5C22 4.20435 21.6839 3.44129 21.1213 2.87868C20.5587 2.31607 19.7957 2 19 2H5ZM11 4V9H20V5C20 4.73478 19.8946 4.48043 19.7071 4.29289C19.5196 4.10536 19.2652 4 19 4H11ZM20 11H11V20H19C19.2652 20 19.5196 19.8946 19.7071 19.7071C19.8946 19.5196 20 19.2652 20 19V11ZM9 20V11H4V19C4 19.2652 4.10536 19.5196 4.29289 19.7071C4.48043 19.8946 4.73478 20 5 20H9Z"/></svg>',observer:"table.observe",command:"block.add"},"cell-setting":{title:"## table.cell-setting ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 3C6.55228 3 7 3.44772 7 4V7.17157C7.4179 7.31933 7.80192 7.55928 8.12132 7.87868C8.68393 8.44129 9 9.20435 9 10C9 10.7956 8.68393 11.5587 8.12132 12.1213C7.80192 12.4407 7.4179 12.6807 7 12.8284V20C7 20.5523 6.55228 21 6 21C5.44772 21 5 20.5523 5 20V12.8284C4.5821 12.6807 4.19808 12.4407 3.87868 12.1213C3.31607 11.5587 3 10.7956 3 10C3 9.20435 3.31607 8.44129 3.87868 7.87868C4.19808 7.55928 4.5821 7.31933 5 7.17157V4C5 3.44772 5.44772 3 6 3ZM12 3C12.5523 3 13 3.44772 13 4V13.1716C13.4179 13.3193 13.8019 13.5593 14.1213 13.8787C14.6839 14.4413 15 15.2043 15 16C15 16.7957 14.6839 17.5587 14.1213 18.1213C13.8019 18.4407 13.4179 18.6807 13 18.8284V20C13 20.5523 12.5523 21 12 21C11.4477 21 11 20.5523 11 20V18.8284C10.5821 18.6807 10.1981 18.4407 9.87868 18.1213C9.31607 17.5587 9 16.7957 9 16C9 15.2043 9.31607 14.4413 9.87868 13.8787C10.1981 13.5593 10.5821 13.3193 11 13.1716V4C11 3.44772 11.4477 3 12 3ZM18 3C18.5523 3 19 3.44772 19 4V4.17157C19.4179 4.31933 19.8019 4.55927 20.1213 4.87868C20.6839 5.44129 21 6.20435 21 7C21 7.79565 20.6839 8.55871 20.1213 9.12132C19.8019 9.44072 19.4179 9.68067 19 9.82843V20C19 20.5523 18.5523 21 18 21C17.4477 21 17 20.5523 17 20V9.82843C16.5821 9.68067 16.1981 9.44072 15.8787 9.12132C15.3161 8.55871 15 7.79565 15 7C15 6.20435 15.3161 5.44129 15.8787 4.87868C16.1981 4.55927 16.5821 4.31933 17 4.17157V4C17 3.44772 17.4477 3 18 3ZM18 6C17.7348 6 17.4804 6.10536 17.2929 6.29289C17.1054 6.48043 17 6.73478 17 7C17 7.26522 17.1054 7.51957 17.2929 7.70711C17.4804 7.89464 17.7348 8 18 8C18.2652 8 18.5196 7.89464 18.7071 7.70711C18.8946 7.51957 19 7.26522 19 7C19 6.73478 18.8946 6.48043 18.7071 6.29289C18.5196 6.10536 18.2652 6 18 6ZM6 9C5.73478 9 5.48043 9.10536 5.29289 9.29289C5.10536 9.48043 5 9.73478 5 10C5 10.2652 5.10536 10.5196 5.29289 10.7071C5.48043 10.8946 5.73478 11 6 11C6.26522 11 6.51957 10.8946 6.70711 10.7071C6.89464 10.5196 7 10.2652 7 10C7 9.73478 6.89464 9.48043 6.70711 9.29289C6.51957 9.10536 6.26522 9 6 9ZM12 15C11.7348 15 11.4804 15.1054 11.2929 15.2929C11.1054 15.4804 11 15.7348 11 16C11 16.2652 11.1054 16.5196 11.2929 16.7071C11.4804 16.8946 11.7348 17 12 17C12.2652 17 12.5196 16.8946 12.7071 16.7071C12.8946 16.5196 13 16.2652 13 16C13 15.7348 12.8946 15.4804 12.7071 15.2929C12.5196 15.1054 12.2652 15 12 15Z"/></svg>',command:"table.cellSetting"},embed:{title:"## buttons.embed ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6 6C5.73478 6 5.48043 6.10536 5.29289 6.29289C5.10536 6.48043 5 6.73478 5 7V11C5 11.2652 4.89464 11.5196 4.70711 11.7071L4.41421 12L4.70711 12.2929C4.89464 12.4804 5 12.7348 5 13V17C5 17.2652 5.10536 17.5196 5.29289 17.7071C5.48043 17.8946 5.73478 18 6 18C6.55228 18 7 18.4477 7 19C7 19.5523 6.55228 20 6 20C5.20435 20 4.44129 19.6839 3.87868 19.1213C3.31607 18.5587 3 17.7956 3 17V13.4142L2.29289 12.7071C1.90237 12.3166 1.90237 11.6834 2.29289 11.2929L3 10.5858V7C3 6.20435 3.31607 5.44129 3.87868 4.87868C4.44129 4.31607 5.20435 4 6 4C6.55228 4 7 4.44772 7 5C7 5.55228 6.55228 6 6 6ZM17 5C17 4.44772 17.4477 4 18 4C18.7956 4 19.5587 4.31607 20.1213 4.87868C20.6839 5.44129 21 6.20435 21 7V10.5858L21.7071 11.2929C22.0976 11.6834 22.0976 12.3166 21.7071 12.7071L21 13.4142V17C21 17.7957 20.6839 18.5587 20.1213 19.1213C19.5587 19.6839 18.7957 20 18 20C17.4477 20 17 19.5523 17 19C17 18.4477 17.4477 18 18 18C18.2652 18 18.5196 17.8946 18.7071 17.7071C18.8946 17.5196 19 17.2652 19 17V13C19 12.7348 19.1054 12.4804 19.2929 12.2929L19.5858 12L19.2929 11.7071C19.1054 11.5196 19 11.2652 19 11V7C19 6.73478 18.8946 6.48043 18.7071 6.29289C18.5196 6.10536 18.2652 6 18 6C17.4477 6 17 5.55228 17 5ZM12 8C12.5523 8 13 8.44772 13 9V11H15C15.5523 11 16 11.4477 16 12C16 12.5523 15.5523 13 15 13H13V15C13 15.5523 12.5523 16 12 16C11.4477 16 11 15.5523 11 15V13H9C8.44772 13 8 12.5523 8 12C8 11.4477 8.44772 11 9 11H11V9C11 8.44772 11.4477 8 12 8Z"/></svg>',observer:"embed.observe",command:"embed.popup"},quote:{title:"## buttons.quote ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.58579 5.58579C4.96086 5.21071 5.46957 5 6 5H9C9.53043 5 10.0391 5.21071 10.4142 5.58579C10.7893 5.96086 11 6.46957 11 7V13C11 14.5025 10.6219 15.8236 9.78098 16.8747C8.94259 17.9227 7.72684 18.5989 6.24262 18.9701C5.70684 19.1041 5.16387 18.7784 5.02988 18.2426C4.89588 17.7068 5.2216 17.1639 5.75738 17.0299C6.94016 16.7341 7.72441 16.2438 8.21927 15.6253C8.7116 15.0099 9 14.1645 9 13V12H6C5.46957 12 4.96086 11.7893 4.58579 11.4142C4.21071 11.0391 4 10.5304 4 10V7C4 6.46957 4.21071 5.96086 4.58579 5.58579ZM9 10V7L6 7L6 10H9ZM13.5858 5.58579C13.9609 5.21071 14.4696 5 15 5H18C18.5304 5 19.0391 5.21071 19.4142 5.58579C19.7893 5.96086 20 6.46957 20 7V13C20 14.5025 19.6219 15.8236 18.781 16.8747C17.9426 17.9227 16.7268 18.5989 15.2426 18.9701C14.7068 19.1041 14.1639 18.7784 14.0299 18.2426C13.8959 17.7068 14.2216 17.1639 14.7574 17.0299C15.9402 16.7341 16.7244 16.2438 17.2193 15.6253C17.7116 15.0099 18 14.1645 18 13V12H15C14.4696 12 13.9609 11.7893 13.5858 11.4142C13.2107 11.0391 13 10.5304 13 10V7C13 6.46957 13.2107 5.96086 13.5858 5.58579ZM18 10L18 7H15V10H18Z"/></svg>',command:"format.set"},layout:{title:"## buttons.layout ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2.58579 2.58579C2.96086 2.21071 3.46957 2 4 2H20C20.5304 2 21.0391 2.21071 21.4142 2.58579C21.7893 2.96086 22 3.46957 22 4V20C22 20.5304 21.7893 21.0391 21.4142 21.4142C21.0391 21.7893 20.5304 22 20 22H4C3.46957 22 2.96086 21.7893 2.58579 21.4142C2.21071 21.0391 2 20.5304 2 20V4C2 3.46957 2.21071 2.96086 2.58579 2.58579ZM13 20H20V4H13V20ZM11 4V20H4V4H11Z"/></svg>',command:"layout.popup"},wrapper:{title:"## buttons.wrapper ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5 6C4.73478 6 4.48043 6.10536 4.29289 6.29289C4.10536 6.48043 4 6.73478 4 7V17C4 17.2652 4.10536 17.5196 4.29289 17.7071C4.48043 17.8946 4.73478 18 5 18H19C19.2652 18 19.5196 17.8946 19.7071 17.7071C19.8946 17.5196 20 17.2652 20 17V7C20 6.73478 19.8946 6.48043 19.7071 6.29289C19.5196 6.10536 19.2652 6 19 6H5ZM2.87868 4.87868C3.44129 4.31607 4.20435 4 5 4H19C19.7957 4 20.5587 4.31607 21.1213 4.87868C21.6839 5.44129 22 6.20435 22 7V17C22 17.7957 21.6839 18.5587 21.1213 19.1213C20.5587 19.6839 19.7957 20 19 20H5C4.20435 20 3.44129 19.6839 2.87868 19.1213C2.31607 18.5587 2 17.7956 2 17V7C2 6.20435 2.31607 5.44129 2.87868 4.87868Z"/></svg>',command:"block.add"},todo:{title:"## buttons.todo ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.79289 3.79289C7.18342 3.40237 7.81658 3.40237 8.20711 3.79289C8.59763 4.18342 8.59763 4.81658 8.20711 5.20711L5.70711 7.70711C5.31658 8.09763 4.68342 8.09763 4.29289 7.70711L2.79289 6.20711C2.40237 5.81658 2.40237 5.18342 2.79289 4.79289C3.18342 4.40237 3.81658 4.40237 4.20711 4.79289L5 5.58579L6.79289 3.79289ZM10 6C10 5.44772 10.4477 5 11 5H20C20.5523 5 21 5.44772 21 6C21 6.55228 20.5523 7 20 7H11C10.4477 7 10 6.55228 10 6ZM8.20711 9.79289C8.59763 10.1834 8.59763 10.8166 8.20711 11.2071L5.70711 13.7071C5.31658 14.0976 4.68342 14.0976 4.29289 13.7071L2.79289 12.2071C2.40237 11.8166 2.40237 11.1834 2.79289 10.7929C3.18342 10.4024 3.81658 10.4024 4.20711 10.7929L5 11.5858L6.79289 9.79289C7.18342 9.40237 7.81658 9.40237 8.20711 9.79289ZM10 12C10 11.4477 10.4477 11 11 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H11C10.4477 13 10 12.5523 10 12ZM8.20711 15.7929C8.59763 16.1834 8.59763 16.8166 8.20711 17.2071L5.70711 19.7071C5.31658 20.0976 4.68342 20.0976 4.29289 19.7071L2.79289 18.2071C2.40237 17.8166 2.40237 17.1834 2.79289 16.7929C3.18342 16.4024 3.81658 16.4024 4.20711 16.7929L5 17.5858L6.79289 15.7929C7.18342 15.4024 7.81658 15.4024 8.20711 15.7929ZM10 18C10 17.4477 10.4477 17 11 17H20C20.5523 17 21 17.4477 21 18C21 18.5523 20.5523 19 20 19H11C10.4477 19 10 18.5523 10 18Z"/></svg>',command:"format.set"},pre:{title:"## buttons.code-snippet ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.2425 3.02986C14.7783 3.16381 15.1041 3.70674 14.9701 4.24254L10.9701 20.2425C10.8362 20.7783 10.2933 21.1041 9.75746 20.9701C9.22167 20.8362 8.89591 20.2933 9.02986 19.7575L13.0299 3.75746C13.1638 3.22167 13.7067 2.89591 14.2425 3.02986ZM7.70711 7.29289C8.09763 7.68342 8.09763 8.31658 7.70711 8.70711L4.41421 12L7.70711 15.2929C8.09763 15.6834 8.09763 16.3166 7.70711 16.7071C7.31658 17.0976 6.68342 17.0976 6.29289 16.7071L2.29289 12.7071C1.90237 12.3166 1.90237 11.6834 2.29289 11.2929L6.29289 7.29289C6.68342 6.90237 7.31658 6.90237 7.70711 7.29289ZM16.2929 7.29289C16.6834 6.90237 17.3166 6.90237 17.7071 7.29289L21.7071 11.2929C22.0976 11.6834 22.0976 12.3166 21.7071 12.7071L17.7071 16.7071C17.3166 17.0976 16.6834 17.0976 16.2929 16.7071C15.9024 16.3166 15.9024 15.6834 16.2929 15.2929L19.5858 12L16.2929 8.70711C15.9024 8.31658 15.9024 7.68342 16.2929 7.29289Z"/></svg>',command:"block.add"},line:{title:"## buttons.line ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M3 12C3 11.4477 3.44772 11 4 11H20C20.5523 11 21 11.4477 21 12C21 12.5523 20.5523 13 20 13H4C3.44772 13 3 12.5523 3 12Z"/></svg>',command:"block.add"},parent:{title:"## buttons.parent ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 6H16C16.5523 6 17 6.44772 17 7C17 7.55228 16.5523 8 16 8H9.41421L17.7071 16.2929C18.0976 16.6834 18.0976 17.3166 17.7071 17.7071C17.3166 18.0976 16.6834 18.0976 16.2929 17.7071L8 9.41421V16C8 16.5523 7.55228 17 7 17C6.44772 17 6 16.5523 6 16V7C6 6.44772 6.44772 6 7 6Z"/></svg>',command:"block.setParent"},code:{title:"## buttons.code ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M14.2425 3.02986C14.7783 3.16381 15.1041 3.70674 14.9701 4.24254L10.9701 20.2425C10.8362 20.7783 10.2933 21.1041 9.75746 20.9701C9.22167 20.8362 8.89591 20.2933 9.02986 19.7575L13.0299 3.75746C13.1638 3.22167 13.7067 2.89591 14.2425 3.02986ZM7.70711 7.29289C8.09763 7.68342 8.09763 8.31658 7.70711 8.70711L4.41421 12L7.70711 15.2929C8.09763 15.6834 8.09763 16.3166 7.70711 16.7071C7.31658 17.0976 6.68342 17.0976 6.29289 16.7071L2.29289 12.7071C1.90237 12.3166 1.90237 11.6834 2.29289 11.2929L6.29289 7.29289C6.68342 6.90237 7.31658 6.90237 7.70711 7.29289ZM16.2929 7.29289C16.6834 6.90237 17.3166 6.90237 17.7071 7.29289L21.7071 11.2929C22.0976 11.6834 22.0976 12.3166 21.7071 12.7071L17.7071 16.7071C17.3166 17.0976 16.6834 17.0976 16.2929 16.7071C15.9024 16.3166 15.9024 15.6834 16.2929 15.2929L19.5858 12L16.2929 8.70711C15.9024 8.31658 15.9024 7.68342 16.2929 7.29289Z"/></svg>',command:"inline.set",params:{tag:"code"}},underline:{title:"## buttons.underline ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7 4C7.55228 4 8 4.44772 8 5V10C8 11.0609 8.42143 12.0783 9.17157 12.8284C9.92172 13.5786 10.9391 14 12 14C13.0609 14 14.0783 13.5786 14.8284 12.8284C15.5786 12.0783 16 11.0609 16 10V5C16 4.44772 16.4477 4 17 4C17.5523 4 18 4.44772 18 5V10C18 11.5913 17.3679 13.1174 16.2426 14.2426C15.1174 15.3679 13.5913 16 12 16C10.4087 16 8.88258 15.3679 7.75736 14.2426C6.63214 13.1174 6 11.5913 6 10V5C6 4.44772 6.44772 4 7 4ZM4 19C4 18.4477 4.44772 18 5 18H19C19.5523 18 20 18.4477 20 19C20 19.5523 19.5523 20 19 20H5C4.44772 20 4 19.5523 4 19Z"/></svg>',command:"inline.set",params:{tag:"u"}},highlight:{title:"## buttons.highlight ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7929 3.79289C13.5109 3.07492 14.4846 2.67157 15.5 2.67157C16.5154 2.67157 17.4891 3.07492 18.2071 3.79289C18.9251 4.51086 19.3284 5.48464 19.3284 6.5C19.3284 7.51536 18.9251 8.48913 18.2071 9.2071L17.2085 10.2057C17.2081 10.2061 17.2076 10.2066 17.2071 10.2071C17.2066 10.2076 17.2061 10.2081 17.2057 10.2085L9.20854 18.2057C9.20807 18.2061 9.20759 18.2066 9.20711 18.2071C9.20663 18.2076 9.20615 18.2081 9.20567 18.2085L7.70711 19.7071C7.51957 19.8946 7.26522 20 7 20H3C2.44772 20 2 19.5523 2 19V15C2 14.7348 2.10536 14.4804 2.29289 14.2929L12.7929 3.79289ZM12.5 6.91421L5.91421 13.5L8.5 16.0858L15.0858 9.5L12.5 6.91421ZM16.5 8.08579L13.9142 5.5L14.2071 5.2071C14.55 4.86421 15.0151 4.67157 15.5 4.67157C15.9849 4.67157 16.45 4.86421 16.7929 5.2071C17.1358 5.55 17.3284 6.01507 17.3284 6.5C17.3284 6.98493 17.1358 7.44999 16.7929 7.79289L16.5 8.08579ZM7.08579 17.5L4.5 14.9142L4 15.4142V18H6.58579L7.08579 17.5ZM16.2929 14.2929C16.4804 14.1054 16.7348 14 17 14H21C21.5523 14 22 14.4477 22 15V19C22 19.5523 21.5523 20 21 20H13C12.5955 20 12.2309 19.7564 12.0761 19.3827C11.9213 19.009 12.0069 18.5789 12.2929 18.2929L16.2929 14.2929ZM20 16H17.4142L15.4142 18H20V16Z"/></svg>',command:"inline.set",params:{tag:"mark"}},sup:{title:"## buttons.superscript ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M17.9565 3.09068C18.7281 2.88025 19.5517 2.98495 20.2461 3.38175C20.5899 3.57822 20.8917 3.8405 21.1342 4.1536C21.3767 4.4667 21.5551 4.82449 21.6593 5.20655C21.7635 5.5886 21.7914 5.98744 21.7415 6.38029C21.6915 6.77313 21.5647 7.1523 21.3682 7.49613C21.3352 7.55397 21.2964 7.60836 21.2526 7.6585L19.2037 9.99999H21C21.5523 9.99999 22 10.4477 22 11C22 11.5523 21.5523 12 21 12H17C16.6076 12 16.2515 11.7705 16.0893 11.4132C15.9272 11.0559 15.989 10.6368 16.2474 10.3415L19.6701 6.42985C19.7146 6.33455 19.7441 6.23275 19.7574 6.12807C19.7743 5.99576 19.7648 5.86144 19.7298 5.73278C19.6947 5.60411 19.6346 5.48362 19.5529 5.37818C19.4713 5.27273 19.3696 5.1844 19.2538 5.11824C19.02 4.9846 18.7426 4.94934 18.4828 5.02021C18.2229 5.09108 18.0019 5.26227 17.8682 5.49613C17.5942 5.97565 16.9834 6.14225 16.5038 5.86824C16.0243 5.59423 15.8577 4.98337 16.1317 4.50385C16.5285 3.80945 17.1849 3.30112 17.9565 3.09068ZM4.37528 6.21913C4.80654 5.87412 5.43584 5.94404 5.78084 6.3753L8.99998 10.3992L12.2191 6.3753C12.5641 5.94404 13.1934 5.87412 13.6247 6.21913C14.0559 6.56414 14.1259 7.19343 13.7808 7.62469L10.2806 12L13.7808 16.3753C14.1259 16.8066 14.0559 17.4359 13.6247 17.7809C13.1934 18.1259 12.5641 18.056 12.2191 17.6247L8.99998 13.6008L5.78084 17.6247C5.43584 18.056 4.80654 18.1259 4.37528 17.7809C3.94402 17.4359 3.8741 16.8066 4.21911 16.3753L7.71935 12L4.21911 7.62469C3.8741 7.19343 3.94402 6.56414 4.37528 6.21913Z"/></svg>',command:"inline.set",params:{tag:"sup"}},sub:{title:"## buttons.subscript ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M4.37528 6.21914C4.80654 5.87413 5.43584 5.94405 5.78084 6.37531L8.99998 10.3992L12.2191 6.37531C12.5641 5.94405 13.1934 5.87413 13.6247 6.21914C14.0559 6.56415 14.1259 7.19344 13.7808 7.6247L10.2806 12L13.7808 16.3753C14.1259 16.8066 14.0559 17.4359 13.6247 17.7809C13.1934 18.1259 12.5641 18.056 12.2191 17.6247L8.99998 13.6008L5.78084 17.6247C5.43584 18.056 4.80654 18.1259 4.37528 17.7809C3.94402 17.4359 3.8741 16.8066 4.21911 16.3753L7.71935 12L4.21911 7.6247C3.8741 7.19344 3.94402 6.56415 4.37528 6.21914ZM17.9565 12.0907C18.3386 11.9865 18.7374 11.9586 19.1303 12.0085C19.5231 12.0585 19.9023 12.1853 20.2461 12.3818C20.5899 12.5782 20.8917 12.8405 21.1342 13.1536C21.3767 13.4667 21.5551 13.8245 21.6593 14.2066C21.7635 14.5886 21.7914 14.9875 21.7415 15.3803C21.6915 15.7731 21.5647 16.1523 21.3682 16.4961C21.3352 16.554 21.2964 16.6084 21.2526 16.6585L19.2037 19H21C21.5523 19 22 19.4477 22 20C22 20.5523 21.5523 21 21 21H17C16.6076 21 16.2515 20.7705 16.0893 20.4132C15.9272 20.0559 15.989 19.6368 16.2474 19.3415L19.6701 15.4299C19.7146 15.3346 19.7441 15.2328 19.7574 15.1281C19.7743 14.9958 19.7648 14.8615 19.7298 14.7328C19.6947 14.6041 19.6346 14.4836 19.5529 14.3782C19.4713 14.2727 19.3696 14.1844 19.2538 14.1182C19.138 14.0521 19.0104 14.0094 18.878 13.9926C18.7457 13.9757 18.6114 13.9851 18.4828 14.0202C18.3541 14.0553 18.2336 14.1154 18.1282 14.1971C18.0227 14.2787 17.9344 14.3804 17.8682 14.4961C17.5942 14.9757 16.9834 15.1423 16.5038 14.8682C16.0243 14.5942 15.8577 13.9834 16.1317 13.5039C16.3282 13.16 16.5905 12.8583 16.9036 12.6158C17.2167 12.3733 17.5745 12.1949 17.9565 12.0907Z"/></svg>',command:"inline.set",params:{tag:"sub"}},removeinline:{title:"## buttons.clear-all-styles ##",position:"last",command:"inline.removeFormat"},heading:{title:"## buttons.heading ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 6C2 5.44772 2.44772 5 3 5H5C5.55228 5 6 5.44772 6 6C6 6.55228 5.55228 7 5 7V11H11V7C10.4477 7 10 6.55228 10 6C10 5.44772 10.4477 5 11 5H13C13.5523 5 14 5.44772 14 6C14 6.55228 13.5523 7 13 7V17C13.5523 17 14 17.4477 14 18C14 18.5523 13.5523 19 13 19H11C10.4477 19 10 18.5523 10 18C10 17.4477 10.4477 17 11 17V13H5V17C5.55228 17 6 17.4477 6 18C6 18.5523 5.55228 19 5 19H3C2.44772 19 2 18.5523 2 18C2 17.4477 2.44772 17 3 17V7C2.44772 7 2 6.55228 2 6ZM19.3827 9.07612C19.7564 9.2309 20 9.59554 20 10V18C20 18.5523 19.5523 19 19 19C18.4477 19 18 18.5523 18 18V12.4142L17.7071 12.7071C17.3166 13.0976 16.6834 13.0976 16.2929 12.7071C15.9024 12.3166 15.9024 11.6834 16.2929 11.2929L18.2929 9.29289C18.5789 9.0069 19.009 8.92134 19.3827 9.07612Z"/></svg>',command:"block.add"},text:{title:"## buttons.text ##",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M5 6C5 5.44772 5.44772 5 6 5H18C18.5523 5 19 5.44772 19 6C19 6.55228 18.5523 7 18 7H13V18C13 18.5523 12.5523 19 12 19C11.4477 19 11 18.5523 11 18V7H6C5.44772 7 5 6.55228 5 6Z"/></svg>',command:"format.set"},h1:{title:"## buttons.heading ## 1",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 6C2 5.44772 2.44772 5 3 5H5C5.55228 5 6 5.44772 6 6C6 6.55228 5.55228 7 5 7V11H11V7C10.4477 7 10 6.55228 10 6C10 5.44772 10.4477 5 11 5H13C13.5523 5 14 5.44772 14 6C14 6.55228 13.5523 7 13 7V17C13.5523 17 14 17.4477 14 18C14 18.5523 13.5523 19 13 19H11C10.4477 19 10 18.5523 10 18C10 17.4477 10.4477 17 11 17V13H5V17C5.55228 17 6 17.4477 6 18C6 18.5523 5.55228 19 5 19H3C2.44772 19 2 18.5523 2 18C2 17.4477 2.44772 17 3 17V7C2.44772 7 2 6.55228 2 6ZM19.3827 9.07612C19.7564 9.2309 20 9.59554 20 10V18C20 18.5523 19.5523 19 19 19C18.4477 19 18 18.5523 18 18V12.4142L17.7071 12.7071C17.3166 13.0976 16.6834 13.0976 16.2929 12.7071C15.9024 12.3166 15.9024 11.6834 16.2929 11.2929L18.2929 9.29289C18.5789 9.0069 19.009 8.92134 19.3827 9.07612Z"/></svg>',command:"format.set"},h2:{title:"## buttons.heading ## 2",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 6C2 5.44772 2.44772 5 3 5H5C5.55228 5 6 5.44772 6 6C6 6.55228 5.55228 7 5 7V11H11V7C10.4477 7 10 6.55228 10 6C10 5.44772 10.4477 5 11 5H13C13.5523 5 14 5.44772 14 6C14 6.55228 13.5523 7 13 7V17C13.5523 17 14 17.4477 14 18C14 18.5523 13.5523 19 13 19H11C10.4477 19 10 18.5523 10 18C10 17.4477 10.4477 17 11 17V13H5V17C5.55228 17 6 17.4477 6 18C6 18.5523 5.55228 19 5 19H3C2.44772 19 2 18.5523 2 18C2 17.4477 2.44772 17 3 17V7C2.44772 7 2 6.55228 2 6ZM19 11C18.7348 11 18.4804 11.1054 18.2929 11.2929C18.1054 11.4804 18 11.7348 18 12C18 12.5523 17.5523 13 17 13C16.4477 13 16 12.5523 16 12C16 11.2043 16.3161 10.4413 16.8787 9.87868C17.4413 9.31607 18.2043 9 19 9C19.7957 9 20.5587 9.31607 21.1213 9.87868C21.6839 10.4413 22 11.2043 22 12C22 12.5095 21.8269 12.9956 21.6442 13.3786C21.4547 13.776 21.2129 14.1483 20.9883 14.4523L20.9769 14.4674L19.0297 17.001H21C21.5523 17.001 22 17.4487 22 18.001C22 18.5533 21.5523 19.001 21 19.001H17C16.6191 19.001 16.2713 18.7846 16.103 18.443C15.9346 18.1013 15.975 17.6936 16.2071 17.3916L19.3851 13.2564C19.5575 13.0223 19.7216 12.7639 19.839 12.5176C19.9646 12.2544 20 12.0815 20 12C20 11.7348 19.8946 11.4804 19.7071 11.2929C19.5196 11.1054 19.2652 11 19 11Z"/></svg>',command:"format.set"},h3:{title:"## buttons.heading ## 3",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 6C2 5.44772 2.44772 5 3 5H5C5.55228 5 6 5.44772 6 6C6 6.55228 5.55228 7 5 7V11H11V7C10.4477 7 10 6.55228 10 6C10 5.44772 10.4477 5 11 5H13C13.5523 5 14 5.44772 14 6C14 6.55228 13.5523 7 13 7V17C13.5523 17 14 17.4477 14 18C14 18.5523 13.5523 19 13 19H11C10.4477 19 10 18.5523 10 18C10 17.4477 10.4477 17 11 17V13H5V17C5.55228 17 6 17.4477 6 18C6 18.5523 5.55228 19 5 19H3C2.44772 19 2 18.5523 2 18C2 17.4477 2.44772 17 3 17V7C2.44772 7 2 6.55228 2 6ZM17.8519 9.22836C18.4001 9.0013 19.0033 8.94189 19.5853 9.05764C20.1672 9.1734 20.7018 9.45912 21.1213 9.87868C21.5409 10.2982 21.8266 10.8328 21.9424 11.4147C22.0581 11.9967 21.9987 12.5999 21.7716 13.1481C21.6417 13.4618 21.4601 13.7495 21.2361 14C21.4601 14.2505 21.6417 14.5382 21.7716 14.8519C21.9987 15.4001 22.0581 16.0033 21.9424 16.5853C21.8266 17.1672 21.5409 17.7018 21.1213 18.1213C20.7018 18.5409 20.1672 18.8266 19.5853 18.9424C19.0033 19.0581 18.4001 18.9987 17.8519 18.7716C17.3038 18.5446 16.8352 18.1601 16.5056 17.6667C16.1759 17.1734 16 16.5933 16 16C16 15.4477 16.4477 15 17 15C17.5523 15 18 15.4477 18 16C18 16.1978 18.0586 16.3911 18.1685 16.5556C18.2784 16.72 18.4346 16.8482 18.6173 16.9239C18.8 16.9996 19.0011 17.0194 19.1951 16.9808C19.3891 16.9422 19.5673 16.847 19.7071 16.7071C19.847 16.5673 19.9422 16.3891 19.9808 16.1951C20.0194 16.0011 19.9996 15.8 19.9239 15.6173C19.8482 15.4346 19.72 15.2784 19.5556 15.1685C19.3911 15.0587 19.1978 15 19 15C18.4477 15 18 14.5523 18 14C18 13.4477 18.4477 13 19 13C19.1978 13 19.3911 12.9414 19.5556 12.8315C19.72 12.7216 19.8482 12.5654 19.9239 12.3827C19.9996 12.2 20.0194 11.9989 19.9808 11.8049C19.9422 11.6109 19.847 11.4327 19.7071 11.2929C19.5673 11.153 19.3891 11.0578 19.1951 11.0192C19.0011 10.9806 18.8 11.0004 18.6173 11.0761C18.4346 11.1518 18.2784 11.28 18.1685 11.4444C18.0586 11.6089 18 11.8022 18 12C18 12.5523 17.5523 13 17 13C16.4477 13 16 12.5523 16 12C16 11.4067 16.1759 10.8266 16.5056 10.3333C16.8352 9.83994 17.3038 9.45543 17.8519 9.22836Z"/></svg>',command:"format.set"},h4:{title:"## buttons.heading ## 4",icon:'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M2 6C2 5.44772 2.44772 5 3 5H5C5.55228 5 6 5.44772 6 6C6 6.55228 5.55228 7 5 7V11H11V7C10.4477 7 10 6.55228 10 6C10 5.44772 10.4477 5 11 5H13C13.5523 5 14 5.44772 14 6C14 6.55228 13.5523 7 13 7V17C13.5523 17 14 17.4477 14 18C14 18.5523 13.5523 19 13 19H11C10.4477 19 10 18.5523 10 18C10 17.4477 10.4477 17 11 17V13H5V17C5.55228 17 6 17.4477 6 18C6 18.5523 5.55228 19 5 19H3C2.44772 19 2 18.5523 2 18C2 17.4477 2.44772 17 3 17V7C2.44772 7 2 6.55228 2 6ZM20.2898 9.04291C20.7115 9.17061 21 9.55933 21 10V15C21.5523 15 22 15.4477 22 16C22 16.5523 21.5523 17 21 17V18C21 18.5523 20.5523 19 20 19C19.4477 19 19 18.5523 19 18V17H16C15.6312 17 15.2923 16.797 15.1183 16.4719C14.9443 16.1467 14.9634 15.7522 15.1679 15.4453L19.1679 9.4453C19.4124 9.07864 19.868 8.91521 20.2898 9.04291ZM19 15V13.3028L17.8685 15H19Z"/></svg>',command:"format.set"},h5:{title:"## buttons.heading ## 5",command:"format.set"},h6:{title:"## buttons.heading ## 6",command:"format.set"},address:{title:"## buttons.address ##",command:"format.set"}},nested:[],nestedValue:[],nonparse:[],inlineGroups:{},tags:{denied:["font","html","head","link","title","body","meta","applet","marquee"],incode:["!DOCTYPE","!doctype","html","head","link","title","body","meta","textarea","style"],form:["form","input","button","select","textarea","legend","fieldset"],inline:["a","svg","span","strong","strike","b","u","em","i","code","del","ins","samp","kbd","sup","sub","mark","var","cite","small","abbr"],block:["pre","hr","ul","ol","li","p","h1","h2","h3","h4","h5","h6","dl","dt","dd","div","table","tbody","thead","tfoot","tr","th","td","blockquote","output","figcaption","figure","address","main","section","header","footer","aside","article","iframe"],parser:["pre","hr","ul","ol","p","h1","h2","h3","h4","h5","h6","table","address","blockquote","figure","iframe","form","dl","div","section","header","footer","article","main","aside"]},regex:{mp4video:/https?:\/\/\S+\.mp4/gi,youtube:/^https?\:\/\/(?:www\.youtube(?:\-nocookie)?\.com\/|m\.youtube\.com\/|youtube\.com\/)?(?:ytscreeningroom\?vi?=|youtu\.be\/|vi?\/|live|user\/.+\/u\/\w{1,2}\/|embed\/|watch\?(?:.*\&)?vi?=|\&vi?=|\?(?:.*\&)?vi?=)([^#\&\?\n\/<>"']*)/gi,vimeo:/(http|https)?:\/\/(?:www.|player.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/(?:[^/]*)\/videos\/|album\/(?:\d+)\/video\/|video\/|)(\d+)(?:\/[a-zA-Z0-9_-]+)?/gi,imageurl:/((https?|www)[^\s]+\.)(jpe?g|png|gif)(\?[^\s-]+)?/gi,aurl1:/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,aurl2:/(^|[^\/])(www\.[\S]+(\b|$))/gim}},o.lang.en={accessibility:{"help-label":"Rich text editor"},placeholders:{figcaption:"Type caption (optional)"},modal:{link:"Link",image:"Image","add-image":"Add Image"},embed:{embed:"Embed",title:"Title",poster:"Poster image",caption:"Caption",description:"Paste any embed/html code or enter the url (vimeo or youtube video only)","responsive-video":"Responsive video"},image:{or:"or","alt-text":"Alt Text",link:"Link",width:"Width",caption:"Caption","link-in-new-tab":"Open link in new tab","url-placeholder":"Paste url of image...","upload-new-placeholder":"Drag to upload a new image<br>or click to select"},link:{link:"Link","edit-link":"Edit Link",unlink:"Unlink","link-in-new-tab":"Open link in new tab",text:"Text",url:"URL"},table:{width:"Width (px or %)",nowrap:"Nowrap","table-cell":"Table cell","select-table":"Select table","select-cell":"Select cell","cell-setting":"Cell setting","add-head":"Add head","remove-head":"Remove head","add-row-below":"Add row below","add-row-above":"Add row above","remove-row":"Remove row","add-column-after":"Add column after","add-column-before":"Add column before","remove-column":"Remove column","delete-table":"Delete table"},buttons:{add:"Add",insert:"Insert",save:"Save",cancel:"Cancel",delete:"Delete","ai-tools":"AI Tools","ai-image":"AI Image",html:"HTML",format:"Format",bold:"Bold",italic:"Italic",deleted:"Deleted","more-formatting":"More formatting",link:"Link","link-text":"Link Text",unlink:"Unlink",image:"Image",unwrap:"Unwrap",outset:"Outset","wrap-image":"Wrap image","move-up":"Move up","move-down":"Move down",list:"List","numbered-list":"Numbered list","bullet-list":"Bullet list",indent:"Indent",outdent:"Outdent","definition-list":"Definition list",hotkeys:"Hotkeys",undo:"Undo",redo:"Redo",toggle:"Toggle",duplicate:"Duplicate",delete:"Delete",table:"Table",embed:"Embed",quote:"Quote",layout:"Layout",wrapper:"Wrapper",todo:"Todo","code-snippet":"Code snippet",line:"Line",parent:"Parent",code:"Code",underline:"Underline",highlight:"Highlight",superscript:"Superscript",subscript:"Subscript","clear-all-styles":"Clear all styles",heading:"Heading",text:"Text",address:"Address"},colorpicker:{"remove-color":"Remove color","remove-background":"Remove background color",color:"Color",background:"Background","set-color":"Set color"},pathbar:{title:"Body"},layout:{"select-layout":"Select layout","select-column":"Select column","single-column":"Single column","two-columns":"Two columns","three-columns":"Three columns","four-columns":"Four columns"},outset:{"outset-none":"Outset none","outset-left":"Outset left","outset-both":"Outset both","outset-right":"Outset right"},wrap:{"wrap-none":"Wrap none","wrap-left":"Wrap left","wrap-center":"Wrap center","wrap-right":"Wrap right"},blocks:{address:"Address",cell:"Cell",column:"Column",dlist:"Definition List",embed:"Embed",figcaption:"Figcaption",heading:"Heading",image:"Image",wrapper:"Wrapper",layout:"Layout",line:"Line",list:"List",listitem:"Item",noneditable:"Noneditable",pre:"Pre",quote:"Quote",row:"Row",table:"Table",text:"Text",todo:"Todo",todoitem:"Item",mergetag:"Mergetag"},hotkeys:{"meta-shift-a":"Select text in the block","meta-a":"Select all blocks","meta-z":"Undo","meta-shift-z":"Redo","meta-shift-m":"Remove inline format","meta-b":"Bold","meta-i":"Italic","meta-u":"Underline","meta-h":"Superscript","meta-l":"Subscript","meta-k":"Link","meta-alt-0":"Normal text","meta-alt-1":"Heading 1","meta-alt-2":"Heading 2","meta-alt-3":"Heading 3","meta-alt-4":"Heading 4","meta-alt-5":"Heading 5","meta-alt-6":"Heading 6","meta-shift-7":"Ordered List","meta-shift-8":"Unordered List","meta-indent":"Indent","meta-outdent":"Outdent","meta-shift-backspace":"Delete block","meta-shift-o":"Add block","meta-shift-d":"Duplicate block","meta-shift-up":"Move line up","meta-shift-down":"Move line down"}};class n{constructor(t,e={},s=0){this.ajax=o.ajax,this.dom=o.dom,this.uuid=s,this.$win=this.dom(window),this.$doc=this.dom(document),this.$body=this.dom("body"),this.keycodes=o.keycodes,this.element=new l(t),this.app=this,this.disableMode=!1,this.readonlyMode=!1,this._core=["ajax","dom","uuid","keycodes","element","page","config","loc"],this._modules={container:v,source:k,editor:$,event:D,codemirror:z,placeholder:Z,block:rt,blocks:ot,sync:dt,observer:ct,scroll:gt,autosave:ut,format:nt,inline:mt,state:bt,progress:ft,hotkeys:vt,image:_t,embed:Ct,layout:kt,list:xt,link:yt,table:wt,ui:W,toolbar:q,extrabar:K,addbar:Q,context:G,control:Y,path:X,statusbar:tt,dropdown:et,modal:st,panel:it,command:at},this._plugins=[],this._props={},this._mode="default",this.started=!1,this.loaded=!1,this._start(e)}start(t={}){this._start(t)}stop(){this.isStopped()||(this.eventBus.emit("app.before.stop"),this._iterate("stop"),this._iterate2("stop"),this.element.showElement(),this._plugins=[],this.started=!1,this.eventBus.emit("app.stop"),this.config.get("clicktoedit")&&(this.eventBus=new N(this),this._waitForClickToEdit()))}enable(){this.editor.enable(),this.ui.enable(),this.disableMode=!1}editable(){this.editor.editable(),this.ui.enable(),this.readonlyMode=!1}disable(){this.editor.disable(),this._disable(),this.disableMode=!0}readonly(){this.editor.readonly(),this._disable(),this.readonlyMode=!0}api(t,...e){if(!t)return;const s=t.split("."),i=s.pop();let a=this;for(const t of s){if(void 0===a[t])return;a=a[t]}return"function"==typeof a[i]?a[i](...e):void 0}create(t,...e){let[s,i]=t.includes(".")?t.split("."):["class",t],a=o.mapping[s]?.[i];if(!a){if("block"!==s)throw new Error(`The ${s} "${i}" does not exist.`);console.warn(`${s} "${i}" not found`),i="wrapper",a=o.mapping.block[i]}const r=new a.proto;Object.assign(r,{_name:i,app:this,uuid:this.uuid,eventBus:this.eventBus,dom:this.dom,ajax:this.ajax,$win:this.$win,$doc:this.$doc,$body:this.$body,lang:this.lang,opts:this.opts});const n=r.init?.(...e);return n||r}destroy(){this.sync.destroy(),this.stop(),this.eventBus.emit("app.destroy"),this.element.dataset(o.namespace,!1),this._clearInstance()}on(t,e){this.eventBus.on(t,e)}broadcast(t,e){return this.eventBus.emit(t,e)}broadcastHtml(t,e){return this.eventBus.emitHtml(t,e)}has(t){return this[t]||this._plugins[t]}isStarted(){return this.started}isStopped(){return!this.started}isDisabled(){return this.disableMode}isReadonly(){return this.readonlyMode}isMode(t){return this._mode===t}isProp(t){return this.getProp(t)}setMode(t){this._mode=t}setProp(t,e){this._props[t]=e}getLayout(){return!!this.editor&&this.editor.getLayout()}getEditor(){return!!this.editor&&this.editor.getEditor()}getMode(){return this._mode}getProp(t){return this._props[t]}removeProp(t){delete this._props[t]}_start(t={}){this._initializeConfig(t),this._initializeCoreComponents(),this._initModes(),this.config.is("clicktoedit")?this._waitForClickToEdit():this._init()}_disable(){this.source.close(),this.ui.disable(),this.ui.close(),this.block.unset(),this.blocks.unset(),this.app.create("selection").remove()}_initModes(){this.config.is("nocontainer")&&this.config.extend(this.config.get("modes.nocontainer")),this.config.is("css")&&this.setMode("iframe")}_initializeConfig(t){this.config=new x(this,t),this.opts=this.config}_initializeCoreComponents(){this.loc=new w(this,this.config.get("lang")),this.lang=this.loc,this.eventBus=new N(this),this.page=new y(this)}_waitForClickToEdit(){this.element.one("click.rx-clicktoedit",(()=>{let t=this.create("marker");this.eventBus.emit("clicktoedit.before.start"),t.save(!0),this._init(),t.restore(),this.editor.click(),this.eventBus.emit("clicktoedit.start"),this.editor.setBlurOther()}))}_init(){this._bindEventsFromConfig(),this.eventBus.emit("app.before.start"),this.element.hideElement(),Object.keys(this._modules).forEach((t=>{this[t]=new this._modules[t](this)})),this._injectDependencies(),this._iterate("init"),this._iterate2("init"),this._iterate("start"),this._iterate2("load"),this._iterate("load");let t=setInterval((()=>{this.loaded&&(clearInterval(t),this._iterate("loaded"))}),100);this.started=!0,this.eventBus.emit("app.start"),this.element.off("click.rx-clicktoedit"),this._buildReadonly(),this._buildDisabled()}_bindEventsFromConfig(){let t=this.config.get("events")||this.config.get("subscribe");if(t)for(const[e,s]of Object.entries(t)){e.split(" ").forEach((t=>{"function"==typeof s&&this.eventBus.on(t,s)}))}}_injectDependencies(){Object.keys(this._modules).forEach((t=>{this._core.forEach((e=>{this[t][e]=this[e]})),Object.keys(this._modules).forEach((e=>{t!==e&&(this[t][e]=this[e])}))}))}_iterate2(t){Object.keys(this._modules).forEach((e=>{const s=this[e],i=s?.[t];"function"==typeof i&&i.apply(s)}))}_iterate(t){if(void 0!==o.mapping.plugin){let e=this.opts.get("plugins");for(let s=0;s<e.length;s++){let i=e[s];void 0!==o.mapping.plugin[i]&&("init"===t&&this._plugins.push(i),this._iterateItem("plugin",i,t))}}}_iterateItem(t,e,s){"init"===s?this[e]=this.create(t+"."+e):this._call(this[e],s)}_call(t,e){"function"==typeof t[e]&&t[e].apply(t)}_buildDisabled(){this.disableMode=this.opts.get("disabled")||this.element.isDisabled(),this.disableMode&&this.disable()}_buildReadonly(){this.readonlyMode=this.opts.get("readonly")||this.element.isReadonly(),this.readonlyMode&&this.readonly()}_clearInstance(){let t=o.instances.indexOf(this.uuid);t>-1&&o.instances.splice(t,1)}}class l extends s{constructor(t){super(t)}isTextarea(){return this.tag("textarea")}isDisabled(){return null!==this.attr("disabled")}isReadonly(){return null!==this.attr("readonly")}hideElement(){this.isTextarea()&&this.addClass("rx-visually-hidden")}showElement(){this.isTextarea()&&this.removeClass("rx-visually-hidden")}setHtml(t){this.isTextarea()?this.val(t):this.html(t)}getHtml(){return this.isTextarea()?this.val():this.html()}getName(){return this.attr("name")}getPlaceholder(){return this.attr("placeholder")}}o.add("mixin","block",{commonDefaults:{uid:{getter:"getUid",setter:"setUid"},time:{getter:"getTime",setter:"setTime",trigger:"updateTime"},id:{getter:"getId",setter:"setId"},style:{getter:"getStyle",setter:"setStyle"},classname:{getter:"getClassname",setter:"setClassname"},attrs:{getter:"getAttrs",setter:"setAttrs"},placeholder:{getter:"getPlaceholder",setter:"setPlaceholder"},noneditable:{getter:"getNoneditable",setter:"setNoneditable"}},init(t,e,i){t instanceof s||t instanceof Element?(this.element=t,this.params=e):this.params=t,this.renderDataBlock=i,this.params=this.params?this.params:{},this.start&&this.start(),this.render()},render(){if(this._createData(this.params),this.element?(this.$block=this.dom(this.element),this.parse&&this.parse()):(this.element=this.create(),this.$block=this.element,this.build&&this.build()),this.data.build(),!1===this.renderDataBlock)return;let t=this.$block.attr("data-rx-attrs");t&&(t=t.replace(/'/g,'"'),this.setAttrs(JSON.parse(t)),this.$block.removeAttr("data-rx-attrs")),this._renderInlineBlocks(),this.$block.dataset("instance",this),this.$block.attr("data-rx-type",this.getType()),this.isInline()&&this.$block.attr("data-rx-inline",!0),this.isEditable()?this.$block.attr("contenteditable",!0):!1===this.isEditable()&&this.$block.attr("contenteditable",!1),(this.isNondeletable()||this.isNondeletableParent())&&this.$block.attr("contenteditable",!1),this.isFocusable()&&this.$block.attr("data-rx-focusable",!0)},trigger(t){let e=this._buildTriggers();for(let[t,s]of Object.entries(e)){1===s.trigger.split(".").length?this[s.trigger].apply(this):this.app.api(s.trigger,this)}},isAllowedButton(t,e){let s=e.blocks,i=this.getType();if(void 0===e.blocks)return!0;if(s.except&&-1!==s.except.indexOf(i))return!1;if(s.all){if(!0===s.all||"all"===s.all)return!0;if("editable"===s.all&&this.isEditable())return!0;if("first-level"===s.all&&this.isFirstLevel())return!0;if("noneditable"===s.all&&this.isType("noneditable"))return!0}return!(!Array.isArray(s.types)||-1===s.types.indexOf(i))},isFocusable(){return void 0!==this.props.focusable},isInline(){return this.props.inline},isEditable(){return this.props.editable},isNondeletable(){return this.$block.attr("data-noneditable")},isNondeletableParent(){return 0!==this.$block.closest("[data-noneditable=true]").length},isType(t){return-1!==(Array.isArray(t)?t:[t]).indexOf(this.props.type)},isFigure(){return"figure"===this.getTag()},isFirstLevel(){return this.$block.attr("data-rx-first-level")},isEmpty(t,e){return this._isEmpty(this.$block,t,e)},isParent(){return this.props.parent},isLastElement:()=>!0,isAllSelected(){if(this.isEditable()){return this.app.create("selection").isFullySelected(this.$block)}return!0},isCaretStart(){let t,e,s,i=this.app.create("caret"),a=this.app.create("selection");return this.isType(["list","todo"])?!a.is()||(t=a.getCurrent(),e=this.dom(t).closest("li"),s=e.prevElement(),0===s.length&&i.is(this.$block,"start")):!this.isEditable()||i.is(this.$block,"start")},isCaretEnd(){let t=this.app.create("caret");return this.isType("address")?t.is(this.$block,"end",!1,!0,!1):!this.isEditable()&&!this.isType(["todo","list"])||t.is(this.$block,"end")},isReorder(){return!1!==this.props.reorder},isContext(){return this.props.context},hasTime(){return this.$block.attr("data-time")},hasUid(){return this.$block.attr("data-uid")},findPreviousElement(){const t=this.app.editor.getLayout().get();let e=this.$block.get(),s=e.previousElementSibling;for(;!s&&e.parentElement;)e=e.parentElement,s=e.previousElementSibling;return s&&t.contains(s)?this.dom(s)?.dataget("instance"):null},findNextElement(){const t=this.app.editor.getLayout().get();let e=this.$block.get(),s=e.nextElementSibling;for(;!s&&e.parentElement;)e=e.parentElement,s=e.nextElementSibling;return s&&t.contains(s)?this.dom(s)?.dataget("instance"):null},getTitle(){let t=this.getType(),e=this.lang.get("blocks"),s=this.$block.attr("data-title");return s=void 0!==e[t]?e[t]:s,s=s||t.charAt(0).toUpperCase()+t.slice(1),s},getProp(t){return void 0!==this.props[t]?this.props[t]:null},getType(){return this.props.type},getTag(){return this.$block.tag()},getBlock(){return this.$block},getJson(){return this.data.getData(!0)},getOuterHtml(){return this.$block.outer()},getHtml(){return this.$block.html()},getPlainText(){return this._getPlainText(this.$block)},getOffset(){return this.$block.offset()},getFirstLevel(){let t=this.$block.closest("[data-rx-first-level]").last();return 0!==t.length&&t.dataget("instance")},getClosest(t){let e=this.$block.parent().closest(this._buildTraverseSelector(t));return 0!==e.length&&e.dataget("instance")},getNextParent(){let t=this.isType("todoitem")?this.getClosest(["todo"]):this.getClosest(["table","wrapper","layout"]),e=!1;return t&&(e=t.getNext()),e},getPrevParent(){let t=this.isType("todoitem")?this.getClosest(["todo"]):this.getClosest(["table","wrapper","layout"]),e=!1;return t&&(e=t.getPrev()),e},getParent(){let t,e=this.props.parent;return t=void 0!==e?this.$block.parent().closest(this._buildTraverseSelector(e)):this.$block.parent().closest("[data-rx-type]"),!(!t||0===t.length)&&t.dataget("instance")},getFirst(t){t=t?"="+t:"";let e=this.$block.find("[data-rx-type"+t+"]").first();return 0!==e.length&&e.dataget("instance")},getLast(t){t=t?"="+t:"";let e=this.$block.find("[data-rx-type"+t+"]").last();return 0!==e.length&&e.dataget("instance")},getNext(t){let e=this.$block.nextElement();return!(0===e.length||!e.is(this._buildTraverseSelector(t)))&&e.dataget("instance")},getPrev(t){let e=this.$block.prevElement();return!(0===e.length||!e.is(this._buildTraverseSelector(t)))&&e.dataget("instance")},getControl(){return!this.isInline()&&this.props.control},getToolbar(){return this.props.toolbar},getExtrabar(){return this.props.extrabar},getButtons(t){return this.props[t]},getPlaceholder(){return this.$block.attr("data-placeholder")},getId(){return this.$block.attr("id")},getStyle(){let t=this.$block.clone(),e=this.app.create("utils"),s=t.attr("style"),i=e.cssToObject(s);return this.isType("column")&&delete i["flex-basis"],0!==Object.keys(i).length?i:null},getAttrs(){let t={};if(this.params.attrs)for(let e of Object.keys(this.params.attrs))t[e]=this.$block.data(e);return 0!==Object.keys(t).length?t:null},getAttr(t){return this.params.attrs&&this.params.attrs[t]?this.params.attrs[t]:null},getClassname(t){let e,s=this.$block.clone();if(t){e="none";for(let[s,i]of Object.entries(t))this.$block.hasClass(i)&&(e=s);return e}return s.removeClass("rx-block-placeholder rx-block-focus rx-layout-grid rx-block-control-focus data-rx-parsed data-rx-first-level data-rx-inline data-rx-focusable"),e=s.attr("class"),""===e?null:e},getContent(){let t=this.$block.clone();return t=this.unparseInlineBlocks(t),t=this.unparseInlineStyle(t),t.html().trim()},getChildren(){let t,e=this.$block.children(),s=[];return e.each((function(e){t=e.dataget("instance"),t&&s.push(t.getJson())})),s},getUid(){return this.$block.attr("data-uid")},getTime(){let t=this.$block.attr("data-time");return!0===t||!1===t?null:t},getData(t){return this.data.getData(t)},getNoneditable(){return this.$block.data("noneditable")},get(t){return this.data.get(t)},set(t,e){this.data.set(t,e)},setData(t){this.data.setData(t)},setEmpty(t){if(this.isType("todoitem"))this.$content.html("");else{if(t){let t=this.$block.find(this.opts.get("tags.inline").join(",")).first();if(0!==t.length)return void t.html("")}this.$block.html("")}},setContent(t){this.$block.html(t)},setId(t){this._setAttr(this.$block,"id",t)},setStyle(t){let e=this.app.create("cleaner");this.$block.css(t),""===this.$block.attr("style")&&this.$block.removeAttr("style"),e.cacheElementStyle(this.$block)},setClassname(t,e){e&&this._removeObjClasses(e),"none"!==t&&this.$block.addClass(t)},setAttr(t,e){this.params.attrs=this.params.attrs||{},this.params.attrs[t]=e,this.$block.attr(t,e,!0)},setAttrs(t){if(t)for(let[e,s]of Object.entries(t))this.setAttr(e,s)},setUid(t){this._setAttr(this.$block,"data-uid",t)},setTime(t){this._setAttr(this.$block,"data-time",t)},setPlaceholder(t){this._setAttr(this.$block,"data-placeholder",t)},setCaret(t){this.app.create("caret").set(this.$block,t)},setNoneditable(t){this._setAttr(this.$block,"data-noneditable",t)},updateTime(){this.hasTime()&&this.setTime((new Date).getTime())},generateUid:()=>Date.now().toString(36)+Math.floor(Math.pow(10,12)+9*Math.random()*Math.pow(10,12)).toString(36),duplicate(t){let e=this.getType(),s=this.$block.clone();s.removeClass("rx-block-focus"),s.removeAttr("data-rx-type"),this._renderInsideClone(s),t&&s.html("");let i=this.app.create("block."+e,s);return this._renderInlineBlocks(i.getBlock(),!0),i},duplicateEmpty(){return this.duplicate(!0)},removeAttr(t){this.params.attrs&&this.params.attrs[t]&&delete this.params.attrs[t],this.$block.removeAttr(t)},removeData(t){this.data.remove(t)},removeCaption(){this.figcaption&&(this.$figcaption.remove(),this.figcaption=!1,this.$figcaption=!1)},remove(t){let e=this.getType(),s=!!this.isInline()&&this.getParent();(t=o.extend({},{traverse:!1,broadcast:!1},t)).traverse?this._removeTraverse():(this.$block.remove(),s&&this.app.block.set(s)),t.broadcast&&this.app.broadcast("block.remove",{type:e})},removeClasses(t){this._removeObjClasses(t)},insert(t){this._compositionCutting();let e=this.app.create("insertion"),s={instance:!1,position:"after",caret:!1,remove:!0,type:"add",current:this};t=o.extend({},s,t);let i=e.insert(t);return"add"===t.type&&this.app.broadcast("block.add",{inserted:i}),this._isIOS()&&i.getBlock().focus(),i},insertEmpty(t){return(t=t||{}).instance=this.app.block.create(),this.insert(t)},_compositionCutting(){if(!this._isIOS())return;const t=document.activeElement;document.querySelector("#rxCompositionCutter"+this.uuid).focus({preventScroll:!0}),t.focus({preventScroll:!0})},_isIOS(){const t=navigator.userAgent||navigator.vendor||window.opera;return/iPad|iPhone|iPod/.test(t)&&!window.MSStream},change(t,e){let s=t.getBlock();this.$block.after(s),this.$block.remove(),this.app.editor.build(),this.app.block.set(s),!1!==e&&this.app.broadcast("block.change",{instance:t})},move(t){let e,s="up"===t?this.getPrev():this.getNext(),i="up"===t?"before":"after";s&&(this.isEditable()&&this.app.editor.save(this.getBlock()),e=s.getBlock(),e[i](this.getBlock()),this.app.block.set(this,!1,!0),this.isEditable()&&this.app.editor.restore(!1))},appendNext(){let t=this.getNext();if(!t)return;let e,s,i=t.getHtml(),a=this.getType(),r=t.getType(),o=!0,n=!0,l=!0;if(!t.isNondeletable())if(t.isEmpty())t.remove();else{if(this.isEmpty())return this.remove(),void this.app.block.set(t,"start");if("pre"===a&&"pre"!==r&&(i=t.getPlainText()),"list"===r)if("list"===a){var h=t.getBlock().children();this.$block.append(h),o=!1,n=!0}else i=this._appendListHtml(t.getBlock(),i),n=t.isEmpty();if(o){if("dlist"===r&&"dlist"===a)return s=t.getBlock().children(),this.$block.append(s),void t.remove();"dlist"===r?i=this._appendDlistHtml(i):"todo"===r?(e=t.getFirstItem(),i=t.getFirstContent().html(),e.remove(),n=t.isEmpty()):"pre"===r?(i=t.getContent(),l=!1):"quote"===r&&(i=t.getPlainText()),this._insertHtml(i,l)}n&&t.remove()}},appendToPrev(){let t,e=this.getPrev(),s=e.getType(),i=this.getHtml(),a=this.getType(),r=!0,o=!0,n=this.app.create("caret"),l=!0;if(!e.isNondeletable()){if(this.isEmpty())return this.remove(),void this.app.block.set(e,"end");if(e.isEmpty())e.remove();else{if("pre"!==a&&"pre"===s&&(i=this.getPlainText()),"list"===a)if("list"===s){var h=this.getBlock().children();this.app.block.set(e,"end"),e.getBlock().append(h),r=!1,o=!0}else i=this._appendListHtml(this.getBlock(),i),o=this.isEmpty();if("dlist"===a&&(i=this._appendDlistHtml(i)),r){if(l="todo"!==s&&l,l="pre"!==s&&l,"dlist"===a&&"dlist"===s)return t=this.$block.children(),e.getBlock().append(t),n.set(t.first(),"start"),void this.remove();"quote"===a&&(i=this.$block.text()),this.app.block.set(e,"end"),this._insertHtml(i,l)}o&&this.remove()}}},parseItems(t,e){this.$block.find(t).each(function(t){t.attr("data-rx-type")||this.app.create("block."+e,t)}.bind(this))},parseCaption(){let t=this.$block.find("figcaption");0!==t.length&&(this.figcaption=this.app.create("block.figcaption",t),this.$figcaption=this.figcaption.getBlock())},unparseInlineBlocks:t=>(t.find("[data-rx-inline]").removeAttr("data-rx-type data-rx-inline contenteditable tabindex").removeClass("rx-block-focus"),""===t.attr("class")&&t.removeAttr("class"),t),unparseInlineStyle:t=>(t.find("[data-rx-style-cache]").removeAttr("data-rx-style-cache"),t),_buildCaption(t){if(this.isFigure()&&t){let e=this.$block.find("figcaption");0!==e.length?(this.figcaption=this.app.create("block.figcaption",e,{content:t}),this.$figcaption=this.figcaption.getBlock()):(this.figcaption=this.app.create("block.figcaption",{content:t}),this.$figcaption=this.figcaption.getBlock(),this.$block.append(this.$figcaption))}},_buildTraverseSelector(t){let e;return e=Array.isArray(t)?"[data-rx-type="+t.join("],[data-rx-type=")+"]":"[data-rx-type"+(t=t?"="+t:"")+"]",e},_buildTriggers(){let t=o.extend(!0,{},o.triggers),e=this.data.dump();for(let[s,i]of Object.entries(e))i.trigger&&(t[s]={trigger:i.trigger});return t},_setAttr(t,e,s){""===s?t.removeAttr(e):t.attr(e,s)},_createData(t){this.data=this.app.create("block-data",this,this.defaults,this.commonDefaults,t)},_createInstance(t,e){return this.app.create("block."+t,e)},_renderInlineBlocks(t,e){this.isType("noneditable")||(t=t||this.$block).find("["+this.opts.get("dataBlock")+"]").each(function(t){if(!e&&t.attr("data-rx-type"))return;let s=t.attr(this.opts.get("dataBlock"));this.app.create("block."+s,t)}.bind(this))},_renderInsideClone(t){t.find("[data-rx-type]").each((t=>{let e=t.attr("data-rx-type");this.app.create("block."+e,t)}))},_isEmpty(t,e,s){let i=this.dom(t),a=i.text(),r=this.app.create("utils"),o=i.find("br").length,n=i.find("svg").length;if(a=r.removeInvisibleChars(a),a=a.replace(/\r?\n/g,""),e&&(a=a.trim()),s&&""===a){if(0!==i.find(this.opts.get("tags.inline").join(",")).first().length)return!1}return""===a&&0===n&&o<2},_insertHtml(t,e){let s=this.app.create("caret"),i=this.app.create("selection"),a=this.app.create("insertion"),r=i.getInlineTop();!1!==e&&r&&s.set(r,"after"),a.insertHtml(t,"start")},_appendListHtml(t,e){let s=t.find("li").first(),i=this.app.create("cleaner");return e=(e=(e=s.html().trim()).replace(/<\/li>/gi,"</li><br>")).replace(/<(ul|ol)/gi,"<br><$1"),e=(e=(e=i.removeTags(e,["ul","ol","li"])).trim()).replace(/<br\s?\/?>$/gi,""),s.remove(),e},_appendDlistHtml(t){return this.app.create("utils").wrap(t,function(t){t.find("dt, dd").unwrap()}.bind(this))},_getPlainText(t){let e=t.html(),s=this.app.create("marker"),i=this.app.create("utils");return e=s.replaceToText(e),e=i.getTextFromHtml(e,{nl:!0}),e=s.replaceToMarker(e),e},_buildObjClasses(t){let e=[];for(let s of Object.values(t))e.push(s);return e},_removeObjClasses(t){let e=this._buildObjClasses(t),s=this.app.create("element");this.$block.removeClass(e.join(" ")),s.removeEmptyAttr(this.$block,"class")},_removeTraverse(){let t=this.getNext(),e=this.getPrev(),s=this.getClosest(["wrapper","todo","list"]),i=this.getClosest(["column","cell"]);if(this.$block.remove(),s&&s.isEmpty(!0)&&(t=s.getNext(),e=s.getPrev(),s.remove()),i&&i.isEmpty(!0)){let t=this.app.block.create();return i.insert({instance:t,position:"append"}),void this.app.block.set(t,"start")}t?this.app.block.set(t,"start"):e?this.app.block.set(e,"end"):this.app.block.unset()}}),o.add("mixin","tool",{init(t,e,s,i){this.name=t,this.setter=s.getSetter(),this.popup=s,this.data=i,this.obj=this._observe(e),this.prefix="rx",this.obj&&this._build()},getElement(){return this.$tool},getInput(){return this.$input},getValue(){return this.$input.val().trim()},setValue(t){this.$input.val(t)},setFocus(){this.$input.focus()},trigger(t){this.setValue(t),this.setter&&this.app.api(this.setter,this.popup)},_build(){this._buildTool(),this._buildLabel(),this._buildInputElement(),this._buildInput(),this._buildEvent(),this._has("placeholder")&&this.$input.attr("placeholder",this.lang.parse(this.obj.placeholder)),this._has("width")&&this.$input.css("width",this.obj.width),this._has("classname")&&this.$input.addClass(this.obj.classname)},_buildInputElement(){this.$input=this.dom("<"+this._getInputParam("tag")+">").addClass(this.prefix+this._getInputParam("classname")),this.$input.attr({name:this.name,type:this._getInputParam("type"),"data-type":this.type}),this.$input.dataset("instance",this)},_buildInput(){},_buildEvent(){if(-1===["segment"].indexOf(this.type)&&this.setter){let t="checkbox"===this.type||"select"===this.type?"change":"input blur";t="number"===this.type?t+" change":t,this.$input.on(t,this._catchSetter.bind(this))}},_buildTool(){this.$tool=this.dom("<div>").addClass(this.prefix+"-form-item").dataset("instance",this),this._has("hidden")&&this.obj.hidden&&this.$tool.hide()},_buildLabel(){if("checkbox"!==this.type&&this._has("label")){if(this.$label=this.dom("<label>").addClass(this.prefix+"-form-label").html(this.lang.parse(this.obj.label)),this.obj.hint){let t=this.dom('<span class="rx-form-hint">').html("("+this.lang.parse(this.obj.hint)+")");this.$label.append(t)}this.$tool.append(this.$label)}},_getInputParam(t){return this.input&&void 0!==this.input[t]?this.input[t]:""},_get(t){return this.obj[t]},_has(t){return Object.prototype.hasOwnProperty.call(this.obj,t)},_observe(t){return Object.prototype.hasOwnProperty.call(t,"observer")&&(t=this.app.api(t.observer,t,this.name)),t},_catchSetter(t){"keydown"===t.type&&13!==t.which||("keydown"===t.type&&t.preventDefault(),this.app.api(this.setter,this.popup))}}),o.add("class","offset",{get(t){this.node=this._node(t);let e=this.app.page.getWinNode().getSelection();if(e&&e.rangeCount>0){let t=e.getRangeAt(0);if(this.node.contains(e.anchorNode)){let e=this._cloneRangeForNode(t).toString().length;return{start:e,end:e+t.toString().length}}}return!1},set(t,e){this.node=this._node(e);let s=this._createRangeForOffset(t),i=this.app.page.getWinNode().getSelection();i&&(i.removeAllRanges(),i.addRange(s))},_node(t){return t?this.dom(t).get():this.app.getLayout().get()},_createRangeForOffset(t){let e=this.app.page.getDocNode().createRange();e.setStart(this.node,0),e.collapse(!0);let s,i=0,a=[this.node],r=!1;for(;s=a.pop();)if(3===s.nodeType){let a=i+s.length;if(!r&&t.start>=i&&t.start<=a&&(e.setStart(s,t.start-i),r=!0),r&&t.end>=i&&t.end<=a)return e.setEnd(s,t.end-i),e;i=a}else for(let t=s.childNodes.length-1;t>=0;t--)a.push(s.childNodes[t]);return e},_cloneRangeForNode(t){let e=t.cloneRange();return e.selectNodeContents(this.node),e.setEnd(t.startContainer,t.startOffset),e}}),o.add("class","marker",{create(t){return this._buildMarker(t)},createHtml(t){return this._buildMarker(t).outerHTML},insert(t=!1){this.remove();let e=this.app.create("selection");t&&e.set(window.getSelection());let s=e.getRange();if(!s)return;let i=this._buildMarker("start"),a=this._buildMarker("end"),r=s.cloneRange(),o=e.isCollapsed();this._insertMarkers(s,r,i,a,o),e.updateRange(s)},save(t=!1){this.insert(t)},restore(){let t=this.find("start"),e=this.find("end");if(!t)return;let s=this._restoreSelection(t,e);this._cleanUpMarkers(t,e),this.app.editor.setWinFocus(),this.app.create("selection").setRange(s)},find(t){let e=this.app.getLayout(),s=!1;if(e){let i={start:this._getMarkerById(e,"start"),end:this._getMarkerById(e,"end")};s=t?i[t]:i}return s},replaceToText(t){return this._replaceMarkersWithText(t)},replaceToMarker(t){return this._replaceTextWithMarkers(t)},remove(){this._remove(this.find("start")),this._remove(this.find("end"))},_insertMarkers(t,e,s,i,a){a||(e.collapse(!1),e.insertNode(i)),e.setStart(t.startContainer,t.startOffset),e.collapse(!0),e.insertNode(s),t.setStartAfter(s),a||t.setEndBefore(i)},_restoreSelection(t,e){let s=this.app.page.getDocNode().createRange(),i=this._getNextNode(t),a=this._getPreviousNode(e);return this._setRangeBasedOnMarkers(s,t,e,i,a),s},_cleanUpMarkers(t,e){this._remove(t),this._remove(e)},_getMarkerById(t,e){let s=t.find(`#rx-selection-marker-${e}`);return 0!==s.length&&s.get()},_replaceMarkersWithText(t){return this.app.create("utils").wrap(t,(t=>{t.find("#rx-selection-marker-start").replaceWith("---marker-start---"),t.find("#rx-selection-marker-end").replaceWith("---marker-end---")}))},_replaceTextWithMarkers(t){let e=this._buildMarker("start").outerHTML,s=this._buildMarker("end").outerHTML;return t.replace("---marker-start---",e).replace("---marker-end---",s)},_remove(t){if(t){let e=this._getParent(t);t.parentNode.removeChild(t),e&&e.normalize()}},_buildMarker(t="start"){let e=this.dom("<span>");return e.attr("id",`rx-selection-marker-${t}`).addClass("rx-selection-marker").html(this.opts.get("markerChar")),e.get()},_getParent(t){let e=this.dom(t).closest(["p","h1","h2","h3","h4","h5","h6","pre","div","address","li","ul","ol","dl","td","th","blockquote"].join(","));return 0!==e.length&&e.get()},_getNextNode:t=>(!t.nextSibling||3!==t.nextSibling.nodeType||""!==t.nextSibling.textContent.replace(/[\n\t]/g,""))&&t.nextSibling,_getPreviousNode:t=>!!t&&t.previousSibling,_setRangeBasedOnMarkers(t,e,s,i,a){s?i&&"rx-selection-marker-end"===i.id?(t.selectNodeContents(e),t.collapse(!1),t.setStart(i,0)):(t.setStartAfter(e),s&&t.setEndBefore(s)):i?(t.selectNodeContents(i),t.collapse(!0)):(t.selectNodeContents(e),t.collapse(!1))}}),o.add("class","caret",{set(t,e){const s=this._node(t),i=this.app.create("selection"),a=this.app.page.getDocNode().createRange();e&&s&&this._isInPage(s)&&(this.app.editor.setWinFocus(),this._isInline(s)&&this._isNoneditable(s)&&(e=this._adjustTypeForNonEditable(e)),this[{start:"_setStart",end:"_setEnd",before:"_setBefore",after:"_setAfter"}[e]](a,s),i.setRange(a))},is(t,e,s,i,a){const r=this._node(t),o=this.app.page.getWinNode().getSelection();if(!r||!o.isCollapsed)return!1;const n=this._getPosition(r,i,a),l=this._getSize(r,s,i);return this._comparePositionWithType(n,l,e)},_node(t){return this.dom(t).get()},_adjustTypeForNonEditable:t=>"start"===t?"before":"end"===t?"after":t,_comparePositionWithType:(t,e,s)=>"end"===s?t===e:"start"===s&&0===t,_setStart(t,e){this._setRangeStartToNodeStart(t,e),this._handleInlineNodeAtStart(t,e)},_setRangeStartToNodeStart(t,e){t.setStart(e,0),t.collapse(!0)},_handleInlineNodeAtStart(t,e){let s=this._getInlineInside(e);s?this._setRangeStartInline(t,s):this._isInline(e)&&this._insertInvisibleNode(t)},_setRangeStartInline(t,e){let s=this.app.create("element").getInlines(e)[0];t.selectNodeContents(s),t.collapse(!0)},_setEnd(t,e){let s=e.lastChild;s&&this._isInline(s)?1===s.childNodes.length&&1===s.childNodes[0].nodeType&&["svg","br"].includes(s.childNodes[0].tagName.toLowerCase())?this._setAfter(t,s):(t.selectNodeContents(s),t.collapse(!1)):(t.selectNodeContents(e),t.collapse(!1))},_setBefore(t,e){t.setStartBefore(e),t.collapse(!0),this._isInline(e)&&this._insertInvisibleNode(t,e)},_setAfter(t,e){t.setStartAfter(e),t.collapse(!0);let s=3!==e.nodeType&&e.tagName.toLowerCase();(this._isInline(e)||"br"===s||"svg"===s)&&this._insertInvisibleNode(t)},_insertInvisibleNode(t,e){let s=this.app.create("utils").createInvisibleChar();e?e.parentNode.insertBefore(s,e):t.insertNode(s),t.selectNodeContents(s),t.collapse(!1)},_getInlineInside(t){let e=t.firstChild;for(;e&&this._isInline(e);){if(!e.firstChild||!this._isInline(e.firstChild))return e;e=e.firstChild}return this._isInline(e)?e:null},_getSize(t,e,s){let i,a=3===t.nodeType;return e&&0!==e.length?i=this._removeSpecifiedBlocks(t,e):(i=a?t.textContent:t.innerHTML,i=a||!1===s?i:i.trim()),this._trimmed(i,a,s).length},_removeSpecifiedBlocks(t,e){let s=this.dom(t).clone(),i=e.join(",");return s.find(i).remove(),s.html().trim()},_getPosition(t,e,s){let i=this.app.page.getWinNode().getSelection();if(0===i.rangeCount)return!1;let a=i.getRangeAt(0),r=a.cloneRange(),o=document.createElement("div"),n=3===t.nodeType;r.selectNodeContents(t),r.setEnd(a.endContainer,a.endOffset),o.appendChild(r.cloneContents());let l=n||!1===e?o.innerHTML:o.innerHTML.trim(),h=this._adjustForBr(l,s);return l=this._trimmed(l,n,e),l.length+h},_adjustForBr(t,e){let s=/<\/?br\s?\/?>$/i.test(t);return e&&s?1:0},_trimmed(t,e,s){let i=this.app.create("utils");return!1===s?t.replace(/\n$/g,""):(""===(t=(t=(t=i.removeInvisibleChars(t)).replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,"")).replace(/\s+/g," "))||e||(t=t.replace(/\s$/,"")),t)},_isInline(t){return this.app.create("element").is(t,"inline")},_isInPage(t){return t&&t.nodeType&&this.app.page.getDocNode().body.contains(t)},_isNoneditable:t=>"false"===t.getAttribute("contenteditable")}),o.add("class","selection",{init(){this.sel=this._get()},set(t){this.sel=t},is(t){if(void 0===t)return!!this.sel;const e=this._node(t);return this.getNodes().includes(e)},contains(t){const e=this.getCurrent();return!!e&&this._node(t).contains(e)},isCollapsed(){return this._collapsed(this.sel,this.getRange())},isFullySelected(t){if(this.isCollapsed())return!1;const e=t?this._node(t):this.app.editor.getLayout().get(),s=!t||this.is(e),i=this.getRange();return s&&e.textContent&&e.textContent.trim().length===i.toString().trim().length},isBackwards(){const t=this.sel;if(t&&!t.collapsed){const e=this.app.page.getDocNode().createRange();e.setStart(t.anchorNode,t.anchorOffset),e.setEnd(t.focusNode,t.focusOffset);const s=e.collapsed;return e.detach(),s}return!1},isCursorInFirstOrLastLine(){const t=this.getRange(),e=this.app.page.getDocNode().createRange();e.setStart(t.startContainer,0),e.setEnd(t.startContainer,t.startOffset);const s=e.getClientRects();if(!s.length)return{isFirstLine:!1,isLastLine:!1};const i=this.app.page.getDocNode().createRange();i.setStart(t.endContainer,t.endOffset),i.setEnd(t.endContainer,t.endContainer.length||t.endContainer.childNodes.length);const a=i.getClientRects();if(!a.length)return{isFirstLine:!1,isLastLine:!1};const r=s[0].top,o=a[a.length-1].bottom;return{isFirstLine:t.getBoundingClientRect().top<=r,isLastLine:t.getBoundingClientRect().bottom>=o}},getRange(){return!!(this.sel&&this.sel.rangeCount>0)&&this.sel.getRangeAt(0)},setRange(t){let e=this.app.page.getWinNode().getSelection();this.updateRange(t,e),this.update()},updateRange(t,e){(e=e||this.sel)&&(e.removeAllRanges(),e.addRange(t))},getCurrent(){return!!this.sel&&this.sel.anchorNode},getParent(){const t=this.getCurrent();return!!t&&t.parentNode},getClosest(t){const e=this.getCurrent(),s=this.dom(e).closest(t);return 0!==s.length&&s.get()},getElement(t){return this._element(t,"element")},getInline(t){return this._element(t,"inline")},getInlineTop(t,e){let s=this.app.create("element"),i=t?this._node(t):this.getCurrent();i.nodeType===Node.TEXT_NODE&&(i=i.parentNode);let a=null;for(;i&&(i.nodeType!==Node.ELEMENT_NODE||!s.is(i,"inline")||(a=i,i.tagName.toLowerCase()!==e));)i=i.parentNode;return a},getBlock(t){return this._element(t,"block")},getBlockControlled(t){let e=t?this._node(t):this.getCurrent();for(;e;){if(1===e.nodeType&&e.getAttribute("data-rx-type"))return this.dom(e);e=e.parentNode}return this.dom()},getNodes(t){if(!this.is())return[];let e=this.getRange(),s=this.app.editor.isSelectAll()?[...this.app.editor.getLayout().get().getElementsByTagName("*")]:this._nodes(e,t?.partial);return s=[...new Set(s)],s.length>0?this._filter(s,e,t):s},getPosition(t){let e,s,i=this.getRange(),a={top:0,left:0,right:0,bottom:0,width:0,height:0};return this.app.page.getWinNode().getSelection&&i.getBoundingClientRect&&(i.startContainer===i.endContainer&&this.isFullySelected(i.startContainer)||(i=i.cloneRange(),"end"===t?i.setStart(i.endContainer,i.endOffset):(e=i.startOffset-1,i.setStart(i.startContainer,e<0?0:e))),s=i.getBoundingClientRect(),a={top:s.top,bottom:s.bottom,left:s.left,right:s.right,width:s.right-s.left,height:s.bottom-s.top}),a},getText(t,e,s){if(!this.sel)return!1;let i,a=this.getRange();if(t&&a){s=s?this._node(s):this.app.editor.getLayout().get(),e=void 0===e?1:e;let r=a.cloneRange();"before"===t?(r.collapse(!0),r.setStart(s,0),i=!0===e?r.toString():r.toString().slice(-e)):"after"===t&&(r.selectNodeContents(s),r.setStart(a.endContainer,a.endOffset),i=!0===e?r.toString():r.toString().slice(0,e))}else i=this.sel?this.sel.toString():"";return i},getHtml(){if(!this.sel)return"";let t,e;return t=this.getRange().cloneContents(),e=document.createElement("div"),e.appendChild(t),e.innerHTML.replace(/<p><\/p>$/i,"")},update(){this.sel=this._get()},select(t){const e=t?this._node(t):this.app.editor.getLayout().get();if(!e)return;const s=this.app.page.getDocNode().createRange();s.selectNodeContents(e),this.setRange(s)},remove(){this.sel&&(this.sel.removeAllRanges(),this.sel=!1)},truncate(){const t=this.getRange();!this.isCollapsed()&&t&&t.deleteContents()},collapse(t){t=t||"start",this.sel&&!this.isCollapsed()&&("start"===t?this.sel.collapseToStart():this.sel.collapseToEnd())},_node(t){return this.dom(t).get()},_element(t,e){if(!this.sel)return!1;const s=this.app.create("element");let i=t||this.getCurrent();for(i=this._node(i);i;){if(s.is(i,e))return i;i=i.parentNode}return!1},_get(){const t=this.app.page.getWinNode().getSelection();return t.rangeCount>0&&this.dom(t.anchorNode).closest(".rx-editor").length>0&&t},_collapsed:(t,e)=>!t||!e||t.isCollapsed||0===e.toString().length,_nodes(t,e){const s=[],i=t.startContainer.childNodes[t.startOffset]||t.startContainer,a=t.endContainer.childNodes[t.endOffset]||t.endContainer,r=t.commonAncestorContainer,o=t=>3===t.nodeType,n=t=>r.contains(t.parentNode),l=t=>{if("TR"===t.tagName){const e=this.dom(t).closest("table").get();s.includes(e)||s.push(e)}else s.push(t)};let h;if(this.app.editor.isEditor(i)||s.push(i),e)for(o(i)&&s.unshift(this.getBlock(i)),h=i;h&&h!==r&&(o(h)||n(h))&&(l(h),h!==a);h=this._next(h));else{for(h=i.parentNode;h&&!this.app.editor.isEditor(h)&&(s.push(h),h!==r);h=h.parentNode);for(s.reverse(),h=i;h;h=this._next(h)){if(!o(h)&&"TR"===h.tagName){const t=this.dom(h).closest("table").get();s.includes(t)||s.push(t)}if(!o(h)&&!n(h))break;if(l(h),h===a)break}}return s},_next(t){if(t.firstChild)return t.firstChild;for(;t;){if(t.nextSibling)return t.nextSibling;t=t.parentNode}},_text(){const t=this.getText();return t?t.replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&"):""},_filter(t,e,s){const i=new Set,a=this._text(),r=this.app.create("element");return t.forEach((t=>{if(this.app.editor.isEditor(t))return;let o=!0;s&&(o=s.types?this._filterByTypes(o,s,t,r):o,o=s.selected?this._filterBySelected(o,s,t,e,a):o,o=s.tags?this._filterByTags(o,s,t):o,o=s.type?this._filterByType(o,s,t,r):o,"inline"===s.type&&r.is(t,"inline")&&t.parentNode&&r.is(t.parentNode,"inline")&&i.add(t.parentNode)),o&&i.add(t)})),Array.from(i)},_filterByTags(t,e,s){const i=void 0!==s.tagName;return(!i||i&&-1===e.tags.indexOf(s.tagName.toLowerCase()))&&(t=!1),t},_filterBySelected(t,e,s,i,a){return!0!==e.selected||this._textIn(i,s)?"inside"===e.selected&&(t=1===s.nodeType&&"A"===s.tagName||this._textSel(s,a)):t=!1,t},_filterByType(t,e,s,i){let a=!1===e.inline?"block-data-not-inline":e.type;return"inline"===e.type?(e.link?i.is(s,e.type)||(t=!1):(1===s.nodeType&&"A"===s.tagName||!i.is(s,e.type))&&(t=!1),e.buttons&&i.is(s,e.type,!1)&&(t=!0)):i.is(s,a)||(t=!1),t},_filterByTypes(t,e,s,i){let a=i.getType(s);return-1===e.types.indexOf(a)&&(t=!1),t},_isInNodesArray:(t,e)=>-1!==t.indexOf(e),_textSel(t,e){const s=this.app.create("utils"),i=9!==t.nodeType?s.removeInvisibleChars(t.textContent):"";return e===i||i.includes(e)||new RegExp(`^${s.escapeRegExp(i)}$`).test(e)},_textIn(t,e){const s=this.app.page.getDocNode().createTreeWalker(e,NodeFilter.SHOW_TEXT,(t=>NodeFilter.FILTER_ACCEPT),!1);let i,a,r;for(;r=s.nextNode();)i||(i=r),a=r;const o=t.cloneRange();return i?(o.setStart(i,0),o.setEnd(a,a.length)):o.selectNodeContents(e),t.compareBoundaryPoints(Range.START_TO_START,o)<=0&&t.compareBoundaryPoints(Range.END_TO_END,o)>=0},get(){return this.sel},isAll(t){return this.isFullySelected(t)}}),o.add("class","utils",{isMobileDevice(){const t="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,e=navigator.userAgent.toLowerCase(),s=/mobile|android|iphone|ipad|tablet|blackberry|phone/i.test(e);return t||s},isFirefox:()=>"undefined"!=typeof navigator&&navigator.userAgent.toLowerCase().includes("firefox"),createInvisibleChar(){return document.createTextNode(this.opts.get("markerChar"))},searchInvisibleChars:t=>t.search(/^\uFEFF$/g),removeInvisibleChars:t=>t.replace(/\uFEFF/g,""),wrap(t,e){let s=this.dom("<div>").html(t);return e(s),t=s.html(),s.remove(),t},isEmptyHtml(t,e){let s=this.app.create("cleaner");return t=t.trim(),t=(t=(t=(t=(t=(t=(t=(t=(t=s.removeInvisibleChars(t)).replace(/^&nbsp;$/gi,"1")).replace(/&nbsp;/gi,"")).replace(/<\/?br\s?\/?>/g,"")).replace(/\s/g,"")).replace(/^<p>\s\S<\/p>$/i,"")).replace(/<hr(.*?[^>])>$/i,"hr")).replace(/<iframe(.*?[^>])>$/i,"iframe")).replace(/<source(.*?[^>])>$/i,"source"),t=s.removeComments(t),t=e?t.replace(/<p[^>]*><\/p>/gi,""):t,""===(t=(t=(t=(t=e?t.replace(/<div[^>]*><\/div>/gi,""):t).replace(/<[^/>]><\/[^>]+>/gi,"")).replace(/<[^/>]><\/[^>]+>/gi,"")).trim())},isLine(t,e){if(this.opts.is("breakline"))return!1;let s=this.dom(document.createElement("div")).html(t),i=this.opts.get("tags"),a=0===s.find(i.block.join(",")+",img").length,r=-1!==t.search(/div><br\s?\/?><div/i),o=-1!==t.search(/<br(.*?[^>])><br(.*?[^>])>/i);return(!this.isPlainText(t)||-1===t.search(/\n\n/gi))&&(!o&&!r&&((!a||"paste"!==e||-1===t.search(/\n\n/gi))&&a))},isPlainText(t){const e=this.opts.get("tags.block");return!new RegExp(`</?(${e.join("|")})\\b[^>]*>`,"i").test(t)},extractHtmlFromCaret(t){let e,s=this._getNode(t),i=this.app.create("selection").getRange();if(i)return e=i.cloneRange(),e.selectNodeContents(s),e.setStart(i.endContainer,i.endOffset),e.extractContents()},getTextFromHtml(t,e){let s,i,a="",r=0,n=this.app.create("cleaner");if(e=o.extend({},{br:!1,nl:!1,trimlines:!0,images:!1,links:!1},e),t=n.store(t,"code"),t=e.links?n.store(t,"links"):t,t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=e.images?n.store(t,"images"):t).replace(/\n\s+<span/gi," <span")).replace(/span>\n\s+/gi,"span> ")).replace(/<(ul|ol)>\s+<li>/gi,"<$1><li>")).replace(/<li[^>]*>\n/gi,"<li$1>")).replace(/<p[^>]*>(\s+|)<\/p>/gi,"xemptyz")).replace(/<!--[\s\S]*?-->/gi,"")).replace(/<style[\s\S]*?style>/gi,"")).replace(/<script[\s\S]*?script>/gi,"")).replace(/<\/(div|li|dt|dd|td|p|H[1-6])>\n?/gi,"</$1>\n")).replace(/&(lt|gt);/gi,"x$1z"),s=this.dom("<div>").html(t),t=this.getText(s.get()),e.trimlines){for(a="",i=t.split("\n");r<i.length;r++)a+=i[r].trim()+"\n";t=a}return t=(t=(t=t.replace(/[\n]+/g,"\n")).replace(/xemptyz/g,"\n")).replace(/x(lt|gt)z/gi,"&$1;"),t=e.br?(t=t.replace(/\n/g,"<br>\n")).replace(/<br\s?\/?>\n?$/gi,""):e.nl?t:t.replace(/\n/gi," "),t=n.restore(t,"code"),t=e.links?n.restore(t,"links"):t,t=(t=(t=(t=(t=e.images?n.restore(t,"images"):t).replace(/<pre[^>]*>/g,"")).replace(/<code[^>]*>/g,"")).replace(/<\/pre>\n?/g,"")).replace(/<\/code>/g,""),e.images||(t=(t=t.replace(/<img[\s\S]*?>/gi,"")).replace(/<a[^>]*>(\s+|)<\/a>/gi,"")),t.trim()},getText(t){var e="";if(3===t.nodeType)e=t.nodeValue;else{for(var s=0;s<t.childNodes.length;s++)e+=this.getText(t.childNodes[s]);var i=1===t.nodeType?getComputedStyle(t).getPropertyValue("display"):"";(i.match(/^block/)||i.match(/list/)||"BR"===t.tagName||"HR"===t.tagName)&&(e+="\n")}return e},findTodoItemTag(){return this.dom("<div>").html(this.opts.get("todo.templateContent")).children().first().tag()},parseMarkdown(t){const e=t.split("\n"),s=/^(#{1,6})\s+(.*)$/,i=/!\[([^\]]*)\]\(([^)\s]+)(?:\s+"([^"]+)")?\)/g,a=/\[([^\]]+)\]\(([^)\s]+)(?:\s+"([^"]+)")?\)/g;return e.map((t=>{const e=t.match(s);if(e){const s=e[1].length;t=`<h${s}>${e[2]}</h${s}>`}return t=(t=(t=t.replace(/^(\-|\d\.)\s?\*\*/g,"**").replace(/^\- (.*)$/g,"<ul><li>\n$1</li></ul>").replace(/^\d\.(.*)$/g,"<ol><li>\n$1</li></ol>")).replace(i,((t,e,s,i)=>`<img src="${s}" alt="${e}"${i?` title="${i}"`:""}>`))).replace(a,((t,e,s,i)=>`<a href="${s}"${i?` title="${i}"`:""}>${e}</a>`))})).join("\n").replace(/(<\/ul>\n<ul>|<\/ol>\n<ol>)/g,"")},extendArrayWithoutDuplicates:(t,e)=>[...new Set([...t,...e])],extendArray(t,e){if(t=[...t],e)for(let s=0;s<e.length;s++)t.push(e[s]);return t},removeFromArrayByValue(t,e){let s,i,a=0;for(a=0,i=(e=Array.isArray(e)?e:[e]).length;a<i;a++)s=t.indexOf(e[a]),s>-1&&t.splice(s,1);return t},sumOfArray:t=>t.reduce((function(t,e){return parseInt(t)+parseInt(e)}),0),cssToObject(t){let e,s=/([\w-]*)\s*:\s*([^;]*)/g,i={};do{e=s.exec(t),null!=e&&(i[e[1]]=this._normalizeValue(e[1],e[2].trim()))}while(e);return i},_normalizeValue(t,e){if(e=(e="string"==typeof e?e.replace(/'/g,'"'):e).trim().replace(/;$/,""),-1!==t.search(/color|background/)&&(e=(e=this.convertRgb2hex(e)).toLowerCase()),-1!==t.search(/family/)&&(e=e.replace(/"/g,"")),"border"===t){let t=e.match(/rgb\((.*?)\)/gi);t&&(e=e.replace(t[0],this.convertRgb2hex(t[0])))}return e},getInvertedColor(t){return t=""===t||null==t?"#ffffff":t,t=this.normalizeColor(t),t=this._removeHexDiese(t),.299*parseInt(t.slice(0,2),16)+.587*parseInt(t.slice(2,4),16)+.114*parseInt(t.slice(4,6),16)>186?"black":"white"},normalizeColor(t){return t=(t=t?this.convertRgb2hex(t):t)?this.convertShorthex2long(t):t},convertRgb2hex(t){if(-1===t.search(/^rgb/i))return t;var e=t.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i);return e&&4===e.length?"#"+("0"+parseInt(e[1],10).toString(16)).slice(-2)+("0"+parseInt(e[2],10).toString(16)).slice(-2)+("0"+parseInt(e[3],10).toString(16)).slice(-2):""},convertShorthex2long(t){return 3===(t=this._removeHexDiese(t)).length?"#"+t[0]+t[0]+t[1]+t[1]+t[2]+t[2]:"#"+t},replaceRgbToHex:t=>t.replace(/rgb\((.*?)\)/g,(function(t,e){return"#"+e.split(",").map((function(t){return 1===(t=parseInt(t).toString(16)).length?"0"+t:t})).join("")})),escapeRegExp:t=>t.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),escapeBackslash:t=>t.replace(/\//g,"/"),extendData(t,e){for(let s in e)t="elements"===s?this._extendDataElements(t,e[s]):this._setData(t,s,e[s]);return t},getRandomId(){let t="",e="abcdefghijklmnopqrstuvwxyz0123456789";for(let s=0;s<12;s++)t+=e.charAt(Math.floor(36*Math.random()));return t},_extendDataElements(t,e){return this.dom(e).each(function(e){if(e.tag("form")){let s=e.serialize(!0);Object.keys(s).forEach(function(e){t=this._setData(t,e,s[e])}.bind(this))}else{let s=e.attr("name")?e.attr("name"):e.attr("id");t=this._setData(t,s,e.val())}}.bind(this)),t},_setData:(t,e,s)=>(t instanceof FormData?t.append(e,s):t[e]=s,t),_getNode(t){return this.dom(t).get()},_removeHexDiese:t=>0===t.indexOf("#")?t.slice(1):t}),o.add("class","block-data",{init(t,e,s,i){this.block=t,this.data=o.extend(!0,e,s),this._initializeData(i)},build(){Object.entries(this.data).forEach((([t,e])=>{e.value&&e.setter&&"function"==typeof this.block[e.setter]&&this.block[e.setter](e.value)}))},dump(){return this.data},is(t){return!!this.get(t)},get(t){return this.data[t]?.value},set(t,e){this.data[t]||(this.data[t]={}),this.data[t].value=e},add(t,e){Array.isArray(this.data[t])||(this.data[t]=[]),this.data[t].push(e)},remove(t){delete this.data[t]},setData(t){Object.entries(t).forEach((([t,e])=>{this.data[t]&&this.data[t].setter&&this.block[this.data[t].setter](e)}))},getData(t){let e={type:this.block.getType()};return Object.entries(this.data).forEach((([s,i])=>{if((!0===t||"items"!==s&&"children"!==s)&&(t&&"getHtml"===i.getter&&"text"===s&&(i.getter="getContent"),i.getter&&"function"==typeof this.block[i.getter])){let t=this.block[i.getter].apply(this.block);null!==t&&(e[s]=t)}})),e},getValues(){return Object.entries(this.data).filter((([,t])=>void 0!==t.value)).reduce(((t,[e,s])=>(t[e]=s.value,t)),{})},_initializeData(t){t&&Object.entries(t).forEach((([t,e])=>{this.set(t,e)}))}}),o.add("class","parser",{init(){this.defaults={type:"html",start:!1,nodes:!1,state:!1,paragraphize:this.opts.get("paragraphize")},this.parsedAttr="data-rx-type"},build(t){return this._buildNodes(t)},parse(t,e){let s,i="";switch(this.defaults=o.extend(!0,this.defaults,e),this.defaults.type){case"json":s=this.app.create("parser-json",this);break;case"line":s=this.app.create("parser-line",this);break;default:s=this.app.create("parser-html",this)}return i=s.parse(t,this.defaults),"json"!==this.defaults.type&&(i=this._buildResult(i)),i},clean(t,e){let s=this.opts.get("templateSyntax"),i=this.opts.get("nonparse"),a=this.app.create("utils"),r=this.app.create("cleaner");s&&(this.opts.set("clean.comments",!1),t=r.storeTemplateSyntax(t,s)),this.app.has("email")&&(t=this.app.email.parseBlocks(t)),t=(t=(t=r.storeComments(t)).replace(/t/gi,"&current")).replace(/<[^>]+>/g,(function(t){return t.replace(/\s+/g," ")})),e&&e.start&&this.app.element.isTextarea()&&(t=r.encodeCode(t)),t=r.sanitize(t),t=r.convertForms(t),t=r.convertFrames(t);for(let e=0;e<i.length;e++)t=r.store(t,i[e]);t=r.store(t,"embed"),t=r.store(t,"svg"),t=r.store(t,"noparse"),t=r.removeTags(t,this.opts.get("tags.denied")),t=r.removeDoctype(t),t=r.removeTagsWithContent(t,["script","style"]),t=r.removeEmptySpans(t),t=r.addHttps(t),t=r.removeBlockTagsInside(t,["li","dt","dd","address"]),t=r.cacheStyle(t);for(let e=0;e<i.length;e++)t=r.restore(t,i[e]);if(t=r.restore(t,"embed"),t=r.restore(t,"noparse"),t=r.restore(t,"svg"),t=r.restoreComments(t),t=this.opts.is("clean.comments")?r.removeComments(t):t,a.isEmptyHtml(t))t=this.app.block.createHtml();else{t=this.app.create("paragraphizer",e.paragraphize).parse(t)}return t=t.replace(/<div>\s*<\/div>/gi,"<div></div>")},replaceTags(t){let e=this.opts.get("replaceTags");if(!e)return t;let s=Object.keys(e),i=this.app.create("utils");return"string"==typeof t?t=i.wrap(t,(function(t){t.find(s.join(",")).each((function(t){t.replaceTag(e[t.tag()])}))})):t.find(s.join(",")).each((function(t){t.replaceTag(e[t.tag()])})),t},_buildResult(t){if(this.defaults.nodes){let e=this._buildNodes(t);this.app.has("email")&&(e=this.app.email.parse(e)),t=e.get().childNodes}return t},_buildNodes(t){let e=this.dom("<div>");return e.html(t),e.find("["+this.parsedAttr+"]").each(this._buildNode.bind(this)),e},_buildNode(t){let e=t.attr(this.parsedAttr);this.app.create("block."+e,t)}}),o.add("class","parser-html",{init(t){this.parser=t,this.parsedAttr=t.parsedAttr},parse(t,e){this.defaults=e,this.utils=this.app.create("utils"),this.elm=this.app.create("element");let s=this.app.create("paragraphizer",this.parser.defaults.paragraphize);return t=t.trim(),t=this.app.broadcastHtml("editor.before.parse",t),this.utils.isEmptyHtml(t)?t=this.app.block.createHtml():(t=this.parser.clean(t,this.defaults),t=this._parseBlocks(t),t=this.parser.replaceTags(t),t=s.parseLayers(t),t=this._parseLayersNodes(t)),t=this.app.broadcastHtml("editor.parse",t)},_parseBlocks(t){let e=this.app.create("predefined");return this.utils.wrap(t,function(t){this._parseElements(t),e.parse(t)}.bind(this))},_parseElements(t){let e,s=this.elm.getBlocks(t),i=0;for(i=0,e=s.length;i<e;i++)this._parseNode(s[i])},_parseNode(t){let e,s=this.dom(t),i=this.opts.get("nested"),a=this.opts.get("nestedValue"),r=s.tag(),o=this._parseType(s,r);o&&s.attr(this.parsedAttr,o),e=i.indexOf(o),-1!==e&&(!0===a[e]?this._parseElements(s):s.find(a[e]).each(this._parseElements.bind(this)))},_parseType(t,e){let s,i=this.opts.get("dataBlock");return s=t.attr(this.parsedAttr)?t.attr(this.parsedAttr):t.attr(i)?t.attr(i):this._parseTypeByTag(t,e),s},_parseTypeByTag(t,e){let s;switch(e){case"p":s="text",this._isImageBlock(t,"p")&&(s="image");break;case"figure":s="embed",this._isImageBlock(t,"figure")?s="image":this._hasChild(t,"pre")?s="pre":this._hasChild(t,"blockquote")&&(s="quote");break;case"div":s="wrapper",this._isLayoutBlock(t,"div")?s="layout":this._isColumnBlock(t,"div")?s="column":this._isImageBlock(t,"div")?s="image":this._isTextBlock(t)&&(s="text");break;case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":s="heading";break;case"blockquote":s="quote";break;case"table":s="table";break;case"pre":s="pre";break;case"hr":s="line";break;case"dl":s="dlist";break;case"address":s="address";break;case"ul":case"ol":s="list",this._isTodo(t)&&(s="todo");break;default:s="wrapper"}return s},_parseLayersNodes(t){let e=this.app.create("predefined");return this.utils.wrap(t,function(t){t.find("[data-rx-tag]").each(this._parseLayersDataTag.bind(this)),t.find("[data-rx-type=wrapper],[data-rx-type=column]").each(function(t){this._parseElements(t),e.parse(t)}.bind(this))}.bind(this))},_parseLayersDataTag(t){if(!t.attr("data-rx-type")){let e="text";this._isImageBlock(t,"div")&&(e="image",t.removeAttr("data-rx-tag")),t.attr(this.parsedAttr,e)}},_isLayoutBlock(t,e){let s=this.opts.get("layout.grid");if(s&&t.hasClass(s))return!0},_isColumnBlock(t,e){let s=this.opts.get("layout.column");if("layout"===t.parent().data("rx-type")||s&&t.hasClass(s))return!0},_isImageBlock(t,e){let s=t.find("img");if(0===s.length||"div"===e&&0!==s.closest("figure").length)return;let i=s,a=s.parent(),r=a,o=0!==a.length&&a.tag();return o&&["a","span"].includes(o)&&(i=a,r=a.parent()),r.get()===t.get()&&0===i.prevElement().length&&("figure"===e||0===i.nextElement().length)||void 0},_isTextBlock(t){let e=t.children().first();return 0===this.app.create("element").getBlocks(t).length&&(0===e.length||!this.elm.is(e,"block")||void 0)},_isTodo(t){let e=t.children().first();if(0!=e.length){let t=this.opts.get("todo.template"),s=this.opts.get("todo.templateItem"),i=s.replace(/\s/g,""),a=this.opts.get("todo.templateItemDone"),r=e.html();if(t)return this._checkToTemplateMatch(t,r);{let t=r.startsWith(s)||r.startsWith(i),e=r.startsWith(a);if(t||e)return!0}}return!1},_checkToTemplateMatch(t,e){let s=t.replace(/\$checked/g,"\\[(x| )\\]").replace(/\$content/g,"(.*)");s="^"+s+"$";return new RegExp(s).test(e)},_hasChild(t,e){let s,i,a;if("pre"===e){if(s=t.find("pre"),0!==s.length)return!0}else if("blockquote"===e&&(i=t.find("blockquote"),a=t.find("script"),0===a.length&&0!==i.length))return!0}}),o.add("class","parser-json",{init(t){this.parser=t,this.parsedAttr=t.parsedAttr},parse(t,e){this.defaults=e;this.app.create("utils");let s,i=this.app.create("predefined"),a=this.dom("<div>");return a=this._render(a,t.blocks),i.parse(a),s=this.defaults.nodes?a.children():a.html(),s=this.parser.replaceTags(s),s},_render(t,e,s){let i,a,r,o,n=this.opts.get("nonparse");for(i of(e||(e=[{type:"text",content:""}]),Object.values(e)))a=this.app.create("block."+i.type,i,s),r=a.getBlock(),o=-1===n.indexOf(i.type)&&!1!==s&&void 0,i.children&&this._render(r,i.children,o),t.append(r);return t}}),o.add("class","parser-line",{init(t){this.parser=t,this.parsedAttr=t.parsedAttr},parse(t,e){return this.defaults=e," "===t?t="&nbsp;":(t=this.app.broadcastHtml("editor.before.parse",t),t=this._parseInlineBlocks(t),t=this._clean(t),t=this.app.broadcastHtml("editor.parse",t)),t},_clean(t){let e=this.app.create("cleaner");return t=e.encodeCode(t),t=e.removeTags(t,this.opts.get("tags.denied")),t=e.removeTagsWithContent(t,["script","style"]),t=e.sanitize(t),t=e.removeEmptySpans(t),t=e.addHttps(t),t=this.parser.replaceTags(t)},_parseInlineBlocks(t){let e;return this.app.create("utils").wrap(t,function(t){t.find("["+this.opts.get("dataBlock")+"]").each(function(t){t.attr("data-rx-type")||(e=t.attr(this.opts.get("dataBlock")),this.app.create("block."+e,t))}.bind(this))}.bind(this))}}),o.add("class","unparser",{init(){this.defaults={type:"html",state:!1,clipboard:!1},this.parsedAttr="data-rx-type"},unparse(t,e){return this.defaults=o.extend(!0,this.defaults,e),this._unparse(t)},unparseClasses:t=>(t.removeClass("rx-block-placeholder rx-block-focus rx-block-meta-focus rx-block-control-focus rx-layout-grid"),t.removeClass("rx-nowrap"),t),_unparse(t){let e=this.opts.get("templateSyntax"),s=this.app.create("utils"),i=this.app.create("predefined"),a=this.app.create("parser"),r=this.app.create("cleaner"),o=this.opts.get("classes");return t=t.trim(),t=this.app.broadcastHtml("editor.before.unparse",t),this.app.has("email")&&!this.defaults.clipboard&&(t=this.app.email.unparseBlocks(t)),s.isEmptyHtml(t)?"":(t=r.revertForms(t),t=r.revertFrames(t),t=r.store(t,"noneditable"),t=r.store(t,"embed"),t=r.addNofollow(t),t=r.removeMarkers(t),t=r.removeInvisibleChars(t),t=r.restore(t,"noneditable"),t=r.restore(t,"embed"),t=r.recacheStyle(t),t=r.removeEmptyAttrs(t,["style","class","rel","alt","title"]),t=a.replaceTags(t),t=this._unparseAllTags(t),t=this._unparseDataType(t),t=this._unparseDataTag(t),t=r.removeEmptyAttrs(t,["style","class","rel","alt","title"]),o&&(t=s.wrap(t,function(t){i.parse(t)}.bind(this))),e&&(t=r.restoreTemplateSyntax(t,e)),"<p></p>"===t&&(t=""),this.app.has("email")&&(t=this.app.email.unparse(t)),t=(t=(t=r.decodeSpecialCharsInAttributes(t)).replace(/&amp;/g,"&")).replace(/&quot;(.*?)&quot;/gi,"'$1'"),t=s.replaceRgbToHex(t),this.app.broadcastHtml("editor.unparse",t))},_unparseAllTags(t){return this.app.create("utils").wrap(t,function(t){t.find(".rx-ai-main").remove(),t.find(".rx-inserted-node").remove(),t.find("#rx-image-resizer").remove(),t.find("*").removeAttr("contenteditable data-gramm_editor data-rx-cont-width").removeClass("rx-mention-link"),this.opts.is("image.states")||t.find("img").removeAttr("data-image")}.bind(this))},_unparseDataType(t,e){let s,i=this.defaults.state,a=this.app.create("utils"),r=this.app.create("cleaner");return a.wrap(t,function(t){s=t.find("[data-rx-type]"),!0!==i&&s.removeClass("rx-block-state"),s.removeAttr("tabindex data-rx-parsed data-rx-width data-rx-first-level data-rx-inline data-rx-focusable"),s=this.unparseClasses(s),s.each(this._unparseByType.bind(this)),s.removeAttr("data-rx-type"),t.find("figcaption").removeAttr("data-rx-type data-placeholder").each(r.removeEmptyTag.bind(this))}.bind(this))},_unparseByType(t){let e=t.attr("data-rx-type");"embed"===e?this._unparseEmbed(t):"todo"===e&&this._unparseTodo(t)},_unparseDataTag(t){let e=this.app.create("utils");return t=(t=(t=e.wrap(t,function(t){t.find("[data-rx-tag]").each(function(t){let s=this.dom(t);s.removeAttr("data-rx-tag"),""===s.attr("style")&&s.removeAttr("style"),""===s.attr("class")&&s.removeAttr("class"),0===s.get().attributes.length&&this._unwrapNode(s,t,e)}.bind(this))}.bind(this))).replace(/<br\s?\/?>$/g,"")).replace(/<br\s?\/?><\/(td|th|div)>/g,"</$1>")},_unwrapNode(t,e,s){s.isEmptyHtml(t.html())?t.html("<br>").unwrap():e.lastChild&&"BR"===e.lastChild.tagName?t.unwrap():t.append("<br>").unwrap()},_unparseEmbed(t){let e=decodeURI(t.attr("data-embed-content"));t.find("."+this.opts.get("embed.classname")).html(e),t.removeAttr("data-embed-content")},_unparseTodo(t){let e=this.app.create("utils").findTodoItemTag(),s=this.opts.get("todo.templateItem"),i=this.opts.get("todo.templateItemDone"),a=this.opts.get("todo.template");t.find("li").each((t=>{let r="0"===t.attr("data-checked")?s:i;t.find("[data-rx-type]").removeAttr("data-rx-type"),t.removeAttr("data-checked");let o=t.find(e).html(),n=r+" "+o;a&&(n=a.replace(/\$checked/gi,r),n=n.replace(/\$content/gi,o)),t.html(n)}))}}),o.add("class","cleaner",{init(){this.stored={},this.storedIndex=0,this.storedComments=[],this._selectors={code:["pre","code"],embed:["figure"],noneditable:["["+this.opts.get("dataBlock")+"=noneditable]"],noparse:["[data-noparse]"],images:["img"],svg:["svg"],links:["a"],lists:["ul","ol"],headings:["h1","h2","h3","h4","h5","h6"]}},clean(t){t=this.app.broadcastHtml("editor.before.clean",t);let e={},s={},i=this._isPages(t),a=this._isHtmlMsWord(t),r=this._isEditor(t),o=this._isGDocs(t),n=this.opts.get("paste.blockTags"),l=this.opts.get("paste.inlineTags"),h=this.opts.get("paste.formTags"),p=this.opts.get("tags.denied"),d=n.concat(l).concat(h);return t=this.store(t,"embed",e,0),t=this.store(t,"svg",e,0),t=this.removeDoctype(t),t=(t=this.removeTags(t,p)).trim(),t=this.removeComments(t),t=(t=this.removeTagsWithContent(t,["script","style"])).replace(/div><br\s?\/?><div/gi,"div><br><br><div"),t=i?this._cleanPages(t):t,t=o?this._cleanGDocs(t):t,t=this.encodePhp(t),r&&(d=d.concat(["div"])),t=this.removeTagsExcept(t,d),t=a?this._cleanMsWord(t):t,s=this._removeClassesAttrs(t,e,r),t=s.html,s.flag||(t=this.restore(t,"embed",e)),t=this.restore(t,"svg",e),t=r?this.cacheStyle(t):this.removeStyleAttr(t),t=this.removeEmptyInlines(t),t=(t=(t=(t=(t=(t=(t=(t=(t=this.removeEmptySpans(t)).replace(/<figure[^>]*><\/figure>/gi,"")).replace(/<p>&nbsp;<\/p>/gi,"<p></p>")).replace(/<p><br\s?\/?><\/p>/gi,"<p></p>")).replace(/^<li/gi,"<ul><li")).replace(/<\/li>$/gi,"</li></ul>")).replace(/<br\s?\/?><\/li>/gi,"</li>")).replace(/<span><br\s?\/?>{1,2}<\/span>/gi,"")).replace(/<br\s?\/?><br\s?\/?>$/gi,""),(a||i||o)&&(t=(t=(t=(t=t.replace(/<p><\/p>/gi,"")).replace(/<p>\s<\/p>/gi,"")).replace(/<\/p><br\s?\/?><p>/gi,"</p><p>")).replace(/<\/(p|ul|ol)><br\s?\/?><h/gi,"</$1><h")),t=this._tidyCleanUp(t),this.app.broadcastHtml("editor.clean",t)},_tidyCleanUp(t){return this.app.create("utils").wrap(t,function(t){t.find(".Apple-converted-space").unwrap(),t.find("ul, ol").each(this._placeListToItem.bind(this)),t.find("li p").unwrap()}.bind(this))},_removeClassesAttrs(t,e,s){let i,a,r,o,n,l=!1,h=this.app.create("utils"),p=this.opts.get("paste.keepClass"),d=this.opts.get("paste.keepAttrs"),c=0!==p.length?p.join(","):"",g=0!==d.length?d.join(","):"";return!s&&this.app.event.isPasteEvent()&&(t=this.restore(t,"embed",e),l=!0),s||(t=h.wrap(t,(t=>{i=t.find("*"),i.not(c).removeAttr("class"),i.not(g).each((t=>{for(a=t.get(),r=a.attributes,o=r.length-1;o>=0;o--)n=r[o].name,"class"!==n&&"dir"!==n&&-1===n.search(/^data-/)&&("IMG"!==a.tagName||"src"!==n&&"alt"!==n)&&("A"===a.tagName&&("href"===n||"id"===n&&this.opts.is("paste.keepIdAttr")||"target"===n)||a.removeAttribute(n))}))}))),{html:t,flag:l}},_isEditor:t=>t.match(new RegExp('meta\\stype="rx-editor"',"i")),_isHtmlMsWord:t=>t.match(/class="?Mso|style="[^"]*\bmso-|style='[^'']*\bmso-|w:WordDocument/i),_isPages:t=>t.match(/name="Generator"\scontent="Cocoa\sHTML\sWriter"/i),_cleanPages:t=>t=(t=t.replace(/\sclass="s[0-9]"/gi,"")).replace(/\sclass="p[0-9]"/gi,""),_isGDocs:t=>-1!==t.search(/docs-internal-guid/i),_cleanGDocs(t){return t=(t=(t=(t=(t=(t=(t=this.app.create("utils").wrap(t,(function(t){t.find("h1, h2, h3, h4, h5, h6").each((function(t){t.find("span").unwrap()}))}))).replace(/ dir="[^>]*"/gi,"")).replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2")).replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3")).replace(/<span[^>]*(font-style:\s?italic;\s?font-weight:\s?(bold|600|700)|font-weight:\s?(bold|600|700);\s?font-style:\s?italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$4</i></b>")).replace(/<span[^>]*font-style:\s?italic[^>]*>([\w\W]*?)<\/span>/gi,"<i>$1</i>")).replace(/<span[^>]*font-weight:\s?(bold|600|700)[^>]*>([\w\W]*?)<\/span>/gi,"<b>$2</b>")},_cleanMsWord(t){let e=this.app.create("utils");t=(t=(t=(t=(t=(t=t.replace(/<!--[\s\S]+?-->/gi,"")).trim()).replace(/<(!|script[^>]*>.*?<\/script(?=[>\s])|\/?(\?xml(:\w+)?|meta|link|style|\w:\w+)(?=[\s/>]))[^>]*>/gi,"")).replace(/<(\/?)s>/gi,"<$1strike>")).replace(/&nbsp;/gi," ")).replace(/<span\s+style\s*=\s*"\s*mso-spacerun\s*:\s*yes\s*;?\s*"\s*>([\s\u00a0]*)<\/span>/gi,(function(t,e){return e.length>0?e.replace(/./," ").slice(Math.floor(e.length/2)).split("").join(""):""}));let s,i="",a=(t=(t=(t=(t=(t=(t=e.wrap(t,(t=>{t.find("p").each((function(t){let e=/mso-list:\w+ \w+([0-9]+)/.exec(t.attr("style"));e&&t.attr("data-listLevel",parseInt(e[1],10))})),this._parseWordLists(t),t.find("[align]").removeAttr("align"),this.opts.is("paste.keepNameAttr")||t.find("[name]").removeAttr("name"),t.find("span").each((function(t){let e=t.attr("style");/mso-list:Ignore/.exec(e)?t.remove():t.unwrap()})),t.find("[style]").removeAttr("style"),t.find("[class^='Mso']").removeAttr("class"),t.find("a").filter((function(t){return!t.attr("href")})).unwrap()}))).replace(/<p><img(.*?)>/gi,"<p><img$1></p><p>")).replace(/<p[^>]*><\/p>/gi,"")).replace(/<li>/gi,"<li>")).trim()).replace(/\/(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)>\s+<(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)/gi,"/$1>\n<$2")).split(/\n/),r=a.length,o=0;for(;o<r;o++)s=""!==a[o]&&-1===a[o].search(/>$/)?" ":"\n",i+=a[o]+s;return i=i.trim(),i},_parseWordLists(t){let e=0,s=null,i=null,a=null;t.find("p").each(function(t){let r=t.attr("data-listLevel");if(null===r&&t.hasClass("MsoListParagraphCxSpMiddle")&&(r=1),null!==r){let o=t.text(),n=/^\s*\w+\./.test(o)?"<ol></ol>":"<ul></ul>";if(t.hasClass("MsoListParagraphCxSpFirst")||t.hasClass("MsoNormal")?(i=this.dom(n),t.before(i)):r>e&&0!==e&&(a=this.dom(n),s.append(a),i=a),r<e){let t=e-r+1,s=0;for(;s<t;s++)i=i.parent()}t.find("span").first().unwrap(),s=this.dom("<li>"+t.html().trim()+"</li>"),null===i&&(t.before(n),i=t.prev()),i.append(s),t.remove(),e=r}else i=null,e=0}.bind(this))},_placeListToItem(t){let e,s=t.get(),i=s.previousSibling;i&&"LI"===i.tagName&&(e=this.dom(i),e.find("p").unwrap(),e.append(s))},escapeHtml:t=>t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),removeDoctype:t=>t.replace(new RegExp("<!doctype[^>]*>","gi"),""),removeComments:t=>t=t.replace(/<!--[\s\S]*?-->\n?/g,""),removeInvisibleChars:t=>t.replace(/\uFEFF/g,""),removeMarkers(t){return this.app.create("utils").wrap(t,function(t){t.find(".rx-plus-button").remove(),t.find(".rx-pastemarker").removeClass("rx-pastemarker"),t.find(".rx-pasteitems").removeClass("rx-pasteitems"),t.find(".rx-selection-marker").remove()}.bind(this))},removeEmptySpans(t){return this.app.create("utils").wrap(t,function(t){t.find("span").each(this.removeEmptySpan.bind(this))}.bind(this))},removeEmptyInlines(t){let e=this.app.create("utils"),s=this.opts.get("tags");return e.wrap(t,function(t){t.find(s.inline.join(",")).each(this.removeEmptyTag.bind(this))}.bind(this))},removeEmptyAttrs(t,e){return this.app.create("utils").wrap(t,(function(t){for(var s=0;s<e.length;s++)t.find("["+e[s]+'=""]').removeAttr(e[s])}))},removeEmptyTag(t){let e=t.html().trim();0===t.get().attributes.length&&""===e&&t.unwrap()},removeEmptySpan(t){0===t.get().attributes.length&&t.unwrap()},removeTags(t,e){let s=e?/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi:/(<([^>]+)>)/gi,i=e?function(t,s){return-1===e.indexOf(s.toLowerCase())?t:""}:"";return t.replace(s,i)},removeTagsWithContent(t,e){return this.app.create("utils").wrap(t,(function(t){t.find(e.join(",")).remove()}))},removeTagsExcept:(t,e)=>void 0===e?t.replace(/(<([^>]+)>)/gi,""):t.replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,(function(t,s){return-1===e.indexOf(s.toLowerCase())?"":t})),removeBlockTags(t,e,s){let i=this.opts.get("tags"),a=this.app.create("utils"),r=[...i.block];return s&&(r=a.removeFromArrayByValue(r,s)),e&&(r=e?a.extendArray(r,e):r),this.removeTags(t,r)},removeBlockTagsInside(t,e){let s=this.app.create("utils");return this.blockListTags=s.removeFromArrayByValue(this.opts.get("tags.block").concat(),["ul","ol","li"]),s.wrap(t,function(t){t.find(e.join(",")).each(this._removeBlockTagsInside.bind(this))}.bind(this))},_removeBlockTagsInside(t){let e=t.tag("li")?this.blockListTags:this.opts.get("tags.block");t.find(e.join(",")).append("<br>").unwrap()},removeInlineStyles(t){let e=this.app.create("utils"),s=e.removeFromArrayByValue(this.opts.get("tags.inline"),"a");return e.wrap(t,(function(t){t.find(s.join(",")).removeAttr("style")}))},removeStyleAttr(t,e){let s=this.app.create("utils");return e=e||"",s.wrap(t,function(t){t.find("*").not("[data-rx-style-cache]"+e).removeAttr("style")}.bind(this))},removeBreakline:t=>t.replace(/<br\s?\/?>/gi,""),addNofollow(t){if(!this.opts.is("link.nofollow"))return t;return this.app.create("utils").wrap(t,(function(t){t.find("a").attr("rel","nofollow")}))},addHttps(t){return this.opts.is("editor.https")?t=(t=(t=t.replace('href="http://','href="https://')).replace('src="http://','src="https://')).replace('srcset="http://','srcset="https://'):t},addBrToBlocks:t=>t.replace(/<\/(div|li|dt|dd|td|p|H[1-6])>\n?/gi,"</$1><br>"),convertForms(t){return this.app.create("utils").wrap(t,function(t){t.find("form").each(this._convertForm.bind(this))}.bind(this))},convertFrames(t){return this.app.create("utils").wrap(t,function(t){t.find("iframe").each(this._convertFrame.bind(this))}.bind(this))},revertForms(t){return this.app.create("utils").wrap(t,function(t){t.find(".rx-div-form").each(this._revertForm.bind(this))}.bind(this))},revertFrames(t){return this.app.create("utils").wrap(t,function(t){t.find(".rx-figure-iframe").each(this._revertFrame.bind(this))}.bind(this))},_convertForm(t){t.replaceTag("div").addClass("rx-div-form")},_convertFrame(t){0===t.closest("figure").length&&(t.wrap("<figure>"),t.parent().addClass("rx-figure-iframe"))},_revertForm(t){t.replaceTag("form").removeClass("rx-div-form")},_revertFrame(t){0===t.get().attributes.length&&0===t.find("figcaption").length&&0===t.find("div").length?t.unwrap():t.removeClass("rx-figure-iframe")},encodeEntities(t){return this.decodeEntities(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},encodePhp:t=>t=(t=(t=t.replace("<?php","&lt;?php")).replace("<?","&lt;?")).replace("?>","?&gt;"),encodeCode(t){return t=(t=(t=(t=(t=(t=(t=(t=this.encodeAttrSings(t)).replace(/<\s/gi,"&lt; ")).replace(/<([^>]+)</gi,"&lt;$1<")).replace(/<(.*?)>/gi,"xtagstartz$1xtagendz")).replace(/xtagstartzpre(.*?)xtagendz/g,"<pre$1>")).replace(/xtagstartzcode(.*?)xtagendz/g,"<code$1>")).replace(/xtagstartz\/codextagendz/g,"</code>")).replace(/xtagstartz\/prextagendz/g,"</pre>"),t=(t=(t=this._encodeCode(t)).replace(/xtagstartz([\w\W]*?)xtagendz/g,"<$1>")).replace(/xtagstartz\/(.*?)xtagendz/g,"</$1>"),t=this.decodeAttrSings(t)},encodeAttrSings(t){let e,s,i=t.match(/="(.*?)"/g),a=0;if(null!==i)for(a=0,e=i.length;a<e;a++)-1===i[a].search(/^"</)&&-1===i[a].search(/>"$/)&&(s=i[a].replace(">","xmoresignz"),s=s.replace("<","xlesssignz"),t=t.replace(i[a],s));return t},decodeAttrSings:t=>t=(t=t.replace(/xmoresignz/gi,">")).replace(/xlesssignz/gi,"<"),decodeEntities:t=>String(t).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&"),decodeHref(t){let e,s=t.match(new RegExp('(href=".*?)(&amp;)(.*?">)',"g")),i=0;if(null!==s)for(i=0,e=s.length;i<e;i++)t=t.replace(s[i],s[i].replace(/&amp;/g,"&"));return t},decodeSpecialCharsInAttributes:t=>t.replace(/<([a-z][a-z0-9]*)\b([^>]*)>/gi,(function(t,e,s){return`<${e}${s.replace(/(["'])(?:(?=(\\?))\2.)*?\1/g,(function(t){return t.replace(/&amp;/g,"&")}))}>`})),_encodeCode(t){return this.app.create("utils").wrap(t,function(t){t.find("pre code, pre, code").each(this._encodeNode.bind(this))}.bind(this))},_encodeNode(t){let e,s=t.get(),i=s.firstChild,a=s.innerHTML;"PRE"===s.tagName&&i&&"CODE"===i.tagName||(a=a.replace(/xtagstartz/g,"<"),a=a.replace(/xtagendz/g,">"),e=this.decodeEntities(a),s.textContent=this._encodeNodeHtml(e))},_encodeNodeHtml(t){let e=this.opts.get("pre.spaces");return t=t.replace(/&nbsp;/g," ").replace(/<br\s?\/?>/g,"\n"),t=e?t.replace(/\t/g,new Array(e+1).join(" ")):t},store(t,e){let s,i,a=this._selectors[e],r=0;for(r=0,s=a.length;r<s;r++)i=this._getElementsFromHtml(t,a[r]),t=this._store(t,e,i);return t},storeComments(t){let e=t.match(new RegExp("\x3c!--([\\w\\W]*?)--\x3e","gi"));if(null===e)return t;t=this.store(t,"code");for(let s=0;s<e.length;s++)t=t.replace(e[s],"#####xstarthtmlcommentzz"+s+"xendhtmlcommentzz#####"),this.storedComments.push(e[s]);return t=this.restore(t,"code")},storeTemplateSyntax(t,e){let s;for(let[i,a]of Object.entries(e))s="ts__"+i,t=t.replace(new RegExp(a[0]+"(.*?)"+a[1],"gi"),"\x3c!--"+s+"$1"+s+"--\x3e");return t},restore(t,e){let s,i=0;if(void 0===this.stored[e])return t;for(i=0,s=this.stored[e].length;i<s;i++)t=t.replace("####_"+e+i+"_####",this.stored[e][i]);return t},restoreComments(t){let e;for(let s=0;s<this.storedComments.length;s++)e=this.storedComments[s].replace(/\$/gi,"&#36;"),t=t.replace("#####xstarthtmlcommentzz"+s+"xendhtmlcommentzz#####",e);return t},restoreTemplateSyntax(t,e){let s,i=this.app.create("utils");for(let[a,r]of Object.entries(e))s="ts__"+a,t=t.replace(new RegExp("\x3c!--"+s+"(.*?)"+s+"--\x3e","gi"),i.escapeBackslash(r[0])+"$1"+i.escapeBackslash(r[1]));return t=t.replace(/\{\{&gt;/gi,"{{>")},cacheStyle(t){let e=this.app.create("utils"),s=this.opts.get("tags"),i=s.block.join(",")+",img,"+s.inline.join(",");return e.wrap(t,function(t){t.find(i).each(this.cacheElementStyle.bind(this))}.bind(this))},cacheElementStyle(t){let e="data-rx-style-cache",s=t.attr("style");s?(s=s.replace(/"/g,""),t.attr(e,s)):s&&""!==s||t.removeAttr(e)},recacheStyle(t){return this.app.create("utils").wrap(t,function(t){t.find("[data-rx-style-cache]").each(this.recacheElementStyle.bind(this))}.bind(this))},recacheElementStyle(t){let e="data-rx-style-cache",s=t.attr(e);t.attr("style",s).removeAttr(e)},_store(t,e,s){if(!s)return t;void 0===this.stored[e]&&(this.stored[e]=[]);for(let i=0,a=s.length;i<a;i++)this.stored[e][this.storedIndex]=s[i],t=t.replace(s[i],"####_"+e+this.storedIndex+"_####"),this.storedIndex++;return t},_getElementsFromHtml(t,e){let s=[];return this.dom("<div>").html(t).find(e).each((function(t){s.push(t.outer())})),s},sanitize(t){return t=this.app.create("utils").wrap(t,function(t){t.find("[src]").each(this._sanitizeSrc),t.find("a").each(this._sanitizeHref),t.find("a,b,i,strong,em,svg,img,details,audio").each(this._sanitizeEvents)}.bind(this))},_sanitizeSrc(t){let e=t.get(),s=e.getAttribute("src");(-1!==s.search(/^javascript:/i)||"IMG"!==e.tagName&&-1!==s.search(/^data:/i))&&e.setAttribute("src","")},_sanitizeHref(t){let e=t.get(),s=e.getAttribute("href");s&&-1!==s.search(/^javascript:/i)&&e.setAttribute("href","")},_sanitizeEvents(t){t.removeAttr("onload onerror ontoggle onwheel onmouseover oncopy")}}),o.add("class","button",{init(t,e,s,i){this.$container=s,this.name=t,this.type=i,this.$button=null,this.icon=null,this.$title=null,this.props=new h(this,e),this.builder=new d(this),this.styler=new u(this),this.state=new g(this),this.behavior=new p(this),this.command=new c(this),this.behavior.checkObserve()&&this.behavior.checkPermissions()&&this.builder.build()},observe(){this.behavior.observe()},has(t){return this.props.has(t)},isButton:()=>!0,getType(){return this.type},getToolbarType(){return this.$button.attr("data-toolbar")},getName(){return this.name},getContainer(){return this.$container},getTemplate(){return this.props.get("template")},getObj(){return this.props.dump()},getParams(){return this.props.get("params")},getElement(){return this.$button},getIcon(){return this.$icon.html()},getTitle(){return this.title},getTitleText(){return this.$title.text()},getOffset(){return this.$button.offset()},getRect(){let t=this.$button.offset(),e=this.$button.width(),s=this.$button.height(),i=Math.round(t.top),a=Math.round(t.left);return{top:i,left:a,bottom:i+s,right:a+e,width:e,height:s}},getWidth(){return this.$button.width()},getHeight(){return this.$button.height()},getDimension(){return{width:this.getWidth(),height:this.getHeight()}},setColor(t){this.styler.setColor(t)},setBackground(t){this.styler.setBackground(t)},resetColor(){this.styler.resetColor()},resetBackground(){this.styler.resetBackground()},setToggled(){this.state.setToggled()},setActive(){this.state.setActive()},unsetToggled(){this.state.unsetToggled()},unsetActive(){this.state.unsetActive()},disable(){this.state.disable()},enable(){this.state.enable()},setCommand(t){this.command.setCommand(t)},getCommand(){return this.command.getCommand()},trigger(t,e){this.command.trigger(t,e)},setTitle(t){this.builder.setTitle(t)},setIcon(t){this.builder.setIcon(t)}}),o.add("class","predefined",{parse(t){t=t||this.app.getLayout();this.opts.get("classes")&&(this._parseElements(t,"tags",this._addTagClass.bind(this)),this._parseElements(t,"blocks",this._addBlockClass.bind(this)))},_parseElements(t,e,s){const i=this.opts.get(`classes.${e}`);if(!i)return;const a=this._buildSelector(e,i);t.find(a).each(s)},_buildSelector(t,e){if("tags"===t)return Object.keys(e).join(",");if("blocks"===t){const t="data-rx-type";return Object.keys(e).map((e=>`[${t}="${e}"]`)).join(",")}},_addTagClass(t){const e=t.tag(),s=this.opts.get("classes.tags");s[e]&&t.addClass(s[e])},_addBlockClass(t){const e=t.attr("data-rx-type"),s=this.opts.get("classes.blocks");s[e]&&t.addClass(s[e])}}),o.add("class","tidy",{parse(t,e){let s=["li"],i=["li"],a=["p","ul","ol","li","div","h1","h2","h3","h4","h5","h6","blockquote","figure","figcaption","table","thead","tbody","tfoot","tr","td","th","dl","dt","dd"],r=0,o=(t=this.app.create("cleaner").encodeAttrSings(t)).length,n=0,l=null,h=null,p="",d="",c="";for("email"===e&&(s=[...s,"style","meta"],a=[...a,"title","head","body"]),this.lineBefore=new RegExp("^<(/?"+s.join("|/?")+"|"+i.join("|")+")[ >]"),this.lineAfter=new RegExp("^<(/?"+s.join("|/?")+"|/"+i.join("|/")+")[ >]"),this.newLevel=new RegExp("^</?("+a.join("|")+")[ >]"),this.cleanlevel=0;r<o;r++){if(n=r,-1===t.substr(r).indexOf("<"))return d+=t.substr(r),this.finish(d);for(;n<o&&"<"!==t.charAt(n);)n++;for(r!==n&&(c=t.substr(r,n-r),c.match(/^\s{2,}$/g)||("\n"===d.charAt(d.length-1)?d+=this.getTabs():"\n"===c.charAt(0)&&(d+="\n"+this.getTabs(),c=c.replace(/^\s+/,"")),d+=c)),l=n;n<o&&">"!==t.charAt(n);)n++;var g;if(p=t.substr(l,n-l),r=n,"!--"===p.substr(1,3)){if(!p.match(/--$/)){for(;"--\x3e"!==t.substr(n,3);)n++;n+=2,p=t.substr(l,n-l),r=n}"\n"!==d.charAt(d.length-1)&&(d+="\n"),d+=this.getTabs(),d+=p+">\n"}else"!"===p[1]?d=this.placeTag(p+">",d):"?"===p[1]?d+=p+">\n":g===p.match(/^<(script|style|pre)/i)?(g[1]=g[1].toLowerCase(),p=this.cleanTag(p),d=this.placeTag(p,d),h=String(t.substr(r+1)).toLowerCase().indexOf("</"+g[1]),h&&(c=t.substr(r+1,h),r+=h,d+=c)):(p=this.cleanTag(p),d=this.placeTag(p,d))}return this.finish(d)},getTabs(){let t="",e=0;for(;e<this.cleanlevel;e++)t+="    ";return t},finish(t){let e=this.app.create("cleaner");return t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/\n\s*\n/g,"\n")).replace(/^[\s\n]*/,"")).replace(/[\s\n]*$/,"")).replace(/<li(.*?)>[\s\n]*/gi,"<li$1>")).replace(/<(p|h1|h2|h3|h4|h5|h6|li|td|th)(.*?)>[\s\n]*<\/\1>/gi,"<$1$2></$1>")).replace(/[\s\n]*<\/li>/gi,"</li>")).replace(/<script(.*?)>\n<\/script>/gi,"<script$1><\/script>")).replace(/\n(.*?)<link(.*?)><style/gi,"\n$1<link$2>\n$1<style")).replace(/\n\s*<pre/gi,"\n<pre")).replace(/><link/gi,">\n<link")).replace(/><\/head/gi,">\n</head"),t=e.decodeAttrSings(t),this.cleanlevel=0,t},cleanTag(t){let e,s="",i="";for((t=(t=(t=t.replace(/\n/g," ")).replace(/\s{2,}/g," ")).replace(/^\s+|\s+$/g," ")).match(/\/$/)&&(i="/",t=t.replace(/\/+$/,""));e=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/.exec(t);)e[2]?s+=e[1].toLowerCase()+"="+e[2]:e[1]&&(s+=e[1].toLowerCase()),s+=" ",t=t.substr(e[0].length);return s.replace(/\s*$/,"")+i+">"},placeTag(t,e){let s=t.match(this.newLevel);return(t.match(this.lineBefore)||s)&&(e=e.replace(/\s*$/,""),e+="\n"),s&&"/"===t.charAt(1)&&this.cleanlevel--,"\n"===e.charAt(e.length-1)&&(e+=this.getTabs()),s&&"/"!==t.charAt(1)&&this.cleanlevel++,e+=t,(t.match(this.lineAfter)||t.match(this.newLevel))&&(e=e.replace(/ *$/,""),e+="\n"),e}}),o.add("class","paragraphizer",{init(t){this.setting=t},parse(t){return!1===this.setting?t:(t=this._parse(t),t=this._parseTable(t))},parseLayers(t){let e;return this.app.create("utils").wrap(t,function(t){t.find('[data-rx-type="wrapper"]').each(function(t){e=this._parse(t.html()),t.html(e)}.bind(this)),t.find('[data-rx-type="column"]').each(function(t){e=this._parse(t.html()),t.html(e)}.bind(this))}.bind(this))},_parse(t,e){this.remStart="#####replace",this.remEnd="#####",this.tags=this._getTags(),this.tags=[...this.tags,...o.customTags];let s,i,a=this.opts.get("breakline"),r=a||e?"sdivtag":this.opts.get("markup"),n=e?"tbr":"br",l="",h=0,p=[],d=this.app.create("cleaner");for(t=this._storeTags(t,p),t=d.store(t,"svg"),t=(t=d.storeComments(t)).trim(),t=(t=(t=(t=(t=this._trimLinks(t)).replace(/xparagraphmarkerz(?:\r\n|\r|\n)$/g,"")).replace(/xparagraphmarkerz$/g,"")).replace(/xparagraphmarkerz(?:\r\n|\r|\n)/g,"\n")).replace(/xparagraphmarkerz/g,"\n"),l="",s=(t=a?(t=(t=t.replace(/<br\s?\/?>(?:\r\n|\r|\n)/gi,"xbreakmarkerz\n")).replace(/<br\s?\/?>/gi,"xbreakmarkerz\n")).replace(/xbreakmarkerz\n<\//gi,"xbreakmarkerz</"):(t=(t=t.replace(/<br\s?\/?><br\s?\/?>$/gi,"")).replace(/[\n]+/g,"\n")).replace(/<br\s?\/?><br\s?\/?>/g,"\n")).split("\n"),h=0,i=s.length;h<i;h++)l+="<"+r+">"+s[h].trim()+"</"+r+">\n";return t=(t=(t=(t=l.replace(/\n$/,"")).replace(new RegExp("<"+r+">\\s+#####","gi"),"#####")).replace(new RegExp("<"+r+">#####","gi"),"#####")).replace(new RegExp("#####</"+r+">","gi"),"#####"),t=a?t.replace(/xbreakmarkerz/gi,"<br>"):t,t=this._restoreTags(t,p),t=d.restore(t,"svg"),t=d.restoreComments(t),a&&(t=(t=t.replace(new RegExp("<"+r+"></"+r+">","gi"),"<"+r+"><br></"+r+">")).replace(/<\/?br\s?\/?><\/div>/gi,"</div>")),t=t.replace(/<(p|h1|h2|h3|h4|h5|h6|li|td|th)(.*?)>[\s\n]*<\/\1>/gi,"<$1$2></$1>"),t=(t=(t=(t=(t=(t=(t=this._has("cleanBreakline")&&!this._is("cleanBreakline")?t:t.replace(/<p(.*?)><\/?br\s?\/?><\/p>/gi,"<p$1></p>")).replace(/<div(.*?)><\/?br\s?\/?><\/div>/gi,"<div$1></div>")).replace(/<\/?br\s?\/?><\/div>/gi,"</div>")).replace(/<\/?br\s?\/?><\/li>/gi,"</li>")).replace(new RegExp("<sdivtag>","gi"),'<div data-rx-tag="'+n+'">')).replace(new RegExp("sdivtag","gi"),"div")).replace(/<\/([^>]+)><div data-rx-tag/g,"</$1>\n<div data-rx-tag"),a&&(t=t.replace(/<\/?br\s?\/?><\/div>/gi,"</div>")),t},_parseTable(t){return this.app.create("utils").wrap(t,function(t){t.find("td, th").each(this._parseCell.bind(this))}.bind(this))},_parseCell(t){let e,s=this.dom(t);e=this._parse(s.html(),"table"),e=this._parseTable(e),s.html(e)},_getTags:()=>["pre","hr","ul","ol","p","h1","h2","h3","h4","h5","h6","table","address","blockquote","figure","iframe","form","dl","div","section","header","footer","article","main","aside","form","audio","figcaption","object","style","script","iframe","select","input","textarea","button","option","map","area","math","fieldset","legend","hgroup","nav","details","menu","summary"],_storeTags(t,e){return this.app.create("utils").wrap(t,function(t){t.find(this.tags.join(", ")).each(function(t,s){this._replaceTag(t,s,e)}.bind(this))}.bind(this))},_restoreTags(t,e){for(let s=0;s<e.length;s++){let i=e[s].replace(/\$/gi,"&#36;");t=t.replace(this.remStart+s+this.remEnd,i)}return t},_replaceTag(t,e,s){let i=t.get(),a=document.createTextNode(this.remStart+e+this.remEnd+"xparagraphmarkerz");s.push(i.outerHTML),i.parentNode.replaceChild(a,i)},_trimLinks(t){return this.app.create("utils").wrap(t,function(t){t.find("a").each(this._trimLink.bind(this))}.bind(this))},_trimLink(t){t.html(t.html().trim())},_has(t){return this.setting&&void 0!==this.setting[t]},_is(t){return this.setting[t]}}),o.add("class","tooltip",{init(t,e){this.eventname="rx-button-"+this.uuid,this._attachTooltipHandlers(t,e)},_attachTooltipHandlers(t,e){(e=this._sanitizeTitle(e))&&(t.on(`mouseover.${this.eventName}`,this._showTooltip.bind(this)),t.on(`mouseout.${this.eventName}`,this._hideTooltip.bind(this)))},_sanitizeTitle:t=>!!t&&t.replace(/(<([^>]+)>)/gi,""),_hideTooltip(){this.$tooltip&&(this.$tooltip.remove(),this.$tooltip=null)},_showTooltip(t){this.app.$body.find(".rx-tooltip").remove();let e=this._getButtonFromEvent(t);this._shouldPreventTooltip(e)||(this.$tooltip=this._createTooltip(e),this.app.$body.append(this.$tooltip),this._setPosition(e))},_shouldPreventTooltip(t){return this.app.modal.isOpen()||t.hasClass("disable")||this.app.dropdown.isOpen()&&"toolbar"===this.app.ui.getState().type},_getButtonFromEvent(t){return this.dom(t.target).closest(".rx-button")},_createTooltip(t){return this.dom("<span>").addClass("rx-tooltip").html(t.attr("data-tooltip")).css("z-index",this._calculateZIndex())},_calculateZIndex(){return this.app.isProp("fullscreen")?10002:1060},_setPosition(t){const e=t.attr("data-toolbar"),s=t.offset(),i=this._getButtonDimensions(t),a=this._getTooltipDimensions(),r=this._calculatePosition(e,s,i,a);this.$tooltip.css({top:r.top+"px",left:r.left+"px","z-index":this._calculateZIndex()}),this.$tooltip.attr({dir:this.opts.get("dir"),"rx-data-theme":this.app.editor.getTheme()})},_calculatePosition(t,e,s,i){let a=this.app.editor.getRect(),r=e.top+s.height,o=e.left;return a.right<e.left+i.width&&(o=e.left+s.width-i.width),"context"===t?r=e.top-i.height-2:this.app.dropdown.isPositionTop()&&(r=e.top+s.height+2),{top:r,left:o}},_getTooltipDimensions(){return{width:this.$tooltip.width(),height:this.$tooltip.height()}},_getButtonDimensions:t=>({height:t.height(),width:t.width()})}),o.add("class","element",{is(t,e,s=!0){const i="text"===e?t:this._node(t),a={inline:()=>this._isElement(i)&&this._isInlineTag(i.tagName,s&&i),"block-data":()=>this._isElement(i)&&i.hasAttribute("data-rx-type"),"block-data-not-inline":()=>this._isElement(i)&&i.hasAttribute("data-rx-type")&&!i.hasAttribute("data-rx-inline"),"block-first":()=>this._isElement(i)&&i.hasAttribute("data-rx-first-level"),block:()=>this._isElement(i)&&this._isBlockTag(i.tagName),element:()=>this._isElement(i),text:()=>"string"==typeof i&&!/^\s*<(\w+|!)[^>]*>/.test(i)||this._isTextNode(i),list:()=>this._isElement(i)&&["ul","ol"].includes(i.tagName.toLowerCase()),heading:()=>this._isElement(i)&&["h1","h2","h3","h4","h5","h6"].includes(i.tagName.toLowerCase())};return!!a[e]&&a[e]()},isTool(t){return this.dom(t).closest(".rx-in-tool").length>0},isType(t,e){return e==this.getType(t)},isTag(t,e){return this._node(t).tagName.toLowerCase()===e},isEmpty(t){let e=this._node(t);return!e||(3===e.nodeType?!e.textContent.trim().replace(/\n/,""):!e.innerHTML)},isScrollVisible(t,e=null){const s=this.dom(t).offset().top,i=e||this.app.scroll.getTarget();return s<=i.scrollTop()+i.height()},isElementVisibleInScroll(t){const e=this.app.editor.getEditor(),s=this.dom(e).get().getBoundingClientRect(),i=this.dom(t).get().getBoundingClientRect();return i.top>=s.top&&i.bottom<=s.bottom},scrollTo(t,e=60){if(t=this.dom(t),!this.isScrollVisible(t)){const s=t.offset().top-e,i=this.app.scroll.getTarget();i.scrollTop(s),setTimeout((()=>i.scrollTop(s)),1)}},getInlines(t,e){if(!t)return[];let s=this.app.create("element"),i=this._node(t);i.nodeType===Node.TEXT_NODE&&(i=i.parentNode);const a=[];for(;i;){if(i.nodeType===Node.ELEMENT_NODE&&s.is(i,"inline")){if(i.tagName.toLowerCase()===e)break;a.push(i)}i=i.parentNode}return a},getType(t){return this.dom(t).attr("data-rx-type")},getDataBlock(t,e){const s=e?`[data-rx-type=${e}]`:"[data-rx-type]",i=this.dom(t).closest(s);return!!i.length&&i},getFirstLevel(t){return this.dom(t).closest("[data-rx-first-level]")},compareStyle(t,e){const s=this.app.create("utils"),i=this.dom(t),a=s.cssToObject(i.attr("style"));return Object.keys(a).length===Object.keys(e).length&&Object.entries(e).every((([t,e])=>{const s=a[t];return void 0!==s&&this._normalizeValue(t,s)===this._normalizeValue(t,e)}))},hasAttrs(t,e){const s=this.dom(t);return Object.entries(e).every((([t,e])=>s.attr(t)===e))},hasStyle(t,e){if(!e)return!1;const s=this.dom(t);return Object.entries(e).every((([t,e])=>{const i=s.css(t);return this._normalizeValue(t,i)===this._normalizeValue(t,e)}))},hasParent(t,e){return 0!==this.dom(t).closest("[data-rx-type="+e+"]").length},splitAtCaret(t){const e=this.split(t);this.app.block.set(e,"start")},split(t){const e=this.dom(t),s=this._node(t).tagName.toLowerCase(),i=this.app.create("utils").extractHtmlFromCaret(t);let a=this.dom(`<${s}>`);this.dom(t).cloneAttrs(a),11===i.nodeType?a.append(this.dom(i)):a.append(i),e.after(a);const r=e.children().last();this.is(r,"inline")&&!r.html().trim()&&r.remove();const o=this.getType(a);return o&&this.app.create(`block.${o}`,a),e.html().trim()||e.remove(),a},getAttrs(t){const e=this._node(t),s={};if(e&&e.attributes)for(const t of e.attributes){let e=t.nodeValue;e=this._convertAttributeValue(t.nodeName,e),s[t.nodeName]=e}return s},removeEmptyAttr(t,e){const s=this.dom(t);return""===s.attr(e)&&(s.removeAttr(e),!0)},getBlocks(t,e){const s=this._node(t);let i=e||this.opts.get("tags.parser");i=[...i,...o.customTags];const a=Array.from(s.childNodes).filter((t=>1===t.nodeType&&i.includes(t.tagName.toLowerCase())));return a},_node(t){return this.dom(t).get()},_convertAttributeValue(t,e){return this._isNumber(e)?parseFloat(e):this._isBooleanString(e)?"true"===e.toLowerCase():e},_getBooleanFromStr:t=>"true"===t||"false"!==t&&t,_isNumber:t=>!isNaN(t)&&!isNaN(parseFloat(t)),_isTag:t=>void 0!==t&&t,_isTextNode:t=>t&&3===t.nodeType,_isBlockTag(t){return this.opts.get("tags.block").includes(t.toLowerCase())},_isInlineTag(t,e){return this.opts.get("tags.inline").includes(t.toLowerCase())&&(!e||!this.dom(e).hasClass("email-button"))},_isElement:t=>t&&t.nodeType&&1===t.nodeType,_normalizeValue(t,e){let s=this.app.create("utils");return e=(e="string"==typeof e?e.replace(/'/g,'"'):e).trim().replace(/;$/,""),(t.includes("color")||t.includes("background"))&&(e=(e=s.convertRgb2hex(e)).toLowerCase()),t.includes("family")&&(e=e.replace(/"/g,"")),e}}),o.add("class","fragment",{create(t){return this.is(t)?t:this._createFragment(t)},is:t=>"object"==typeof t&&t.frag,insert(t){let e=this.app.create("selection"),s=e.getRange();s&&(this._clearRangeIfNecessary(s,e),this._insertFragmentIntoRange(t,s))},_createFragment(t){let e=this._createContainer(t),s=document.createDocumentFragment(),i=[],[a,r]=this._appendChildrenToFragment(e,s,i);return{frag:s,first:a,last:r,nodes:i}},_createContainer(t){let e=this.dom("<div>");return"string"==typeof t?e.html(t):e.append(this.dom(t).clone(!0)),e.get()},_appendChildrenToFragment(t,e,s){let i,a=null,r=null,o=0;for(;i=t.firstChild;)s.push(e.appendChild(i)),0==o++&&(a=s[0]),r=i;return[a,r]},_clearRangeIfNecessary(t,e){if(e.isCollapsed()){let e=t.startContainer;3!==e.nodeType&&"BR"===e.tagName&&e.parentNode.removeChild(e)}else t.deleteContents()},_insertFragmentIntoRange(t,e){t.frag?e.insertNode(t.frag):e.insertNode(t)}}),o.add("class","insertion",{set(t){return this.insert(t,"set")},setEmpty(){this.app.editor.getLayout().html("")},insert(t,e){let s;return this.p=o.extend({},{target:!1,position:!1,html:!1,clean:!1,parse:!0,current:!1,instance:!1,caret:!1,remove:!0,type:!1,paragraphize:!0},t),this.p.html&&(this.p.html=this.app.broadcastHtml("editor.before.insert",this.p.html)),s="set"===e||this.app.editor.isSelectAll()?this._setContent():this._insertContent(),s&&this.app.broadcast("editor.insert",{inserted:s}),setTimeout(function(){this.app.observer.observe()}.bind(this),0),s},insertNewline(t,e){let s=e?"\n\n":"\n";return this._insertFragment({node:document.createTextNode(s)},t||"after")},insertPoint(t){const e=this.app.create("utils"),s=this.app.create("caret"),i=this.app.create("selection"),a=e.createInvisibleChar(),r=t.clientX,o=t.clientY,n=this.app.page.getDocNode();let l;if(n.caretPositionFromPoint){const t=n.caretPositionFromPoint(r,o);l=i.getRange(),l||(this.app.editor.focus(),l=n.createRange()),l.setStart(t.offsetNode,t.offset),l.collapse(!0),l.insertNode(a)}else n.caretRangeFromPoint&&(l=n.caretRangeFromPoint(r,o),l.insertNode(a));s.set(a,"after")},insertBreakline(t,e){const s=this.app.create("selection");let i=s.getNodes({type:"inline"});return!1!==e&&s.isCollapsed()&&0!==i.length?this._splitInline(i,document.createElement("br")):this._insertFragment({node:document.createElement("br")},t||"after")},insertNode(t,e,s){let i=this.app.create("selection");if(s){let e=i.getNodes({type:"inline"});if(0!==e.length)return this._splitInline(e,t)}return this._insertFragment({node:this.dom(t).get()},e)},insertHtml(t,e){return this._insertFragment({html:t},e)},insertText(t,e,s){let i,a,r=this.app.block.get(),o=this.app.create("selection"),n=this.app.create("caret"),l=this.app.create("utils");return!r||r&&!r.isEditable()?this.insert({html:t,caret:e}):(o.is()&&(t=s?t:l.getTextFromHtml(t,{nl:!0}),i=document.createTextNode(t),a=o.getRange(),a.deleteContents(),a.insertNode(i),e=e||"end",n.set(i,e)),this.app.context.close(),i)},detectPosition(t,e){if(e)return e;const s=this.app.create("caret");return e=s.is(t,"end")?"after":s.is(t,"start")?"before":"split"},_splitInline(t,e){const s=this.app.create("element"),i=this.app.create("caret");let a=s.split(t[0]);return a.before(e),""===a.html()?(i.set(a,"after"),a.remove()):i.set(a,"start"),this.dom(e)},_insertContent(){let t;return t=this.p.instance?this._insertInstance():"<br>"===this.p.html.trim()?this.insertBreakline():this._insertHtml(),t},_insertHtml(){let t=this.p.current?this.p.current:this.app.block.get(),e=this.app.create("utils");if("string"!=typeof this.p.html&&(this.p.html=this.dom(this.p.html).outer()),this.isEmpty=e.isEmptyHtml(this.p.html),this.isLine=e.isLine(this.p.html,this.p.type),this.isLine&&this.opts.is("paste.paragraphizeLines")){this.isLine=!1;let t=this.app.create("paragraphizer");this.p.html=t.parse(this.p.html)}if(!this.isEmpty){if(this.p.target)return this._createEmptyBlock(),this._insertToTarget();if(this.app.blocks.is())return this._createEmptyBlock(),this.app.context.close(),this._insertToBlocks();if(t){if(this._isTableToTable(t,this.p.html))return;if(this._isListToList(t,this.p.html))return this._insertToList(t);if(t&&(t.isEditable()||t.isType("quote")||t.isInline())){if(this.isEmpty)return;return this._insertToOneEditable(t)}return t&&!t.isEditable()?(this._createEmptyBlock(),this._insertToOneNotEditable(t)):void 0}return this._createEmptyBlock(),this._insertToEditor()}},_insertToTarget(){let t=this.p.position?this.p.position:"after",e=this.dom(this.p.target);this.p.html=this._clean(this.p.html);let s=this._parse(this.p.html),i=this.dom(s),a=this._getLastNode(s);return e[t](s),this.p.remove&&e.fadeOut(500,function(){e.remove(),this.app.block.set(a,"end",!1,!0)}.bind(this)),this.app.editor.build(),this.p.remove||this.app.block.set(a,"end",!1,!0),i},_insertToBlocks(){let t,e,s,i,a,r,o=this.app.create("selection"),n="before";return this.p.html=this._clean(this.p.html),t=this._parse(this.p.html),i=this.dom(t),this.isLine?t=this._insertFragment({fragment:t}):(o.truncate(),this.app.context.close(),a=this.app.blocks.get({last:!0,selected:!0,instances:!0}),r=a.getBlock(),a.isType("listitem")&&this._isListToList(a,this.p.html)?(e=this.dom(t),r[n](e.children())):r[n](t)),s=this._getLastNode(t),this.app.editor.build(),this.app.block.set(s,"end"),i},_insertToEditor(){let t,e,s,i,a,r,o=this.app.create("element");return this.p.html=this._clean(this.p.html),t=this._parse(this.p.html),i=this.dom(t),a=this._getLastNode(t),"top"===this.opts.get("addPosition")?(e=this.app.blocks.get({first:!0,instances:!0}),s="before"):(e=this.app.blocks.get({last:!0,instances:!0}),s="after"),r=e.getBlock(),r[s](t),o.scrollTo(a),this.app.editor.build(),this.app.block.set(a,"end"),i},_insertToList(t){let e,s,i,a,r,o=this.app.create("selection"),n=t.getBlock();return this.p.html=this._clean(this.p.html),i=this._parse(this.p.html),a=this.dom(i),r=this._getLastNode(i),t.isType("list")?(s=a.children(),n.append(s)):(e=this.detectPosition(n,e),o.truncate(),this.app.context.close(),"split"===e?(s=i,this._insertFragment({fragment:i})):(s=a.children(),n[e](s))),this.app.editor.build(),this.app.block.set(r,"end"),s},_insertToTable(t){},_insertToOneEditable(t){let e,s,i,a=this.app.create("utils"),r=this.app.create("selection"),o=this.app.create("element"),n=this.app.create("caret"),l=!1,h=this.p.position,p=t.getBlock();if(this.p.html=this._clean(this.p.html),this.p.html=this._cleanSpecial(this.p.html,t),e=this._parse(this.p.html),i=this.dom(e),s=this._getLastNode(e),t.isInline()&&(t.isEditable()||(n.set(p,"after"),t.remove())),this.isLine){let s=this.dom(e).find("li");if(t.isType("todoitem")){let t=this.dom("<div>").append(e);e=this._insertFragment({html:t.text()},this.p.caret?this.p.caret:"end")}t.isType("listitem")&&0!==s.length?(e=this.dom(e).find("li").html(),e=this._insertFragment({html:e},this.p.caret?this.p.caret:"end")):e=this._insertFragment({fragment:e},this.p.caret?this.p.caret:"end"),i=this.dom(e)}else{if(a.isEmptyHtml(p.html())?(l="input"!==this.p.type,h="after"):h=h||this.detectPosition(p,h),l||(r.truncate(),this.app.context.close()),"split"===h){let t=o.split(p).before(e);this._cleanUpPart(t)}else p[h](e);l&&t.remove(),this.app.editor.build(),this.app.block.set(s,"end")}return i},_insertToOneNotEditable(t){let e,s,i,a=t.getBlock();return this.p.html=this._clean(this.p.html),e=this._parse(this.p.html),i=this.dom(e),s=this._getLastNode(e),t.isType(["cell","row","column"])&&(a=(t=t.getParent()).getBlock()),a.after(e),this.app.editor.build(),this.app.block.set(s,"end"),i},_insertInstance(){let t,e,s,i,a=this.p.current?this.p.current:this.app.block.get(),r=this.p.position,o=this.app.create("element"),n=this.app.create("caret"),l=this.p.instance.getBlock(),h=!1,p=!1;if(this.p.caret=this.p.instance.isType(["table","quote","layout"])?"start":this.p.caret?this.p.caret:"end",!a){if("top"===this.opts.get("addPosition")?(a=this.app.blocks.get({first:!0,instances:!0}),r="before"):(a=this.app.blocks.get({last:!0,instances:!0}),r="after"),i=a.getBlock(),this.p.instance.isInline()){t=this.app.block.create().getBlock(),t.append(l)}else this.p.instance.isType("list")&&a.isType("list")&&(s=this.p.instance.getItems(),a.getBlock().append(s));return t?i[r](t):i[r](l),this.app.editor.build(),this.p.caret&&setTimeout(function(){this.app.block.set(l,this.p.caret),o.scrollTo(l)}.bind(this),0),this.p.instance}if(a.isEditable()&&(r=this.detectPosition(a.getBlock(),r)),this.p.instance.isType("table")&&(a.isType("table")||a.getClosest("table"))){if(!a.isType("table"))return;r="after"}if("duplicate"===this.p.type)i=a.getBlock(),i.after(l);else if(this.p.instance.isType("list")&&a.isType("listitem"))s=this.p.instance.getItems(),1===s.length&&""===s[0]?(s=this.p.instance.getBlock(),a.getBlock().append(s)):(e=o.split(a.getBlock()),e.prepend(s));else if(this.p.instance.isType("list")&&a.isType("list"))s=this.p.instance.getItems(),a.getBlock().append(s);else{if(i=a.getBlock(),this.p.instance.isInline()){if(a.isInline())r="after";else if(a.isEditable())r="fragment";else if(!a.isEditable()){r="after",t=this.app.block.create().getBlock(),t.append(l)}}else a.isInline()?(r="split",n.set(i,"after"),i=i.parent().closest("[data-rx-type]"),h=!0):a.isType(["cell","column"])?r=this.p.position?r:"prepend":a.isType(["row","figcaption"])?(r="split"===r?"after":r,i=a.getParent().getBlock()):a.isType("todo")?this.p.instance.isType("todoitem")?r="append":this.p.instance.isType("todo")&&(l=this.dom(this.p.instance.getBlock().contents()),r="append"):a.isType("quote")?r=a.isCaretStart()?"before":a.isCaretEnd()?"after":"split":a.isType("todoitem")?this.p.instance.isType("todoitem")?r="after":this.p.instance.isType("todo")?(l=this.p.instance.getItems(),r="after"):(i=a.getParent().getBlock(),a.getParent().isCaretStart()?r="before":a.getParent().isCaretEnd()?r="after":(r="split",p="list-empty",a.setCaret("end"))):a.isType("listitem")?(i=a.getBlock().parents("ul, ol").last(),a.getParentTopInstance().isCaretStart()?r="before":a.getParentTopInstance().isCaretEnd()?r="after":(r="split",p="list-normalize")):a.isType("list")&&"split"===r&&(p="list-empty");if("duplicate"===this.p.type&&(r="after"),!1===r&&(r="after"),"split"===r){if(e=o.split(i),e.before(l),"list-empty"===p)e.find("li").first().remove();else if("list-normalize"===p){let t=e.find("li").first(),s=t.clone();if(s.find("ol, ul").remove(),""===s.text().trim()){let s=t.find("ol, ul").first().children();s.find("ul, ol").each(function(t){t.removeAttr("data-rx-type"),this.app.create("block.list",t)}.bind(this)),e.find("li").each(function(t){t.removeAttr("data-rx-type"),this.app.create("block.listitem",t)}.bind(this)),t.before(s),t.remove()}}this._cleanUpPart(e)}else"fragment"===r?this._insertFragment({node:l.get()},"start"):t?i[r](t):i[r](l);(h||this.p.remove&&a.isEditable()&&a.isEmpty())&&a.remove()}return this.app.editor.build(),this.p.caret&&setTimeout(function(){this.app.block.set(l,this.p.caret)}.bind(this),0),this.p.instance},_insertFragment(t,e){let s,i,a=this.app.create("fragment"),r=this.app.create("caret");if(void 0!==t.html||t.fragment?(s=a.create(t.html||t.fragment),a.insert(s)):a.insert(t.node),e){let i=t.node?t.node:"start"===e?s.first:s.last;r.set(i,e)}if(i=t.node?t.node:s.nodes,Array.isArray(i))for(let t of i){let e=this.dom(t);if(!e.dataget("instance")){let t=e.attr("data-rx-type");t&&this.app.create("block."+t,e)}}return this.app.context.close(),this.dom(i)},_setContent(){let t,e,s,i,a,r=this.app.create("utils");return this.isEmpty=r.isEmptyHtml(this.p.html),this.isLine=r.isLine(this.p.html),this._createEmptyBlock(),this.p.html=this._clean(this.p.html),a=this._parse(this.p.html),i=this.dom(a),t=this._getLastNode(a),e=this._getFirstNode(a),this.app.editor.unsetSelectAll(),this.setEmpty(),this.app.editor.getLayout().append(a),this.p.caret&&(s="start"===this.p.caret?e:t,setTimeout(function(){this.app.block.set(s,this.p.caret)}.bind(this),0)),this.isEmpty&&this.app.broadcast("editor.empty"),this.app.editor.build(),this.app.broadcast("editor.set",{inserted:i}),i},_parse(t){let e,s=this.app.create("parser");return this.p.parse?e=s.parse(t,{type:this._getParseType(),nodes:!0,paragraphize:this.p.paragraphize}):(e=s.build(t),e=e.get().childNodes),e},_getParseType(){return this.isLine?"line":"html"},_clean(t){let e=this.app.create("cleaner");return this.p.clean?e.clean(t):t},_cleanSpecial(t,e){let s,i,a=this.app.create("cleaner"),r=e.getType();return-1!==["address","figcaption","quote","todoitem","dlist"].indexOf(r)?s=!0:"list"===r||"listitem"===r?(s=!0,i=["ul","ol","li"]):"pre"===r&&(s=!0),s&&(this.isLine=!0,"pre"===r?t=a.removeBreakline(t):"list"!==r&&"listitem"!==r&&(t=a.addBrToBlocks(t)),t=(t=a.removeBlockTags(t,undefined,i)).replace(/<br\s?\/?>\n?$/gi,"")),t},_cleanUpPart(t){t.find(".rx-block-focus").removeClass("rx-block-focus rx-block-control-focus"),t.removeClass("rx-block-focus rx-block-control-focus")},_createEmptyBlock(){this.isLine&&(this.p.html=this.app.block.createHtml(this.p.html))},_isListToList(t,e){t.getBlock();let s=t.getType(),i=this.dom("<div>").html(e);return i.find("meta").remove(),i.find("b").unwrap(),i=i.children().first(),("list"===s||"listitem"===s)&&0!==i.length&&-1!==["ul","ol"].indexOf(i.tag())},_isTableToTable(t,e){let s=t.getClosest("table"),i=this.dom("<div>").html(e);return s&&0!==i.find("table").length},_getFirstNode(t){return this.dom(t).first()},_getLastNode(t){return this.dom(t).last()}}),o.add("class","clipboard",{getContent(t){let e=this._determineContentType(t),s=t.getData(e),i=this.app.create("cleaner");return"text/plain"===e?i.escapeHtml(s):s},setContent(t,e,s){let i=t.clipboardData,a=this.app.create("utils"),r=this.app.create("unparser");e=this._cleanSvgWhitespace(e),e=this._prepareHtmlForClipboard(e,r),s=this._prepareTextForClipboard(e,s,a),i.setData("text/html",e),i.setData("text/plain",s)},isPlainText(t){let e=t.getData("text/plain"),s=t.getData("text/html");return!(s&&s.trim())&&null!==e},_cleanSvgWhitespace:t=>t.replace(/(\s*)<svg([^>]*?)>([\s\S]*?)<\/svg>(\s*)/g,(function(t,e,s,i,a,r,o){return" <svg"+s+">"+i.trim()+"</svg> "})),_determineContentType(t){return this.isPlainText(t)?"text/plain":"text/html"},_prepareHtmlForClipboard:(t,e)=>'<meta type="rx-editor"/>'+(t=e.unparse(t,{clipboard:!0})),_prepareTextForClipboard:(t,e,s)=>e||s.getTextFromHtml(t,{nl:!0})}),o.add("class","autoparse",{parse(t){if(!this.opts.is("paste.autoparse"))return t;let e=this.app.block.get(),s=[],i=this.app.create("cleaner");return t=this._preprocessHtml(t,i),t=this._storeAndReplaceTags(t,["figure","html","form","pre","div","span","video","object","iframe","code","a","img","link","script"],["div","img","html","span"],s),t=this._replaceLinksAndImages(t,e),t=this._restoreStoredHtml(t,s,i),t=this._restoreStoredHtml(t,s,i)},_preprocessHtml:(t,e)=>(t=e.storeComments(t),t=e.store(t,"svg"),e.removeDoctype(t)),_replaceLinksAndImages(t,e){return t=t.replace("&amp;","&"),t=this._formatLinks(t),this._replaceImages(t,e)},_storeAndReplaceTags:(t,e,s,i)=>(e.forEach((e=>{let a=s.includes(e)?`<${e}[^>]*>`:`<${e}[^>]*>([\\w\\W]*?)</${e}>`,r=t.match(new RegExp(a,"gi"));r&&r.forEach(((e,s)=>{t=t.replace(e,`#####replaceparse${i.length}#####`),i.push(e)}))})),t),_formatLinks(t){const e=this.opts.get("regex.aurl1"),s=this.opts.get("regex.aurl2"),i=this.opts.get("regex.imageurl");if((t.match(e)||t.match(s))&&!t.match(i)){let i=this.opts.get("paste.linkTarget"),a=this.opts.get("https")?"https":"http",r=!1!==i?` target="${i}"`:"";t=(t=t.replace(e,(t=>`<a href="${t}"${r}>${this._subLinkText(t)}</a>`))).replace(s,((t,e,s)=>`${e}<a href="${a}://${s}"${r}>${this._subLinkText(s)}</a>`))}return t},_replaceImages(t,e){const s=this.opts.get("regex.imageurl"),i=t.match(s);return i&&i.forEach((s=>{t=t.replace(s,this._splitBlock(e,`<img src="${s}">`))})),t},_restoreStoredHtml:(t,e,s)=>(e.forEach(((e,s)=>{t=t.replace(`#####replaceparse${s}#####`,e)})),t=s.restoreComments(t),s.restore(t,"svg")),_splitBlock:(t,e)=>t?`\n${e}\n`:e,_subLinkText(t){let e=this.opts.get("link.size");return t=(t=t.length>e?t.substring(0,e)+"...":t).includes("%")?t:decodeURIComponent(t)}}),o.add("class","stack",{init(){this.data=!1},create(t,e){this.params=o.extend({},{title:!1,footer:!1,setter:!1,getter:!1,form:!1,button:!1,width:"240px"},e),this.name=t,this._build(),this._buildBody(),this._buildFooter()},render(){this._renderForm(),this._renderFooter(),this.app.modal.updateWidth(this.params.width)},renderFocus(t){this.form&&this.form.renderFocus(t)},setData(t){this.data=t},hasForm(){return this.params.form},getTitle(){return this.params.title},getStack(){return this.$stack},getBody(){return this.$body},getForm(){return this.form},getButtonPrimary(){return this.$footer.find(".rx-form-button-primary")},getFooter(){return this.$footer},getFormItem(t){return this.form?this.form.getItem(t):null},getInput(t){return this.form?this.form.getInput(t):null},getTool(t){return this.form?this.form.getTool(t):null},getData(t){return this.form?this.form.getData(t):null},_build(){this.$stack=this.dom("<div>").addClass("rx-modal-stack")},_buildBody(){this.$body=this.dom("<div>").addClass("rx-modal-body"),this.$stack.append(this.$body)},_buildFooter(){this.$footer=this.dom("<div>").addClass("rx-modal-footer"),this.$stack.append(this.$footer)},_renderForm(){this.params.form&&(this.form=this.app.create("form"),this.form.create({data:this.data,setter:this.params.setter,getter:this.params.getter,items:this.params.form}),this.$form=this.form.getElement(),this.$body.append(this.$form))},_renderFooter(){this.footerbuttons=0;let t=this.params.footer;if(t){this.$footer.html("");for(let[s,i]of Object.entries(t))if(!1!==i){var e=this.app.create("stack-button",s,this,i);this.$footer.append(e.getElement()),this.footerbuttons++}}}}),o.add("class","stack-button",{init(t,e,s){this.prefix="rx",this.name=t,this.obj=s,this.popup=e,this.$button=this.dom("<button>").addClass(this.prefix+"-form-button"),this.$button.attr("data-name",this.name),this.$button.html(this.lang.parse(this.obj.title)),this.$button.dataset("instance",this),this._has("type")&&this.$button.addClass(this.prefix+"-form-button-"+this.obj.type),this._has("classname")&&this.$button.addClass(this.obj.classname),this._has("fullwidth")&&this.$button.addClass(this.prefix+"-form-button-fullwidth"),this._has("right")&&this.$button.addClass(this.prefix+"-form-button-push-right"),this.$button.on("click."+this.prefix+"-popup-button"+this.uuid,this._catch.bind(this))},getName(){return this.name},getElement(){return this.$button},invokeCommand(){this._invoke()},_has(t){return Object.prototype.hasOwnProperty.call(this.obj,t)},_catch(t){t.preventDefault(),t.stopPropagation(),this._has("command")?this._invoke(t):this._has("close")&&this.app.popup.close()},_invoke(t){this.app.api(this.obj.command,this.popup,this.name,t)}}),o.add("class","upload",{defaults:{type:"image",box:!1,url:!1,cover:!0,name:"file",data:!1,multiple:!0,placeholder:!1,progress:!0,hidden:!0,target:!1,success:!1,error:!1,remove:!1,trigger:!1,input:!1},init(t,e,s){this.eventname="rx-upload",t&&this._build(t,e,s)},send(t,e,s,i){this.p=this._buildParams(s,i),this._send(t,e)},complete:function(t,e){this._complete(t,e)},setImage(t){this.p.input||(this.$image&&this.$image.remove(),this.$remove&&this.$remove.remove(),""===t?this.$placeholder.show():(this.$placeholder.hide(),this._buildImage(t),this.p.remove&&this._buildRemove()))},_build(t,e,s){this.p=this._buildParams(e,s),this.$element=this.dom(t),this.$element.tag("input")?this._buildByInput():this._buildByBox()},_buildImage(t){this.$image=this.dom("<img>"),this.$image.attr("src",t),this.$box.append(this.$image),!1===this.p.input&&(this.$box.off("click."+this.eventname),this.$image.on("click."+this.eventname,this._click.bind(this)))},_buildRemove(){this.$remove=this.dom("<span>"),this.$remove.addClass("rx-upload-remove"),this.$remove.on("click",this._removeImage.bind(this)),this.$box.append(this.$remove)},_buildParams(t,e){return t=o.extend(!0,this.defaults,t),e&&(t.trigger=e),t},_buildByInput(){this.$input=this.$element,this.p.box?(this._buildBox(),this._buildPlaceholder()):this.p.input=!0,this._buildAccept(),this._buildMultiple(),this._buildEvents()},_buildByBox(){this._buildInput(),this._buildAccept(),this._buildMultiple(),this._buildBox(),this._buildPlaceholder(),this._buildEvents()},_buildBox(){this.$box=this.dom("<div>").addClass("rx-form-upload-box"),this.$element.before(this.$box),!1===this.p.cover&&this.$box.addClass("rx-form-upload-cover-off"),this.p.hidden&&this.$element.hide()},_buildPlaceholder(){this.p.placeholder&&(this.$placeholder=this.dom("<span>").addClass("rx-form-upload-placeholder"),this.$placeholder.html(this.p.placeholder),this.$box.append(this.$placeholder))},_buildInput(){this.$input=this.dom("<input>"),this.$input.attr("type","file"),this.$input.attr("name",this._getUploadParam()),this.$input.hide(),this.$element.before(this.$input)},_buildAccept(){if("image"===this.p.type){var t=this.opts.get("image.types").join(",");this.$input.attr("accept",t)}},_buildMultiple(){"image"===this.p.type&&(this.p.multiple?this.$input.attr("multiple","multiple"):this.$input.removeAttr("multiple"))},_buildEvents(){this.$input.on("change."+this.eventname+"-"+this.uuid,this._change.bind(this)),!1===this.p.input&&(this.$box.on("click."+this.eventname,this._click.bind(this)),this.$box.on("drop."+this.eventname,this._drop.bind(this)),this.$box.on("dragover."+this.eventname,this._dragover.bind(this)),this.$box.on("dragleave."+this.eventname,this._dragleave.bind(this)))},_buildData(t,e,s){if("single"===this.p.multiple)s.append(t,e[0]);else if(this.p.multiple)for(var i=0;i<e.length;i++)s.append(t+"[]",e[i]);else s.append(t+"[]",e[0]);return s},_removeImage(t){t&&(t.preventDefault(),t.stopPropagation()),this.$image&&this.$image.remove(),this.$remove&&this.$remove.remove(),this.$placeholder.show(),!1===this.p.input&&this.$box.on("click."+this.eventname,this._click.bind(this)),t&&this.app.api(this.p.remove,t)},_getUploadParam(){return this.p.name},_click(t){t.preventDefault(),this.$input.click()},_change(t){this._send(t,this.$input.get().files)},_drop(t){t.preventDefault(),this._send(t)},_dragover(t){return t.preventDefault(),this._setStatus("hover"),!1},_dragleave(t){return t.preventDefault(),this._removeStatus(),!1},_setStatus(t){!this.p.input&&this.p.box&&(this._removeStatus(),this.$box.addClass("rx-form-upload-"+t))},_removeStatus(){if(!this.p.input&&this.p.box)for(var t=["hover","error"],e=0;e<t.length;e++)this.$box.removeClass("rx-form-upload-"+t[e])},_send(t,e){e=e||t.dataTransfer.files;var s=new FormData,i=this._getUploadParam();let a=this.app.create("utils");s=this._buildData(i,e,s),s=a.extendData(s,this.p.data),this._sendData(t,e,s)},_sendData(t,e,s){"function"==typeof this.p.url?this.p.url.call(this.app,this,{data:s,files:e,e:t}):(this.app.progress.show(),this.ajax.post({url:this.p.url,data:s,before:function(i){if(this.app.broadcast("upload.before.send",{xhr:i,data:s,files:e,e:t}).isStopped())return this.app.progress.hide(),!1}.bind(this),success:function(e){this._complete(e,t)}.bind(this),error:function(e){this._complete(e,t)}.bind(this)}))},_complete(t,e){t&&t.error?(this._setStatus("error"),this.p.error&&(this.app.broadcast("upload.error",{response:t}),this.app.api(this.p.error,t,e))):(this._removeStatus(),this._trigger(t),this.p.success&&(this.app.broadcast("upload.complete",{response:t}),this.app.api(this.p.success,t,e))),setTimeout(function(){this.app.progress.hide()}.bind(this),500)},_trigger(t){if(this.p.trigger&&t&&t.url){var e=this.p.trigger.instance;e[this.p.trigger.method].call(e,t.url)}}}),o.add("class","colorpicker",{build(t){return this.$colorpicker=this.dom('<div class="rx-colorpicker rx-colorpicker-'+this.uuid+'">'),this._build(t,this.$colorpicker),this.app.$body.append(this.$colorpicker),this._buildPosition(),this._buildEvents(),this.$colorpicker},create(t){return this.$dropdown=this.dom('<div class="rx-dropdown-box">'),this._build(t,this.$dropdown),this.$dropdown.on("mouseleave.rx-colorpicker",this._outLayerColor.bind(this)),this.$dropdown},_buildPosition(t){let e=this.params.$toggle.offset(),s=this.params.$toggle.width(),i=e.top,a=e.left+s;0===e.left?this.$colorpicker.hide():this.$colorpicker.show(),this.$colorpicker.css({top:i+"px",left:a+"px"}),this.app.ui.buildDepth("colorpicker",this.$colorpicker)},_buildEvents(){this.app.scroll.getTarget().on("resize.rx-colorpicker scroll.rx-colorpicker",this._buildPosition.bind(this)),this.$colorpicker.on("mouseleave.rx-colorpicker",this._outLayerColor.bind(this))},_build(t,e){this.params=o.extend({},{$toggle:!1,colors:!1,method:!1,style:{},name:"color",tabs:!1,instant:!1,set:!1,input:!1,remove:!1},t),this.currentColor=!!this.params.style.color&&this.params.style.color,this.currentBackgroundColor=!!this.params.style.background&&this.params.style.background;let s,i,a=this.dom('<div class="rx-dropdown-layer rx-dropdown-layer-'+this.params.name+'">').attr("data-type",this.params.name);if(this.params.tabs){let t=this.dom('<div class="rx-dropdown-tabs">');e.append(t);let r=this.params.tabs;for(let o=0;o<r.length;o++){let n=this.dom('<a href="#">').attr("data-tab",r[o]).addClass("rx-dropdown-tab rx-dropdown-tab-"+r[o]).html(this.lang.get("colorpicker."+r[o]));if(n.on("click.rx-dropdown-tab",this._selectTab.bind(this)),0===o&&n.addClass("active"),t.append(n),s=this._buildPicker(r[o]),a=this.dom('<div class="rx-dropdown-layer rx-dropdown-layer-'+r[o]+'">').attr("data-type",r[o]),a.append(s),a.on("mouseover",this._outColor.bind(this)),this._createInput(a,r[o]),this.params.remove&&this.params.remove[r[o]]){let t=this.params.remove[r[o]];i=this.app.create("button","remove",this._createRemoveButton(r[o],t),!1,"dropdown"),a.append(i.getElement())}o===r.length-1&&a.hide(),e.append(a)}}else s=this._buildPicker(this.params.name),a.append(s),a.on("mouseover",this._outColor.bind(this)),this._createInput(a,this.params.name),this.params.remove&&(i=this.app.create("button","remove",this._createRemoveButton(this.params.name,this.params.remove),!1,"dropdown"),a.append(i.getElement())),e.append(a)},_createInput(t,e){if(!this.params.input)return;let s=this.dom("<div>").addClass("rx-form-box"),i=this.dom("<label>").addClass("rx-form-label").html(this.lang.get("colorpicker.set-color")),a=this.dom("<div>").addClass("rx-form-flex"),r=this.dom('<input type="input">').addClass("rx-form-input rx-form-input-"+e),o=this.dom('<button">').attr("data-rule",e).addClass("rx-form-button").html("&rarr;");o.on("click",this._setFromInput.bind(this));let n="color"===e?this.currentColor:this.currentBackgroundColor;n=n||"",r.val(n),a.append(r),a.append(o),s.append(i),s.append(a),t.append(s),this.input=!0},_createRemoveButton(t,e){return{position:"last",title:this.lang.get("colorpicker.remove-"+t),command:e}},_inColor(t){let e=this.dom(t.target).closest("a"),s=e.data("rule"),i=e.attr("rel"),a=e.closest(".rx-dropdown-layer"),r=a.find(".rx-form-input-"+s);if(this.params.instant&&this._setInstant(s,i),!a.attr("data-color")){let t=this.input?r.val():this.params.style.color;t="false"===t||""===t?"empty":t,a.attr("data-color",t)}this.input&&r.val(i)},_outLayerColor(t){let e=this.dom(t.target).find(".rx-dropdown-layer[data-color]"),s=e.data("type"),i=e.attr("data-color");this._clearColor(e,i,s)},_outColor(t){let e=this.dom(t.target);if(0!==e.closest(".rx-dropdown-color-box").length)return;let s=e.closest(".rx-dropdown-layer"),i=s.data("type"),a=s.attr("data-color");this._clearColor(s,a,i)},_clearColor(t,e,s){if(!e)return;let i="empty"===e?"":e;if(this.params.instant&&this._setInstant(s,i),t.removeAttr("data-color"),this.input){t.find(".rx-form-input-"+s).val(i)}},_selectTab(t){t.preventDefault(),t.stopPropagation();let e=this.dom(t.target),s=e.closest(".rx-dropdown-box"),i=e.attr("data-tab");s.find(".rx-dropdown-layer").each((t=>{let e=t.data("type"),s=t.attr("data-color");this._clearColor(t,s,e)})),s.find(".rx-dropdown-layer").hide(),s.find(".rx-dropdown-tab").removeClass("active"),s.find(".rx-dropdown-layer-"+i).show(),s.find(".rx-dropdown-tab-"+i).addClass("active")},_buildPicker(t){let e=this.dom('<div class="rx-dropdown-color-box rx-dropdown-box-'+t+'">'),s=this.dom('<div class="rx-dropdown-swatches">'),i="background"==t?"background":"color",a=(this.params.colors.length,this.opts.get("colorpicker.row")),r=this.opts.get("colorpicker.size"),o=this.opts.get("colorpicker.wrap"),n=this.opts.get("colorpicker.width");o&&s.addClass("rx-dropdown-swatches-wrap"),n&&s.css("max-width",n);for(let[t,e]of Object.entries(this.params.colors)){let o=this.dom('<div class="rx-dropdown-swatches-colors">');a&&o.addClass("rx-dropdown-swatches-colors-row");for(let s=0;s<e.length;s++){let a=e[s],n=this.dom('<a href="#" tabindex="-1" class="rx-dropdown-swatch">');r&&n.addClass("rx-dropdown-swatch-size-"+r),n.attr({rel:a,"data-rule":i}),n.css({background:a}),n.on("click",this._set.bind(this)),n.on("mouseover",this._inColor.bind(this)),n.attr({title:t+"-"+s}),"#fff"!==a&&"#ffffff"!==a||n.addClass("rx-dropdown-color-contrast"),"color"===i&&this.currentColor===a&&n.addClass("active"),"background"===i&&this.currentBackgroundColor===a&&n.addClass("active"),o.append(n)}s.append(o)}return e.append(s),e},_setFromInput(t){t.preventDefault(),t.stopPropagation();let e=this.dom(t.target),s=e.prev().val();if(""===s)return;let i=this.app.create("utils"),a=(this.app.create("offset"),i.normalizeColor(s)),r={tag:"span",style:"color"===e.data("rule")?{color:a}:{background:a}};this.app.inline.restoreOffset(),this._call(a,r,!1,!0)},_set(t){if(t.preventDefault(),t.stopPropagation(),this.$colorpicker&&this.$colorpicker.off(".rx-colorpicker"),this.params.instant&&!this.params.method){this.app.create("selection");return this.app.dropdown.close(),this.app.editor.restore(),void(this.$dropdown&&this.$dropdown.off(".rx-colorpicker"))}this._setCall(t)},_setCall(t){let e=this.dom(t.target).closest("a"),s=e.attr("rel"),i={tag:"span",style:"color"===e.data("rule")?{color:s}:{background:s}};this._call(s,i)},_setInstant(t,e){let s={tag:"span",style:"color"===t?{color:e}:{background:e}};this._call(e,s,!0)},_call(t,e,s,i){this.params.method?this.params.method.apply(this,[t,s,i]):this.app.api(this.params.set,e,s,i)}}),o.add("class","form",{init(){this.tools={},this.data=!1},create(t){this.params=o.extend({},{title:!1,data:!1,width:!1,items:!1,focus:!1,setter:!1,getter:!1,footer:!1},t),this.data=this.params.data,this._build(),this._buildTitle(),this._buildData(),this._buildForm(),this._buildFocus(),this._buildFooter()},renderFocus(t){this._buildFocus(t)},setData(t){this.data=t},getSetter(){return this.params.setter},getElement(){return this.$form},getItem(t){let e=this.getTool(t);return e?e.getInput().closest(".rx-form-item"):this.dom()},getInput(t){let e=this.getTool(t);return e?e.getInput():this.dom()},getTool(t){return void 0!==this.tools[t]&&this.tools[t]},getData(t){let e;return t?void 0!==this.tools[t]&&(e=this.tools[t].getValue()):(e={},Object.keys(this.tools).forEach(function(t){e[t]=this.tools[t].getValue()}.bind(this))),e},_build(){this.$form=this.dom("<div>").addClass("rx-form rx-form-"+this.uuid),this.params.width&&this.$form.css("width",this.params.width)},_buildData(){this.data||(this.data=!!this.params.getter&&this.app.api(this.params.getter,this))},_buildFocus(t){(t=t||this.params.focus)&&void 0!==this.tools[t]&&this.tools[t].setFocus()},_buildTitle(){this.params.title&&(this.$title=this.dom("<div>").addClass("rx-form-title"),this.$title.html(this.lang.parse(this.params.title)),this.$form.append(this.$title))},_buildFooter(){if(!this.params.footer)return;this.$footer=this.dom("<div>").addClass("rx-form-footer"),this.$form.append(this.$footer);let t=this.params.footer;for(let[s,i]of Object.entries(t)){var e=this.app.create("stack-button",s,this,i);this.$footer.append(e.getElement())}},_buildForm(){this._renderTools(),this._renderData(),this.$form.find("input[type=text],input[type=url],input[type=email]").on("keydown.rx-form",function(t){if(13===t.which)return t.preventDefault(),!1}.bind(this))},_renderTools(){for(let[t,e]of Object.entries(this.params.items))if(e.title){let t=this.dom('<div class="rx-form-section-title">');t.html(this.lang.parse(e.title)),this.$form.append(t)}else if("flex"===t){let t=this.dom('<div class="rx-form-container-flex">');this.$form.append(t);for(let[s,i]of Object.entries(e))this._renderTool(s,i,t)}else this._renderTool(t,e,this.$form)},_renderTool(t,e,s){let i=this.app.create("tool."+e.type,t,e,this,this.data),a=i.getElement();a&&(this.tools[t]=i,s.append(a))},_renderData(){if(this.data)for(let t in this.data)void 0!==this.tools[t]&&this.tools[t].setValue(this.data[t])}});class h{constructor(t,e){this.button=t,this.app=t.app,this.obj=e||{}}has(t){return Object.hasOwn(this.obj,t)}dump(){return this.obj}update(t){this.obj=t}get(t){return!!this.has(t)&&this.obj[t]}}class p{constructor(t){this.button=t,this.app=t.app,this.props=t.props}checkPermissions(){const t=this.app.block.get();return!(t&&!t.isAllowedButton(this.button.name,this.props.dump()))}checkObserve(){if(this.props.has("observer")){let t=this.fetchUpdatedObject();if(!t)return!1;this.props.update(t)}return!0}observe(){this.checkObserve()&&this.button.builder.update()}fetchUpdatedObject(){let t=this.app.api(this.props.get("observer"),this.props.dump(),this.button.name,this.button.type);return t||!1}}class d{constructor(t){this.button=t,this.app=t.app,this.lang=t.lang,this.dom=t.dom,this.opts=t.opts,this.props=t.props,this.initializeElements()}setTitle(t){t=this.lang.parse(t),this.$title.html(t),this.$button.attr({"aria-label":t,"data-tooltip":t})}setIcon(t){if(t.startsWith("<"))this.$icon.html(t);else{let e=this.opts.get("buttonsObj")[t];if(e){let t=this.getIconCode(e.icon);this.$icon.html(t)}}}initializeElements(){this.$button=this.dom("<a>").addClass("rx-button"),this.$icon=this.dom("<span>").addClass("rx-button-icon"),this.$title=this.dom("<span>").addClass("rx-button-title"),this.$button.append(this.$icon),this.$button.append(this.$title),this.button.$button=this.$button,this.button.$icon=this.$icon,this.button.$title=this.$title}build(){this.buildToolbarType(),this.configureButton(),this.configureIcon(),this.configureTitle(),this.configureData(),this.configureTooltip(),this.buildPosition(),this.button.state.build()}buildToolbarType(){"toolbar"===this.button.type||"extrabar"===this.button.type?this.toolbarType="toolbar":"dropdown"===this.button.type?this.toolbarType=!1:this.toolbarType=this.button.type}configureHtmlButton(){this.title=this.button.name,this.$button=this.dom("<div>"),this.$button.html(this.props.get("html")),this.renderClassname(this.props.get("classname"))}configureButton(){if(this.props.has("html"))return this.configureHtmlButton();this.$button.attr({href:"#",role:"button",tabindex:-1}),this.$button.dataset("instance",this.button),this.props.has("text")&&this.$button.addClass("rx-button-text"),this.props.has("danger")&&this.$button.addClass("rx-button-danger"),this.props.has("disable")&&!1!==this.props.get("disable")&&this.$button.addClass("disable"),this.button.type&&this.$button.addClass("rx-button-"+this.button.type),this.renderClassname(this.props.get("classname"))}configureIcon(){let t=this.props.has("icon")?this.getIconCode(this.props.get("icon")):"";t||(t=""),this.$icon.html(t)}configureTitle(){this.renderTitle(this.props.get("title"))}configureTooltip(){if(this.props.has("tooltip")&&!this.props.get("tooltip")||this.props.has("text"))return;-1===["control","dropdown","addbar","formatbar","inlinebar"].indexOf(this.button.type)&&(this.tooltip=this.app.create("tooltip",this.$button,this.title))}configureData(){this.$button.attr({"data-name":this.button.name,"data-toolbar":this.toolbarType}),this.renderCommand(this.props.get("command"))}buildPosition(){if(!this.button.$container)return;const{position:t}=this.props.dump();this.props.has("position")?this.positionButton(t):this.button.$container.append(this.$button)}positionButton(t){const e=Object.hasOwn(t,"after")?"after":"before",s=Object.hasOwn(t,"first"),i=t[e];if("first"===t)this.button.$container.prepend(this.$button);else if("last"===t)this.button.$container.append(this.$button);else if("object"==typeof t){if(this.findPosition(this.button.name).length>0)return;let t=this.findPosition(i);t?t[e](this.$button):this.button.$container[s?"prepend":"append"](this.$button)}}findPosition(t){return(Array.isArray(t)?t:[t]).map((t=>this.button.$container.find(`[data-name="${t}"]`))).find((t=>t.length))||!1}update(){this.renderTitle(this.props.get("title")),this.renderClassname(this.props.get("classname")),this.renderCommand(this.props.get("command")),this.renderIcon(this.props.get("icon"))}renderTitle(t){this.title=void 0!==t?this.lang.parse(t):"",this.$title.html(this.title),this.$button.attr({"data-tooltip":this.title,"aria-label":this.title}),this.button.title=this.title}renderClassname(t){t&&this.$button.addClass(t)}renderCommand(t){this.$button.attr("data-command",t||!1);let e=t?"catch":"stop";this.$button.off(".rx-button"),this.$button.on("click.rx-button",this.button.command[e].bind(this.button.command)),this.$button.on("dragstart.rx-button",(t=>t.preventDefault()))}renderIcon(t){t&&(t=this.getIconCode(t))&&this.$icon.html(t)}getIconCode(t){return this.opts.is("buttons.icons")&&this.opts.is("buttons.icons."+this.button.name)&&(t=this.opts.get("buttons.icons."+this.button.name)),t}}class c{constructor(t){this.button=t,this.dom=t.dom,this.app=t.app}setCommand(t){this.button.builder.renderCommand(t)}getCommand(){return this.button.$button.attr("data-command")}trigger(t,e){this.preventActions(t),this.app.editor.setFocus(),this.button.$button.hasClass("rx-in-dropdown")?this.catchDropdownClose():this.catchCommand(t,this.button.$button,e)}stop(t){this.preventActions(t)}catch(t){this.preventActions(t);let e=this.dom(t.target).closest(".rx-button");e.hasClass("disable")||(this.app.editor.setFocus(),e.hasClass("rx-in-dropdown")?this.catchDropdownClose(t):this.catchCommand(t,e))}catchDropdownClose(){this.app.dropdown.close(),this.app.ui.closeTooltip()}catchCommand(t,e,s){let i=e.attr("data-command"),a=e.attr("data-name"),r=e.dataget("instance"),o=this.button.getParams(),n=s||this.button.getToolbarType();n&&this.app.ui.setState({button:this.button,type:n}),this.app.api(i,o,r,a,t),this.app.ui.closeTooltip()}preventActions(t){t.preventDefault(),t.stopPropagation()}}class g{constructor(t){this.button=t,this.props=t.props,this.activeClass="active",this.disableClass="disable",this.toggledClass="toggled"}build(){this.props.get("active")&&this.button.$button.addClass(this.activeClass)}setToggled(){this.updateState([this.disableClass],[this.toggledClass])}setActive(){this.updateState([this.disableClass],[this.activeClass])}unsetToggled(){this.button.$button.removeClass(this.toggledClass)}unsetActive(){this.button.$button.removeClass(this.activeClass)}disable(){this.updateState([this.toggledClass,this.activeClass],[this.disableClass])}enable(){this.button.$button.removeClass(this.disableClass)}updateState(t,e){this.button.$button.removeClass(t.join(" ")).addClass(e.join(" "))}}class u{constructor(t){this.button=t,this.app=t.app}setColor(t){this.getSvg().attr("fill",t)}setBackground(t){let e=this.app.create("utils").getInvertedColor(t);this.button.$button.addClass("rx-button-icon-color"),this.button.$icon.css({"background-color":t}),this.getSvg().attr("fill",e)}resetColor(){this.getSvg().removeAttr("fill")}resetBackground(){this.button.$button.removeClass("rx-button-icon-color"),this.resetIconStyle()}resetIconStyle(){this.button.$icon.css("background-color",""),this.getSvg().removeAttr("fill")}getSvg(){return this.button.$icon.find("svg path")}}class m{constructor(t){this.app=t,this.dom=t.dom,this.config=t.config}handle(t){let e=t.get("e"),s=e.which,i=new b(e);if(!this._doSelectAll(e,i))if(i.is("enter","delete","backspace","alpha","space")&&this.app.control.updatePosition(),i.is("enter")&&i.is("shift"))this.handleShiftEnter(e,s,i);else if(i.is("enter"))this.handleEnter(e,s,i);else if(i.is("space")&&i.is("shift"))this.handleShiftSpace(e,s,i);else if(i.is("space"))this.handleSpace(e,s,i);else if(i.is("tab")&&this.config.is("tab.key"))this.handleTab(e,s,i);else if(i.is("arrow")){if(i.is("ctrl")&&i.is("up"))return void this.handleArrowCtrl(e,s,i);if(i.is("shift","alt","ctrl"))return;this.handleArrow(e,s,i)}else if(i.is("delete","backspace"))this.handleDelete(e,s,i);else if(i.is("alpha")){let t=this.app.block.get();if(t&&t.isType("cell")){t.setEmpty();let e=t.getFirstElement();this.app.block.set(e,"start")}}}handleSpace(t,e,s){let i=this.app.block.get(),a=this.app.create("selection"),r=this.app.create("caret");if(i&&i.isType(["column","embed"]))t.preventDefault();else{if(this.app.blocks.is()){let t=this.app.blocks.get({first:!0,selected:!0});return a.truncate(),r.set(t,"end"),void this.app.image.observeStates()}if(i)if(i.handleSpace&&i.handleSpace(t,e,s))this.app.image.observeStates();else if(i.isInline())(!i.isEditable()||i.isEditable()&&i.isAllSelected())&&(t.preventDefault(),r.set(i.getBlock(),"after"),i.remove());else{if(i.isEditable()&&i.isAllSelected())return t.preventDefault(),void i.setEmpty();if(!i.isEditable()){if(t.preventDefault(),i.isType("cell")){t.preventDefault(),i.getBlock().html("");let e=this.app.block.create();return i.getBlock().append(e.getBlock()),this.app.editor.build(),void this.app.block.set(e.getBlock(),"start")}i.insertEmpty({position:"after",caret:"start",type:"input"}),i.remove({broadcast:!0}),this.app.image.observeStates()}}}}handleEnter(t,e,s){let i=this.app.block.get(),a=this.app.create("selection"),r=this.app.create("insertion"),o=this.app.create("caret");if(i&&i.isType("column"))return t.preventDefault(),void i.insertEmpty({position:"prepend",caret:"start",type:"input"});if(this.app.blocks.is()){t.preventDefault();let e=this.app.blocks.get({last:!0,selected:!0});return a.truncate(),void setTimeout((()=>{this.app.block.set(e),this.app.image.observeStates()}),0)}if(i&&!(i.isNondeletable()||!i.isInline()&&this._deleteInsideSelection(t))){if(i.isInline())return t.preventDefault(),void((!i.isEditable()||i.isEditable()&&i.isAllSelected())&&(o.set(i.getBlock(),"after"),i.remove()));if(i.isEditable()){if(i.isAllSelected())return t.preventDefault(),void i.setEmpty();if(!a.isCollapsed())return t.preventDefault(),void(i.isType("pre")?r.insertNewline():r.insertBreakline())}else if(!i.isEditable()){if(t.preventDefault(),i.isType("list")){let t=i.getBlock().closest("li");return 0===t.length?void i.insertEmpty({position:"after",caret:"start",type:"input"}):(i.remove(),void this.app.block.set(t,"end"))}if(i.isType("cell")){t.preventDefault(),i.getBlock().html("");let e=this.app.block.create();return i.getBlock().append(e.getBlock()),this.app.editor.build(),void this.app.block.set(e.getBlock(),"start")}return i.insertEmpty({position:"after",caret:"start",type:"input"}),void this.app.image.observeStates()}if(i.handleEnter)return i.handleEnter(t,e,s),void this.app.image.observeStates();if(i.isEditable())if(t.preventDefault(),i.isEmpty()||i.isCaretEnd()||i.isCaretStart()){let t=i.isCaretStart()?"before":"after";i.insertEmpty({position:t,caret:"start",remove:!1,type:"input"})}else{this.app.create("element").splitAtCaret(i.getBlock())}}}handleTab(t,e,s){let i=this.app.block.get(),a=this.app.create("insertion"),r=this.app.create("selection");if(this.app.blocks.is())return t.preventDefault(),i=this.app.blocks.get({last:!0,selected:!0}),r.collapse("end"),this.app.block.set(i),void this.app.context.close();if(i){const a=i.getParent("cell");if(a&&a.handleTab&&a.handleTab(t,e,s))return}if(!(i&&i.handleTab&&i.handleTab(t,e,s)))if(i&&this.config.is("tab.spaces")&&i.isEditable()){t.preventDefault();let e=this.config.get("tab.spaces"),s=document.createTextNode(Array(e+1).join(""));a.insertNode(s,"end")}else i&&this._traverseNext(t,i)}handleArrowCtrl(t,e,s){let i=this.app.create("selection");this.app.editor.unsetSelectAll(),i.remove(),this.app.editor.setFocus("start")}handleArrow(t,e,s){let i=this.app.block.get(),a=(this.app.create("caret"),this.app.create("utils")),r=this.app.create("selection");if(this.app.editor.isSelectAll()){t.preventDefault();let e=s.is("down+right")?this.app.blocks.get({last:!0}):this.app.blocks.get({first:!0}),i=s.is("down+right")?"end":"start";return this.app.editor.unsetSelectAll(),void this.app.block.set(e,i)}if(this.app.blocks.is())return t.preventDefault(),i=s.is("down+right")?this.app.blocks.get({last:!0,selected:!0}):this.app.blocks.get({first:!0,selected:!0}),r.collapse(s.is("down+right")?"end":"start"),this.app.block.set(i),void this.app.context.close();if(i&&!(i.isEditable()&&s.is("left","right")&&this._trimInvisibleChar(t,s.is("left")?"left":"right")||i.handleArrow&&i.handleArrow(t,e,s))){if(a.isFirefox()){const{isFirstLine:e,isLastLine:a}=r.isCursorInFirstOrLastLine();if(s.is("up")){const s=i.findPreviousElement();if(s&&s.isType("text")&&s.isEmpty()&&e)return t.preventDefault(),void this.app.block.set(s,"start")}else if(s.is("down")){const e=i.findNextElement();if(e&&e.isType("text")&&e.isEmpty()&&a)return t.preventDefault(),void this.app.block.set(e,"start")}}if(!i.isEditable()||i.isType(["todo","list"])){if(s.is("up+left"))return this._traversePrev(t,i);if(s.is("down+right"))return this._traverseNext(t,i)}else if(i.isEditable()&&s.is("down+right")&&i.isCaretEnd()){let e,s=i.getClosest("table");if(s){if(t.preventDefault(),e=s.getNext(),e)this.app.block.set(e,"start");else{let t=this.app.block.create();s.insert({instance:t,position:"after",type:"input"})}return}if(e=i.getNext(),e)return t.preventDefault(),void this.app.block.set(e,"start")}}}handleDelete(t,e,s){let i=this.app.block.get(),a=s.is("backspace"),r=s.is("delete"),o=this.app.create("selection"),n=this.app.create("caret");if(i&&i.isNondeletable())return;if(i&&i.isType("column"))return void t.preventDefault();if(this.app.editor.isEmpty())return void t.preventDefault();if(this.app.blocks.is()){t.preventDefault();let e=this.app.blocks.get({first:!0,selected:!0});return o.truncate(),this.app.block.set(e,"end"),this.app.block.get().appendNext(),this.app.context.close(),void this.app.image.observeStates()}if(i&&i.isEditable()&&this._trimInvisibleChar(t,s.is("backspace")?"left":"right",r))return;let l=o.getInline();if(l&&1===l.innerHTML.length&&a&&!n.is(l,"start"))return t.preventDefault(),l.innerHTML="",void(i&&i.isEditable()&&i.isEmpty(!0)&&this._deleteEditable(t,i,s));i&&(i.handleDelete&&i.handleDelete(t,e,s)||(i.isInline()?this._deleteInlineBlock(t,i):i.isEditable()?i.isEditable()&&this._deleteEditable(t,i,s):this._deleteNotEditable(t,i)),this.app.image.observeStates())}handleShiftEnter(t){let e=this.app.block.get(),s=this.app.create("insertion"),i=this.app.create("selection"),a=this.app.create("caret");if(this.app.blocks.is()){t.preventDefault();let e=this.app.blocks.get({first:!0,selected:!0});return i.truncate(),a.set(e,"end"),void s.insertBreakline()}if(!this._deleteInsideSelection(t)&&e)return e.isInline()?(t.preventDefault(),void(e.isEditable()||(a.set(e.getBlock(),"after"),e.remove()))):void(e.isEditable()?(t.preventDefault(),s.insertBreakline()):(t.preventDefault(),e.insertEmpty({position:"after",caret:"start",type:"input"})))}handleShiftSpace(t){let e=this.app.block.get(),s=this.app.create("insertion"),i=this.app.create("selection"),a=this.app.create("caret");if(this.app.blocks.is()){t.preventDefault();let e=this.app.blocks.get({first:!0,selected:!0});return i.truncate(),a.set(e,"end"),void s.insertHtml("&nbsp;","end")}if(!e.isInline()&&e.isEditable()){if(e.isAllSelected())return t.preventDefault(),void e.setEmpty();if(!e.isType("pre"))return t.preventDefault(),void s.insertHtml("&nbsp;","end")}}_deleteInlineBlock(t,e){let s=this.app.create("caret"),i=e.getBlock(),a=i.parent().closest("[data-rx-type]");e.isEditable()&&!e.isAllSelected()||(t.preventDefault(),s.set(i,"after"),e.remove(),this.app.block.set(a),this.app.context.close())}_deleteEditable(t,e,s){let i=e.getNext(),a=e.getPrev(),r=s.is("backspace"),o=s.is("delete"),n=this.app.create("selection");if(e.isAllSelected())return t.preventDefault(),e.isType("quote")?this.app.block.remove():e.setEmpty(),void this.app.context.close();if(o&&i&&e.isCaretEnd()){if(t.preventDefault(),i.isEditable()||i.isType(["list","todo"])){if("pre"===i.getType()&&e.isEmpty())return void e.remove({broadcast:!0});e.appendNext()}else this.app.block.set(i),e.isEmpty()&&e.remove({broadcast:!0});this.app.context.close()}else if(o&&!i&&e.isCaretEnd()){e.getClosest(["column","cell"])&&t.preventDefault()}else{if(r&&a&&e.isCaretStart()){this.app.create("caret");if(t.preventDefault(),a.isEditable()||a.isType(["list","todo"])){if("pre"===a.getType()&&e.isEmpty())return void e.remove({broadcast:!0});e.appendToPrev(),this.app.control.updatePosition()}else this.app.block.set(a,"force"),e.isEmpty()&&e.remove({broadcast:!0});return void this.app.context.close()}if(r&&!a&&e.isCaretStart()){e.getClosest(["column","cell"])&&t.preventDefault()}else if(!n.isCollapsed())return t.preventDefault(),n.truncate(),void this.app.context.close()}}_deleteNotEditable(t,e){let s=e.getNext(),i=e.getPrev(),a=e.getType(),r={},o=e.getClosest(["column","cell"]);if(t.preventDefault(),"image"===a&&(r={url:e.getSrc(),id:e.getId(),uid:e.getDataImage()},this.app.image.setImageState(e,r,!1)),e.remove({broadcast:!0}),"image"===a&&this.app.broadcast("image.remove",r),o&&o.isEmpty(!0)){let t=this.app.block.create();return o.insert({instance:t,position:"append"}),void this.app.block.set(t,"start")}s?this.app.block.set(s,"start"):i?this.app.block.set(i,"end"):this.app.editor.isEmpty()?this.app.editor.setEmpty():this.app.block.unset()}_deleteInsideSelection(t){let e,s=this.app.create("selection"),i=this.app.create("caret");return!s.isCollapsed()&&(e=s.getNodes({type:"block"}),e.length>1)&&(t.preventDefault(),s.truncate(),i.set(e[0],"end"),!0)}_doSelectAll(t,e){if(this._isAllSelected(e))return this._setEditorEmpty(t,e),!0;if(e.is("select-block")){let e,s=this.app.block.get();if(s&&s.isEditable()){let i=this.app.create("selection");return e=s.getBlock(),s.isType("todoitem")?e=s.getContentItem():s.isType("quote")&&(e=s.getCurrentItem()),t.preventDefault(),i.select(e),void this.app.context.open(t)}}else if(e.is("select"))return t.preventDefault(),this.app.editor.setSelectAll(),this.app.context.open(t),!0}_traverseNext(t,e){let s=e.getNext();return s?(t.preventDefault(),void this.app.block.set(s,"start")):(s=e.getNextParent(),s?(t.preventDefault(),void this.app.block.set(s,"start")):void 0)}_traversePrev(t,e){let s=e.getPrev();return s?(t.preventDefault(),void this.app.block.set(s,"end")):(s=e.getPrevParent(),s?(t.preventDefault(),void this.app.block.set(s,"end")):void 0)}_isAllSelected(t){return this.app.editor.isSelectAll()&&t.is("enter","delete","backspace","alpha","space")}_setEditorEmpty(t,e){e.is("alpha","space")||t.preventDefault(),this.app.editor.setEmpty()}_trimInvisibleChar(t,e,s){let i,a="left"===e?"before":"after",r=this.app.create("selection"),o=this.app.create("offset"),n=r.getCurrent(),l=this._isInvisibleChar(r,n,a);if(l&&"left"===e)i=n,this.dom(i).replaceWith(i.textContent.replace(/\uFEFF/g,""));else if(l&&s&&n&&n.nextSibling)i=n.nextSibling,this.dom(i).replaceWith(i.textContent.replace(/\uFEFF/g,""));else if(l&&"right"===e){t.preventDefault();let e=o.get();return o.set(!1,{start:e.start+1,end:e.end+1}),!0}}_isInvisibleChar(t,e,s){let i=this.app.create("utils"),a=t.getText(s);return e&&3===e.nodeType&&0===i.searchInvisibleChars(a)}}class b{constructor(t){const e=t.which,s=!t.ctrlKey&&!t.metaKey&&(e>=48&&e<=57||e>=65&&e<=90||[186,187,188,189,190,191,192,219,220,221,222].includes(e));this.rules={ctrl:t.ctrlKey||t.metaKey,shift:t.shiftKey,alt:t.altKey,select:(t.ctrlKey||t.metaKey)&&!t.altKey&&65===e,"select-block":(t.ctrlKey||t.metaKey)&&t.shiftKey&&!t.altKey&&65===e,enter:13===e,space:32===e,esc:27===e,tab:9===e&&!t.altKey&&!t.ctrlKey&&!t.metaKey,delete:46===e,backspace:8===e,alpha:s,arrow:-1!==[37,38,39,40].indexOf(e),left:37===e,right:39===e,up:38===e,down:40===e,"left+right":37===e||39===e,"up+left":38===e||37===e,"down+right":40===e||39===e}}is(...t){return t.some((t=>this.rules[t]))}}class f{constructor(t,e,s,i,a){s&&(this.app=t,this.dom=t.dom,this.control=e,this.$control=i,this.instance=a,this.$button=s.getElement(),this.$button.on("click.rx-reorder-button",this._pressStop.bind(this)),this.$button.on("mousedown.rx-reorder-button touchstart.rx-reorder-button",this._press.bind(this)))}_pressStop(t){t.stopPropagation(),t.preventDefault(),clearTimeout(this.dragTimeout),this.$button.removeClass("rx-in-dragging")}_press(t){t.stopPropagation(),t.preventDefault(),this.touchStartTime=(new Date).getTime(),this.isDragging=!1,this.dragTimeout=setTimeout((()=>{this.isDragging=!0,this._startDragging()}),200),this.$button.on("touchend.rx-reorder-button mouseup.rx-reorder-button",this._checkTap.bind(this))}_checkTap(t){const e=(new Date).getTime()-this.touchStartTime,s=this.app.create("utils");e<200&&!this.isDragging&&(clearTimeout(this.dragTimeout),this._pressStop(t),s.isMobileDevice()&&this.control.trigger()),this.$button.off("touchend.rx-reorder-button mouseup.rx-reorder-button",this._checkTap.bind(this))}_startDragging(){this.$button.addClass("rx-in-dragging"),this._bindWindowEvents()}_bindWindowEvents(){this.app.page.getWin().on("mouseup.rx-reorder-button touchend.rx-reorder-button",this._release.bind(this)),this.app.page.getWin().on("mousemove.rx-reorder-button touchmove.rx-reorder-button",this._move.bind(this))}_release(t){this.$button.hasClass("rx-handle")&&(this._resetDragState(),this._setCaretAfterRelease())}_resetDragState(){this.$button.removeClass("rx-handle rx-in-dragging"),this.app.page.getWin().off(".rx-reorder-button"),this.app.observer.trigger=!0,this.oldY=0,this.dragging=!1,this._trashDragItem(),this.app.control.updatePosition(),this.$control.show(),this.app.ui.closeTooltip()}_setCaretAfterRelease(){setTimeout((()=>{this.app.block.set(this.instance,"start",!0),this.app.event.trigger=!0}),1)}_move(t){if(t.preventDefault(),!this.$button.hasClass("rx-in-dragging"))return;this.$button.hasClass("rx-handle")||this._initializeDrag(t),this.app.dropdown.close();const e=this._calculateDeltaY(t.pageY),s=this._getDirection(e);this._moveItem(this.$dragItem,e),this.oldY=t.pageY,this._handleAutoScroll(t.pageY,s);const i=this._getContainer();this._placeItem(i)}_initializeDrag(t){const e=this.instance.getBlock().get();this.$button.addClass("rx-handle"),this.dragging=!0,this.$dragItem=this._makeDragItem(e,t.target),this.$control.hide(),this.app.event.trigger=!1}_getDirection(t){return t>0?"up":t<0&&"down"}_calculateDeltaY(t){return 0===this.oldY?0:this.oldY-t}_handleAutoScroll(t,e){const{topStop:s,bottomStop:i,topEdge:a,bottomEdge:r}=this._getScrollBoundaries();this._isScrollUp(t,s,a,e)?this._scroll(-10):this._isScrollDown(t,i,r,e)&&this._scroll(10)}_getContainer(){const t=this.instance.getClosest(["list","todo","cell","column","wrapper"]);return t?t.getBlock():this.app.editor.getLayout()}_getScrollBoundaries(){const t=this.app.editor.getRect(),e=this.app.page.getDoc().scrollTop();let s=e>t.top?e+40:t.top+40,i=this.app.page.getWin().height()+e-40,a=t.top,r=t.top+this.app.editor.getEditor().height();if(this.app.scroll.isTarget()){const o=this.app.scroll.getTarget(),n=o.offset();a=n.top,s=e>t.top?n.top+40:s,r=n.top+o.height(),i=r-40}return{topStop:s,bottomStop:i,topEdge:a,bottomEdge:r}}_isScrollUp(t,e,s,i){return"up"===i&&t<e&&t>s}_isScrollDown(t,e,s,i){return"down"===i&&t>e&&t<s}_placeItem(t){const e=t.children(),s=e.length;for(let t=0;t<s;t++){const s=e.eq(t).get(),i=this.dom(s);s!==this.$clickItem.get()&&(this._isOver(i)&&this._swapItems(s))}}_isOver(t){const e=this.$dragItem.offset().top,s=t.offset(),i=t.height();return e>s.top&&e<s.top+i}_scroll(t){const e=this.app.scroll.isTarget()?this.app.scroll.getTarget():this.app.page.getWin(),s=e.scrollTop();e.scrollTop(s+t)}_swapItems(t){const e=this.$dragItem.offset().top,s=this.$clickItem,i=this.dom(t),a=i.offset(),r=i.height()/2;i[r+a.top>e?"before":"after"](s)}_moveItem(t,e){const s=t.offset().top-e;t.css("top",`${s}px`),this.$control.css("top",`${s}px`)}_makeDragItem(t){this._trashDragItem();const e=this.dom(t),s=e.offset(),i=this.app.editor.getTheme();this.$clickItem=e,this.$clickItem.addClass("rx-drag-active");const a=e.clone();a.removeClass("rx-drag-active rx-element-active"),a.css({"font-family":e.css("font-family"),"font-size":e.css("font-size"),"line-height":e.css("line-height"),margin:0,padding:0});const r=this.dom("<div>").addClass("rx-dragging");return r.append(a),r.attr("rx-data-theme",i),r.css({opacity:.95,position:"absolute","z-index":999,left:s.left+"px",top:s.top+"px",width:e.width()+"px"}),this.app.page.getFrameBody().append(r),r}_trashDragItem(){this.$dragItem&&this.$clickItem&&(this.$clickItem.removeClass("rx-drag-active"),this.$clickItem=null,this.$dragItem.remove(),this.$dragItem=null)}}class v{constructor(t){this.app=t}init(){this.manager=new _(this.app),this.focusManager=new C(this.app,this.manager),this.buildBSModal()}stop(){this.editor.destroy(),this.manager.removeAllContainers()}get(t){return this.manager.getContainer(t)}toggleFocus(){this.manager.toggleFocus()}setFocus(){this.focusManager.setFocus()}setBlur(){this.focusManager.setBlur()}hasFocus(){return this.focusManager.hasFocus()}isExternal(t){return this.manager.getTarget(t)}buildBSModal(){this.config.set("bsmodal",!!this.manager.getContainer("main").closest(".modal-dialog").length)}}class C{constructor(t,e){this.app=t,this.manager=e,this.blurClass="rx-in-blur",this.focusClass="rx-in-focus"}setFocus(){this.manager.getContainer("main").removeClass(this.blurClass).addClass(this.focusClass)}setBlur(){this.manager.getContainer("main").removeClass(this.focusClass).addClass(this.blurClass)}hasFocus(){return this.manager.getContainer("main").hasClass(this.focusClass)}}class _{constructor(t){this.app=t,this.uuid=t.uuid,this.dom=t.dom,this.config=t.config,this.element=t.element,this.elements=["toolbox","statusbar"],this.$body=t.page.getBody(),this.$container=null,this.containers={},this.targets={},this._initializeContainers()}createMainContainer(){this.$container=this.dom("<div>").attr("rx-uuid",this.uuid).addClass(`rx-container rx-container-${this.uuid}`).addClass(this.config.is("nocontainer")?"":"rx-main-container"),this.element.after(this.$container)}removeAllContainers(){Object.values(this.containers).forEach((t=>t.remove())),this.$container&&this.$container.remove(),this.containers={},this.targets={}}getContainer(t){return"main"===t?this.$container:this.containers[t]}getTarget(t){return this.targets[t]}toggleFocus(){this.config.is("toolbar.sharedTarget")&&this.elements.forEach((t=>{const e=this.$body.find(`.rx-${t}-external`),s=this.$body.find(`.rx-${t}-external.rx-${t}-container-${this.uuid}`);e.hide(),s.show()}))}_initializeContainers(){this.createMainContainer(),this._buildContainers(this.$container,this.config.get("containers.main")),this.elements.forEach((t=>this._buildExternal(t)))}_buildContainers(t,e){e.forEach((e=>{const s=this._createContainer(e,t);this.containers[e]=s,this._buildNestedContainers(e,s)}))}_createContainer(t,e){const s=this._getExternalTarget(t);s&&(this.targets[t]=s,e=s);const i=this.dom("<div>").addClass(`rx-${t}-container rx-${t}-container-${this.uuid}`).toggleClass(`rx-${t}-external`,this.getTarget(t));return this._getTargetElement(e).append(i),i}_getExternalTarget(t){return"toolbox"===t?this.config.get("toolbar.target"):"toolbar"!==t&&this.config.get(`${t}.target`)}_getTargetElement(t){return t?this.dom(t):this.$container}_buildNestedContainers(t,e){const s=this.config.get(`containers.${t}`);s&&this._buildContainers(e,s)}_buildExternal(t){if(!this.config.is("toolbar.sharedTarget"))return;this.$body.find(`.rx-${t}-external`).hide().first().show()}}class k{constructor(t){this.app=t,this.eventname="rx-source-events"}init(){this.$source=this.dom("<textarea>").addClass("rx-source").attr("data-gramm_editor",!1),this.container.get("source").append(this.$source)}setContent(t){this.$source.val(t)}getContent(){let t=this.$source.val();return this.codemirror.val(t)}getElement(){return this.$source}getSource(){return this.$source}update(t){this.editor.setSource(t)}is(){const t=this.container.get("source");return t&&t.length&&"none"!==t.css("display")}toggle(){this.is()?this.close():this.open()}open(){const t=this.container.get("editor"),e=this.container.get("source"),s=this.app.create("tidy");this.app.broadcast("source.before.open");let i=s.parse(this.editor.getContent());this._prepareSource(i),this._toggleView(t,e,!0);const a=this._adjustHeight(t);this._initializeCodemirror(a),this._setUIState(!0),this.app.broadcast("source.open")}close(){if(!this.is())return;this.app.broadcast("source.before.close");const t=this.container.get("editor"),e=this.container.get("source"),s=this.getContent();this.codemirror.destroy(),this._toggleView(t,e,!1),this.editor.setContent({html:s,caret:"start"}),this._setUIState(!1),this.app.broadcast("source.close")}_adjustHeight(t){const e=this._getMinHeight(),s=Math.max(this.$source.get().scrollHeight,e);return this.$source.css("height","auto").css("height",`${s}px`),Math.max(t.height(),e)}_getMinHeight(){return parseInt(this.config.get("minHeight"))}_prepareSource(t){this.$source.val(t).on(`focus.${this.eventname}`,this._handleFocus.bind(this)).on(`input.${this.eventname}`,this._handleChanges.bind(this)).on(`keydown.${this.eventname}`,this.event.handleTextareaTab.bind(this)),this.blocks.unset(),this.block.unset(),this.editor.deselectAll()}_toggleView(t,e,s){s?(t.hide(),e.show()):(e.hide(),t.show())}_initializeCodemirror(t){const e=this.codemirror.create({el:this.$source,height:t,focus:!0});e&&(e.on("change",this._handleChanges.bind(this)),e.on("focus",this._handleFocus.bind(this)))}_setUIState(t){t?(this.app.ui.close(),this.app.ui.disable(),this.app.toolbar.enableSticky(),this.app.toolbar.setToggled("html"),this.app.extrabar.setToggled("html")):(this.app.ui.enable(),this.app.toolbar.unsetToggled("html"),this.app.extrabar.unsetToggled("html"))}_setUIState2(t){this.ui.toggle(!t),this.toolbar.toggleSticky(t),this.toolbar.toggle("html",t),this.extrabar.toggle("html",t)}_handleFocus(){this.editor.setFocus()}_handleChanges(t){const e=this.getContent();this.update(e),this.$source.css("height",this.$source.get().scrollHeight+"px"),this.app.broadcast("source.change",{e:t})}}class y{constructor(t){this.app=t,this.dom=t.dom,this.$win=this.dom(window),this.$doc=this.dom(document),this.$body=this.dom("body")}getWin(){return this._isIframeMode()?this.getFrameWin():this.$win}getWinNode(){return this._isIframeMode()?this.getFrameWinNode():this.$win.get()}getDoc(t=!0){return this._isIframeMode()&&t?this.getFrameDoc():this.$doc}getDocNode(){return this._isIframeMode()?this.getFrameDocNode():this.$doc.get()}getBody(){return this.$body}getFrameBody(){return this._isIframeMode()?this.getFrameDoc().find("body"):this.$body}getFrameHead(){return this.getFrameDoc().find("head")}getFrameDoc(){return this.dom(this.getFrameDocNode())}getFrameDocNode(){const t=this._getEditorNode();return t&&t.contentWindow?t.contentWindow.document:null}getFrameWin(){return this.dom(this.getFrameWinNode())}getFrameWinNode(){const t=this._getEditorNode();return t&&t.contentWindow?t.contentWindow:null}_isIframeMode(){return this.app.isMode("iframe")}_getEditorNode(){return this.app.getEditor()?.get()}}class x{constructor(t,e,s=!1){this.app=t,this.element=t.element,this.config={},this._init(s,e)}dump(){return this.config}is(t){let e=this.get(t);return void 0!==e&&!1!==e&&null!==e}set(t,e){t.split(".").reduce(((t,s,i,a)=>t[s]=i===a.length-1?e:t[s]||{}),this.config)}get(t){return t.split(".").reduce(((t,e)=>t?.[e]),this.config)}extend(t){this.opts=o.extend(!0,{},this.config,t)}remove(t){let e=t.split("."),s=e.pop();delete e.reduce(((t,e)=>t[e]||{}),this.config)[s]}_init(t,e){const s=t?"defaults"in t?t.defaults:{}:o.opts,i=o.extend(!0,{},s),a=o.extend(!0,i,o.settings),r=this._parseDataAttributes();this._updateObject(a,r);const n=o.extend(!0,{},a,r,e);this.config=o.extend(!0,n,e),this._configureTranslations(this.config)}_configureTranslations(t){const e=t.localization||t.translations;e&&o.addLang(e)}_updateObject(t,e){Object.keys(t).forEach((s=>{const i=s.toLowerCase();e.hasOwnProperty(i)&&("object"==typeof t[s]&&null!==t[s]&&"object"==typeof e[i]?this._updateObject(t[s],e[i]):t[s]=e[i])}))}_parseDataAttributes(){const t=this.element.get(),e={};return Array.from(t.attributes).forEach((t=>{t.name.startsWith("data-")&&this._processAttribute(t,e)})),e}_processAttribute(t,e){const s=t.name.slice(5).split("-");let i=e;s.forEach(((e,a)=>{a===s.length-1?i[e]=this._parseValue(t.value):i=this._getOrCreateNextLevel(i,e)}))}_parseValue(t){try{return JSON.parse(t)}catch(e){try{const e=t.replace(/(\w+)\s*:/g,'"$1":').replace(/:\s*([\w\[\]{]+)\s*/g,': "$1"').replace(/'/g,'"');return JSON.parse(e)}catch(e){return t}}}_getOrCreateNextLevel(t,e){return t[e]&&"object"==typeof t[e]&&!Array.isArray(t[e])||(t[e]={}),t[e]}}class w{constructor(t,e){this.language=e,this.translations=o.lang[this.language]||o.lang.en}dump(){return this.translations}has(t){return""!==this.get(t)}set(t){o.extend(!0,o.lang,t),this._init()}get(t){let e=this._fetchFromVars(t)||"en"!==this.language&&this._fetchFromDefaultLang(t);return void 0===e?"":e}parse(t){return"string"!=typeof t?t:this._replaceLanguageVariables(t)}_fetchFromVars(t){return this._getValue(t,this.translations)}_fetchFromDefaultLang(t){return this._getValue(t,o.lang.en)}_replaceLanguageVariables(t){let e=t.match(/## (.*?) ##/g);return e&&e.forEach((e=>{let s=e.replace(/## /g,"").replace(/ ##/g,"");t=t.replace(e,this.get(s))})),t}_getValue(t,e){return t.split(".").reduce(((t,e)=>t&&t[e]),e)}}class ${constructor(t){this.app=t,this.rawhtml=""}init(){this.theme=new I(this.app),this.app.theme=this.theme,this.focusManager=new E(this.app,this),this.selectionManager=new S(this.app,this),this.buildStrategy=this.app.isMode("default")?new H(this.app,this):new A(this.app,this),this.buildStrategy.build()}stop(){this._removeOverlay(),this.theme.stop(),this.buildStrategy.stop(),this._restoreDivElement()}load(){!this.app.isMode("iframe")&&this.config.is("focus")&&this.setFocus(this.config.get("focus"))}click(){const t=this.app.create("selection").getBlockControlled();setTimeout((()=>{this.block.set(t)}),1)}readonly(){this.event.pause(),this._toggleEditableState(!1)}disable(){this.$editor.addClass("rx-editor-disabled"),this._createOverlay()}editable(){this._toggleEditableState(!0),this.event.run()}enable(){this.$editor.removeClass("rx-editor-disabled"),this._removeOverlay()}destroy(){this._restoreTextareaAttributes(),this.theme.destroy(),this.buildStrategy.destroy()}build(){const t=this.app.create("predefined");this.blocks.build(),this.embed.build(),this.image.observeStates(),t.parse(this.$editor),this.observer.observe()}save(t,e=!1){this.selectionManager.save(t,e)}restore(t){this.selectionManager.restore(t)}resetSaved(){this.selectionManager.reset()}focus(){this.getLayout().focus({preventScroll:!0})}hasFocus(){return this.focusManager.hasFocus()}getTheme(){return this.theme.get()}getLayout(){return this.app.isMode("iframe")?this.$layout:this.$editor}getEditor(){return this.$editor}getRect(){const t=this.$editor.offset(),e=this.$editor.width(),s=this.$editor.height(),i=Math.round(t.top),a=Math.round(t.left);return{top:i,left:a,bottom:i+s,right:a+e,width:e,height:s}}getWidth(){return this.$editor.width()}getHtml(){return this.getLayout().html()}getEmail(t){return this.app.has("email")?this.app.email.getEmail(t):this.getContent()}getContent(t){return this.content.getContent(t)}getJson(){let t={};return this.app.has("email")?t=this.app.email.getJson():(t=this.getSourceJson()||{},t.blocks=this.content.getJson()),t}getSourceJson(){return this.config.get("data")}getSource(){return this.$source.val()}getRawHtml(){return this.rawhtml}getContentType(){return this.content.getType()}setTheme(t){this.theme.set(t)}setContent(t){if(this.app.has("email"))this.app.email.setContent(t);else{this.app.create("insertion").set(t)}}setJson(t){this.config.set("data",t),this.app.has("email")?this.app.email.setJson(t):(this.content.set(t,"json"),this.build())}setHtml(t){this.getLayout().html(t)}setEmpty(){const t=this.block.create();this.app.create("insertion").setEmpty(),this.getLayout().append(t.getBlock()),this.build(),this.setFocus("end"),this.app.broadcast("editor.empty")}setFocus(t,e=!0){this.focusManager.setFocus(t,e)}setBlurOther(){this.focusManager.setBlurOther()}setBlur(t){this.focusManager.setBlur(t)}deselectAll(){this.selectionManager.deselectAll()}selectAll(t,e=!0){this.selectionManager.selectAll(t,e)}setSource(t){this.$source.val(t)}setOutput(t){if(!this.config.is("output"))return;const e=this.config.get("output"),s=this.dom(e);["textarea","input"].includes(s.tag())?s.val(t):s.html(t)}setWinFocus(){this.app.isMode("iframe")&&this.page.getWin().focus()}insertContent(t){this.app.create("insertion").insert(t)}isSelectAll(){return this.$editor.hasClass("rx-select-all")}isEmpty(){const t=this.app.create("utils"),e=this.getLayout().html();return t.isEmptyHtml(e,!0)}isEditor(t){return this.dom(t).get()===this.getLayout().get()}adjustHeight(){this.app.isMode("iframe")&&this.$editor&&!this.app.isStopped()&&setTimeout((()=>{this.$editor.height(this.page.getFrameBody().height())}),1)}unsetSelectAll(){this.deselectAll()}setSelectAll(t,e){this.selectAll(t,e)}_createOverlay(){this.$overlay=this.dom("<div>").addClass("rx-editor-overlay"),this.container.get("main").append(this.$overlay)}_removeOverlay(){this.$overlay&&this.$overlay.remove()}_restoreDivElement(){this.element.isTextarea()||(this.$editor.removeClass("rx-editor rx-empty rx-editor-breakline "+this.config.get("classname")),this.$editor.removeAttr("style dir"),this.buildStrategy.restore(),this.$editor.html(this.getContent()))}_restoreTextareaAttributes(){this.element.isTextarea()||(this.$editor.removeClass("rx-editor rx-editor-"+this.uuid+" rx-empty rx-editor-breakline rx-editor-disabled rx-placeholder"),this.$editor.removeAttr("contenteditable data-gramm_editor"),this.container.get("main").before(this.$editor))}_toggleEditableState(t){const e=t?"removeClass":"addClass";this.getLayout().attr("contenteditable",t),this.$editor[e]("rx-editor-readonly"),t?this.getLayout().find("[rx-readonly=true]").each((t=>{t.removeAttr("rx-readonly").attr("contenteditable",!0)})):this.getLayout().find("[contenteditable=true]").each((t=>{t.attr("rx-readonly",!0).attr("contenteditable",!1)}))}}class T{constructor(t){this.app=t,this.editor=t.editor,this.source=t.source,this.element=t.element,this.config=t.config,this.sourceType=this._determineSourceType(),this.type=this.config.is("data")?"json":"html",this.content=this._getElementContent(),this._broadcastBeforeLoad(),this._parseContent(),this._unparseContent()}getSourceType(){return this.sourceType}getType(){return this.type}getContent(t){let e=this.editor.getHtml();return e=this._unparse(e),t&&(e=this._tidyContent(e)),e}getJson(){const t=[];return this.editor.getLayout().children("[data-rx-type]").each((e=>{const s=e.dataget("instance");t.push(s.getJson())})),t}set(t,e="html"){this.content=t,this.type=e,this._parseContent(),this._unparseContent()}isJson(){return"json"===this.type}_determineSourceType(){return this.config.is("content")?"content":this.config.is("data")?"data":"element"}_unparse(t){return this.app.create("unparser").unparse(t)}_tidyContent(t){return this.app.create("tidy").parse(t)}_parseContent(){const t=this.app.create("parser").parse(this.content,{type:this.type,start:!0,nodes:!0});this.editor.setHtml(t)}_unparseContent(){const t=this._unparse(this.editor.getHtml());this.source.setContent(t),!this.isJson()&&this.element.isTextarea()&&this.editor.setSource(t)}_broadcastBeforeLoad(){const t=this.app.broadcast("editor.before.load",{html:this.content});this.content=t.get("html")}_getElementContent(){return this.config.is("content")?this.config.get("content"):this.config.is("data")?this.config.get("data"):this.app.element.getHtml()}}class E{constructor(t,e){this.app=t,this.editor=e,this.container=t.container,this.source=t.source,this.block=t.block,this.blocks=t.blocks,this.path=t.path,this.ui=t.ui}hasFocus(){return this.container.hasFocus()}setFocus(t,e=!0){t?(this._setFocusWithPosition(t),e&&this.app.broadcast("editor.focus")):!1!==t&&this._setFocusWithoutPosition()}setBlurOther(){o.instances.forEach((t=>{t!==this.app&&t.editor&&t.editor.setBlur()}))}setBlur(t){if(!this.hasFocus()||!this.editor.getEditor())return;this.app.broadcast("editor.before.blur",{e:t}).isStopped()?t&&t.preventDefault():(this.container.setBlur(),this._clearSelection(),this.app.broadcast("editor.blur",{e:t}))}_setFocusWithPosition(t){const e=!0===t?"start":t,s="start"===e?this.blocks.get({first:!0}):this.blocks.get({last:!0});this.block.set(s,e),this.container.setFocus()}_setFocusWithoutPosition(){this.hasFocus()||(this.setBlurOther(),this.container.setFocus(),this.container.toggleFocus(),this.app.broadcast("editor.focus"))}_clearSelection(){this.source.is()||(this.block.unset(),this.blocks.unset(),this.ui.close(),this.path.build(),this.ui.unset())}}class S{constructor(t,e){this.app=t,this.dom=t.dom,this.editor=e,this.block=t.block,this.blocks=t.blocks,this.savedSelection=null,this.savedInline=null}save(t,e=!1){if("inline"===e)return void(this.savedInline=t);const s=this.app.create("offset"),i=this.block.get();!1!==t&&(t=i&&!this.blocks.is()?i.getBlock():this.editor.getLayout()),this.savedSelection={el:t,offset:s.get(t)}}restore(t){this.savedSelection&&(this.editor.setWinFocus(),this.savedInline?this._restoreInlineCaret():this._restoreBlockSelection(t),this._clearSavedSelection())}reset(){this._clearSavedSelection()}selectAll(t,e=!0){if(this.editor.isSelectAll())return;const s=this.app.create("selection");this.editor.getEditor().addClass("rx-select-all"),t=t||this.blocks.get({firstLevel:!0}),this.block.unset(),this.blocks.set(t),s.select(this.editor.getLayout()),e&&this.app.broadcast("editor.select")}deselectAll(){this.editor.isSelectAll()&&(this.editor.getEditor().removeClass("rx-select-all"),this.block.unset(),this.blocks.unset(),this.app.broadcast("editor.deselect"),this.app.broadcast("editor.unselect"))}_restoreInlineCaret(){const t=this.app.create("caret");this.savedInline.innerHTML="",t.set(this.savedInline,"start")}_restoreBlockSelection(t){const{el:e,offset:s}=this.savedSelection;if(this.dom(e).dataget("instance")&&!1!==t&&this.block.set(e),e&&s){e.focus();this.app.create("offset").set(s,e)}}_clearSavedSelection(){this.savedSelection=null,this.savedInline=null}}class B{constructor(t){this.app=t,this.loc=t.loc,this.uuid=t.uuid,this.dom=t.dom,this.container=t.container,this.$editor=t.editor.getEditor(),this._assignAriaAttributes(),this._prependAccessibilityLabel()}destroy(){this.$editor.removeAttr("aria-labelledby role")}_assignAriaAttributes(){this.$editor.attr({"aria-labelledby":`rx-voice-${this.uuid}`,role:"presentation"})}_prependAccessibilityLabel(){const t=this.loc.get("accessibility.help-label"),e=this._createAccessibilityLabel(t);this.container.get("main").prepend(e)}_createAccessibilityLabel(t){return this.dom("<span>").attr({id:`rx-voice-${this.uuid}`,"aria-hidden":!1}).addClass("rx-voice-label").html(t)}}class I{constructor(t){this.app=t,this.config=t.config,this.ui=t.ui,this.page=t.page,this.container=t.container,this.dataAttr="rx-data-theme",this._initialize()}stop(){this._removeTheme()}destroy(){this._removeMediaQueryListener()}set(t){this._applyTheme(t),this._broadcastThemeChange(t)}get(){return this.container.get("main").attr(this.dataAttr)}_initialize(){const t=this._getInitialTheme(),e=this.config.get("theme");this.config.set("globalTheme",t),"auto"===e?(this._addMediaQueryListener(),this.set(t)):this.set(e)}_getInitialTheme(){return this._getStoredTheme()?this._getStoredTheme():this._detectSystemTheme()}_getStoredTheme(){return localStorage.getItem("theme")}_detectSystemTheme(){return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}_applyTheme(t){if("auto"===t&&(t=this._getInitialTheme()),this.container.get("main").attr(this.dataAttr,t),this.ui.updateTheme(t),this.app.isMode("iframe")){const e=this.config.get("themeAttr"),s=this.page.getFrameBody().closest("html");s.attr(this.dataAttr,t),e&&s.attr(e,t)}}_broadcastThemeChange(t){this.app.broadcast("editor.theme",t)}_removeTheme(){if(this.container.get("main").removeAttr(this.dataAttr),this.app.isMode("iframe")){const t=this.config.get("themeAttr"),e=this.page.getFrameBody().closest("html");e.removeAttr(this.dataAttr),t&&e.removeAttr(t)}}_changeThemeOnSystemPreference(){const t=this._detectSystemTheme();this.set(t)}_addMediaQueryListener(){this._mediaQuery().addEventListener("change",this._changeThemeOnSystemPreference.bind(this))}_removeMediaQueryListener(){this._mediaQuery().removeEventListener("change",this._changeThemeOnSystemPreference.bind(this))}_mediaQuery(){return window.matchMedia("(prefers-color-scheme: dark)")}}class L{constructor(t,e){this.app=t,this.editor=e,this.dom=t.dom,this.uuid=t.uuid,this.page=t.page,this.element=t.element,this.config=t.config,this.container=t.container,this.observer=t.observer,this.saved=!1}build(){throw new Error("Method build() must be implemented")}stop(){this.inputComposition.remove()}destroy(){this.a11y.destroy()}restore(){!this.element.isTextarea()&&this.saved&&(this.editor.$editor.attr("style",this.saved.style),this.editor.$editor.attr("dir",this.saved.dir))}_saveElementStyles(){this.element.isTextarea()||(this.saved={style:this.element.attr("style"),dir:this.element.attr("dir")})}_setContainerStyles(){this.config.is("container.border")||this.container.get("main").css("border","none")}_setupDraggable(){this._buildDraggable()}_buildVisibility(){this.editor.$editor.css("visibility","visible")}_buildInputComposition(){this.inputComposition=this.dom('<input type="text" id="rxCompositionCutter'+this.uuid+'" style="position: fixed; left: -9000px; z-index: -1000; width: 1px; height: 1px;" />'),this.page.getFrameBody().append(this.inputComposition)}_buildContent(){this.editor.rawhtml=this.element.getHtml().trim(),this.editor.content=new T(this.app)}_buildBlurClass(){this.config.get("clicktoedit")?this.container.setFocus():this.container.setBlur()}_buildAccessibility(){this.a11y=new B(this.app)}_buildEditable(){this.app.getLayout().attr("contenteditable",!0)}_buildDraggable(){this.page.getBody().find("[data-rx-drop-id]").each((t=>{t.attr("draggable",!0),t.on("dragstart",(t=>{const e=this.dom(t.target).attr("data-rx-drop-id");t.dataTransfer.setData("item",e)}))}))}}class A extends L{build(){this._buildInputComposition(),this._buildElement(),this._buildBlurClass(),this._buildAccessibility(),this._buildStartHtml()}_buildElement(){this.editor.$editor=this._createIframe(),this.editor.$source=this.element,this._appendEditorToContainer(),this._setupIframeLoadHandler()}_createIframe(){const t=this.dom("<iframe>").addClass("rx-editor-frame").css({visibility:"hidden",margin:"0",padding:"0"});return this.config.is("maxHeight")||t.attr("scrolling","no"),t}_appendEditorToContainer(){this.container.get("editor").append(this.editor.$editor)}_setupIframeLoadHandler(){this.editor.$editor.on("load",this._onload.bind(this))}_buildOptions(){const t=this.config.dump();this._saveElementStyles(),this._setEditorAttributesAndStyles(t),this._setContainerStyles()}_setEditorAttributesAndStyles({dir:t,width:e="100%",padding:s,minHeight:i,maxHeight:a,notranslate:r,spellcheck:o,grammarly:n}){const l=this.element.attr("dir")||t;this.editor.$layout.attr("dir",l).css({"max-width":e,padding:s,"min-height":i,"max-height":a,overflow:a?"auto":null}),this.config.is("tabindex")&&this.editor.$editor.attr("tabindex",this.config.get("tabindex")),r&&this.editor.$layout.addClass("notranslate"),o||this.editor.$layout.attr("spellcheck",!1),n||this.editor.$layout.attr("data-gramm_editor",!1)}_buildLayout(){const t=this.page.getFrameBody();this.editor.$layout=t.children().first(),this._applyLayoutClasses(),t.css("height","auto")}_applyLayoutClasses(){const t=this.config.get("classname");this.editor.$layout.attr("dir",this.config.get("dir")).addClass("rx-editor rx-editor-"+this.uuid+" rx-empty"),this.config.is("breakline")&&this.editor.$layout.addClass("rx-editor-breakline"),this.config.is("nostyle")||this.editor.$layout.addClass(t)}_buildStartHtml(){const t=this._generateHtmlDocument();this._writeCode(t)}_generateHtmlDocument(){const t=this._createDoctype(),e=this._buildCustomJs(),s=`<div class="${this.config.get("classname")}"></div>`;return`${t}<html${this.config.is("frame.lang")?` lang="${this.config.get("frame.lang")}"`:""}${this.config.is("frame.dir")?` dir="${this.config.get("frame.dir")}"`:""}><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">${e}</head><body style="padding: 0; margin: 0; width: 100%;">${s}${this._createScripts()}</body></html>`}_buildCustomJs(){return this.config.is("custom.js")?this._processScripts(this.config.get("custom.js"),!0):""}_createDoctype(){return`${this.config.get("doctype")}\n`}_createScripts(){return this.config.is("custom.js")?this._processScripts(this.config.get("custom.js")):""}_processScripts(t,e=!1){return t.flatMap((t=>this._normalizeScript(t))).filter((t=>t.head===e)).map((t=>this.dom("<script>").attr("src",t.src).outer())).join("")}_normalizeScript(t){return"string"==typeof t?{src:t,head:!1}:"object"!=typeof t||null===t||Array.isArray(t)?[]:t}_writeCode(t){const e=this.page.getDocNode();e.open(),e.write(t),e.close()}_onload(){this._buildLayout(),this._buildOptions(),this._buildContent(),this._buildEditable(),this._loaded()}_loaded(){this._initializeApp(),this._buildVisibility(),this._buildEditorCss(),this._buildCustomCss(),this._setupDraggable(),this._adjustOnResize(),this._finalizeLoading()}_initializeApp(){const{app:t}=this.app;t.event.build(),t.placeholder.build(),t.placeholder.trigger(),t.blocks.build(),t.sync.build(),t.embed.build(),t.image.observeStates()}_buildEditorCss(){const t=this.config.get("css")+this.config.get("cssFile");this._buildCssLink(t)}_buildCustomCss(){this.config.is("custom.css")&&this.config.get("custom.css").forEach((t=>this._buildCssLink(t)))}_buildCssLink(t){const e=this.config.is("csscache")?"":(t.includes("?")?"&":"?")+(new Date).getTime(),s=this.dom("<link>").attr({class:"rx-css",rel:"stylesheet",href:t+e});this.page.getFrameHead().append(s)}_adjustOnResize(){this.page.getWin().on("resize.rx-editor-frame",this.editor.adjustHeight.bind(this))}_finalizeLoading(){this.app.loaded=!0,this.app.broadcast("editor.load"),this.editor.adjustHeight(),setTimeout((()=>{if(this.app.isStopped())return;this.editor.adjustHeight(),this.editor.getEditor().focus(),this.editor.setFocus(this.config.get("focus")),this.observer.build(),this.app.broadcast("editor.ready");new IntersectionObserver((t=>{t.forEach((t=>{t.isIntersecting&&this.editor.adjustHeight()}))}),{threshold:0}).observe(this.editor.$editor.get())}),500),setTimeout((()=>this.editor.adjustHeight()),3e3)}}class H extends L{build(){this._initializeBuild(),this._finalizeBuild()}_initializeBuild(){this._buildInputComposition(),this._buildElement(),this._buildOptions(),this._buildBlurClass(),this._buildAccessibility(),this._buildEditable(),this._buildContent()}_finalizeBuild(){this._load()}_buildElement(){const t=this.container.get("editor"),e=this.element.isTextarea(),s=this.config.get("classname"),i=!(this.config.is("nostyle")&&"rx-content"===s);this.editor.$editor=e?this.dom("<div>"):this.element,this.editor.$source=e?this.element:this.dom("<textarea>").hide(),this._addEditorClasses(i),this._addEditorToContainer(t,e)}_addEditorClasses(t){t&&this.editor.$editor.addClass(this.config.get("classname")),this.config.is("breakline")&&this.editor.$editor.addClass("rx-editor-breakline"),this.editor.$editor.addClass(`rx-editor rx-editor-${this.uuid} rx-empty`)}_addEditorToContainer(t,e){t.append(this.editor.$editor),e||t.append(this.editor.$source)}_buildOptions(){const t=this.config.dump(),{dir:e,width:s="100%",padding:i,minHeight:a,maxHeight:r,notranslate:o,spellcheck:n,grammarly:l}=t;this._saveElementStyles(),this._setEditorAttributesAndStyles({dir:e,width:s,padding:i,minHeight:a,maxHeight:r,notranslate:o,spellcheck:n,grammarly:l}),this._setContainerStyles()}_setEditorAttributesAndStyles({dir:t,width:e,padding:s,minHeight:i,maxHeight:a,notranslate:r,spellcheck:o,grammarly:n}){const l={"max-width":this.config.is("nocontainer")?null:e,padding:this.config.is("nocontainer")?null:s,"min-height":i||null,"max-height":a||null,overflow:a?"auto":null};this.editor.$editor.css(l),this._setEditorAttributes(t,r,o,n)}_setEditorAttributes(t,e,s,i){this.config.is("tabindex")&&this.editor.$editor.attr("tabindex",this.config.get("tabindex")),this.editor.$editor.attr("dir",this.element.attr("dir")||t),e&&this.editor.$editor.addClass("notranslate"),s||this.editor.$editor.attr("spellcheck",!1),i||this.editor.$editor.attr("data-gramm_editor",!1)}_load(){try{this._loaded()}catch(t){throw t}}_loaded(){this._initializeApp(),this._setupDraggable(),this._broadcastLoadEvent()}_initializeApp(){const{app:t}=this.app;t.event.build(),t.placeholder.build(),t.placeholder.trigger(),t.blocks.build(),t.sync.build(),t.embed.build(),t.observer.build(),t.image.observeStates()}_broadcastLoadEvent(){this.app.loaded=!0,this.app.broadcast("editor.load")}}class D{constructor(t){this.app=t,this.eventTrigger=!0,this.eventPause=!1,this.eventMouseDown=!1,this.eventTripleClick=!1,this.eventPaste=!1,this.eventTabFocus=!1,this.eventImageDrag=!1,this.preventName="rx-prevent-events"}init(){this.eventStrategy=this.app.isMode("default")?new V(this.app,this):new j(this.app,this)}build(){const t=setInterval((()=>{this.app.isStarted()&&!this.app.isReadonly()&&(this._stopLinkEvents(),this.eventStrategy.start(),clearInterval(t))}),1)}stop(){this._offPreventEvents(),this.eventStrategy.stop()}run(){this._setPause(!1),this._stopLinkEvents(),this.eventStrategy.start()}pause(){this._setPause(!0),this.eventStrategy.stop(),this._offPreventEvents()}isPaused(){return this.eventPause}isPasteEvent(){return this.eventPaste}isTrigger(){return this.eventTrigger}isTabFocus(){return this.eventTabFocus}isMouseDown(){return this.eventMouseDown}isImageDrag(){return this.eventImageDrag}isTripleClick(){return this.eventTripleClick}isToolClick(t){return 0!==this.dom(t.target).closest(".rx-in-tool").length&&(this.block.setTool(!0),!0)}isEditorClick(t){return!!this.editor.isEditor(t.target)&&(t.preventDefault(),!0)}isEditorFocus(){return!(this.dropdown.isOpen()||this.modal.isOpen()||this.source.is())&&(this.block.is()||this.blocks.is()||this.editor.isSelectAll())}isOutsideEditor(t){const e=this.dom(t.target),s=["-modal-","-form-","-toolbar-container-","-source-container-","-control-","-context-","-pathbar-"].map((t=>`.rx${t}${this.uuid}`)).join(",");return!e.closest(`${s}, .rx-editor-${this.uuid}`).length}isEditorContainer(t){const e=this.app.isMode("iframe")?"editor":"container";return 0!==this.dom(t.target).closest(`.rx-${e}-${this.uuid}`).length}setPasteEvent(t){this.eventPaste=t}setTrigger(t){this.eventTrigger=t}setImageDrag(t){this.eventImageDrag=t}setMouseDown(t){this.eventMouseDown=t?{type:this.editor.isEditor(t.target)?"editor":"block",event:t}:t}setTripleClick(t){this.eventTripleClick=t}setTabFocus(t){this.eventTabFocus=t}setMultipleBlocks(){this.selector=new P(this.app,this),this.selector.setMultiple()}getImageDrag(t){return this.eventImageDrag}getMouseDown(){return this.eventMouseDown}checkTabFocus(t){this.setTabFocus("Tab"===t.key)}checkPopupsOpen(t){"Escape"===t.key&&this.ui.isAnyOpen("dropdown","modal","panel")&&this.ui.close("dropdown","modal","panel")}checkPanelKeys(t){const e=t.which;return!(!this.panel.isOpen()||"Enter"!==t.key&&![37,38,39,40].includes(e))&&(t.preventDefault(),!0)}checkModalEnter(t){if(this.modal.isOpen()&&"Enter"===t.key){const e=this.modal.getStack();if(!1!==e.hasForm()&&"TEXTAREA"!==t.target.tagName)return t.preventDefault(),e.getButtonPrimary().dataget("instance").invokeCommand(),!0}return!1}handleTextareaTab(t){if(9!==t.keyCode)return!0;t.preventDefault();let e=t.target,s=e.value,i=e.selectionStart;e.value=s.substring(0,i)+"    "+s.substring(e.selectionEnd),e.selectionStart=e.selectionEnd=i+4}_setPause(t){this.eventPause=t}_stopLinkEvents(){this.editor.getLayout().on(`click.${this.preventName} dblclick.${this.preventName}`,this._stopLinkEvent.bind(this))}_stopLinkEvent(t){this.dom(t.target).closest("a").length&&t.preventDefault()}_offPreventEvents(){this.editor.getLayout().off(`.${this.preventName}`)}_removeDrag(){this.editor.getLayout().find(".rx-draggable-placeholder").remove()}}class P{constructor(t,e){this.app=t,this.dom=t.dom,this.event=e,this.block=t.block,this.blocks=t.blocks,this.editor=t.editor}handleMouseUp(t){const e=this.app.create("selection"),s=this._getBlockFromTarget(t.target),i=s.dataget("instance"),a=e.getRange()?this._normalizeBlocks(e.getNodes({type:"block",partial:!0})):[];if(i?.isType("image"))this.blocks.is()&&!s.hasClass("rx-block-meta-focus")?this._setOne(t,e):this._setOne(!1,e,s);else if(this.event.isMouseDown()){const t=this.event.getMouseDown();"block"===t.type?1===a.length?this._setOne(t.event,e):this._setMultiple(t.event,e,a):1===a.length?this._setOne(!1,e,a[0]):this._setMultiple(!1,e,a)}else this.event.isEditorClick(t)&&e.isCollapsed()?this._setByCoords(t):e.isCollapsed()||1===a.length?this._setOne(t,e):a.length>1&&this._setMultiple(t,e,a)}setByClick(t){const e=this.app.create("selection");this._setOne(t,e)}setMultiple(){const t=this.app.create("selection"),e=t.getNodes({type:"block",partial:!0});this._setMultiple(!1,t,e)}_setMultiple(t,e,s){this.editor.setFocus(),this.editor.deselectAll();const i=this.app.create("element"),a=!!t&&this._getBlockFromTarget(t.target);e.isFullySelected()?this._handleFullSelection(e):s.length>1&&this._handleMultipleBlocks(i,s,a)}_setOne(t,e,s=!1){this.editor.setFocus();const i=s?this.dom(s):this._getBlockFromTarget(t.target);if(i.length){const t=!i.dataget("instance").isEditable()&&"force",e=!1!==t;this.editor.setFocus(),this.block.set(i,t,e)}}_setByCoords(t){const e=this.blocks.get({firstLevel:!0}),s=[],i=[];let a=!1;e.each((t=>{const e=t.get().getBoundingClientRect();s.push([e.x,e.y,e.y+e.height])})),s.forEach(((e,s)=>{const r=t.clientY,o=t.clientX;if(e[1]<r&&r<e[2])return void(a=s);const n=Math.hypot(e[0]-o,e[1]-r);i.push(n)}));const r=!1!==a?a:i.indexOf(Math.min(...i)),o=e.eq(r);this.editor.setFocus(),this.block.set(o,"start")}_setMultipleBlocks(t){this.block.unset(),this.blocks.set(t)}_setSingleBlock(t){this.block.set(t),this.blocks.unset()}_handleMultipleBlocks(t,e,s){this._checkInside(t,e,"quote")?(s=t.getDataBlock(s,"quote"),this._setSingleBlock(s)):this._checkInside(t,e,"noneditable")?(s=t.getDataBlock(s,"noneditable"),this._setSingleBlock(s)):this._setMultipleBlocks(e)}_handleFullSelection(t){const e=this.blocks.get({firstLevel:!0}),s=t.getNodes({type:"block-first"});e.length===s.length&&this.editor.selectAll(e)}_checkInside(t,e,s){return e.every((e=>t.hasParent(e,s)))}_normalizeBlocks(t){const e=t.map((t=>{let e=this.dom(t);return e.attr("data-rx-type")||(e=e.closest("[data-rx-type]")),e.get()}));return[...new Set(e)]}_getBlockFromTarget(t){return this.dom(t).closest("[data-rx-type]")}}class N{constructor(t){this.app=t,this.events={}}on(t,e){this.events[t]||(this.events[t]=[]),this.events[t].push(e)}emit(t,e={}){const s=new M(this.app,t,e);if(this.events[t])for(const e of this.events[t]){const t=e.call(this.app,s);if(void 0!==t&&s.set("result",t),s.isStopped())break}return this._broadcastPlugins(t,s),s}emitHtml(t,e){if("string"!=typeof e)throw new Error("emitHtml expects an HTML string as the third argument.");if(this.events[t]){for(const s of this.events[t]){const t=s.call(this.app,e);void 0!==t&&(e=t)}return e}this.count=0;const s=new M(this.app,t,{html:e});return this._broadcastPlugins(t,s),0!==this.count?s.get("html"):e}_broadcastPlugins(t,e){this.app._plugins.forEach((s=>{this.count++;const i=this.app[s],{subscribe:a}=i;a&&Object.entries(a).forEach((([s,a])=>{s.split(",").map((t=>t.trim())).forEach((s=>{s===t&&("string"==typeof a?i[a](e):a.call(i,e))}))}))}))}}class F{constructor(t,e){this.app=t,this.event=e,this.config=t.config,this.block=t.block,this.blocks=t.blocks,this.editor=t.editor,this.image=t.image,this.control=t.control,this.context=t.context,this.placeholder=t.placeholder}handlePaste(t){t.preventDefault();const e=t.clipboardData,s=this.app.create("clipboard"),i=this.app.create("insertion"),a=this.app.create("utils"),r=this.app.create("cleaner"),o=this.app.create("autoparse");let n=s.getContent(e);const l=e.getData("URL"),h=e.getData("text/rtf"),p=this.block.get();let d=!1,c=!0,g=!0;if(this._handleImagePaste(e))return;this.event.setPasteEvent(!0);const u=this.app.broadcast("editor.before.paste",{e:t,html:n});if(u.isStopped())return void this.event.setPasteEvent(!1);if(n=u.get("html"),n=l&&""!==l?l:n,this.config.is("paste.plaintext")?(c=!1,g=!1,n=a.getTextFromHtml(n,{br:!0})):p&&"pre"===p.getType()&&!this.editor.isSelectAll()?(d=!0,c=!1,g=!1,n=a.getTextFromHtml(n,{nl:!0,trimlines:!1})):this.config.is("paste.clean")||(c=!1),n=this.config.is("paste.links")?n:r.removeTags(n,["a"]),n=this.config.is("paste.images")?n:r.removeTags(n,["img"]),""===n)return void this.event.setPasteEvent(!1);if(h){const t=this._findLocalImages(n);n=this._replaceLocalImages(n,t,this._extractImagesFromRtf(h))}n=c?o.parse(n):n,s.isPlainText(e)&&!d&&(n=n.replace(/\n/g,"<br>"));const m=i.insert({html:n,clean:c,type:"paste",parse:g});this.config.is("image.upload")&&this.image.parseInserted(m),this.placeholder.toggle(),this.app.broadcast("editor.paste",m),this.event.setPasteEvent(!1)}handleCopy(t){this._handleClipboardAction(t,"copy")}handleCut(t){this._handleClipboardAction(t,"cut")}_handleImagePaste(t){const e=this.image.insertFromClipboard(t);return this.config.is("image")&&this.config.is("image.upload")&&e}_handleClipboardAction(t,e){const s=this.app.create("clipboard"),i=this.app.create("selection"),a=this.block.get();let r={};if(a&&a.isEditable()&&i.isCollapsed())return;t.preventDefault(),this.editor.isSelectAll()?r={html:this.editor.getLayout().html(),remove:"all"}:this.blocks.is()?r={html:i.getHtml(),remove:"content"}:a&&a.isEditable()?r=this._copyFromEditable(e,a,i):a&&(r=this._copyFromNonEditable(e,a));var o=this.app.broadcast("editor.before."+e,{e:t,html:r.html});if(o.isStopped())return;"cut"===e&&this._cutDeleteContent(r,i);let n=o.get("html");return s.setContent(t,n),this.app.broadcastHtml("editor."+e,n)}_cutDeleteContent(t,e){this.control.close(),this.context.close(),"instance"===t.remove?t.instance.remove({broadcast:!0}):"all"===t.remove?this.editor.setEmpty():!1!==t.remove&&e.truncate()}_copyFromEditable(t,e,s){const i=e.getType();let a=s.getHtml(),r="content";if("figcaption"===i||"cell"===i||"paragraph"===i)r="content";else if(e.isAllSelected())a=e.getOuterHtml(),r="instance";else if("list"===i){var o=e.getTag();a=s.getHtml(),-1!==a.search(/<li/gi)&&(-1===a.search(/^<li/g)&&(a="<li>"+a+"</li>"),a="<"+o+">"+a+"</"+o+">")}return{html:a,remove:r,instance:e}}_copyFromNonEditable(t,e){return{html:e.getOuterHtml(),remove:"cut"===t&&"instance",instance:e}}_findLocalImages(t){const e=this.app.create("utils"),s=[];return e.wrap(t,(function(t){t.find("img").each((function(t){-1!==t.attr("src").search(/^file:\/\//)&&s.push(t.attr("src"))}))})),s}_extractImagesFromRtf(t){if(!t)return[];const e=/{\\pict[\s\S]+?\\bliptag-?\d+(\\blipupi-?\d+)?({\\\*\\blipuid\s?[\da-fA-F]+)?[\s}]*?/,s=new RegExp("(?:("+e.source+"))([\\da-fA-F\\s]+)\\}","g"),i=t.match(s),a=[];if(!i)return[];for(let t=0;t<i.length;t++){let s=!1;-1!==i[t].indexOf("\\pngblip")?s="image/png":-1!==i[t].indexOf("\\jpegblip")&&(s="image/jpeg"),s&&a.push({hex:i[t].replace(e,"").replace(/[^\da-fA-F]/g,""),type:s})}return a}_convertHexToBase64(t){return btoa(t.match(/\w{2}/g).map((function(t){return String.fromCharCode(parseInt(t,16))})).join(""))}_replaceLocalImages(t,e,s){if(e.length===s.length)for(let i=0;i<e.length;i++){let a="data:"+s[i].type+";base64,"+this._convertHexToBase64(s[i].hex);t=t.replace(new RegExp('src="'+e[i]+'"',"g"),'src="'+a+'"')}return t}}class M{constructor(t,e,s={}){this.app=t,this.eventName=e,this.data=s instanceof M?s.dump():s,this._isStopped=!1}stop(){this._isStopped=!0}isStopped(){return this._isStopped}is(...t){return t.some((t=>this.data.hasOwnProperty(t)))}has(t){return void 0!==this.data[t]}get(t){return this.data.hasOwnProperty(t)?this.data[t]:null}set(t,e){this.data[t]=e}dump(){return this.data}getName(){return this.eventName}}class O{constructor(t,e){this.app=t,this.event=e,this.dom=t.dom,this.image=t.image,this.config=t.config,this.observer=t.observer,this.editor=t.editor,this.block=t.block,this.blocks=t.blocks,this.imageDrag=!1}handleDrop(t){const e=t.dataTransfer,s=e.getData("item"),i=this.config.get("draggable"),a=this.config.is("image")&&this.config.is("image.upload"),r=this.config.get("filelink.upload")&&e.files?.length;s?this._handleItemDrop(t,i[s]):a&&e.files?.length?(t.preventDefault(),this.image.drop(t,e)):r?(t.preventDefault(),this.app.filelink.drop(t,e)):this._handleHtmlDrop(t,e),this._finalizeDrop()}_handleItemDrop(t,e){t.preventDefault(),(e=e||this._getDropItemHtml(t.dataTransfer.getData("item")))&&this._drop(t,e,"after",!1)}_handleHtmlDrop(t,e){let s=e.getData("text/html").trim()||e.getData("Text");const i=this._drop(t,s);if(this.event.isImageDrag()&&i.length){i.dataget("instance").change(this.event.getImageDrag(),!1)}}_getDropItemHtml(t){return this.dom(`[data-rx-drop-item=${t}]`).html().trim()}_finalizeDrop(){this.event._removeDrag(),this.event.setImageDrag(!1),this.observer.setTrigger(!0),this.editor.setFocus()}_drop(t,e,s,i=!0){const a=this.app.create("insertion"),r=this.app.create("autoparse"),o=this.app.create("utils"),n=this._getDropTarget(t.target,s);this.block.set(n),s||a.insertPoint(t);let l=!0,h=!0;const p=this.block.get();if(p&&p.isType("pre")&&!this.editor.isSelectAll()&&(l=!1,h=!1,e=o.getTextFromHtml(e,{nl:!0,trimlines:!1})),!1===i&&(l=!1,e=r.parse(e)),""!==e)return e=l?r.parse(e):e,a.insert({html:e,clean:l,parse:h,position:s})}_getDropTarget(t,e){const s=this.app.create("element"),i="after"===e?s.getFirstLevel(t):s.getDataBlock(t);return 0===i.length?this.blocks.get({first:!0}):i}}class R{constructor(t,e){this.app=t,this.event=e,this.config=t.config,this.dom=t.dom,this.uuid=t.uuid,this.ui=t.ui,this.page=t.page,this.block=t.block,this.blocks=t.blocks,this.state=t.state,this.modal=t.modal,this.keycodes=t.keycodes,this.command=t.command,this.hotkeys=t.hotkeys,this.source=t.source,this.editor=t.editor,this.context=t.context,this.dropdown=t.dropdown,this.observer=t.observer,this.placeholder=t.placeholder,this.eventname="rx-events",this.isPopupMouseUp=!1,this.dragoverEvent=!1,this.input=new m(this.app),this.selector=new P(this.app,this.event),this.dropHandler=new O(this.app,this.event),this.clipboardHandler=new F(this.app,this.event)}onmouseup(t){setTimeout((()=>{this.event.isTrigger()&&!this.event.isToolClick(t)&&(this.selector.handleMouseUp(t),this._observeAndContext(t),this.state.add(t),this.app.broadcast("editor.mouseup",{e:t}))}),0)}onmousedown(t){this.event.isTrigger()&&!this.event.isToolClick(t)&&(this.event.setMouseDown(t),this.isPopupMouseUp||(this.modal.close(),this.dropdown.close()),this.placeholder.handleClick(t),this.app.broadcast("editor.mousedown",{e:t}))}ontouchstart(t){this.event.isTrigger()&&this.state.add(t)}onmouseover(t){this.event.isTrigger()&&(this.page.getBody().find(".rx-tooltip").remove(),this.app.broadcast("editor.mouseover",{e:t}))}onkeyup(t){if(!this.event.isTrigger()||this.dropdown.isOpen())return;if(this.app.broadcast("editor.keyup",{e:t}).isStopped())return void t.preventDefault();this.config.is("command")&&this.command.build(t);const e=t.which,{DOWN:s,UP:i,BACKSPACE:a,LEFT:r,RIGHT:o,ENTER:n}=this.keycodes;[s,i].includes(e)&&this._handleArrowKeys(),e===a&&this.editor.isEmpty()&&this.editor.setEmpty(),[r,o,s,i].includes(e)&&this.observer.observe(),e===n&&this._scrollOnEnter()}ondrop(t){if(!this.event.isTrigger()||!this.config.is("drop"))return t.preventDefault();if(this.app.broadcast("editor.drop",{e:t}).isStopped())return t.preventDefault();this.dropHandler.handleDrop(t)}ondragstart(t){if(!this.event.isTrigger())return;const e=this.dom(t.target).closest("[data-rx-first-level]"),s=this.app.create("element");0!==e.length&&s.isType(e,"image")&&this.event.setImageDrag(e.dataget("instance")),this.app.broadcast("editor.dragstart",{e:t})}ondragover(t){if(this.event.isTrigger()){if(t.preventDefault(),this.dragoverEvent=!0,this.observer.setTrigger(!1),this.event._removeDrag(),t.dataTransfer.types.includes("item")){const e=this.dom(t.target).closest("[data-rx-type]");if(e.length){const t=this.dom("<div>").addClass("rx-draggable-placeholder");e.after(t)}}this.app.broadcast("editor.dragover",{e:t})}}ondragleave(t){this.event.isTrigger()&&(t.preventDefault(),this.dragoverEvent=!0,this.observer.setTrigger(!0),this.event._removeDrag(),this.app.broadcast("editor.dragleave",{e:t}))}ondocmousedown(t){this.event.isTrigger()&&(this.isPopupMouseUp=!!this.dom(t.target).closest(`.rx-modal-${this.uuid}, .rx-dropdown-${this.uuid}`).length,this.app.broadcast("document.mousedown",{e:t}))}onwinfocus(){const t=this.block.get();t&&!t.isEditable()&&setTimeout((()=>{this.app.create("selection").remove()}),0)}_onfocus(t){this.event.isTabFocus()&&!this.editor.hasFocus()&&(this.editor.setFocus("start"),this.event.setTabFocus(!1))}_onpaste(t){this.event.isEditorFocus()&&this.clipboardHandler.handlePaste(t)}_oncopy(t){this.event.isEditorFocus()&&this.clipboardHandler.handleCopy(t)}_oncut(t){this.event.isEditorFocus()&&this.clipboardHandler.handleCut(t)}_onkeydown(t){if(!this._shouldHandleKeyEvent())return;let e=this.app.broadcast("editor.keydown",{e:t});if(e.isStopped())return t.preventDefault();const s=t.key,i=this.app.create("selection");this.event.checkPanelKeys(t)||this._handleInlineCaretMove(t,s,i)||this._handleEscapeKey(t,s,i)||(this.context.close(),this._handleEnterKey(t,s)||this.state.listen(t)||this.hotkeys.handle(t)||this.input.handle(e))}_onclick(t){this.event.isTrigger()&&(this.app.broadcast("editor.click",{e:t}),3!==t.detail||this.event.isToolClick(t)||setTimeout((()=>{this.event.setTripleClick(!0),this.selector.setByClick(t)}),0))}_ondockeydown(t){this.event.isTrigger()&&!this.block.isTool()&&(this.event.checkTabFocus(t),this.event.checkPopupsOpen(t),this.event.checkPanelKeys(t)||this.event.checkModalEnter(t)||this.event.isOutsideEditor(t)||this.app.broadcast("document.keydown",{e:t}))}_observeAndContext(t){setTimeout((()=>{this.context.open(),this.observer.observe(),this.event.setMouseDown(!1),this.event.setTripleClick(!1)}),1)}_shouldHandleKeyEvent(){return this.event.isTrigger()&&!this.ui.isAnyOpen("dropdown","modal")&&!this.source.is()&&this.editor.hasFocus()}_handleInlineCaretMove(t,e,s){const i=this.app.create("caret"),a=s.getInline();return!(!a||!i.is(a,"end")||"ArrowRight"!==e||"block"===a.style.display)&&(t.preventDefault(),i.set(a,"after"),!0)}_handleEnterKey(t,e){return!this.config.is("enterKey")&&"Enter"===e&&(t.preventDefault(),!0)}_handleEscapeKey(t,e,s){if("Escape"===e&&this.context.isOpen()){if(t.preventDefault(),s.collapse(),this.context.close(),this.blocks.is()){const t=this.blocks.get({selected:!0,first:!0,instances:!0});this.blocks.unset(),this.block.set(t)}return!0}return"Escape"===e&&(this.block.unset(),this.blocks.unset(),s.remove()),!1}_handleArrowKeys(){const t=this.app.create("selection").getBlockControlled();t.length&&!this.block.is(t)&&this.block.set(t)}_scrollOnEnter(){setTimeout((()=>{const t=this.app.create("element"),e=this.block.get().getBlock(),s=t.isElementVisibleInScroll(e),i=this.editor.getEditor().get();s||i.scrollTo({top:i.scrollHeight-i.clientHeight,behavior:"smooth"})}),10)}_bindEvents(t,e,s){e.forEach((e=>{t.on(`${e}.${this.eventname}`,(t=>{const i=`on${s}${e}`;"function"==typeof this[i]&&this[i](t)}))}))}_unbindEvent(...t){t.forEach((t=>t.off("."+this.eventname)))}}class j extends R{start(){this.events={body:["click","touchstart","mouseover","mouseup","mousedown","keydown","keyup","paste","copy","cut","drop","dragstart","dragover","dragleave"],doc:["keydown","mousedown","mouseup","click"],win:["focus"],frame:["click"],layout:["focus"]},this._bindEvents(this.page.getFrameBody(),this.events.body,""),this._bindEvents(this.page.getWin(),this.events.win,"win"),this._bindEvents(this.page.getFrameDoc(),this.events.frame,"frame"),this._bindEvents(this.page.getDoc(!1),this.events.doc,"doc"),this._bindEvents(this.editor.getLayout(),this.events.layout,"layout")}stop(){this._unbindEvent(this.page.getFrameBody(),this.page.getWin(),this.page.getFrameDoc(),this.page.getDoc(),this.editor.getLayout())}onclick(t){this._onclick(t)}onkeydown(t){return this._onkeydown(t)}onpaste(t){return this._onpaste(t)}oncopy(t){return this._oncopy(t)}oncut(t){return this._oncut(t)}ondocclick(t){this.event.isTrigger()&&!this.event.isToolClick(t)&&this.app.broadcast("document.click",{e:t})}ondockeydown(t){return this._ondockeydown(t)}ondocmouseup(t){this.isPopupMouseUp||this.event.isOutsideEditor(t)&&(this.editor.setBlur(),this.app.broadcast("document.mouseup",{e:t}))}onframeclick(t){this.event.isTrigger()&&"HTML"===t.target.tagName&&this.selector.setByClick(t)}onlayoutfocus(t){return this._onfocus(t)}}class V extends R{start(){this.events={editor:["click","touchstart","mouseover","mouseup","mousedown","keyup","keydown","drop","dragstart","dragover","dragleave","focus"],doc:["keydown","mousedown","mouseup","click","paste","cut","copy"],win:["focus"]},this._bindEvents(this.editor.getEditor(),this.events.editor,""),this._bindEvents(this.page.getDoc(),this.events.doc,"doc"),this._bindEvents(this.page.getWin(),this.events.win,"win")}stop(){this._unbindEvent(this.editor.getEditor(),this.page.getDoc(),this.page.getWin())}onfocus(t){return this._onfocus(t)}onclick(t){return this._onclick(t)}onkeydown(t){return this._onkeydown(t)}ondocpaste(t){return this._onpaste(t)}ondoccopy(t){return this._oncopy(t)}ondoccut(t){return this._oncut(t)}ondocclick(t){!this.event.isTrigger()||this.event.isToolClick(t)||this.isPopupMouseUp||(this.event.isOutsideEditor(t)&&!this.event.isMouseDown()&&this.editor.setBlur(t),this.app.broadcast("document.click",{e:t}))}ondockeydown(t){return this._ondockeydown(t)}ondocmouseup(t){this.event.isOutsideEditor(t)&&setTimeout((()=>{this.event.isMouseDown()&&(this.selector.handleMouseUp(t),this._observeAndContext(t)),this.app.broadcast("document.mouseup",{e:t})}),2)}}class z{constructor(t){this.app=t,this.cm=!1}create(t){if(!this._isCodemirrorAvailable())return;const e=this._getCodemirrorConfig(),s=this._getCodemirrorInstance();return this.cm=s.fromTextArea(this._getElement(t.el),e),this._setAdditionalOptions(t),this.cm}destroy(){this.cm&&(this.cm.toTextArea(),this.cm=!1)}val(t){return this._isCodemirrorAvailable()&&this.cm?this.cm.getValue():t}_isCodemirrorAvailable(){return this.config.get("codemirror")}_getCodemirrorConfig(){const t=this.config.get("codemirror");return"object"==typeof t?t:{}}_getCodemirrorInstance(){return this.config.get("codemirrorSrc")||CodeMirror}_getElement(t){return this.dom(t).get()}_setAdditionalOptions(t){t.height&&this.cm.setSize(null,t.height),t.focus&&this.cm.focus()}}class Z{constructor(t){this.app=t,this.placeholderClass="rx-placeholder",this.observerTimer=null}build(){const t=this.config.get("placeholder"),e=this.element.getPlaceholder()||t;e&&this._setEditorPlaceholder(e)}handleClick(t){this._isPlaceholderClicked(t)&&(t.preventDefault(),t.stopPropagation(),this.editor.setFocus("start",!1))}trigger(){this.$editor=this.editor.getLayout(),this.editor.isEmpty()?this.show():this.hide()}set(t){this._setEditorPlaceholder(t)}toggle(){clearTimeout(this.observerTimer),this.observerTimer=setTimeout((()=>this.trigger()),10)}show(){this.$editor.addClass(this.placeholderClass)}hide(){this.$editor.removeClass(this.placeholderClass)}_isPlaceholderClicked(t){return this.dom(t.target).hasClass(this.placeholderClass)}_setEditorPlaceholder(t){this.editor.getLayout().attr("placeholder",t)}}class W{constructor(t){this.app=t,this.register={},this.containers={},this.buttonsCustom={},this.buttonsRemove={},this.buttonsBlockSpecific={},this.state={type:!1,button:!1,instance:!1}}stop(){this.closeTooltip()}closeTooltip(){this.app.$body.find(".rx-tooltip").remove()}close(t,...e){t&&!t.preventDefault&&(e.unshift(t),t=null);this._handleContexts(e,["dropdown","modal","control","context","panel"]).forEach((e=>this.app[e].close(t)))}unset(...t){this._handleContexts(t,["toolbar","extrabar","context"]).forEach((t=>this.app[t].unsetActive()))}disable(...t){let e=["path","extrabar","statusbar","toolbar"];if(this.app.isReadonly()){const t=this.config.get("readonly");"object"==typeof t&&(e=e.filter((e=>!t.hasOwnProperty(e))))}this._handleContexts(t,e).forEach((t=>this.app[t].disable()))}disableToolbar(t,e){this._findButtons(t).each((t=>this._enableDisable(t,e,"disable")))}enable(...t){this._handleContexts(t,["path","extrabar","statusbar","toolbar"]).forEach((t=>this.app[t].enable()))}enableToolbar(t,e){this._findButtons(t).each((t=>this._enableDisable(t,e,"enable")))}_enableDisable(t,e,s){if(e.length>0){let i=t.data("name");e.includes(i)&&t.dataget("instance")[s]()}else t.dataget("instance")[s]()}isAnyOpen(...t){return t.some((t=>this.app[t]&&this.app[t].isOpen()))}updateTheme(t){["tooltip","control","context","panel"].forEach((e=>this.app.$body.find(`.rx-${e}`).attr("rx-data-theme",t))),["dropdown","modal"].forEach((e=>this.app.$body.find(`.rx-${e}-`+this.uuid).each((e=>e.attr("rx-data-theme",t)))))}updatePosition(...t){t.forEach((t=>this.app[t].updatePosition()))}updateEvents(...t){t.forEach((t=>this.app[t].updateEvents()))}observeButtons(t){t.find(".rx-button").each((t=>t.dataget("instance")?.observe()))}loadToolbar(t,e){let s=this.app.block.get();return e!==(!!s&&s.getType())?(e=this.buildButtons(t),this.loadBlockButtons(t)):this.observeButtons(this.getContainer(t)),e}loadBlockButtons(t){this.buildBlockButtons(t,this.getContainer(t))}build(t,e){return new U(this,t,e)}loadButtons(t,e,s,i,a){t=this._buildButtonObj(s,t),e=this._buildButtonObj(s,e);const r=this._getToggledButtons(i),o=this._makeButtons(s,i,t,e,a);return i&&i.html(""),this._createButtons(o,r,s,i)}buildButtons(t,e,s){const i=s?[]:this._getButtonsFromconfig(t,e),a=this._getCustomButtons(t,e,s),r="control"===t?[]:this.getButtonsRemove(t),o=this.getContainer(t),n=this._getToggledButtons(o),l=this._makeButtons(t,o,i,a,r,s);(o||"context"===t&&e)&&o.html(""),this._createButtons(l,n,t,o),this._buildButtonsOrder(t,o);let h=this.app.block.get();return!!h&&h.getType()}buildBlockButtons(t,e,s=[]){const i=this.app.block.get();if(!i)return;const a=i.getButtons(t)||{};Object.entries(a).forEach((([i,a])=>{const r=this._buildObject(t,i,a);s.includes(i)||this._isHiddenButton(t,i)||this.app.create("button",i,r,e,t)}))}buildDepth(t,e){let s="",i=["modal","dropdown"].includes(t);this.config.is("bsmodal")?s=i?1061:1060:this.app.isProp("fullscreen")&&(s=i?10002:10001),e.css("z-index",s)}getContainer(t){return this.containers[t]??=this.dom([])}getButtonsCustom(t){return this.buttonsCustom[t]??={}}getButtonsBlockSpecific(t){return this.buttonsBlockSpecific[t]??={}}getButtonsRemove(t){return this.buttonsRemove[t]??=[]}addContainer(t,e){this.containers[t]=e}registerButton(t,e){this.register[t]=e}addButton(t,e,s,i){if(this.app.isStarted()){let i=this._buildObject(t,e,s);this.app.create("button",e,i,this.getContainer(t),t)}else i?(this.buttonsBlockSpecific[t]??={},this.buttonsBlockSpecific[t][e]=s):(this.buttonsCustom[t]??={},this.buttonsCustom[t][e]=s),this.registerButton(e,s)}removeButton(t,e){this.buttonsRemove[t]??=[],Array.isArray(e)?this.buttonsRemove[t].push(...e):this.buttonsRemove[t].push(e)}setButton(){}setButtonColor(t,e){const s=t.dataget("instance");if(s?.has("color"))if(e&&Object.keys(e).length){const{color:t,background:i}=e;t&&i?(s.setBackground(i),s.setColor(t)):s.setBackground(t||i)}else s.resetBackground()}setState(t){let e=this.state;this.state=t,e&&(this.state.prev=e)}setActive(t,e){this.unsetActive(t),this._findButtonInstance(t,e)?.setActive()}setActiveKeys(t,e,s){t.forEach((t=>this._setButtonsActiveByKeys(t,e))),t.forEach((t=>this._setButtonsStyle(t,s)))}setToggled(t,e){this.unsetToggled(t),this._findButtonInstance(t,e)?.setToggled()}getState(){return this.state}getButton(t,e){return this._findButtonInstance(t,e)}unsetActive(t,e){if(e){let s=this._findButtonInstance(t,e);s&&s.unsetActive()}else this._findButtons(t).each((t=>{t.dataget("instance").unsetActive(),t.dataget("instance").resetBackground()}))}unsetToggled(t,e,s){if(e){let s=this._findButtonInstance(t,e);s&&s.unsetToggled()}else this._findButtons(t).each((t=>{let e=t.dataget("instance");e.unsetToggled(),(!s||s&&e.getName()!==s)&&t.removeClass("rx-in-modal")}))}_handleContexts(t,e){return 0===t.length?e:t}_setButtonsActiveByKeys(t,e){e.forEach((e=>this._findButtonInstance(t,e)?.setActive()))}_setButtonsStyle(t,e){this._findButtons(t).each((t=>this.setButtonColor(t,e)))}_findButton(t,e){return this.getContainer(t).find("[data-name="+e+"]")}_findButtonInstance(t,e){let s=this._findButton(t,e);if(0!==s.length)return s.dataget("instance")}_findButtons(t){return this.getContainer(t).find(".rx-button")}_makeButtons(t,e,s,i,a,r){let o=[...s,...i,...r?[]:this._getExtendFromconfig(t),...this._getBlockButtons(t)],n=[...a,...this.config.get(`${t}.hide`)||[]];return o=this._shiftLastPositionButtons(o),o.filter((t=>!n.includes(t.name)))}_buildButtonsOrder(t,e){const s=this._findButtons(t).all(),i=document.createDocumentFragment(),a=this.config.get("buttons."+t),r=o.opts.buttons[t];a&&r!==a&&(a.forEach((t=>{const e=s.find((e=>e.getAttribute("data-name")===t));e&&i.appendChild(e)})),s.forEach((t=>{a.includes(t.getAttribute("data-name"))||i.appendChild(t)})),e.html(""),e.append(i))}_buildObject(t,e,s){let i=this._getButtonObj(e);return i=i?o.extend(!0,{},i,s):o.extend(!0,{},s),i.name=void 0!==i.name?i.name:e,!this._isHiddenButton(t,e)&&i}_buildButtonObj(t,e){let s=[];return Array.isArray(e)?e.forEach((e=>{let i={};"object"==typeof e&&(i=e,e=e.name);const a=this._buildObject(t,e,i);a&&s.push(a)})):Object.entries(e).forEach((([e,i])=>{const a=this._buildObject(t,e,i);a&&s.push(a)})),s}_shiftLastPositionButtons(t){const e=t.findIndex((t=>"last"===t.position));if(-1!==e){const[s]=t.splice(e,1);t.push(s)}return t}_getButtonsFromconfig(t,e){let s=[...this.config.get("buttons."+t)];return"context"===t&&e&&(s=[]),this._buildButtonObj(t,s)}_getCustomButtons(t,e,s){let i="control"===t?{}:this.getButtonsCustom(t);return i=s?{}:i,"context"===t&&e&&(i=this.getButtonsBlockSpecific(t)),this._buildButtonObj(t,i)}_getExtendFromconfig(t){const e=this.config.get(`${t}.add`)||{};return this._buildButtonObj(t,e)}_getBlockButtons(t){const e=this.app.block.get(),s="control"===t?{}:e&&e.getButtons(t)||{};return this._buildButtonObj(t,s)}_getToggledButtons(t){const e={};return t&&t.find(".toggled").each((t=>{const s=t.dataget("instance");s&&(e[s.getName()]={title:s.getTitle(),icon:s.getIcon(),command:s.getCommand()})})),e}_createButtons(t,e,s,i){const a={};return t.forEach((t=>{const r=this.app.create("button",t.name,t,i,s);a[t.name]=r,e[t.name]&&(r.setToggled(),r.setIcon(e[t.name].icon),r.setCommand(e[t.name].command),r.setTitle(e[t.name].title))})),a}_isHiddenButton(t,e){const s=this.app.block.get(),i={add:"addbar",html:"source",format:"format",line:"line",pre:"pre",quote:"quote",layout:"layouts",wrapper:"wrapper",table:"table",image:"image"};return void 0!==i[e]&&!this.config.is(i[e])||(!("trash"!==e||!s||!s.isType("noneditable")||this.config.is("noneditable.remove"))||(!("trash"!==e||!s||!s.isNondeletable())||!("trash"!==e&&"duplicate"!==e||!s||!s.isType("column"))))}_getButtonObj(t){const e=this.config.get("buttonsObj");let s=!!e[t]&&e[t];return s=!s&&this.app.ui.register[t]?this.app.ui.register[t]:s,s}}class U{constructor(t,e,s){this.ui=t,this.type=e,this.uuid=t.uuid,this.$container=s,this.build()}build(){this.$toolbar=new s("<div>").addClass("rx-"+this.type+" rx-"+this.type+"-"+this.uuid),this.$toolbarButtons=new s("<div>").addClass("rx-"+this.type+"-buttons"),this.$toolbarLine=new s("<div>").addClass("rx-"+this.type+"-line").hide(),this.$toolbar.append(this.$toolbarButtons),"context"===this.type&&this.$toolbar.append(this.$toolbarLine),this.$container.append(this.$toolbar),this.ui.addContainer(this.type,this.$toolbarButtons)}getElement(){return this.$toolbar}getElementLine(){return this.$toolbarLine}}class q{constructor(t){this.app=t}init(){this.isEnabled()&&(this.$toolbox=this.app.container.get("toolbox"),this._buildToolbar(),this._buildRaised(),this._buildSticky())}stop(){this.isEnabled()&&this.$toolbar.remove()}load(){this.build()}build(){this.isEnabled()&&this.app.ui.buildButtons("toolbar")}add(t,e){this.app.ui.addButton("toolbar",t,e)}remove(t){this.app.ui.removeButton("toolbar",t)}setActive(t){this.app.ui.setActive("toolbar",t)}setToggled(t){this.app.ui.setToggled("toolbar",t)}unsetActive(t){this.app.ui.unsetActive("toolbar",t)}unsetToggled(t,e){this.app.ui.unsetToggled("toolbar",t,e)}getButton(t){return this.app.ui.getButton("toolbar",t)}getElement(){return this.$toolbar}enable(...t){this.enableSticky(),this.app.ui.enableToolbar("toolbar",t)}disable(...t){this.disableSticky(),this.app.ui.disableToolbar("toolbar",t)}enableSticky(){this.sticky.enableSticky()}disableSticky(){this.sticky.disableSticky()}isSticky(){return this.sticky.isSticky()}isEnabled(){return this.config.is("toolbar")}isRaised(){return this.config.is("toolbar.raised")}isExternal(){return this.config.is("toolbar.target")}rebuildSticky(){this.sticky.observeSticky()}_buildToolbar(){const t=this.app.container.get("toolbar");this.$toolbar=this.app.ui.build("toolbar",t).getElement()}_buildSticky(){this.sticky=new J(this.app,this),this.sticky.enableSticky()}_buildRaised(){this.config.is("toolbar.raised")&&this.$toolbox.addClass("rx-raised")}}class K{constructor(t){this.app=t,this.eventname="rx-toolbar"}init(){this.isEnabled()&&this._buildToolbar()}stop(){this.isEnabled()&&this.$toolbar.remove()}load(){this.build()}build(){this.isEnabled()&&this.app.ui.buildButtons("extrabar")}add(t,e){this.app.ui.addButton("extrabar",t,e)}remove(t){this.app.ui.removeButton("extrabar",t)}setActive(t){this.app.ui.setActive("extrabar",t)}setToggled(t){this.app.ui.setToggled("extrabar",t)}unsetActive(t){this.app.ui.unsetActive("extrabar",t)}unsetToggled(t,e){this.app.ui.unsetToggled("extrabar",t,e)}getButton(t){return this.app.ui.getButton("extrabar",t)}getElement(){return this.$toolbar}enable(...t){this.app.ui.enableToolbar("extrabar",t)}disable(...t){this.app.ui.disableToolbar("extrabar",t)}isEnabled(){return this.config.is("extrabar")}_buildToolbar(){const t=this.app.container.get("toolbar");this.$toolbar=this.app.ui.build("extrabar",t).getElement()}}class J{constructor(t,e){this.toolbar=e,this.app=t,this.config=t.config,this.eventname="rx-toolbar",this.$toolbox=this.app.container.get("toolbox")}isSticky(){let t=this.app.container.get("main"),e=this.toolbar.isRaised()?parseInt(this.$toolbox.css("margin-top")):0,s=t.offset().top+parseInt(t.css("border-top-width"))+e,i=this.$toolbox.offset().top;return i>s||i<s}enableSticky(){this.config.is("toolbar.sticky")&&!this.config.is("toolbar.target")&&(this.config.is("scrollOverflow")?this._startStickyOverflowEvent():(this._applyStickyStyles(),this._startStickyEvent()),this.config.is("scrollOverflow")&&this._observeOverflowSticky())}disableSticky(){this.config.is("toolbar.sticky")&&(this._removeStickyStyles(),this._stopStickyEvent())}observeSticky(){if(this._isSource())return;let t=this.app.scroll.getTarget(),e=0-(this.app.scroll.isTarget()?parseInt(t.css("padding-top")):0)+parseInt(this.config.get("toolbar.stickyTopOffset"));this.app.isProp("fullscreen")&&(e=0),this.$toolbox.css({top:`${e}px`}),this.broadcastSticky()}broadcastSticky(){this.isSticky()?(this.$toolbox.addClass("rx-sticky-on"),this.app.broadcast("toolbar.sticky")):(this.$toolbox.removeClass("rx-sticky-on"),this.app.broadcast("toolbar.static"))}_isSource(){return!!this.app.source.is()&&(this.$toolbox.css("top",0),!0)}_applyStickyStyles(){this.$toolbox.addClass("rx-sticky"),this.$toolbox.css("top",`${this.config.get("toolbar.stickyTopOffset")}px`)}_removeStickyStyles(){this.$toolbox.removeClass("rx-sticky rx-fixed-on"),this.$toolbox.css({position:"","z-index":"","max-width":"",top:""})}_getStickyTarget(){return this.app.scroll.getTarget()}_startStickyOverflowEvent(){const t=this._getStickyTarget(),e=this.app.container.get("main");setTimeout((()=>e.attr("data-initial-width",e.width())),0),t.on(`scroll.${this.eventname}`,this._observeOverflowSticky.bind(this)),t.on(`resize.${this.eventname}`,this._resizeOverflowSticky.bind(this))}_startStickyEvent(){this._getStickyTarget().on(`scroll.${this.eventname}`,this.observeSticky.bind(this))}_stopStickyEvent(){this._getStickyTarget().off(`.${this.eventname}`)}_resizeOverflowSticky(){const t=this.app.container.get("main");t.css("width",""),t.attr("data-initial-width",t.width()),this.$toolbox.hasClass("rx-fixed-on")&&this.$toolbox.css("max-width",`${t.width()}px`)}_observeOverflowSticky(){if(this._isSource())return;const t=this.app.editor.getRect(),e=this.app.container.get("main"),s=this.app.scroll.getTarget(),i=e.offset().top,a=e.data("initial-width"),r=this.$toolbox.height(),o=t.bottom-80,n=s.get().pageYOffset;n>=i&&n<=o?(this._applyFixedStyles(e,a,r),this.app.broadcast("toolbar.sticky")):(this._removeFixedStyles(e),this.app.broadcast("toolbar.static"))}_applyFixedStyles(t,e,s){this.$toolbox.css({position:"fixed","z-index":1060,"max-width":`${t.width()}px`,top:"0px"}),t.css({width:`${e}px`,"padding-top":`${s}px`}),this.$toolbox.addClass("rx-fixed-on")}_removeFixedStyles(t){this.$toolbox.css({position:"","z-index":"","max-width":"",top:""}),t.css({width:"","padding-top":""}),this.$toolbox.removeClass("rx-fixed-on")}}class Q{constructor(t){this.app=t,this.customButtons={},this.removeButtons=[]}add(t,e){this.customButtons[t]=e,this.app.ui.registerButton(t,e)}remove(t){if(Array.isArray(t))for(let e=0;e<t.length;e++)this.removeButtons.push(t[e]);else this.removeButtons.push(t)}getItems(){let t=[...this.config.get("popups.addbar")],e=this.config.get("addbarItems")||{},s=o.extend(!0,{},e,this.customButtons),i=this.app.ui.loadButtons(t,s,"addbar",!1,this.removeButtons),a=["text","address","list","todo","quote","dlist"];for(let[t,e]of Object.entries(i))-1!==a.indexOf(t)&&e.setCommand("block.add");return i}popup(t,e){void 0===t&&(t=e,e=void 0,this.ui.setState({button:e,type:!1}));let s=[...this.config.get("popups.addbar")],i=this.config.get("addbarItems")||{};const a=this.config.get("addbar.hide")||[];this.customButtons=o.extend(!0,{},i,this.customButtons);let r=[...this.removeButtons,...a];this.app.dropdown.create("addbar",{items:s,extend:this.customButtons,remove:r,type:"addbar"}),this.app.dropdown.open(t,e)}}class G{constructor(t){this.app=t,this.eventName="rx-context",this.instance=!1,this.line=!1}init(){if(!this.isEnabled())return;let t=this.app.ui.build("context",this.app.$body);this.$context=t.getElement(),this.$contextLine=t.getElementLine(),this.$contextButtons=this.app.ui.getContainer("context"),this.$context.hide()}stop(){this.isEnabled()&&(this.$context.remove(),this.app.scroll.getTarget().off("."+this.eventName))}remove(t){this.app.ui.removeButton("context",t)}addLine(t){this.line=t}add(t,e,s){this.app.ui.addButton("context",t,e,s)}unsetActive(t){this.app.ui.unsetActive("context",t)}unsetToggled(t,e){this.app.ui.unsetToggled("context",t,e)}getButton(t){return this.app.ui.getButton("context",t)}getElement(){return this.$context}getInstance(){return this.instance}isOpen(){if(this.isEnabled())return this.$context.hasClass("open")}isEnabled(){return this.config.is("context")}close(){this._close()}open(){if(this.line=!1,!this.isEnabled()||this.app.block.isTool())return;if(this.config.is("context.click"))return void this._open();let t=this.app.create("selection"),e=this.app.create("element"),s=t.getCurrent(),i=this._getBlockSelection(s),a=this._getInlineSelection(s);t.is()&&e.isTool(s)?this.app.block.setTool(!0):i&&t.is()&&!t.isCollapsed()?this._open():a&&0!==a.length?(this.instance=a.dataget("instance"),this.instance.isContext()&&this._open(a)):this._close()}updateEvents(){this.isEnabled()&&(this.app.scroll.getTarget().off("."+this.eventName),this.app.editor.getEditor().off("."+this.eventname),this._buildEvents())}updatePosition(){if(!this.isEnabled())return;let t=this.$context.width(),e=this.app.editor.getRect(),s=this.app.page.getDoc().scrollTop(),i=this.app.create("selection"),a=i.getPosition("end"),r=0,o=0;if(this.app.isMode("iframe")){let t=this.app.editor.getRect();r=t.top,o=t.left}const n=i.getPosition();let l=n.left+o+2,h=n.bottom+r+s;if(this.app.blocks.is()&&0===a.left&&0===a.top){let t=this.app.blocks.get({last:!0,selected:!0,instances:!0}),e=t.getOffset();l=e.left+o+2,h=e.top+t.getBlock().height()}if(this.app.editor.isSelectAll()){let t=this.app.blocks.get({last:!0}),e=t.offset();l=e.left+o+2,h=e.top+r+t.height()+s}if(l+t>e.right&&(l=a.left+o-t-2),a.left-o==0&&a.right-r==0&&this.instance){let t=this.instance.getOffset(),e=this.instance.getBlock().height();l=t.left,h=t.top+e}this.app.ui.buildDepth("context",this.$context),this.$context.css({left:l+"px",top:h+2+"px"}),this.$context.attr({dir:this.config.get("dir"),"rx-data-theme":this.app.editor.getTheme()})}_open(t){this._shouldShowToolbar()&&(this.$contextLine.html("").hide(),this.instance&&this.$contextButtons.html(""),this.app.ui.buildButtons("context",this.instance,t),""===this.$contextButtons.html()&&(this.instance=!1),this.line&&this.$contextLine.html(this.line).show(),this._buildPosition(),this._buildEvents(),this.app.broadcast("context.open"))}_shouldShowToolbar(){if(!this.config.is("context.exclude")&&!this.config.is("context.include"))return!0;const t=this.app.create("selection").getNodes({type:"block"}),e=this.config.get("context.exclude")||{},s=this.config.get("context.include")||{},i=e.tags||[],a=e.blocks||[],r=s.tags||[],o=s.blocks||[];for(let e of t){const t=e.tagName.toLowerCase(),s=e.getAttribute("data-rx-type");if(i.includes(t)||a.includes(s))return!1;if((r.length||o.length)&&!r.includes(t)&&!o.includes(s))return!1}return!0}_close(){this.isEnabled()&&this.$context.hasClass("open")&&(this.$context.hide().removeClass("open"),this.instance=!1,this.app.scroll.getTarget().off("."+this.eventname),this.app.editor.getEditor().off("."+this.eventname),this.app.broadcast("context.close"))}_getBlockSelection(t){return 0===this.dom(t).closest("[data-rx-inline], [data-rx-type=noneditable], [data-rx-type=figcaption]").length}_getInlineSelection(t){return t?this.dom(t).closest("[data-rx-inline]"):this.editor.getLayout().find("[data-rx-inline]").filter((t=>t.hasClass("rx-block-focus"))).eq(0)}_buildPosition(){this.$context.addClass("open"),this.updatePosition(),this.$context.show()}_buildEvents(){let t=this.app.scroll.getTarget();this.app.scroll.isTarget()&&t.on("scroll."+this.eventname,this._scroll.bind(this)),t.on("resize."+this.eventName,this.updatePosition.bind(this)),this.app.editor.getEditor().on("scroll."+this.eventname,this._scroll.bind(this))}_scroll(){const t=()=>{this.app.modal.isOpen()&&this.app.editor.save()},e=(e,s=0)=>{const i=e.offset().top+s,r=i+e.height();return a+this.$context.height()>r||i>a?(this.$context.hide(),!0):this.isOpen()?(this.$context.show(),t(),!1):void 0};this.app.modal.isOpen()&&this.app.editor.restore();const s=this.app.create("selection").getPosition("end"),i=this.app.page.getDoc().scrollTop(),a=s.bottom+i+2;this.$context.css("top",`${a}px`);let r=!1;if(this.app.scroll.isTarget()){r=e(this.app.scroll.getTarget(),20)}if(this.config.is("maxHeight")&&!r){e(this.app.editor.getEditor())}}_isInstance(t){let e=this.app.block.get(),s=e&&e.isEditable(),i=e&&"pre"!==e.getType();return s&&i}}class Y{constructor(t){this.app=t,this.eventName="rx-control",this.parentTypes={cell:[{name:"parent",title:"## table.select-table ##"},"cell-setting"],cellParent:[{name:"parent",title:"## table.select-table ##"},{name:"parent",title:"## table.select-cell ##",params:{cell:!0}}],column:[{name:"parent",title:"## layout.select-layout ##"},{name:"parent",title:"## layout.select-column ##",params:{column:!0}}]}}init(){this.isEnabled()&&this._buildToolbar()}stop(){this.isEnabled()&&(this._removeControl(),this._stopEvents())}add(t,e){this.app.ui.addButton("control",t,e)}remove(t){this.app.ui.removeButton("control",t)}isEnabled(){return this.config.is("control")}build(){let t=this.app.block.get();t?this.open(t):this.close()}getButton(t){return this.app.ui.getButton("control",t)}getElement(){return this.$control}trigger(){this.isEnabled()&&this.getButton("toggle").getElement().click()}popup(t,e){if(this._shouldCloseDropdown())return void this.app.dropdown.close();let s=[...this.config.get("popups.control")];this._getParentElement()&&(s=this._getParentButtons(s));const i=this.app.ui.getButtonsCustom("control"),a=this.app.ui.getButtonsRemove("control");this.app.dropdown.create("control",{items:s,extend:i,remove:a}),this.app.dropdown.open(t,e)}open(t){this.isEnabled()&&(this.instance=t,this._hasControl()?(this._setParentInstance(),this.instance?(this._buildEvents(),this._prepareToOpen(),this._updatePositions(),this._buildReorder()):this.close()):this.close())}close(){this.isEnabled()&&this.$control&&(this.$control.hide(),this._stopEvents(),this.instance=!1)}updateEvents(){this.isEnabled()&&(this._stopEvents(),this._buildEvents())}updatePosition(){if(!this.isEnabled()||!this.instance)return void this.close();const{top:t,left:e}=this._calculatePosition();this.$control.show(),(this._shouldHideForScrollTarget(t)||this._shouldHideForEditor(t))&&this.$control.hide(),this._setPosition(t,e)}_calculatePosition(){const t=this.instance.getOffset(),e=this.$control.width(),{topOutlineFix:s,leftOutlineFix:i}=this._getOutlineFixes(),{frameOffsetTop:a,frameOffsetLeft:r}=this._getFrameOffsets(),o=parseInt(this.instance.getBlock().css("margin-left")),n=this._getAdjustedLeftOutlineFix(i,o);return{top:t.top+a-s,left:t.left+r-e-n}}_getOutlineFixes(){const t=parseInt(this.instance.getBlock().css("padding-top"));return{topOutlineFix:this.instance.isType("line")&&0===t?14:5,leftOutlineFix:5}}_getFrameOffsets(){let t=0,e=0;if(this.app.isMode("iframe")){const s=this.app.editor.getRect();t=s.top,e=s.left}return{frameOffsetTop:t,frameOffsetLeft:e}}_getAdjustedLeftOutlineFix(t,e){return e<0?t+e:t}_shouldHideForScrollTarget(t){if(this.app.scroll.isTarget()){const e=this.app.scroll.getTarget(),s=e.offset().top+e.height(),i=e.offset().top,a=t+this.$control.height(),r=parseInt(e.css("padding-top"));return a>s||i+r>t}return!1}_shouldHideForEditor(t){if(this.config.is("maxHeight")){const e=this.app.editor.getEditor(),s=e.offset().top+e.height(),i=e.offset().top;return t+this.$control.height()>s||i>t}return!1}_setPosition(t,e){this.app.ui.buildDepth("control",this.$control),this.$control.css({top:`${t}px`,left:`${e}px`})}_removeControl(){this.$control.remove()}_shouldCloseDropdown(){return this.app.dropdown.isOpen()&&"control"===this.app.dropdown.getName()}_getParentElement(){return this.instance.getClosest(["list","wrapper","layout","todo","table"])}_getParentButtons(t){return this.instance.isType("cell")?t.push(...this.parentTypes.cell):this.instance.getClosest("cell")?t.unshift(...this.parentTypes.cellParent):this.instance.getClosest("column")?t.unshift(...this.parentTypes.column):t.unshift("parent"),t}_setParentInstance(){this.instance.isParent()&&(this.instance=this.instance.getParent())}_prepareToOpen(){this.app.ui.buildButtons("control"),this.$control.attr("rx-data-theme",this.app.editor.getTheme()),this.$control.show()}_hasControl(){return!1!==this.instance.getControl()}_updatePositions(){this.updatePosition(),this.app.dropdown.updatePosition()}_stopEvents(){this.app.scroll.getTarget().off("."+this.eventName),this.app.editor.getEditor().off("."+this.eventName)}_buildReorder(){const t=this.getButton("toggle");this.config.is("reorder")&&this.instance.isReorder()&&new f(this.app,this,t,this.$control,this.instance)}_buildToolbar(){this.$control=this.app.ui.build("control",this.app.$body).getElement(),this.$control.hide()}_buildEvents(){let t=this.app.scroll.getTarget();t.on("resize."+this.eventName,this.updatePosition.bind(this)),t.on("scroll."+this.eventName,this.updatePosition.bind(this)),this.app.editor.getEditor().on("scroll."+this.eventName,this.updatePosition.bind(this))}}class X{constructor(t){this.app=t,this.classname="rx-pathbar",this.activeClass="active",this.pathItemClass="rx-pathbar-item"}init(){this.config.is("pathbar")&&(this.$pathbar=this.dom("<div>").attr("dir",this.config.get("dir")),this.$pathbar.addClass(this.classname+" "+this.classname+"-"+this.uuid),this.app.container.get("pathbar").append(this.$pathbar),this._buildRoot(),this._buildActive())}build(){this.config.is("pathbar")&&(this._clear(),this._buildRoot(),this.app.blocks.is()||(this._buildItems(),this._buildActive()))}enable(){this.config.is("pathbar")&&this.$pathbar.removeClass("disable")}disable(){this.config.is("pathbar")&&this.$pathbar.addClass("disable")}_clear(){this.$pathbar.find("."+this.pathItemClass).off(".rx-path-"+this.uuid),this.$pathbar.html("")}_createItem(){return this.dom("<span>").addClass(this.pathItemClass)}_buildRoot(){let t=this.config.get("pathbar.title");t=t||this.loc.get("pathbar.title"),this._buildItem(!1,t)}_buildItems(){let t=this.app.block.get();if(!t)return;let e=t.getBlock().parents("[data-rx-type]");e.nodes.reverse(),e.each(this._buildParentItem.bind(this)),this._buildItem(t)}_buildParentItem(t){let e=t.dataget("instance");e.isType(["row"])||this._buildItem(e)}_buildItem(t,e){let s=this._createItem();s.dataset("instance",t),s.on("click.rx-path-"+this.uuid,this._selectItem.bind(this)),this._buildTitle(s,e||t.getTitle()),this.$pathbar.append(s)}_buildTitle(t,e){let s=this.dom("<span>").html(e);t.append(s)}_buildActive(){this.$pathbar.find("."+this.pathItemClass).removeClass(this.activeClass).last().addClass(this.activeClass)}_selectItem(t){if(t.stopPropagation(),t.preventDefault(),this.$pathbar.hasClass("disable"))return;let e=this.dom(t.target).closest("."+this.pathItemClass).dataget("instance");if(this.app.dropdown.close(),this.app.context.close(),this.app.modal.close(),e){let t=!!e.isType("column")&&"column";this.app.block.set(e,t)}else this._clear(),this._buildRoot(),this._buildActive(),this.app.block.unset(),this.app.blocks.unset()}}class tt{constructor(t){this.app=t,this.classname="rx-statusbar"}init(){this.$statusbar=this.dom("<div>").attr("dir",this.config.get("dir")),this.$statusbar.addClass(this.classname+" "+this.classname+"-"+this.uuid),this.app.container.get("statusbar").append(this.$statusbar)}is(){return""!==this.$statusbar.html()}enable(){this.$statusbar.removeClass("disable")}disable(){this.$statusbar.addClass("disable")}add(t,e){return this.update(t,e)}update(t,e){let s=this.get(t);return 0===s.length&&(s=this._buildItem(t)),s.html(e)}getHeight(){return this.is()?this.$statusbar.height():0}getElement(){return this.$statusbar}get(t){let e=t?"[data-name="+t+"]":"[data-name]";return this.$statusbar.find(e)}remove(t){this.get(t).remove()}clear(){this.$statusbar.html("")}_buildItem(t){let e=this.dom("<span>").addClass(this.classname+"-item");return e.attr("data-name",t),this.$statusbar.append(e),e}}class et{constructor(t){this.app=t,this.defs={type:!1,button:!1,width:!1,maxWidth:!1,items:!1,remove:!1,extend:!1,getter:!1,setter:!1,builder:!1,observer:!1,html:!1,listen:!0,keys:[]}}isOpen(){return 0!==this.app.$body.find(".rx-dropdown").length}isPositionTop(){if(!this.dropdown)return!1;let t=this.dropdown.getElement();return this.isOpen()&&"top"===t.attr("data-rx-pos")}open(t,e){this.app.editor.save(),this.app.broadcast("dropdown.before.open",{dropdown:this}),this._open(t,e),this.app.modal.close(),this.app.observer.observe(),this.app.broadcast("dropdown.open",{dropdown:this})}close(){if(this.$dropdown){if(this._stopEvents(),this.button&&this.button.isButton){let t=this.button.getName();this.app.toolbar.unsetToggled(t),this.app.extrabar.unsetToggled(t),this.app.context.unsetToggled(t),this.button.getElement().removeClass("rx-in-dropdown toggled")}this.$dropdown.remove(),this.app.$body.find(".rx-colorpicker-"+this.uuid).remove(),this.app.broadcast("dropdown.close")}}closeAll(){this.app.$body.find(".rx-dropdown").each((function(t){let e=t.dataget("instance");e&&e.close()}))}getName(){return this.name}updatePosition(t){this.$dropdown&&(this._buildPosition(t),this._buildHeight())}getElement(){return this.$dropdown}create(t,e){this.params=o.extend({},this.defs,e),this.name=t,this.params.html&&(this.params.listen=!1),this.closeAll(),this._build()}_open(t,e){this.button=e,this.params.html?this._buildHtml():this._buildItems(),this._buildName(),this._buildWidth(),this._buildPosition(),this._buildHeight(),this._buildActiveKeys(),this._startEvents(),this.app.ui.buildDepth("dropdown",this.$dropdown),this.button&&this.button.isButton&&this.button.getElement().addClass("rx-in-dropdown toggled"),this.$dropdown.show(),this.params.listen&&this.app.page.getDoc().on("keydown.rx-dropdown",this._listen.bind(this))}_buildWidth(){this.params.width&&this.$dropdown.css("width",this.params.width),this.params.maxWidth&&this.$dropdown.css("max-width",this.params.maxWidth)}_buildPosition(t){let e,s,i,a,r,o,{button:n,type:l,prev:h}=this.app.ui.getState(),p=1,d=2,c=this.app.scroll.getTarget(),g=this.app.toolbar.getElement(),u=this.app.editor.getRect();if(this.$dropdown.attr("data-panel"))return;d="context"===l?-2:"toolbar"===l?0:d,p="context"===l?1:p,h&&"addbar"===l&&(n=h.button,"toolbar"===h.type&&(l="toolbar"));let m=this.app.$body.get().getBoundingClientRect();"control"===l?(e=this.app.control.getElement().width(),s=this.app.control.getElement().offset()):n&&n.isButton?(e=n.getWidth(),s=n.getOffset(),i=n.getHeight()):!n&&this.control.isEnabled()?(e=this.app.control.getElement().width(),s=this.app.control.getElement().offset()):(e=0,s=g.offset(),i=g.height(),l="toolbar"),["toolbar","context"].includes(l)?(a=s.top+i+p,r=s.left):(a=s.top+p,r=s.left+e+d),"panel"===l&&(s=this.app.panel.getRect(),a=s.top,r=s.left,d=0),this.app.panel.hide(),this.$dropdown.show(),o=this.$dropdown.width(),["toolbar","context"].includes(l)?(r=u.left<r?s.left+d:r,r=u.right<r+o?s.left-o+e:r,r=r<0?0:r):(r=u.left<r?s.left+e+d:r,r=u.right<r+o?s.left-o-d:r),["panel","context"].includes(l)&&m.bottom<a+200?(a=a-this.$dropdown.height()-i-4,this.$dropdown.attr("data-rx-pos","top")):this.$dropdown.removeAttr("data-rx-pos"),this._buildHide(t,c,a),"panel"===l?this.$dropdown.attr("data-panel",!0):this.$dropdown.removeAttr("data-panel"),this.$dropdown.css({top:a+"px",left:r+"px"})}_buildHide(t,e,s){let i=e.offset().top,a=parseInt(e.css("padding-top"));if(t&&i+a>s)return this.$dropdown.hide(),!0;if(this.config.is("maxHeight")&&"toolbar"!==this.app.ui.getState().type){let t=this.app.editor.getEditor(),e=t.offset().top+t.height(),i=t.offset().top;if(s>e||i>s)return this.$dropdown.hide(),!0}return!1}_buildHeight(){let t,e,s,i=this.app.scroll.getTarget(),a=this.$dropdown.offset();this.app.scroll.isTarget()?(e=a.top-i.offset().top,t=i.height()-parseInt(i.css("border-bottom-width"))):(e=a.top-i.scrollTop(),t=i.height()),s=t-e-10,this.$dropdown.css("max-height",s+"px")}_buildActiveKeys(){0!==this.params.keys.length&&this._setActiveKeys(this.params.keys)}_buildName(){this.$dropdown.attr("data-rx-dropdown-name",this.name),this.$dropdown.addClass("rx-dropdown-"+this.name)}_buildHtml(){this.$dropdownItems.append(this.params.html)}_buildItems(){let t,e=this.params.items,s=this.params.extend?this.params.extend:{},i=["text","address","list","todo","quote","dlist"],a="dropdown",r=[];if("control"===this.app.ui.getState().type&&"control"===this.name){a="control";let t=this.config.get("control.add");t&&(s=o.extend(!0,{},s,t));let e=this.config.get("control.hide");e&&(r=[...r,...e])}this.params.remove&&(r=this.params.remove);let n=this.params.type||"dropdown";this.app.ui.loadButtons(e,s,n,this.$dropdownItems,r),this.app.ui.buildBlockButtons(a,this.$dropdownItems,r),"addbar"===this.name&&(t=this.$dropdown.find(".rx-button-addbar"),t.each((function(t){let e=t.attr("data-name");if(-1!==i.indexOf(e)){t.dataget("instance").setCommand("block.add")}})))}_build(){this.$dropdown=this.dom("<div>").addClass("rx-dropdown rx-dropdown-"+this.uuid),this.$dropdown.hide(),this.$dropdown.dataset("instance",this),this.$dropdown.attr({dir:this.config.get("dir"),"rx-data-theme":this.app.editor.getTheme()}),this.params.type&&this.$dropdown.addClass("rx-dropdown-type-"+this.params.type),this.$dropdownItems=this.dom("<div>").addClass("rx-dropdown-items"),this.$dropdown.append(this.$dropdownItems),this.app.$body.append(this.$dropdown)}_startEvents(){this.app.scroll.getTarget().on("resize.rx-dropdown scroll.rx-dropdown",this.updatePosition.bind(this)),this.app.editor.getEditor().on("scroll.rx-dropdown",this.updatePosition.bind(this))}_stopEvents(){this.app.scroll.getTarget().off(".rx-dropdown"),this.app.editor.getEditor().off(".rx-dropdown"),this.app.page.getDoc().off(".rx-dropdown")}_listen(t){switch(t.which){case 9:case 40:t.preventDefault(),this._select("next");break;case 38:t.preventDefault(),this._select("prev");break;case 13:t.preventDefault(),this._set(t)}}_select(t){let e=this.$dropdown.find(".rx-button");if(0===e.length)return;let s=this.$dropdown.find(".active");e.removeClass("active");let i=this._selectItem(s,e,t);i.addClass("active");let a=i.outerHeight(),r=i.position().top,o=this.$dropdown.scrollTop(),n=r+2*a,l=this.$dropdown.outerHeight();this.$dropdown.scrollTop(n>o+l?n-l:r-a<o?r-a:o)}_selectItem(t,e,s){let i,a=0!==t.length,r="next"===s?0:e.length-1;return a&&(i=t[s]()),a&&i&&0!==i.length||(i=e.eq(r)),i}_set(t){let e=this.$dropdown.find(".active").dataget("instance");e&&e.trigger(t)}_setActiveKeys(t){for(let e=0;e<t.length;e++)this.$dropdown.find("[data-name="+t[e]+"]").addClass("active")}_unsetActive(){this.$dropdown.find(".rx-button-dropdown").removeClass("active")}}class st{constructor(t){this.app=t,this.saved=!1}init(){this._build(),this._buildStacks(),this._buildHeader()}stop(){this._stopEvents(),this._stop()}isOpen(){return this.$modal&&this.$modal.hasClass("open")}open(t){if(this.params=o.extend({},{name:!1,stack:!1,button:!1,focus:!1},t),this.button=this.params.button,this.stack=this.params.stack,this.name=this.params.name,this.button&&this.button.isButton){this.app.toolbar.unsetToggled(!1,this.button.getName()),this.app.extrabar.unsetToggled(!1,this.button.getName()),this.app.context.unsetToggled(!1,this.button.getName());let t=this.button.getElement();if(t.hasClass("rx-in-modal"))return void this.close();t.addClass("rx-in-modal toggled")}this.app.editor.save(),this.app.dropdown.close(),this._open()}close(t){this.isOpen()&&(t||this.app.editor.restore(),this._stopEvents(),this.$modal.hide(),this.$modal.removeClass("open"),this.button&&this.button.isButton&&this.button.getElement().removeClass("rx-in-modal toggled"),this.app.broadcast("modal.close",{modal:this,stack:this.stack}),this.button=!1,this.stack=!1,this.name=!1)}getHeader(){return this.$header}getBody(){return this.stack.getBody()}getFooter(){return this.stack.getFooter()}getStack(){return this.stack}getElement(){return this.$modal}getName(){return this.name}getButton(){return this.button}updateWidth(t){let e=this.app.container.get("main"),s=e.width(),i=parseInt(e.css("border-left-width")),a=parseInt(e.css("border-right-width")),r="100%"===t;("100%"===t||s<parseInt(t))&&(s>880&&(r=!1),s=s>880?880:s,t=(t=s-i-a)<300?300:t,t+="px"),this.$modal.css({width:t}),this.$modal.attr("data-width",t),this.$modal.attr("data-fullwidth",r)}updatePosition(t){this._buildPosition(t),setTimeout(this._buildHeight.bind(this),0),this.app.ui.buildDepth("modal",this.$modal)}updateOnScroll(){this.isOpen()&&(this._buildPosition(),setTimeout(this._buildHeight.bind(this),0))}_open(){this.app.broadcast("modal.before.open",{modal:this,stack:this.stack}),this.$stacks.html(""),this.$stacks.append(this.stack.getStack()),this._renderName(),this._renderHeader(),this.stack.render(),this._buildPosition(),setTimeout(this._buildHeight.bind(this),0),this.app.ui.buildDepth("modal",this.$modal),this._startEvents(),this.$modal.show(),this.$modal.addClass("open"),this.stack.renderFocus(this.params.focus),this.app.broadcast("modal.open",{modal:this,stack:this.stack})}_startEvents(){let t=this.app.scroll.getTarget();t.on("resize.rx-modal",this.updatePosition.bind(this)),t.on("scroll.rx-modal",this.updateOnScroll.bind(this)),this.app.editor.getEditor().on("scroll.rx-modal",this.updateOnScroll.bind(this))}_stopEvents(){this.app.scroll.getTarget().off(".rx-modal"),this.app.editor.getEditor().off(".rx-modal")}_stop(){this.$modal&&this.$modal.remove()}_renderHeader(){let t=this.stack.getTitle();this.$header.html(""),t&&(this.$header.html(this.loc.parse(t)),this._buildClose())}_renderName(){this.$modal.attr("rx-modal-name",this.name)}_build(){this.$modal=this.dom("<div>").addClass("rx-modal rx-modal-"+this.uuid),this.$modal.hide(),this.$modal.attr({dir:this.config.get("dir"),"rx-data-theme":this.app.editor.getTheme()}),this.app.$body.append(this.$modal)}_buildClose(){let t=this.dom("<span>").addClass("rx-modal-close");t.one("click",this._catchClose.bind(this)),this.$header.append(t)}_buildHeader(){this.$header=this.dom("<div>").addClass("rx-modal-header"),this.$modal.prepend(this.$header)}_buildStacks(){this.$stacks=this.dom("<div>").addClass("rx-modal-stacks"),this.$modal.append(this.$stacks)}_buildPosition(){let{button:t,type:e,prev:s}=this.app.ui.getState();const i=this.app.container.get("toolbox"),a=this.app.$body.get().getBoundingClientRect(),r=this.app.container.get("main").get().getBoundingClientRect(),o=this.$modal.attr("data-fullwidth");if(this.$modal.attr("data-panel"))return;s&&"addbar"===e&&(t=s.button,"toolbar"===s.type&&(e="toolbar"));let n=parseInt(this.$modal.attr("data-width")),l=0,h=0,p=0;if(t){let s="control"===e?this.control.getButton("toggle"):t,d="panel"===e?this.panel.getRect():s.getRect(),c=d?d.left-a.left:0,g=d?a.right-d.right:0;o?("toolbar"===e?l=i.offset().top+i.height():(l=d.top+d.height,p=10,n-=20,this.$modal.css({width:n+"px"})),h=r.left+p):(h=r.left,l=d.top+d.height,g>=n?h=d.left:c>=n&&(h=d.left+d.width-n))}else l=i.offset().top+i.height(),h=r.left;if(this.config.is("maxHeight")){let t=this.app.editor.getEditor(),e=t.offset().top+t.height(),s=t.offset().top;l>e||s>l?this.$modal.hide():this.app.modal.isOpen()&&this.$modal.show()}let d=this.app.scroll.getTarget();n>d.width()?this.$modal.css({width:d.width()+"px"}):this.$modal.css({width:n+"px"}),"panel"===e?this.$modal.attr("data-panel",!0):this.$modal.removeAttr("data-panel"),this.app.panel.hide(),this.$modal.css({top:l+"px",left:h+"px"})}_buildHeight(){let t,e,s,i=this.app.scroll.getTarget(),a=this.$modal.offset();this.app.scroll.isTarget()?(e=a.top-i.offset().top+parseInt(i.css("padding-top")),t=i.height()-parseInt(i.css("border-bottom-width")),s=t-e-0):(e=a.top-i.scrollTop(),t=i.height(),s=t-e-0),this.$modal.css("max-height",s+"px")}_catchClose(t){t.preventDefault(),t.stopPropagation(),this.close()}}class it{constructor(t){this.app=t,this.classname="rx-panel"}stop(){this.close(),this.app.page.getDoc().off(".rx-panel")}isOpen(){return this.$panel&&this.$panel.hasClass("open")}build(t,e){return this.$panel=this.app.$body.find(".rx-panel"),this.module=t,this.callback=e,0===this.$panel.length?(this.$panel=this.dom("<div>").addClass(this.classname),this.app.$body.append(this.$panel)):this.$panel.html(""),this.$panel}open(t){if(!this.$panel)return;this.$panel.addClass("open");let e=0,s=0;if(this.app.isMode("iframe")){let t=this.app.editor.getRect();e=t.top,s=t.left}this.$panel.css({top:t.top+e+"px",left:t.left+s+"px"}),this.config.is("bsmodal")?this.$panel.css("z-index",1061):this.app.isProp("fullscreen")?this.$panel.css("z-index",10001):this.$panel.css("z-index",""),this.app.page.getDoc().off(".rx-panel"),this.app.page.getDoc().on("keydown.rx-panel",this._listen.bind(this)),this.app.editor.getEditor().on("click.rx-panel",this.hide.bind(this))}close(){this.$panel&&(this.$panel.remove(),this.$panel=!1,this.app.page.getDoc().off(".rx-panel"),this.app.editor.getEditor().off(".rx-panel"))}hide(){this.$panel&&this.$panel.hide()}getElement(){return this.$panel}getRect(){let t=this.$panel.offset();return t.height=0,t.width=0,t}getItems(){return this.$panel.find(".rx-panel-item")}getActiveItem(){return this.$panel.find(".active")}getFirstItem(){return this.getItems().first()}getLastItem(){return this.getItems().last()}setActive(t){this.getItems().removeClass("active"),t.addClass("active");var e=t.outerHeight(),s=t.position().top,i=this.$panel.scrollTop(),a=s+2*e,r=this.$panel.outerHeight();this.$panel.scrollTop(a>i+r?a-r:s-e<i?s-e:i)}setNextActive(t){let e=t.next();if(0!==e.length)this.setActive(e);else{let s=t.closest(".rx-panel-section");if(0!==s.length&&0!==s.next().length&&(e=s.next().find(".rx-panel-item").first(),0!==e.length))return void this.setActive(e);let i=this.getFirstItem();this.setActive(i)}}setPrevActive(t){let e=t.prev();if(0!==e.length)this.setActive(e);else{let s=t.closest(".rx-panel-section");if(0!==s.length&&0!==s.prev().length&&(e=s.prev().find(".rx-panel-item").last(),0!==e.length))return void this.setActive(e);let i=this.getLastItem();this.setActive(i)}}_listen(t){let e=t.which,s=this.app.keycodes;if(this.isOpen()&&e===s.ENTER){let e=this.getActiveItem();return 0===e.length?void this.close():(t.preventDefault(),void this.module[this.callback].call(this.module,t,e))}if(this.isOpen()&&(40===e||38===e||39===e||37===e)){let t=this.getActiveItem();if(0===t.length){let t=this.getFirstItem();this.setActive(t)}else 40===e||39===e?this.setNextActive(t):38!==e&&37!==e||this.setPrevActive(t)}}}class at{constructor(t){this.app=t,this.handleStr="",this.handleLen=1,this.handleTrigger="/"}build(t){let e=t.which,s=t.ctrlKey||t.metaKey,i=this.app.keycodes;if(e!==i.ESC){if(e!==i.DELETE&&e!==i.SHIFT&&!s&&-1===[37,38,39,40].indexOf(e)){if(e===i.SPACE)return this.handleLen=1,void this._hide();e===i.BACKSPACE&&(this.handleLen=this.handleLen-2,this.handleLen<=0?(this.handleLen=1,this._hide()):this.handleLen<=1&&this._hide()),this._emit()}}else this.app.editor.restore()}_emit(){let t=this.app.create("selection"),e=this.handleTrigger,s=new RegExp("^"+e);this.handleStr=t.getText("before",this.handleLen),this.handleStr2=t.getText("before",this.handleLen+1),s.test(this.handleStr)&&(this.handleStr=this.handleStr.replace(e,""),this.handleLen++,this.handleLen-1>0&&this._load())}_load(){this._createPanel(),0===this._buildPanel(this.$panel,this.handleStr)&&this._hide()}_createPanel(){this.$panel=this.app.panel.build(this,"_insertFromPanel"),this.$panel.addClass("rx-panel-command rx-panel-stack").css("max-width","372px");let t=this.app.page.getDoc().scrollTop(),e=this.app.create("selection").getPosition();this.app.panel.open({top:e.bottom+t,left:e.left}),this.app.editor.save()}_buildPanel(t,e){let s=this.app.create("utils"),i=0,a={add:"Add",format:"Turn into"};this.items={add:this.app.addbar.getItems(),format:this.app.format.getItems()};for(let[r,o]of Object.entries(this.items)){let n=this.dom('<div class="rx-panel-section">'),l=this.dom('<div class="rx-panel-title">'),h=this.dom('<div class="rx-panel-box">'),p=0,d=a[r];l.html(d),n.append(l),n.append(h);let c=!(!e||""===e)&&new RegExp(s.escapeRegExp(e),"gi");for(let[t,e]of Object.entries(o)){if(!e.getTitle())continue;let s=e.getTitleText();if(c&&-1===t.search(c)&&-1===s.search(c))continue;let i=this.dom('<span class="rx-panel-item">'),a=this.dom('<span class="rx-panel-item-icon">').html(e.getIcon()),o=this.dom('<span class="rx-panel-item-title">').html(e.getTitle());i.attr({"data-name":t,"data-section":r}),i.append(a),i.append(o),i.on("click",this._insertFromPanel.bind(this)),h.append(i),p++}p>0&&(i++,t.append(n))}return i}_insertFromPanel(t,e){this.app.editor.restore();let s=e||this.dom(t.target);s=s.closest(".rx-panel-item");let i=s.data("name"),a=s.data("section"),r=this.handleTrigger,o=this.app.create("selection"),n=this.app.create("offset"),l=o.getCurrent(),h=r+this.handleStr,p=l.textContent,d=n.get(l),c=(r+this.handleStr).length,g=p.lastIndexOf(h);g>=0&&(p=p.substring(0,g)+""+p.substring(g+h.length)),l.textContent=p,d.start=d.start-c+0,d.end=d.end-c+0,n.set(d,l),this.items[a][i].trigger(t,"panel"),this._hideForce()}_hide(){this.app.panel.close()}_hideForce(){this._hide(),this.handleStr="",this.handleLen=1}}class rt{constructor(t){this.app=t,this.instance=!1,this.$block=!1,this.tool=!1}create(t){const e=this.app.create("block.text");return t&&e.getBlock().html(t),e}createHtml(t){return this.create(t).getOuterHtml()}trigger(t){this.is()&&this.instance.getPlaceholder()&&(this.instance.isEditable()&&this.instance.isEmpty(!1,!0)&&this.instance.setEmpty(!0),"childlist"!==t.type&&"characterData"!==t.type||this.instance.trigger(t))}isTool(){return this.tool}setTool(t){this.tool=t,this.observer.trigger=!t,t&&this.unset()}is(t){return t?this._isBlockActive(t):this.get()}setParent(t){if(!this.is())return;this._closeUI();const e=t&&t.column?"column":"force",s=this._getParentByParams(t);s&&this.set(s,e)}set(t,e,s){if(t&&(!0===s||!this._isBlockActive(t))&&(this.editor.deselectAll(),this.blocks.unset(),this.unset(),this.instance=this._getInstance(t),this.instance)){if(this.instance.isType("noneditable")&&!this.config.is("noneditable.select"))return this.instance=!1,!1;this.instance.isType("column")&&"column"!==e?(this.instance=this.instance.getFirstBlockInstance(),e="start"):this.instance.isParent()&&(this.instance=this.instance.getParent()),this.$block=this.instance.getBlock(),this.$block.addClass("rx-block-focus"),this.config.is("block.outline")&&this.config.is("control")&&!this.instance.isFocusable()&&this.instance.getControl()&&this.$block.addClass("rx-block-control-focus"),this._setCaret(e),this.toolbar.build(),this.extrabar.build(),this.control.build(),this.path.build(),this.app.broadcast("block.set",{instance:this.instance})}}unset(){this.instance&&(this.$block&&this.$block.removeClass("rx-block-focus rx-block-control-focus"),this.instance=!1,this.$block=!1,this.setTool(!1),this.dropdown.close(),this.control.close(),this.context.close(),this.path.build(),this.app.broadcast("block.unset"))}get(){return this.instance}setData(t){this.instance&&this.instance.setData(t)}getData(){return this.instance?this.instance.getData():null}unwrap(){if(!this.is()||!this.instance.isType(["layout","wrapper"]))return;this.dropdown.close();const t=this.instance.getBlock();let e=this.instance.getType(),s=t.children().first();"wrapper"===e?t.unwrap():"layout"===e&&(s=s.children().first(),t.find("[data-rx-type=column]").unwrap(),t.unwrap()),this.set(s,"start"),this.editor.build(),this.app.broadcast("block.unwrap",{type:e})}remove(t){if(!this.is())return;this._closeUI();const e=this.instance.getType(),s={traverse:!0,...t},i="image"===e?this._getDataImage():{};this.instance.remove({traverse:s.traverse}),s.traverse||this.unset(),"image"===e&&(this.image.setImageState(this.instance,i,!1),this.app.broadcast("image.remove",i)),this.app.broadcast("block.remove",{type:e}),this.editor.isEmpty()&&this.editor.setEmpty()}change(t,e){this.is()&&this.instance.change(t,e)}insert(t){if(this.is())return this.instance.insert(t)}add(t,e,s){this._closeUI();const i=this.app.create("insertion"),a=e.getTemplate();let r;if(a)r=i.insert({html:a,position:position});else{const t=this.app.create(`block.${s}`);r=i.insert({instance:t,type:"add"})}return setTimeout((()=>{this.app.broadcast("block.add",{inserted:r})}),1),r}duplicate(){if(!this.is())return;this._closeUI();const t=this.instance.duplicate(),e=this.instance.insert({instance:t,position:"after",caret:"start",type:"duplicate"});return this.app.broadcast("block.duplicate",{instance:e}),e}moveUp(){this.is()&&this.instance.move("up")}moveDown(){this.is()&&this.instance.move("down")}_closeUI(){this.dropdown.close(),this.modal.close(),this.ui.closeTooltip()}_getParentByParams(t){return t&&t.cell?this.instance.getClosest("cell"):t&&t.column?this.instance.getClosest("column"):this.instance.getClosest(["list","wrapper","layout","todo","table"])}_getInstance(t){return t&&t.app?t:this.dom(t).dataget("instance")}_getDataImage(){return{url:this.instance.getSrc(),id:this.instance.getId(),uid:this.instance.getDataImage()}}_isBlockActive(t){return t=t.$block?t.$block:t,this.instance&&this.dom(t).get()===this.$block.get()}_setCaret(t){const e=["embed","image","line","noneditable"],s=["todo","list"],i=this.app.create("utils"),a=this.instance.getType(),r=t=>t.includes(a),o="force"===t&&r(s)||!t&&r(s),n="force"===t?i.extendArray(e,["layout","wrapper","table","cell"]):e;"column"===t||r(n)||this.instance.isInline()&&!this.instance.isEditable()||o?this._setFocus(a):t&&"force"!==t&&this.instance.setCaret(t)}_setFocus(t){const e=this.app.create("selection");this.scroll.save(),this.$block.attr("tabindex","-1"),this.$block.focus(),"noneditable"!==t&&(e.collapse(),setTimeout((()=>e.remove()),1)),this.scroll.restore()}}class ot{constructor(t){this.app=t,this.selected=[],this.focusClass="rx-block-meta-focus"}build(){const t=this.app.editor.getLayout();t.find("[data-rx-first-level]").removeAttr("data-rx-first-level"),t.children("[data-rx-type]").attr("data-rx-first-level",!0)}trigger(t){this.is()&&("childlist"!==t.type&&"characterData"!==t.type||this.get({selected:!0,instances:!0}).forEach((e=>{e.trigger(t)})))}is(){return this.selected.length>0}set(t){this.unset(),this.selected=Array.isArray(t)?t:t.all(),this.selected.forEach((t=>{this.dom(t).addClass(this.focusClass)})),this.path.build()}setInstances(t){this.unset();this.selected=t.map((t=>{const e=t.getBlock();return e.addClass(this.focusClass),e})),this.path.build()}unset(){this.selected=[],this.editor.getLayout().find("."+this.focusClass).removeClass(this.focusClass),this.block.setTool(!1)}has(t){return 0!==this.count(t)}count(t){return this.get(t).length}get(t={}){let e=this.editor.getLayout().find("[data-rx-type]");if(t.selected&&(e=e.filter("."+this.focusClass)),t.firstLevel&&(e=e.filter("[data-rx-first-level]")),!1===t.firstLevel&&(e=e.not("[data-rx-first-level]")),t.type&&(e=e.filter(this._getTypesSelector(t.type))),t.editable&&(e=e.filter("[contenteditable=true]")),t.except&&(e=e.not(this._getTypesSelector(t.except))),t.first&&(e=e.first()),t.last&&(e=e.last()),t.instances){const s=[];return e.each((t=>{s.push(t.dataget("instance"))})),t.first||t.last?s[0]:s}return e}removeAll(){if(this.editor.isSelectAll())return this._removeAllSelected(),this.get({first:!0});this.get({selected:!0}).each((t=>{t.closest("[data-rx-first-level]").remove()}))}remove(t){if(this.editor.isSelectAll())return void this._removeAllSelected();const e=this.get({selected:!0}),s=e.last(),i=this._getNextElement(s);e.get().reverse().forEach((t=>this._removeSelected(t))),this.get({selected:!0,type:["cell","column"],instances:!0}).forEach((t=>this._fillEmptyBlocks(t))),t&&0!==i.length?this.block.set(i,"start"):this.context.close()}_removeAllSelected(){this.editor.setEmpty(),this.editor.deselectAll(),this.editor.setFocus("start",!1)}_removeSelected(t){const e=this.dom(t).dataget("instance"),s=e.getType();if(!("noneditable"===s&&!this.config.is("noneditable.remove"))&&-1===["cell","row","column","figcaption"].indexOf(s)){this._shouldRemoveInstance(s,e)&&e.remove({traverse:!1})}}_shouldRemoveInstance(t,e){const s=["todo","list","wrapper"];return!["wrapper","layout","table","todo","list"].includes(t)||(!("table"!==t||!this._isTableSelected($node))||(!(!s.includes(t)||!e.isEmpty(!0))||!("layout"!==t||!this._isLayoutSelected(e.getBlock(),e))))}_fillEmptyBlocks(t){if(t.isEmpty()){const e=this.block.create();t.getBlock().append(e.getBlock())}}_getTypesSelector(t){return Array.isArray(t)?"[data-rx-type="+t.join("],[data-rx-type=")+"]":`[data-rx-type=${t}]`}_getNextElement(t){const e=t.dataget("instance"),s=e.getType(),i=e.getClosest(["cell","column"]);let a=t.nextElement();return["todoitem","listitem"].includes(s)&&e.isLastElement()?a=e.getParent().getBlock().nextElement():i&&i.isLastElement()&&(a=i.getParent().getBlock().nextElement()),a}_isLayoutSelected(t,e){const s=e.getColumns(),i=s.filter((t=>t.getBlock().hasClass(this.focusClass)&&t.isEmpty())).length;return s.length===i}_isTableSelected(t){const e=t.find("tr");return e.length===e.filter(`.${this.focusClass}`).length}}class nt{constructor(t){this.app=t}init(){this.popupManager=new lt(this.app)}getItems(){return this.popupManager.getItems()}popup(t,e){this.popupManager.popup(t,e)}remove(t){this.popupManager.remove(t)}set(t,e,s){if(this.block.isTool())return;this.dropdown.close();const i=this.app.create("selection"),a=this.app.block.get(),r=this._getInstances(i,a);this.params=t||{},this.name=s,this.tag=this._buildTag(),this.type=this._buildType(),this.multiple=r.length>1,this.isSelectAll=this.editor.isSelectAll(),this.$editor=this.app.editor.getLayout(),this.collection=[],r.length&&(this.app.broadcast("format.before.set",{instances:r}),this._format(r))}_getInstances(t,e){return!this.editor.isSelectAll()&&t.isCollapsed()?e?[e]:[]:this.blocks.is()?this.blocks.get({selected:!0,instances:!0}):e?[e]:[]}_format(t){const e=this.app.create("marker"),s=this.app.create("element");this.converter=new ht(this.app,this),this.isSelectAll||e.save(),t.forEach((t=>this._processInstance(t,s))),this._convertFormatted(s),this._combineSelected("list"),this._combineSelected("todo"),setTimeout((()=>this._buildConverted(e)),0)}_processInstance(t,e){if(-1===["text","heading","address","list","listitem","todo","todoitem","quote","pre"].indexOf(t.getType()))return;const s=this._hasSameTag(t),i=this._processNewInstance(t,s,e);s&&t.isType(this.type)&&this.collection.push(t),i&&(Array.isArray(i)?this.collection.push(...i):this.collection.push(i))}_processNewInstance(t,e,s){return this._shouldConvertToText(t,e)?this.converter.convertToText(t,s):t.isType(["text","heading","address"])?this.converter.convertText(this.type,t,s):t.isType("listitem")?this._processConvertListItem(t,e,s):t.isType("todoitem")?this.converter.convertTodoItem(this.type,t,s):t.isType(["pre","quote"])?this.converter.convertPreQuote(this.type,t,s):t.isType("list")?this.converter.convertList(this.type,t,s):t.isType("todo")?this.converter.convertTodo(this.type,t,s):this.isSelectAll?this._processAllSelected(t,e,s):void 0}_processAllSelected(t,e,s){return["heading","text"].includes(this.type)&&t.isType(["list","todo"])?this.converter.convertAllSelected(t):"list"===this.type&&!e&&t.isType("list")?this.converter.convertAllSelectedList(t,s):void 0}_processConvertListItem(t,e,s){let i=!e&&this.listType?"list":this.type,a=t.getParentTop();return a.length&&a.tag(this.tag)&&(i="text"),this.converter.convertListItem(i,t,s)}_shouldConvertToText(t,e){return!this.multiple&&e&&!this._isParams()&&["heading","address"].includes(this.type)}_convertFormatted(t){Object.entries({".rx-format-todo-to-listitem":"convertFormattedTodoToList",".rx-format-todo-to-text":"convertFormattedTodoToText",".rx-format-list-to-text":"convertFormattedListToText",".rx-format-listitem-to-todo":"convertFormattedListToTodo"}).forEach((([e,s])=>{this.$editor.find(e).each((e=>this.converter[s](e,t)))}))}_buildConverted(t){let e;this.isSelectAll?(e=this.app.create("selection"),this._setParams(e),this._finalizeSelection()):(t.restore(),e=this.app.create("selection"),this._setParams(e),this._setFocus(e))}_setFocus(t){if(this.multiple){const e=t.getNodes({type:"block",partial:!0});this.blocks.set(e),this.app.broadcast("format.set",{$nodes:this.dom(e)})}else{let e=t.getBlockControlled();e=0===e.length?this.app.editor.getLayout().find(".rx-block-focus").dataget("instance"):e;const s=!(!e.isEmpty||!e.isEmpty())&&"start";this.block.set(e,s),this.app.broadcast("format.set",{$nodes:this.dom(e)})}this.editor.build(),t.isCollapsed()||this.context.open()}_finalizeSelection(){this.editor.deselectAll(),this.editor.build(),this.editor.selectAll(!1,!1);const t=this.blocks.get();this.app.broadcast("format.set",{$nodes:t})}_setParams(t){if(!t.is())return;const e=t.getNodes({tags:[this.tag],partial:!0}),s=this.app.create("element"),{classParamSize:i,styleParamSize:a,attrsParamSize:r}=this._checkParams(e,s);e.length&&(this._setClass(e,i),this._setStyle(e,a),this._setAttrs(e,r))}_checkParams(t,e){let s=0,i=0,a=0;return t.forEach((t=>{const r=this.dom(t);this.params.classname&&r.hasClass(this.params.classname)&&s++,this.params.style&&e.hasStyle(r,this.params.style)&&i++,this.params.attrs&&e.hasAttrs(r,this.params.attrs)&&a++})),{classParamSize:s,styleParamSize:i,attrsParamSize:a}}_setAttrs(t,e){if(!this.params.attrs)return;const s=this.params.attrs;this.dom(t).each((i=>{const a=i.dataget("instance");a&&(t.length===e?this._removeAttrs(a,s):this._setAttrsForInstance(a,s))}))}_removeAttrs(t,e){Object.keys(e).forEach((e=>t.removeAttr(e)))}_setAttrsForInstance(t,e){Object.entries(e).forEach((([e,s])=>t.setAttr(e,s)))}_setStyle(t,e){if(!this.params.style)return;const s=this.app.create("cleaner"),i={...this.params.style};t.length===e&&Object.keys(i).forEach((t=>i[t]="")),this.dom(t).css(i).each((t=>{s.cacheElementStyle(t),""===t.attr("style")&&t.removeAttr("style")}))}_setClass(t,e){if(!this.params.classname)return;const s=t.length===e?"removeClass":"addClass";this.dom(t)[s](this.params.classname)}_combineSelected(t){const e=this.app.create("selection");if(e.is()){e.getNodes({types:[t],partial:!0}).forEach((e=>this._combineBlock(e,t)))}}_combineBlock(t,e){const s=this.dom(t).dataget("instance");if(s){const t=s.getPrev(e);t&&t.getTag()===s.getTag()&&(t.getBlock().append(s.getBlock().children()),s.remove())}}_buildTag(){return{numberedlist:"ol",bulletlist:"ul",text:this.config.get("markup")}[this.name]||this.params.tag||this.name}_buildType(){return["text","p","div"].includes(this.tag)?"text":["h1","h2","h3","h4","h5","h6"].includes(this.tag)?"heading":["ol","ul"].includes(this.tag)?"list":this.params.type||this.name}_isParams(){return Boolean(this.params.style||this.params.classname||this.params.attrs)}_hasSameTag(t){const e=t.getTag();return t.isType("quote")&&"quote"===this.tag||t.isType(["todo","todoitem"])&&"todo"===this.tag||e===this.tag}}class lt{constructor(t){this.app=t,this.config=t.config,this.dropdown=t.dropdown,this.observer=t.observer,this.ui=t.ui,this.removeButtons=[]}getItems(){const t=[...this.config.get("popups.format")],e=this._getFormatItemsWithCommands();return this.ui.loadButtons(t,e,"format",!1,this.removeButtons)}popup(t,e){const s=[...this.config.get("popups.format")],i=this._getFormatItemsWithCommands(),a=this.observer.getKeys();this.dropdown.create("format",{items:s,extend:i,keys:a,remove:this.removeButtons,type:"formatbar"}),this.dropdown.open(t,e)}remove(t){Array.isArray(t)?this.removeButtons.push(...t):this.removeButtons.push(t)}_getFormatItemsWithCommands(){const t=this.config.get("formatItems");if(t)for(let e in t)t[e].command="format.set";return t}}class ht{constructor(t,e){this.app=t,this.format=e,this.config=t.config,this.tag=e.tag,this.type=e.type,this.collection=e.collection,this.replacer=new pt(this.app,e)}convertAllSelectedList(t,e){const s=t.getBlock();return this.replacer.replaceListToListElement("list",this.tag,s,e)}convertAllSelected(t){const e=t.getBlock(),s=[];return e.children().each((t=>{const e=t.dataget("instance"),i=e.getContent(),a="text"===this.type?"block.text":"block.heading",r="text"===this.type?{content:i}:{level:this.tag.replace("h",""),content:i},o=this.app.create(a,r);e.getBlock().after(o.getBlock()),e.remove(),s.push(o)})),e.unwrap(),s}convertFormattedListToText(t,e){this._convertListOrTodoToText(t,"list",e)}convertFormattedTodoToText(t,e){this._convertListOrTodoToText(t,"todo",e)}convertFormattedListToTodo(t,e){this._convertTodoList(t,e,"list","todo","todoitem","rx-format-listitem-to-todo")}convertFormattedTodoToList(t,e){this._convertTodoList(t,e,"todo","list","listitem","rx-format-todo-to-listitem",this.tag)}convertToText(t,e){return this.replacer.replaceTo("text",this.config.get("markup"),t,e)}convertText(t,e,s){return{heading:()=>this.replacer.replaceTo("heading",this.tag,e,s),text:()=>this.replacer.replaceTo("text",this.config.get("markup"),e,s),address:()=>this.replacer.replaceTo("text",this.config.get("markup"),e,s),list:()=>this.replacer.replaceToList(e),todo:()=>this.replacer.replaceToTodo(e),quote:()=>this.replacer.replaceToQuote(e)}[t]()}convertTodoItem(t,e,s){return{heading:()=>this.replacer.replaceListTodoToText("heading","todo",e),text:()=>this.replacer.replaceListTodoToText("text","todo",e),list:()=>this.replacer.replaceTodoToList(e)}[t]()}convertPreQuote(t,e,s){return{heading:()=>this.replacer.replaceToHeading(e),text:()=>this.replacer.replaceToText(e),list:()=>this.replacer.replaceToList(e),todo:()=>this.replacer.replaceToTodo(e),quote:()=>this.replacer.replaceToQuote(e)}[t]()}convertList(t,e,s){let i=e.getItems();if("text"===t||"heading"===t)this._convertItemsToTextOrHeading(i,e,t);else{if("list"===t)return this.replacer.replaceListToList(this.tag,e,s);"quote"===t?this._convertItemsToQuote(i,e):"todo"===t&&this._convertItemsToTodoList(i,e)}}convertTodo(t,e,s){let i=e.getItems();"text"===t||"heading"===t?this._convertItemsToTextOrHeading(i,e,t,!0):"quote"===t?this._convertItemsToQuote(i,e):"list"===t&&this._convertItemsToList(i,e)}convertListItem(t,e,s){if("text"===t&&!e.hasParentList())return this.replacer.replaceListTodoToText("text","list",e);if("heading"===t&&!e.hasParentList())return this.replacer.replaceListTodoToText("heading","list",e);if("todo"===t){const t=this.app.create("block.todoitem",{content:e.getContent()}),s=t.getBlock();return e.getBlock().after(s),e.remove(),s.closest("[data-rx-type=list]").addClass("rx-format-listitem-to-todo"),t}return"list"===t?this.replacer.replaceListToList(this.tag,e,s):void 0}_convertItemsToTextOrHeading(t,e,s,i=!1){let a,r;for(let o=0;o<t.length;o++){const n=i?t[o].content:t[o];r="text"===s?this.app.create("block.text",{content:n}):this.app.create("block.heading",{level:this.tag.replace("h",""),content:n}),0===o&&(a=r),e.getBlock().before(r.getBlock())}a&&this.app.block.set(a.getBlock(),"start"),e.remove()}_convertItemsToQuote(t,e){let s=t.map((t=>t.content||t)).join(""),i=this.app.create("block.quote",{content:s});e.getBlock().before(i.getBlock()),this.app.block.set(i.getBlock(),"start"),e.remove()}_convertItemsToList(t,e){let s=this.app.create("block.list",{numbered:"ol"===this.tag});e.getBlock().before(s.getBlock()),s.setEmpty(),t.forEach((t=>{let e=this.app.create("block.listitem",{content:t.content||t});s.getBlock().append(e.getBlock())})),this.app.block.set(s.getBlock(),"start"),e.remove()}_convertItemsToTodoList(t,e){let s=this.app.create("block.todo");e.getBlock().before(s.getBlock()),s.setEmpty(),t.forEach((t=>{let e=this.app.create("block.todoitem",{content:t.content||t});s.getBlock().append(e.getBlock())})),this.app.block.set(s.getBlock(),"start"),e.remove()}_convertTodoList(t,e,s,i,a,r,o=null){let n;if(t.find("li").length===t.find(`[data-rx-type=${a}]`).length){o&&(t=t.replaceTag(o)),t.removeAttr("data-rx-type"),t.children().removeAttr("data-rx-type"),n=this.app.create(`block.${i}`,t);const e=t.dataget("instance");e&&"todo"===s&&n.setAttrs(e.getAttrs()),this.collection.push(n)}else{const e=this._findConvertedItem(s,i,a,t).nextElement();e?.attr("data-rx-type")===s&&0===e.get().children.length&&e.remove()}t.removeClass(r)}_convertListOrTodoToText(t,e,s){if(0===t.find("li").length)return void t.unwrap();const i=this._findConvertedText(e,t),a=i.nextElement();a?.attr("data-rx-type")===e&&0===a.get().children.length&&a.remove(),i.unwrap(),t.removeClass("rx-format-todo-to-text")}_findConvertedItem(t,e,s,i){const a=`[data-rx-type=${s}]`;let r,o,n=i.find(a).first().prevElement().get();if(n)for(o=i.cloneEmpty(),"list"===e&&(o=o.replaceTag(this.tag)),i.after(o),r=this.app.create(`block.${e}`,o),this.collection.push(r);n.nextSibling;)o.append(n.nextSibling);else o=i,"list"===e&&(o=o.replaceTag(this.tag)),r=this.app.create(`block.${e}`,o),this.collection.push(r);return this._appendNextSiblings(t,i,o,a),o}_findConvertedText(t,e){const s="[data-rx-type=text],[data-rx-type=heading]";let i,a=e.find(s).first().prevElement().get();if(a)for(i=e.cloneEmpty(),i=i.replaceTag(this.tag),e.after(i);a.nextSibling;)i.append(a.nextSibling);else i=e;return this._appendNextSiblings(t,e,i,s),i}_appendNextSiblings(t,e,s,i){let a=s.find(i).last().get();if(a){const i=e.cloneEmpty();for(s.after(i),this.app.create(`block.${t}`,i);a.nextSibling;)i.append(a.nextSibling)}}}class pt{constructor(t,e){this.app=t,this.tag=e.tag}replaceToList(t){return this._replaceToListOrTodo(t,"list",{numbered:"ol"===this.tag})}replaceToTodo(t){return this._replaceToListOrTodo(t,"todo")}replaceToQuote(t){return this._replaceToBlock(t,"quote",{content:t.getPlainText()})}replaceToHeading(t){return this._replaceToBlock(t,"heading",{level:this.tag.replace("h",""),content:t.getContent()})}replaceToText(t){return this._replaceToBlock(t,"text",{content:t.getContent()})}replaceListTodoToText(t,e,s){const i=s.getContent(!0),a="text"===t?"block.text":"block.heading",r="text"===t?{content:i}:{level:this.tag.replace("h",""),content:i},o=this.app.create(a,r),n=o.getBlock(),l=s.getBlock().find("li");return s.getBlock().after(n),l.each((e=>{const s=e.dataget("instance"),i="text"===t?"block.text":"block.heading",a="text"===t?{content:s.getContent(!0)}:{level:this.tag.replace("h",""),content:s.getContent(!0)},r=this.app.create(i,a);n.after(r.getBlock())})),s.remove(),n.closest("[data-rx-type="+e+"]").addClass("rx-format-"+e+"-to-text"),o}replaceTodoToList(t){const e=t.getContent(),s=this.app.create("block.listitem",{content:e}),i=s.getBlock();return t.getBlock().after(i),t.remove(),i.closest("[data-rx-type=todo]").addClass("rx-format-todo-to-listitem"),s}replaceListToList(t,e,s){const i=e.isType("listitem")?e.getParentTop():e.getBlock();if(!i.tag(t))return this.replaceListToListElement("list",t,i,s)}replaceListToListElement(t,e,s,i){const a=s.dataget("instance"),r=a?a.getAttrs():null,o=s.replaceTag(e);o.removeAttr("data-rx-type"),o.children().removeAttr("data-rx-type");const n=this._parseInstance(t,o,r);return o.find("ol, ul").each((s=>{this.replaceListToListElement(t,e,s,i)})),n}replaceTo(t,e,s,i){if(s.getTag()===e)return;const a=s.getBlock();let r=s.getAttrs();const o=a.replaceTag(e);return o.removeAttr("data-rx-type class"),"text"!==t&&o.removeAttr("data-rx-tag"),this._parseInstance(t,o,r)}_parseInstance(t,e,s){const i=this.app.create("block."+t,e);return i.setAttrs(s),i}_replaceToListOrTodo(t,e,s={}){const i=this.app.create("cleaner");let a=t.getContent();a=i.removeBlockTags(a);let r=this.app.create("block."+e,s);return r.getFirstItemInstance().setContent(a),r=this._setDataStyle(t,r),this._insertAfterAndRemove(t,r),r}_replaceToBlock(t,e,s={}){let i=this.app.create("block."+e,s);return i=this._setDataStyle(t,i),this._insertAfterAndRemove(t,i),i}_setDataStyle(t,e){const s=t.getBlock().attr("data-rx-style-cache");return s&&e.getBlock().attr("style",s),e}_insertAfterAndRemove(t,e){t.getBlock().after(e.getBlock()),t.remove()}}class dt{constructor(t){this.app=t,this.syncedHtml="",this.typingTimer=null}build(){this.syncedHtml=this.element.getHtml()}destroy(){this._clearTypingTimer()}trigger(){this._clearTypingTimer(),this.typingTimer=setTimeout((()=>this.update()),300)}update(){const t=this._getHtml();this._needsSync(t)&&this._sync(t)}invoke(){let t=this._getHtml();this.syncedHtml=t,this._sync(t)}_needsSync(t){return this.syncedHtml!==t&&(this.syncedHtml=t,!0)}_clearTypingTimer(){this.typingTimer&&clearTimeout(this.typingTimer)}_getHtml(){const t=this.app.create("unparser"),e=this.editor.getHtml();return t.unparse(e)}_sync(t){const e=this.app.broadcast("editor.before.change",{html:t});if(e.isStopped())return;const s=e.get("html");this.editor.setOutput(s),this.editor.setSource(s),this.autosave.send(),this.state.trigger(),this.app.broadcast("editor.change",e)}}class ct{constructor(t){this.app=t,this.styles={},this.observer=null,this.trigger=!0}build(){if(!this._shouldObserve())return;const t=this.editor.getLayout().get();this.observer=this._createObserver(t),this.observer.observe(t,{attributes:!0,subtree:!0,childList:!0,characterData:!0,characterDataOldValue:!0})}stop(){this.observer&&this.observer.disconnect(),this.trigger=!0}setTrigger(t){this.trigger=t}addKeys(t,e,s){this.config.set(`active.${t}.${e}`,s)}getKeys(){return this.styles={},this._collectActiveKeys()}getStyles(){return this.styles}observeUnset(){this._resetActiveStates()}observe(){if(!this._shouldObserveToolbars())return;this.styles={};let t=this._collectActiveKeys();this._resetActiveStates(),t.length&&this.ui.setActiveKeys(["toolbar","extrabar","context"],t,this.styles)}_shouldObserve(){return this.config.is("sync")&&window.MutationObserver}_shouldObserveToolbars(){return this.config.is("toolbar")||this.config.is("extrabar")||this.context.isOpen()}_createObserver(t){return new MutationObserver((e=>{this._handleMutation(e[e.length-1],t)}))}_handleMutation(t,e){"attributes"===t.type&&t.target===e||this.trigger&&(this.app.broadcast("observer.change"),this.editor.adjustHeight(),this.placeholder.trigger(),this.block.trigger(t),this.blocks.trigger(t),this.sync.trigger())}_collectActiveKeys(){const t=this.block.get(),e=this._collectObservedTags(t),s=this._collectInstanceTypes(t);return[...this._getKeysForTags(e),...this._getKeysForTypes(t,s),...s]}_collectInstanceTypes(t){if(!t)return[];const e=[];if(["table","layout","wrapper"].forEach((s=>{t.getClosest(s)&&e.push(s)})),t.isType("todoitem")&&e.push("todo"),t.isType("listitem")){const s=t.getParentTopInstance();s&&e.push(s.getTag())}return e}_collectObservedTags(t){const e=this.app.create("selection");let s=e.is()?e.getNodes({type:"inline",selected:"inside",link:!0,buttons:!0}):[];!e.is()&&t&&t.isType("image")&&t.getLinkElement()&&(s=[t.getLinkElement().get(0)]);let i=t?[t.getTag()]:[];return s.length&&(i=[...i,...this._collectInlineTags(s)]),i}_collectInlineTags(t){const e=this.app.create("utils"),s=[];return t.forEach((t=>{const i=e.cssToObject(t.getAttribute("style"));i.color&&(this.styles.color=i.color),i.background&&(this.styles.background=i.background),s.push(t.tagName.toLowerCase())})),s}_getKeysForTags(t){const e=this.config.get("active.tags");return t.reduce(((t,s)=>{const i=e[s];return i?t.concat(i):t}),[])}_getKeysForTypes(t,e){if(!t)return[];return[...this.config.get("active.blocks")[t.getType()]||[],...e]}_resetActiveStates(){this.toolbar.unsetActive(),this.extrabar.unsetActive(),this.context.unsetActive()}}class gt{constructor(t){this.app=t,this.scrolltop=null,this.reserved=null}save(){this.scrolltop=this.getTarget().scrollTop()}restore(){null!==this.scrolltop&&(this.getTarget().scrollTop(this.scrolltop),this.scrolltop=null)}getScrollTop(){return this.getTarget().scrollTop()}isTarget(){return this.config.is("scrollTarget")}resetTarget(){this.reserved&&(this.config.set("scrollTarget",this.reserved),this.reserved=null)}setTarget(t){this.reserved=this.config.get("scrollTarget"),this.config.set("scrollTarget",t)}getTarget(){return this.dom(this.config.get("scrollTarget")||window)}}class ut{constructor(t){this.app=t}send(){this.config.is("autosave.url")&&this._send()}_send(){const t=this._getName(),e=this.config.get("autosave.url"),s=this.config.get("autosave.method"),i=this.config.get("autosave.data"),a=this._buildData(t,i);this._ajaxRequest(s,e,a,t)}_getName(){const t=this.config.get("autosave.name");if(t)return t;let e=this.element.getName();return e||`content${this.app.uuid}`}_buildData(t,e){const s=this.app.create("utils");let i={};return i[t]=this.element.getHtml(),s.extendData(i,e)}_ajaxRequest(t,e,s,i){this.ajax.request(t,{url:e,data:s,before:t=>this._beforeSend(t,i,s),success:t=>this._complete(t,i,s)})}_beforeSend(t,e,s){return!this.app.broadcast("autosave.before.send",{xhr:t,name:e,data:s}).isStopped()}_complete(t,e,s){const i=t&&t.error?"autosave.error":"autosave.send";this.app.broadcast(i,{name:e,data:s,response:t})}}class mt{constructor(t){this.app=t,this.offset=!1}popup(t,e){let s=[...this.config.get("popups.inline")],i=this.config.get("inlineItems"),a=this.app.observer.getKeys();if(i)for(let t of Object.values(i))t.command="inline.set";this.app.dropdown.create("inline",{items:s,extend:i,keys:a,type:"inlinebar"}),this.app.dropdown.open(t,e)}set(t,e,s){if(!0!==s&&this.app.block.isTool())return;let i=this.dom([]),a=this.app.create("selection"),r=this.app.create("offset");if(e||this.app.dropdown.close(),this.params=t||{},this.instant=e,this.offset=r.get(),this.params.style){let t={};for(let[e,s]of Object.entries(this.params.style)){let i=e.replace(/([A-Z])/g," $1");i=i.split(" ").join("-").toLowerCase(),t[i]=s}this.params.style=t}return a.getRange()?(this.params.tag=this._replaceTags(),i=a.isCollapsed()?this._formatCollapsed():this._formatUncollapsed(),this.offset=r.get(),this.app.context.updatePosition(),this.app.broadcast("inline.set",{$nodes:i}),this.app.sync.trigger(),this.app.observer.observe(),i):void 0}remove(t){let e=this.app.create("selection"),s=this.app.create("cleaner"),i=e.getNodes({type:"inline",link:!0}),a=e.getInlineTop();if(e.isCollapsed()&&a){let t=this.app.create("caret"),e=a.tagName.toLowerCase(),s=this._insertSplit(a,e);t.set(s,"before")}else{if(this.app.editor.save(),t.style){let e=Array.isArray(t.style)?t.style:[t.style];for(let t=0;t<i.length;t++){let a=this.dom(i[t]),r=i[t].tagName.toLowerCase();a.removeAttr("data-rx-style-cache");for(let t=0;t<e.length;t++)a.css(e[t],"");""===a.attr("style")&&a.removeAttr("style"),s.cacheElementStyle(a),"span"===r&&0===i[t].attributes.length&&a.unwrap()}}else if(t.classname)for(let e=0;e<i.length;e++){let s=this.dom(i[e]),a=i[e].tagName.toLowerCase();s.removeClass(t.classname),""===s.attr("class")&&s.removeAttr("class"),"span"===a&&0===i[e].attributes.length&&s.unwrap()}this.app.editor.restore(),this.app.observer.observe()}}removeFormat(){this.app.dropdown.close(),this.app.modal.close();let t,e=this.app.block.get(),s=this.app.create("selection");if(!e)return;let i=e.getBlock();this.app.editor.save(i);let a=s.getNodes({type:"inline",link:!0});for(let e=0;e<a.length;e++)t=this.dom(a[e]),"A"!==a[e].tagName?t.attr("data-rx-type")||t.unwrap():t.removeAttr("style data-rx-style-cache");this.app.editor.restore(),this.app.observer.observe()}restoreOffset(){let t=this.app.create("offset");this.offset&&t.set(this.offset)}_formatCollapsed(){let t,e=this.app.create("selection"),s=this.app.create("caret"),i=this.app.create("utils"),a=(this.app.create("offset"),this.app.create("element")),r=e.getInline(),o=e.getInlineTop(!1,this.params.tag),n=a.getInlines(r),l=this.dom(r),h=this._getTags(),p=this._isSameTag(r,h),d=this._isSameTag(o,h),c=!(!this.params||!this.params.caret)&&this.params.caret;if(this.app.editor.save(),r)if(r&&i.isEmptyHtml(r.innerHTML))if(p)this._isParams()?this._hasAllSameParams(r)?(s.set(r,c||"after"),l.remove()):this._hasSameClassname(r)?(this.instant||this.app.editor.restore(),t=this._setStyle(r)):this._hasSameStyle(r)?(this.instant||this.app.editor.restore(),t=this._setClassname(r)):(this.instant||this.app.editor.restore(),t=this._setParams(r)):(s.set(r,c||"after"),l.remove());else if(this._hasCommonTags(n,h)){let t=this._findMatchingIndex(n,h);const e=n.splice(t,1)[0];this.dom(e).unwrap(),n.reverse(),s.set(n[n.length-1],"start")}else t=this._insertInline(this.params.tag,c),t=this._setParams(t);else r&&(p?this._isParams()?this._hasAllSameParams(r)?this._makeSplit(r,c):this._hasSameClassname(r)?(t=this._insertInline(this.params.tag,c),t=this._setStyle(t)):this._hasSameStyle(r)?(t=this._insertInline(this.params.tag,c),t=this._setClassname(t)):(t=this._insertInline(this.params.tag,c),t=this._setParams(t)):this._makeSplit(r,c):d?this._isParams()?this._hasAllSameParams(o)?this._makeSplit(o,c,r):this._hasSameClassname(o)?(t=this._insertInline(this.params.tag,c),t=this._setStyle(t)):this._hasSameStyle(o)?(t=this._insertInline(this.params.tag,c),t=this._setClassname(t)):(t=this._insertInline(this.params.tag,c),t=this._setParams(t)):this._makeSplit(o,c,r):(t=this._insertInline(this.params.tag,c),t=this._setParams(t)));else t=this._insertInline(this.params.tag,c),t=this._setParams(t),this.app.editor.save(t,"inline");return this.app.editor.resetSaved(),this.dom(t)}_formatUncollapsed(){let t=this.app.create("selection"),e=this.app.create("caret"),s=(this.app.create("element"),!1),i=this.app.editor.isSelectAll(),a=this.dom(t.getNodes({type:"block",partial:!0})),r=t.getNodes({type:"inline"});if(this.app.editor.save(),this._convertTags(a,r),this.app.editor.restore(),this.app.editor.save(),this._convertToStrike(),this.app.editor.restore(),this.app.page.getDocNode().execCommand("strikethrough"),this.app.editor.save(),s=this._revertToInlines(a),this.app.editor.restore(),this._clearEmptyStyle(),this.app.editor.save(),s.each(this._applyParams.bind(this)),this.app.editor.restore(),a.each((function(t){t.get().normalize()})),this.app.editor.save(),this._revertTags(a),this.app.editor.restore(),this.params.caret){let t=s.last();e.set(t,this.params.caret)}return i&&this.app.editor.selectAll(),s}_isParams(){return this.params.style||this.params.classname}_applyParams(t){let e=t.tag(),s=this._getTags(),i=t.parent();0!==i.length&&this._isSameTag(i.get(),s)&&i.text()===t.text()?this._applyParamsToNode(i,e):this._applyParamsToNode(t,e)}_applyParamsToNode(t,e){t.removeAttr("data-rx-style-cache"),""===t.attr("class")&&t.removeAttr("class"),0===t.get().attributes.length?this._isParams()&&"span"===this.params.tag?(this._setParams(t),this._clearSpanInside(t)):"span"===e&&t.unwrap():this._isParams()&&(this._setParams(t),this._clearSpanInside(t))}_setParams(t){return t=this._setClassname(t),t=this._setStyle(t)}_setClassname(t){let e=this.dom(t);if(this.params.classname){if(this.params.group){let t="inlineGroups."+this.params.group,s=!!this.config.is(t)&&this.config.get(t);s&&e.removeClass(s.join(" "))}else e.removeAttr("class");e.addClass(this.params.classname)}return e.get()}_setStyle(t){let e=this.dom(t),s=this.app.create("cleaner");return this.params.style&&(e.css(this.params.style),s.cacheElementStyle(e)),e.get()}_hasAllSameParams(t){return this._hasSameClassname(t)&&this._hasSameStyle(t)}_hasSameClassname(t){let e=this.dom(t);return!!e.attr("class")&&(!this.params.classname||e.hasClass(this.params.classname))}_hasSameStyle(t){let e=this.dom(t),s=this.app.create("element");return!this.params.style||s.compareStyle(e,this.params.style)}_hasCommonTags(t,e){return e.some((e=>t.some((t=>t.tagName.toLowerCase()===e))))}_findMatchingIndex(t,e){return t.findIndex((t=>e.some((e=>t.tagName.toLowerCase()===e))))}_makeSplit(t,e,s){let i=this.app.create("caret"),a=this.app.create("element"),r=i.is(t,"end"),o=t;if(s){o=r?t:this._insertSplit(t);let e=a.getInlines(s,this.params.tag),n=e[0].cloneNode();n.innerHTML="";let l=n,h=l,p=e.length-1;e.reverse();for(let t=0;t<p;t++)n=e[t].cloneNode(),n.innerHTML="",this.dom(l).append(n),h=n;let d=r?"after":"before";this.dom(o)[d](l),i.set(h,"start")}else r?e="after":o=this._insertSplit(t),i.set(o,e||"before")}_insertSplit(t,e){let s=this.app.create("utils"),i=this.dom(t),a=s.extractHtmlFromCaret(t),r=this.dom("<"+(e||this.params.tag)+" />"),o=document.createElement("div");return o.appendChild(a),i.cloneAttrs(r),r.append(o.innerHTML),i.after(r),r}_insertInline(t,e){return this.app.create("insertion").insertNode(document.createElement(t),e||"start")}_isSameTag(t,e){return t&&-1!==e.indexOf(t.tagName.toLowerCase())}_getTags(){let t=[this.params.tag];return"b"===this.params.tag||"strong"===this.params.tag?t=["b","strong"]:"i"!==this.params.tag&&"em"!==this.params.tag||(t=["i","em"]),t}_replaceTags(){let t=this.config.get("replaceTags")[this.params.tag];return t||this.params.tag}_convertToStrike(){let t,e,s,i,a=this.app.create("selection"),r=this.app.create("utils"),o=a.getNodes({type:"inline",link:!0,buttons:!0}),n=a.getText().replace(/[-[\]/{}()*+?.\\^$|]/g,"$&"),l=this._getTags(),h=!1;for(let a=0;a<o.length;a++)if(t=o[a],e=this.dom(t),s=o[a].tagName.toLowerCase(),i=this._hasAllSameParams(t),"a"===s&&"span"===this.params.tag&&this._isFullySelected(t,n)){let t=r.cssToObject(e.attr("style"));e.addClass("rx-inline-convertable"),e.removeAttr("data-rx-style-cache"),t&&t["text-decoration"]&&e.attr("data-rx-inline-line",t["text-decoration"])}else-1!==l.indexOf(s)&&("span"===this.params.tag&&this._isFullySelected(t,n)?(e.addClass("rx-inline-convertable"),e.removeAttr("data-rx-style-cache")):i&&"a"!==this.params.tag?this._replaceToStrike(e):"span"===this.params.tag?(this.params.style&&this._hasSameStyle(e)&&(h=!0),this.params.classname&&this._hasSameClassname(e)&&(h=!0),h?(e.addClass("rx-inline-convertable"),e.removeAttr("data-rx-style-cache")):e.addClass("rx-inline-unconvertable")):i||this._replaceToStrike(e))}_convertInlineBlocks(t){t.find("[data-rx-inline]").each((function(t){!0===t.attr("contenteditable")&&t.addClass("rx-inlineblock-editable").attr("contenteditable",!1)}))}_convertTag(t,e){let s;this.params.tag!==t?e.find(t).each((function(e){s=e.replaceTag("span"),s.addClass("rx-convertable-"+t)})):"del"===this.params.tag&&e.find(t).replaceTag("strike")}_convertTags(t){let e=this.app.create("utils");this._convertTag("del",t),this._convertTag("u",t),this._convertTag("a",t),this._convertInlineBlocks(t),t.find("span").each((function(t){let s=e.cssToObject(t.attr("style"));s&&s["text-decoration"]&&(t.css("text-decoration",""),t.attr("data-rx-convertable-style",s["text-decoration"]),t.addClass("rx-convertable-restore-style"))}))}_replaceToStrike(t){t.replaceWith(function(e){return this.dom("<strike>").append(t.contents())}.bind(this))}_revertInlineBlocks(t){t.find(".rx-inlineblock-editable").removeClass("rx-inlineblock-editable").attr("contenteditable",!0)}_revertTag(t,e){this.app.create("element");e.find("span.rx-convertable-"+t).replaceTag(t).removeAttr("class")}_revertTags(t){this._revertTag("a",t),this._revertTag("u",t),this._revertTag("del",t),this._revertInlineBlocks(t)}_revertToInlines(t){let e=this.dom([]),s=this.app.create("element");return"u"!==this.params.tag&&t.find("u").unwrap(),t.each((function(t){t.find("*").each((function(t){t.get().style.textDecorationLine&&(t.css("text-decoration-line",""),t.wrap("<u>"),""===t.attr("style")&&t.removeAttr("style"))}))})),t.find(".rx-inline-convertable").each(function(t){t.find("strike").each((function(e){t.text()===e.text()&&e.unwrap()})),t.removeClass("rx-inline-convertable");let i=t.attr("data-rx-inline-line");i&&(t.css("text-decoration",i),t.removeAttr("data-rx-inline-line")),s.removeEmptyAttr(t,"class"),this._hasAllSameParams(t)?t.unwrap():e.add(t)}.bind(this)),t.find("span.rx-inline-unconvertable").each(function(t){t.removeClass("rx-inline-unconvertable"),s.removeEmptyAttr(t,"class")}.bind(this)),t.find("span.rx-convertable-restore-style").each((function(t){t.removeClass("rx-convertable-restore-style");let e=t.attr("data-rx-convertable-style");e&&"null"!==e&&t.css("text-decoration",e),t.removeAttr("data-rx-convertable-style")})),t.find("strike").each(function(t){t=t.replaceTag(this.params.tag),e.add(t)}.bind(this)),e}_clearEmptyStyle(){let t,e=this.app.create("selection").getNodes({type:"inline"}),s=0,i=e.length,a=0;for(;s<i;s++)if(this._clearEmptyStyleAttr(e[s]),t=e[s].childNodes,t)for(;a<t.length;a++)this._clearEmptyStyleAttr(t[a])}_clearEmptyStyleAttr(t){3!==t.nodeType&&""===t.getAttribute("style")&&t.removeAttribute("style")}_clearSpanInside(t){t.find("span").each(function(t){if(this.params.classname&&t.removeAttr("class"),this.params.style)for(let e of Object.keys(this.params.style))t.css(e,"");""===t.attr("class")&&t.removeAttr("class"),""===t.attr("style")&&t.removeAttr("style"),0===t.get().attributes.length&&t.unwrap()}.bind(this))}_isFullySelected(t,e){let s=this.app.create("utils"),i=s.removeInvisibleChars(t.textContent);return e===i||-1!==e.search(new RegExp("^"+s.escapeRegExp(i)+"$"))}}class bt{constructor(t){this.app=t,this.storage=!1,this.undoStorage=[],this.redoStorage=[]}load(){this.clear(),this.app.isMode("iframe")?this.app.on("editor.ready",this.loadInitialState.bind(this)):this.loadInitialState()}stop(){this.clear()}get(){return this.undoStorage}clear(){this.storage=!1,this.undoStorage=[],this.redoStorage=[]}trigger(){const t=this._createState();this._addStateToUndo(t)}add(t){if(this._isSpecialKeyEvent(t)||!this.observer.trigger)return;const e=this._createState();this._updateCurrentState(e)}listen(t){return this._isUndo(t)?(t.preventDefault(),this.undo(),!0):!!this._isRedo(t)&&(t.preventDefault(),this.redo(),!0)}undo(){if(!this._hasUndo())return;const t=this._getPreviousUndoState();t&&(this._saveRedoState(),this._rebuildEditor(t,"undo"))}redo(){if(!this._hasRedo())return;const t=this.redoStorage.pop();t&&(this._addStateToUndo(t),this._rebuildEditor(t,"redo"),this.undoStorage.splice(this.undoStorage.length-1,1))}loadInitialState(){const t=this._createState();this.undoStorage.push(t),this.storage=t}_isSpecialKeyEvent(t){return t&&(t.ctrlKey||t.metaKey||this._isUndo(t)||this._isRedo(t))}_updateCurrentState(t){const e=this.undoStorage.length-1;e>=0&&(this.undoStorage[e]=t)}_addStateToUndo(t){const e=this.undoStorage[this.undoStorage.length-1];void 0!==e&&e.html===t.html||(this.undoStorage.push({html:t.html,offset:t.offset,synced:!0}),this._trimUndoStorage())}_trimUndoStorage(){const t=this.config.get("state.limit");this.undoStorage.length>t&&(this.undoStorage=this.undoStorage.slice(-t))}_getPreviousUndoState(){const t=this.undoStorage.length-2;return-1!==t&&this.undoStorage.splice(t+1,1),this.undoStorage[t]}_saveRedoState(){const t=this._createState(),e=this.config.get("state.limit");this.redoStorage.push(t),this.redoStorage=this.redoStorage.slice(0,e)}_parseHtml(t){return this.app.create("parser").parse(t,{type:"html",nodes:!0})}_restoreEditorContent(t,e){this.editor.getLayout().html(t),this.editor.build(),this.app.has("email")&&this.app.email._build(!0)}_restoreEmailOptions(t){this.app.has("email")&&(this.app.email.reset(),this.app.email.setOptions(t.emailOptions))}_restoreFocus(t){const e=this.app.create("offset"),s=this.editor.getLayout().find(".rx-block-state");0!==s.length?setTimeout((()=>{this.block.set(s),e.set(t.offset,s),s.removeClass("rx-block-state")}),1):!1===t.offset?this.editor.setFocus("start",!1):(e.set(t.offset),this.event.setMultipleBlocks())}_rebuildEditor(t,e){this.ui.close();const s=this._parseHtml(t.html);this._restoreEmailOptions(t),this._restoreEditorContent(s,t),this._restoreFocus(t),setTimeout((()=>{this.observer.observe(),this.app.broadcast(`state.${e}`,t)}),2)}_isUndo(t){return(t.ctrlKey||t.metaKey)&&90===t.which&&!t.shiftKey&&!t.altKey}_isRedo(t){return(t.ctrlKey||t.metaKey)&&(90===t.which&&t.shiftKey||89===t.which)}_hasUndo(){return 0!==this.undoStorage.length}_hasRedo(){return 0!==this.redoStorage.length}_getEditorContent(){if(this.app.has("email"))return this.app.email.getContent();if("json"===this.editor.getContentType()){this.blocks.get({instances:!0}).forEach((t=>{if(t){const e=t.getAttrs();e&&t.getBlock().attr("data-rx-attrs",JSON.stringify(e))}}))}return this.editor.getLayout().html()}_getEmailOptions(){return this.app.has("email")?this.config.get("email"):null}_getOffset(){const t=this.app.create("offset"),e=this.app.block.get(),s=!(!e||!e.isEditable())&&e.getBlock();return this.app.blocks.is()?t.get():t.get(s)}_createState(){const t=this._getOffset();let e=this._getEditorContent();if(!this.app.blocks.is()){e=this.app.create("utils").wrap(e,function(t){t.find(".rx-block-focus").addClass("rx-block-state")}.bind(this))}return{html:this.app.create("unparser").unparse(e,{state:!0}),offset:t,emailOptions:this._getEmailOptions()}}}class ft{constructor(t){this.app=t,this.$progress=null,this.$progressBar=null}stop(){this.hide()}show(t){this.hide(),this._createProgressElements();(t&&"boolean"!=typeof t?t:this.page.getBody()).append(this.$progress)}hide(){this.$progress&&(this.$progress.remove(),this.$progress=null,this.$progressBar=null)}_createProgressElements(){this.$progress=this.dom("<div>").addClass("rx-editor-progress").attr("id","rx-progress"),this.$progressBar=this.dom("<span>"),this.$progress.append(this.$progressBar)}}class vt{constructor(t){this.app=t,this.triggered=!1}init(){this._initializeHotkeysConfig(),this.hotkeys=this.config.get("hotkeys"),this.hotkeysKeys=this._getHotkeysMap(),this.hotkeysShiftNums=this._getShiftedKeysMap()}add(t,e){this.hotkeys[t]=e}remove(t){this.config.set("hotkeys",this._removeKeyFromObject(t,this.config.get("hotkeys"))),this.config.set("hotkeysBase",this._removeKeyFromObject(t,this.config.get("hotkeysBase")))}popup(t,e){const s=this._getMetaKey();let i={},a=this._buildPopupItems(i,0,this.config.get("hotkeysBase"),s,"base");this._buildPopupItems(i,a,this.config.get("hotkeys"),s),this.dropdown.create("hotkeys",{width:"320px",items:i}),this.dropdown.open(t,e)}handle(t){return this.triggered=!1,!1===this.hotkeys?(this._disableDefaultShortcuts(t),!0):((t.ctrlKey||t.metaKey||t.shiftKey||t.altKey)&&Object.entries(this.hotkeys).forEach((([e,s])=>{this._buildHotkeyHandler(t,e,s)})),this.triggered)}_disableDefaultShortcuts(t){!t.ctrlKey&&!t.metaKey||66!==t.which&&73!==t.which||t.preventDefault()}_initializeHotkeysConfig(){this.config.is("hotkeysRemove")&&this.config.get("hotkeysRemove").forEach((t=>this.remove(t))),this.config.is("hotkeysAdd")&&Object.entries(this.config.get("hotkeysAdd")).forEach((([t,e])=>{this.config.set("hotkeys."+t,e)}))}_getHotkeysMap(){return{8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"}}_getShiftedKeysMap(){return{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|"}}_removeKeyFromObject(t,e){return Object.keys(e).reduce(((s,i)=>(i!==t&&(s[i]=e[i]),s)),{})}_getMetaKey(){return/Mac|iPhone|iPod|iPad/i.test(navigator.platform)?"Cmd":"Ctrl"}_buildPopupItems(t,e,s,i,a="custom"){return Object.entries(s).forEach((([s,r])=>{const o="base"===a?r:r.title,n="base"===a?s.replace("meta",i):r.name.replace("meta",i),l=this._createPopupItem(o,n,i);t[e++]={title:o,classname:"rx-dropdown-item",html:l.html()}})),e}_createPopupItem(t,e,s){let i=this.dom("<div>"),a=this.dom("<span>").addClass("rx-dropdown-item-title").html(this.loc.parse(t)),r=this.dom("<span>").addClass("rx-dropdown-item-hotkey").html(this._formatKeyDisplay(e,s));return i.append(a),i.append(r),i}_formatKeyDisplay(t,e){return t.split("+").map((t=>{const e=-1===t.search(/&/)?t.toUpperCase():t;return"Cmd"===t||"Ctrl"===t?`<span class="rx-hk-meta">${t}</span>`:"alt"===t?'<span class="rx-hk-alt">Alt</span>':"shift"===t?'<span class="rx-hk-shift">Shift</span>':`<span>${e}</span>`})).join("+")}_buildHotkeyHandler(t,e,s){e.split(",").forEach((e=>{"string"!=typeof e||Object.prototype.hasOwnProperty.call(s,"trigger")||this._handleHotkey(t,e.trim(),s)}))}_handleHotkey(t,e,s){const i=this.hotkeysKeys[t.keyCode],a=91!==t.which&&String.fromCharCode(t.which).toLowerCase();let r=this._getModifiers(t,["meta","ctrl","alt","shift"],i);const o=this._buildPossibleKeys(r,i,a);e=e.toLowerCase().split(" ");for(const i of e)if(o[i])return t.preventDefault(),this.triggered=!0,void this.app.api(s.command,s.params,t)}_getModifiers(t,e,s){return e.reduce(((e,i)=>(t[i+"Key"]&&s!==i&&(e+=i+"+"),e)),93===t.keyCode?"meta+":"")}_buildPossibleKeys(t,e,s){const i={};return e&&(i[t+e]=!0),s&&(i[t+s]=!0,i[t+this.hotkeysShiftNums[s]]=!0,"shift+"===t&&(i[this.hotkeysShiftNums[s]]=!0)),i}}class Ct{constructor(t){this.app=t,this.ampRegex='(\\b\\w+="[^"]*)&amp;([^"]*")',this.modals={add:{title:"## embed.embed ##",width:"100%",form:{embed:{type:"textarea",label:"## embed.description ##",rows:6},caption:{type:"input",label:"## embed.caption ##"},responsive:{type:"checkbox",text:"## embed.responsive-video ##"}},footer:{insert:{title:"## buttons.insert ##",command:"embed.insert",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"modal.close"}}},edit:{title:"## embed.embed ##",width:"100%",form:{embed:{type:"textarea",label:"## embed.description ##",rows:6},caption:{type:"input",label:"## embed.caption ##"},responsive:{type:"checkbox",text:"## embed.responsive-video ##"}},footer:{save:{title:"## buttons.save ##",command:"embed.save",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"modal.close"},remove:{title:"## buttons.delete ##",command:"embed.remove",type:"danger",right:!0}}}}}observe(t,e){if(!this.config.is("embed"))return!1;let s=this.app.block.get();return s&&s.isType("embed")&&(t.command="embed.edit"),t}build(t){t?this._callScripts(t):this._findScripts()}popup(t,e){let s=this.app.create("stack");s.create("embed",this.modals.add),this.app.modal.open({name:"embed",stack:s,title:"Snippets",focus:"embed",button:e}),this.config.is("embed.responsive")&&s.getInput("responsive").attr("checked",!0),this._buildCodemirror(s)}edit(t,e){let s=this.app.block.get(),i={embed:s.getContent().replace(new RegExp(this.ampRegex,"g"),"$1&$2"),caption:s.getCaption(),responsive:s.isResponsive()},a=this.app.create("stack");a.create("embed",this.modals.edit),a.setData(i),this.app.modal.open({button:e,name:"embed",stack:a,focus:"embed"}),this._buildCodemirror(a)}insert(t){this.app.modal.close();let e=t.getData(),s=this._getEmbedCode(e);if(""===s)return;let i=this._createInstance(e,s);this.app.create("insertion").insert({instance:i}),this.app.broadcast("embed.insert",{code:s,instance:i})}save(t){this.app.modal.close();let e=this.app.block.get(),s=t.getData(),i=this._getEmbedCode(s);if(""===i)return void this.app.block.remove();let a=this._createInstance(s,i,e);this._isNeedToChange(s,a,e)&&this.app.block.change(a)}remove(){this.app.modal.close(),this.app.block.remove()}_buildCodemirror(t){let e=t.getInput("embed");this.app.codemirror.create({el:e,height:"200px",focus:!0}),this.app.modal.updatePosition()}_getEmbedCode(t){let e=t.embed.trim(),s=this.app.create("cleaner");return e=this.app.codemirror.val(e),e=this._removeScript(e),e=s.sanitize(e),e=this._isHtmlString(e)||""===e?e:this._parseUrl(e),e}_isHtmlString(t){return/^\s*<(\w+|!)[^>]*>/.test(t)}_isFigure(t){return/^<figure/.test(t)}_isNeedToChange(t,e,s){return s.getContent()!==e.getContent()||(t.responsive!==s.isResponsive()||(t.caption!==s.getCaption()||void 0))}_removeScript(t){if(!this.config.is("embed.script")){t=this.app.create("cleaner").removeTagsWithContent(t,["script"])}return t}_parseUrl(t){let e,s='<iframe width="560" height="315" src="',i='" frameborder="0" allowfullscreen></iframe>',a=this.config.get("regex.mp4video"),r=this.config.get("regex.youtube"),o=this.config.get("regex.vimeo");if(t.match(a))t=t.replace(a,(t=>`<video controls src="${t}"></video>`));else if(t.match(r)){let a="https://www.youtube.com";-1!==t.search("youtube-nocookie.com")&&(a="https://www.youtube-nocookie.com"),e=t.replace(r,a+"/embed/$1"),t=s+e+i}else t.match(o)&&(e=t.replace(o,"https://player.vimeo.com/video/$2"),t=s+e+i);return t}_createInstance(t,e,s){let i,a;return e=e.replace(new RegExp(this.ampRegex,"g"),"$1&$2"),s?(a=s.duplicateEmpty(),i=a.getBlock(),i.html(e)):(i=this._isFigure(e)?e:"<figure>"+e+"</figure>",i=this.dom(i)),this.app.create("block.embed",i,{caption:t.caption,responsive:t.responsive})}_findScripts(){let t=this.app.editor.getLayout().find("[data-rx-type=embed]").find("script").all();this.build.call(this,t)}_callScripts(t){for(let e=0;e<t.length;e++)if(""!==t[e].src){let s=t[e].src,i=this.dom("<script>").attr({src:s,async:!0,defer:"true"});this.app.page.getDoc().find('head script[src="'+s+'"]').remove(),i.on("load",function(){if(-1!==s.search("instagram")){var i=this.app.page.getWinNode();i.instgrm&&i.instgrm.Embeds.process()}this.build(t.slice(e+1))}.bind(this));let a=this.app.page.getDoc().get().getElementsByTagName("head")[0];a&&a.appendChild(i.get())}}}class _t{constructor(t){this.app=t,this.dataStates=[],this.modals={add:{title:"## modal.add-image ##",width:"100%"},edit:{title:"## modal.image ##",width:"100%",getter:"block.getData",form:{width:{type:"input",width:"100px",label:"## image.width ##",observer:"image.observeImageWidth"},alt:{type:"input",label:"## image.alt-text ##"},caption:{type:"input",label:"## image.caption ##",observer:"image.observeImageCaption"},url:{type:"input",label:"## image.link ##",observer:"image.observeImageLink"},target:{type:"checkbox",text:"## image.link-in-new-tab ##",observer:"image.observeImageLink"}},footer:{save:{title:"## buttons.save ##",command:"image.save",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"modal.close"},remove:{title:"## buttons.delete ##",command:"image.remove",type:"danger",right:!0}}}}}popupWrap(t,e){let s=this.config.get("wrap"),i={},a=this.app.block.get(),r=a?a.getClassname(s):"none";for(let[t,e]of Object.entries(s))i[t]={title:this.loc.get("wrap.wrap-"+t),command:"image.wrap",active:t===r,params:{classname:e}};this.app.dropdown.create("wrap",{items:i}),this.app.dropdown.open(t,e)}popupOutset(t,e){let s=this.config.get("outset"),i={},a=this.app.block.get(),r=a?a.getClassname(s):"none";for(let[t,e]of Object.entries(s))i[t]={title:this.loc.get("outset.outset-"+t),command:"image.outset",active:t===r,params:{classname:e}};this.app.dropdown.create("wrap",{items:i}),this.app.dropdown.open(t,e)}popup(t,e){let s=this.config.get("image.create");if(s)return void s(this.app);let i=this.app.create("stack");i.create("image",this.modals.add);let a=i.getBody();this._createImageByUrl(a),this._createOrSection(a),this._createUploadBox(a),this._createSelectBox(a),this.app.modal.open({name:"image",stack:i,button:e}),this.config.is("image.url")&&this.$urlinput.focus()}edit(t,e){let s=this.config.get("image.edit");if(s){let t=this.app.block.get();return void s(this.app,t)}let i=this.app.create("stack");i.create("image-edit",this.modals.edit);let a=i.getBody();this._buildEditUpload(a),this.app.modal.open({name:"image-edit",stack:i,button:e})}wrap(t){this.app.dropdown.close();let e=t.classname,s=this.config.get("wrap"),i=this.app.block.get();i&&("none"!==e&&"wrap-center"!==e||i.setStyle({"max-width":""}),this.config.is("wrapWithStyle")?["none","wrap-center"].includes(e)?(i.removeClasses(s),this._toggleCentered(i,e)):(this._unsetCentered(i),i.setClassname(e,s)):i.setClassname(e,s),this.app.control.updatePosition(),this.app.broadcast("image.wrap",{image:i}))}outset(t){this.app.dropdown.close();let e=t.classname,s=this.config.get("outset"),i=this.app.block.get();i&&(i.setClassname(e,s),this.app.control.updatePosition(),this.app.broadcast("image.outset",{image:i}))}observe(t,e){if("image"===e){let e=this.app.block.get();e&&e.isType("image")&&(t.command="image.edit")}else{if("wrap"===e&&!this.config.is("wrap"))return;if("outset"===e&&!this.config.is("outset"))return}return t}observeStates(){let t=this._findImages(),e=[];t.each(this._addImageState.bind(this)),t.each((t=>{let s=t.attr("data-image");s&&(e[s]=t)}));for(let[t,s]of Object.entries(this.dataStates))this.dataStates[t].status=!!e[t]}observeImageLink(t){return!!this.config.is("image.link")&&t}observeImageCaption(t){let e=this.app.block.get();return!(!e||!e.isFigure())&&t}observeImageWidth(t){return!!this.config.is("image.width")&&t}drop(t,e){let s=[];for(let t=0;t<e.files.length;t++){let i=e.files[t]||e.items[t].getAsFile();i&&s.push(i)}let i={url:this.config.get("image.upload"),name:this.config.get("image.name"),data:this.config.get("image.data"),multiple:this.config.get("image.multiple"),success:"image.insertByDrop",error:"image.error"};if(s.length>0){let e=this.dom(t.target).closest("[data-rx-type]");0!==e.length&&this.app.block.set(e),this.app.create("upload").send(t,s,i)}}parseInserted(t){if(!this.config.is("image.upload"))return;let e=[],s={url:this.config.get("image.upload"),name:this.config.get("image.name"),data:this.config.get("image.data"),multiple:!0,success:"image.insertFromInserted",error:"image.error"};this.pasteInsertedImages=[],this.resolved=[];let i=0,a=[];t.each((function(t){let e=t.dataget("instance");e&&a.push(e)}));for(let r=0;r<a.length;r++){let o=a[r];if("image"===o.getType()){let n=o.getSrc();if(-1!==n.search(/^data:/i)){let l=this._dataURLtoFile(n,"image"+r);e.push(l),this.pasteInsertedImages.push(o)}else if(-1!==n.search(/^blob:/i)){i++,this.pasteInsertedImages.push(o);let h=this;function p(t,e){var s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="blob",s.onload=function(t){if(200==s.status){let t=s.response,i=new File([t],"image"+e,{type:"image/png"});h.resolved.push(i)}},s.send()}p(n,r)}}}if(0!==i){let d=setInterval(function(){if(this.resolved.length===i){clearInterval(d),this.app.create("upload").send(!1,this.resolved,s)}}.bind(this),100)}if(0!==e.length){this.app.create("upload").send(!1,e,s)}}paste(t,e){if(!this.config.is("image.upload"))return;let s={url:this.config.get("image.upload"),name:this.config.get("image.name"),data:this.config.get("image.data"),multiple:this.config.get("image.multiple"),success:"image.insertFromBlob",error:"image.error"};this.app.create("upload").send(e,[t],s)}insertFromClipboard(t){let e=t.getData("text/plain")||t.getData("text/html");if(e=e.trim(),""!==e)return;let s=t.items,i=null;for(var a=0;a<s.length;a++)0===s[a].type.indexOf("image")&&(i=s[a].getAsFile());return null!==i?(this.paste(i),!0):void 0}insertFromBlob(t){this.insert(t)}insertFromInserted(t){let e=0;for(let[s,i]of Object.entries(t))this.pasteInsertedImages[e].setImage(i),e++}insertByDrop(t,e){if(this.app.block.is()){let s=this.app.block.get(),i=(e.target,"image"===s.getType()),a=this.app.create("insertion");if(i)return void this.change(t);e&&s.isEditable()&&a.insertPoint(e)}this.insert(t)}insertByUrl(t){t.preventDefault();let e=this.$urlinput.val();if(""===e.trim())return;let s={file:{url:e,id:this.app.create("utils").getRandomId()}};this.insert(s)}insertByUpload(t){this.insert(t)}insertFromSelect(t){t.preventDefault();let e=this.dom(t.target),s=e.data(),i=["id","alt","caption","url","width","height"];for(let t=0;t<i.length;t++){let a=e.attr("data-"+i[t]);null!==a&&(s[i[t]]=a)}this.insert({file:s},!0)}insert(t,e){this.app.modal.close(),this.imageslen=0,this.imagescount=0;let s=this.app.block.get(),i=this.config.get("image.tag"),a=this.app.create("insertion");for(let[s,r]of Object.entries(t)){let t=this.dom("<"+i+">"),s=this._createImageFromResponseItem(r);t.append(s);let o=this.app.create("block.image",t);a.insert({instance:o,remove:!1});let n=e?"select":"upload";this.app.broadcast("image."+n,{instance:o,data:r}),this.$last=o.getBlock(),this.imageslen++}s&&s.isEditable()&&s.isEmpty()&&s.remove()}createUploadBox(t,e){if(!t)return;let s=this.dom("<div>");return e.append(s),s}createSelectBox(t,e,s,i){if(t)if(this.$selectbox=this._createImagesBox(e,i),"object"==typeof t)this._parseList(t,s);else{let e=this.config.is("reloadmarker")?{d:(new Date).getTime()}:{};this.ajax.request(this.config.get("image.selectMethod"),{url:t,data:e,success:function(t){this._parseList(t,s)}.bind(this)})}}changeClone(t){for(let[e,s]of Object.entries(t)){this.$imageclone.attr("src",s.url);break}this.change(t,!1)}change(t,e){!1!==e&&this.app.modal.close();var s=this.app.block.get();for(var i in t)if(t.hasOwnProperty(i))return s.setImage(t[i]),this.app.broadcast("image.change",t[i]),void this.app.broadcast("image.upload",{instance:s,data:t[i]});this.app.parser.buildPredefinedClasses()}save(t){let e=t.getData();this.app.modal.close(),this.app.block.setData(e)}remove(){this.app.modal.close(),this.app.block.remove()}error(t){this.app.broadcast("image.upload.error",{response:t})}getStates(){return this.dataStates}setImageState(t,e,s){e.uid&&(this.dataStates[e.uid].status=s)}_toggleCentered(t,e){if("none"===e)this._unsetCentered(t);else{"center"===t.getBlock().css("text-align")?this._unsetCentered(t):this._setCentered(t)}}_setCentered(t){t.setStyle({"text-align":"center"}),t.getImage().css({"margin-left":"auto","margin-right":"auto"}),t.getCaptionElement().css({"text-align":"center","margin-left":"auto","margin-right":"auto"})}_unsetCentered(t){t.setStyle({"text-align":""}),t.getImage().css({"margin-left":"","margin-right":""}),t.getCaptionElement().css({"text-align":"","margin-left":"","margin-right":""})}_buildUpload(t,e){if(!this.config.is("image.upload"))return;let s={box:!0,placeholder:this.loc.get("image.upload-new-placeholder"),url:this.config.get("image.upload"),name:this.config.get("image.name"),data:this.config.get("image.data"),multiple:this.config.get("image.multiple"),success:e,error:"image.error"};this.app.create("upload",t,s)}_buildEditUpload(t){if(!this.config.is("image.upload"))return;let e=this.app.block.get(),s=this._createFormItem();s.addClass("rx-form-item-edit-image-box"),this.$imageclone=e.getImage().clone(),this.$imageclone.removeAttr("width height style");var i=this.dom("<div>").addClass("rx-form-item-image");i.append(this.$imageclone),s.append(i),this.$upload=this.dom("<div>"),s.append(this.$upload),t.prepend(s),this._buildUpload(this.$upload,"image.changeClone")}_createImageFromResponseItem(t){let e=this.dom("<img>").attr("src",t.url).one("load",this._checkImageLoad.bind(this));if(["id","alt","width","height"].forEach((s=>{void 0!==t[s]&&e.attr(s,t[s])})),t.id&&e.attr("data-image",t.id),t.srcset&&e.attr("srcset",t.srcset),t.link){let s=this.dom("<a>");s.attr("href",t.link),e.wrap(s),e=s}return e}_createSelectBox(t){this.createSelectBox(this.config.get("image.select"),t,"image.insertFromSelect")}_createImagesBox(t,e){let s=this.dom("<div>").addClass("rx-modal-images-box");return e?(s.addClass("rx-modal-images-box-edit"),t.after(s)):t.append(s),s}_createOrSection(t){if(this.config.is("image.url")&&(this.config.is("image.upload")||this.config.is("image.select"))){let e=this.dom("<div>").addClass("rx-modal-image-section-or");e.html(this.loc.get("image.or")),t.append(e)}}_createImageByUrl(t){if(this.config.is("image.url")){var e=this._createFormItem();this.$urlinput=this._createUrlInput(),this.$urlbutton=this._createUrlButton(),e.append(this.$urlinput),e.append(this.$urlbutton),t.append(e),this.$urlinput.focus()}}_createUploadBox(t){this.$upload=this.createUploadBox(this.config.get("image.upload"),t),this._buildUpload(this.$upload,"image.insertByUpload")}_createFormItem(){return this.dom("<div>").addClass("rx-form-container-flex")}_createUrlInput(){let t=this.dom("<input>").addClass("rx-form-input");return t.attr("placeholder",this.loc.get("image.url-placeholder")),t}_createUrlButton(){let t=this.dom("<button>").addClass("rx-form-button rx-form-button-primary");return t.html(this.loc.get("buttons.insert")),t.one("click",this.insertByUrl.bind(this)),t}_checkImageLoad(){this.imagescount++,this.imagescount===this.imageslen&&(this.app.block.unset(),this.app.block.set(this.$last),this.app.editor.adjustHeight())}_parseList(t,e){for(let[s,i]of Object.entries(t)){if("object"!=typeof i)continue;let t=this.dom("<img>"),s=i.thumb?i.thumb:i.url;t.addClass("rx-modal-event"),t.attr("src",s),t.attr("data-url",i.url),t.attr("data-callback",e);let a=["id","alt","caption","link","width","height"];for(let e=0;e<a.length;e++)Object.prototype.hasOwnProperty.call(i,a[e])&&t.attr("data-"+a[e],i[a[e]]);t.on("click.rx-modal-event-"+this.uuid,function(t){let e=this.dom(t.target).attr("data-callback");this.app.api(e,t)}.bind(this)),this.$selectbox.append(t)}}_blobToImage(t){return new Promise((e=>{const s=URL.createObjectURL(t);let i=new Image;i.onload=()=>{URL.revokeObjectURL(s),e(i)},i.src=s}))}_dataURLtoFile(t,e){let s=t.split(","),i=s[0].match(/:(.*?);/)[1],a=atob(s[1]),r=a.length,o=new Uint8Array(r);for(;r--;)o[r]=a.charCodeAt(r);return new File([o],e,{type:i})}_findImages(){return this.app.editor.getLayout().find("[data-image]")}_addImageState(t){let e=t.attr("data-image");e&&(this.dataStates[e]={type:"image",status:!0,url:t.attr("src"),$img:t,id:e})}}class kt{constructor(t){this.app=t}popup(t,e){let s=this.config.get("layouts");s=o.extend(!0,{},s);for(let[t,e]of Object.entries(s))e.command="layout.insert",e.params=o.extend(!0,{},e);this.app.dropdown.create("layout",{items:s}),this.app.dropdown.open(t,e)}insert(t){this.app.dropdown.close();let e=this.app.create("block.layout",t);this.app.create("insertion").insert({instance:e})}}class yt{constructor(t){this.app=t,this.dropdowns={format:{link:{title:"## link.link ##",command:"link.popupCreate",icon:!1,shortcut:"Ctrl+k"},unlink:{title:"## link.unlink ##",command:"link.unlink",icon:!1}},change:{link:{title:"## link.edit-link ##",command:"link.popupEdit",icon:!1,shortcut:"Ctrl+k"},unlink:{title:"## link.unlink ##",command:"link.unlink",icon:!1}}},this.modals={create:{title:"## modal.link ##",width:"600px",form:{text:{type:"input",label:"## link.text ##"},url:{type:"input",label:"## link.url ##"},target:{type:"checkbox",text:"## link.link-in-new-tab ##"}},footer:{insert:{title:"## buttons.insert ##",command:"link.insert",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"modal.close"}}},edit:{title:"## modal.link ##",width:"600px",form:{text:{type:"input",label:"## link.text ##"},url:{type:"input",label:"## link.url ##"},target:{type:"checkbox",text:"## link.link-in-new-tab ##"}},footer:{save:{title:"## buttons.save ##",command:"link.save",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"modal.close"}}}}}popup(t,e){let s=this.get().length,i=this.app.create("selection"),a=!!this._isImageLink()||i.is();i.getText();!t&&0===s||!a||0===s?(e=!(!t&&this._isImageLink())&&e,this.popupCreate(t,e)):1===s&&(this.app.dropdown.create("link",{items:this.dropdowns.change}),this.app.dropdown.open(t,e))}popupCreate(t,e){let s=this.app.create("selection").getText(),i=this.config.get("link.create");if(i)return void i(this.app,s);let a=this.app.create("stack");a.create("image",this.modals.create),a.setData({text:s||"",target:this.config.get("link.target")}),this.app.modal.open({name:"link",focus:"text",stack:a,button:e})}popupEdit(t,e){let s=this.get(),i=this._getLinkData(s),a=this.config.get("link.edit");if(a)return void a(this.app,s,i);let r=this.app.create("stack");r.create("image",this.modals.edit),r.setData(i),this.app.modal.open({name:"link",focus:"url",stack:r,button:e})}set(t){let e,s=this.app.block.get(),i=this.app.create("selection"),a="link";if(s&&s.isType("image"))e=s.getLinkElement(),a="image";else if(s&&s.isEditable()&&s.isEmpty()&&""===i.getText())e=this.dom("<a>"),s.getBlock().append(e);else if(s){let t=this.app.inline.set({tag:"a"});e=this.dom(t.first())}else{e=this.dom("<a>"),s=this.app.block.create(),s.getBlock().append(e),this.app.blocks.get({first:!0}).before(s.getBlock()),this.app.block.set(s)}t.text||(t.text=i.getText()),this.app.editor.save(),(t=this._setData(t,e,a))?("link"===a&&i.select(e),this.app.broadcast("link.add",{element:e,data:t})):this.app.editor.restore(),this.app.observer.observe()}save(t){let e=t.getData();if(""===e.url)return;this.app.modal.close(),this.app.editor.save();let s=this.get(),i=this._isImageLink()?"image":"link";e=this._setData(e,s,i),this.app.editor.restore(),this.app.observer.observe(),this.app.broadcast("link.change",{element:s,data:e})}insert(t){let e=t.getData();""!==e.url&&(this.app.modal.close(),this.set(e))}open(t,e){let s=e.getParams();s.href&&this.app.page.getWinNode().open(s.href,"_blank")}observe(t,e,s){let i=this.app.create("selection");if("context"===s&&"link"===e&&i.is()){let t=this.getLinks();if(1===t.length){let e=t.eq(0).attr("href");if(!e)return;this.app.context.addLine('<a href="'+e+'">'+this._truncateLinkText(e)+"</a>"),this.app.context.add("unlink")}else t.length>1&&this.app.context.add("unlink")}return t}unlink(){this.app.modal.close(),this.app.dropdown.close(),this.app.context.close();let t=this.app.create("selection"),e=t.getNodes({tags:["a"]});if(!t.is()&&this._isImageLink()){let t=this.app.block.get(),e={url:t.getLinkElement().attr("href"),text:""};return t.setUrl(""),this.app.broadcast("link.remove",{data:e}),void this.app.observer.observe()}0!==e.length&&(this.app.editor.save(),e.forEach(function(t){let e=this.dom(t),s={url:e.attr("href"),text:e.text()};this.app.broadcast("link.remove",{data:s}),e.unwrap()}.bind(this)),this.app.editor.restore(),this.app.observer.observe())}getLinks(){return this._getLinks()}get(){const t=this.app.block.get();if(t&&t.isType("image")&&t.getLinkElement())return t.getLinkElement();let e=this._getLinks();return 0!==e.length?e.eq(0):this.dom()}_isImageLink(){const t=this.app.block.get();return t&&t.isType("image")&&t.getLinkElement()}_setData(t,e,s="link"){if(t=this._cleanUrl(t),t=this._encodeUrl(t),"image"===s){this.app.block.get().setUrl(t.url)}else t=this._setUrl(e,t),1===e.length&&(t=this._setText(e,t)),t=this._setTarget(e,t);return t.element=e,t}_setUrl(t,e){return t.attr("href",e.url),e}_setText(t,e){return e.text=""===e.text?e.url:e.text,t.text(e.text),e}_setTarget(t,e){return e.target?t.attr("target","_blank"):t.removeAttr("target"),e}_getLinkData(t){let e={};return 0!==t.length&&(e={text:t.text(),url:t.attr("href"),target:t.attr("target")||this.config.get("link.target")},e=this._encodeUrl(e)),e}_getLinks(){let t=this.app.create("selection");if(!t.is())return this.dom();let e=t.getNodes({tags:["a"]});return 0!==e.length?this.dom(e):this.dom()}_truncateLinkText(t){let e=this.config.get("link.truncate");return(t=t.replace(/^https?\:\/\//i,"")).length>e?t.substring(0,e)+"...":t}_cleanUrl(t){let e=this.app.create("cleaner");return t.url=e.escapeHtml(t.url),t.url=-1!==t.url.search(/^javascript:/i)?"":t.url,t}_encodeUrl(t){return t.url=t.url?t.url.replace(/&amp;/g,"&"):"",t}}class xt{constructor(t){this.app=t,this.dropdowns={list:["bulletlist","numberedlist"],haslist:["bulletlist","numberedlist","indent","outdent"]}}popup(t,e){let s=this._isList()?this.dropdowns.haslist:this.dropdowns.list;this.app.dropdown.create("list",{items:s}),this.app.dropdown.open(t,e)}indent(){let t=this.app.create("selection"),e=t.getBlock(),s=this.dom(e),i=s.prevElement(),a=i.get(),r=(t.isFullySelected(s)||t.isCollapsed())&&e&&a&&"LI"===a.tagName;if(r){this.app.editor.save(e),i=this.dom(a);let t=i.children("ul, ol"),r=s.closest("ul, ol");if(0!==t.length)t.append(s);else{let t=r.tag(),e=this.dom("<"+t+">");e.append(s),i.append(e)}this.app.editor.restore(),this.app.control.updatePosition()}return r}outdent(){let t=this.app.create("selection"),e=t.getBlock(),s=this.dom(e),i=!1;if((t.isFullySelected(s)||t.isCollapsed())&&e){let t,r,o=s.parent(),n=o.closest("li"),l=s.prevElement(),h=s.nextElement(),p=l.get(),d=h.get(),c=!1===p,g=!1!==p&&!1!==d;if(c){let t=this.app.block.get();if(!t.hasParentList()){this.app.dropdown.close(),this.app.context.close(),this.app.editor.save(!1);let e=t.getParent().getBlock(),s=this.app.block.create(t.getContent());return e.before(s.getBlock()),t.getBlock().remove(),0===e.children().length&&e.remove(),this.app.editor.build(),this.app.block.set(s),this.app.editor.restore(),i}}if(this.app.editor.save(e),0!==n.length){if(g){t=this._getAllNext(s.get()),r=this.dom("<"+o.tag()+">");for(var a=0;a<t.length;a++)r.append(t[a]);n.after(s),s.append(r)}else n.after(s),0===o.children().length?o.remove():c&&s.append(o);i=!0}this.app.editor.restore(),this.app.control.updatePosition()}return i}_isList(){let t=this.app.block.get();return t&&t.isType("listitem")}_getAllNext(t){let e,s=[];for(;t;){if(e=this.dom(t).nextElement(),!(t=e.get()))return s;s.push(t)}return s}}class wt{constructor(t){this.app=t,this.dropdowns={items:{addhead:{title:"## table.add-head ##",command:"table.addHead"},addcolumnbefore:{title:"## table.add-column-before ##",command:"table.addColumnBefore"},addcolumnafter:{title:"## table.add-column-after ##",command:"table.addColumnAfter"},addrowbelow:{title:"## table.add-row-below ##",command:"table.addRowBelow"},addrowabove:{title:"## table.add-row-above ##",command:"table.addRowAbove"},removehead:{title:"## table.remove-head ##",command:"table.removeHead",divider:"top"},removecolumn:{title:"## table.remove-column ##",command:"table.removeColumn"},removerow:{title:"## table.remove-row ##",command:"table.removeRow"},removetable:{title:"## table.delete-table ##",command:"table.removeTable",divider:"top",danger:!0}}},this.modals={cell:{title:"## table.table-cell ##",width:"300px",form:{width:{type:"input",label:"## table.width ##"},nowrap:{type:"checkbox",text:"## table.nowrap ##"}},footer:{insert:{title:"## buttons.save ##",command:"table.save",type:"primary"},cancel:{title:"## buttons.cancel ##",command:"modal.close"}}}}}observe(t,e,s){if(!this.config.is("table"))return!1;if("dropdown"!==s){let e=this.app.block.get();e&&e.getBlock().closest("table").length&&(t.command="table.popup")}return t}popup(t,e){let s=this.app.block.get(),i=this.dropdowns.items;(s.isNondeletable()||s.isNondeletableParent())&&delete i.removetable;const a=s.isType("table");Object.entries(i).forEach((([t,e])=>{"removetable"!==t&&(i[t].disable=a)})),this.app.dropdown.create("table",{items:i}),this.app.dropdown.open(t,e)}addHead(){let t=this.app.block.get(),e=(t.isType("cell")?t:t.getClosest("cell")).getTable().getBlock();this.removeHead();let s=e.find("tr").first().children("td, th").length,i=this.dom("<thead>"),a=this._buildRow(!1,s,"<th>");i.append(a),e.prepend(i),this.app.block.set(a.children("td, th").first(),"start")}addRowBelow(){this._addRow("below")}addRowAbove(){this._addRow("above")}addColumnBefore(){this._addColumn("before")}addColumnAfter(){this._addColumn("after")}removeHead(){this.app.modal.close(),this.app.dropdown.close();let t=this.app.block.get(),e=(t.isType("cell")?t:t.getClosest("cell")).getTable().getBlock(),s=e.find("thead");0!==s.length&&(s.remove(),this.app.block.set(e,"start"))}removeRow(){this.app.modal.close(),this.app.dropdown.close(),this.app.control.close();let t=this.app.block.get(),e=t.isType("cell")?t:t.getClosest("cell"),s=e.getTable(),i=e.getRow(),a=i.getBlock().closest("thead");0!==a.length?a.remove():i.remove(),0!==s.getRows().length?this.app.block.set(s.getFirstBlock(),"start"):s.remove({traverse:!0})}removeColumn(){this.app.modal.close(),this.app.dropdown.close(),this.app.control.close();let t=this.app.block.get(),e=t.isType("cell")?t:t.getClosest("cell"),s=e.getTable(),i=e.getBlock(),a=i.closest("table"),r=i.closest("tr"),o=0;if(r.find("td, th").each((function(t,e){t.get()===i.get()&&(o=e)})),a.find("tr").each(function(t){let e=t.find("td, th").get(o);this.dom(e).remove()}.bind(this)),0!==s.getCells().length){let t,e=o-1;if(e=e<0?0:e,0!==e){t=this.dom(a.find("tr").first().find("td, th").get(e));let s=t.dataget("instance");t=s.getFirstElement()}else t=s.getFirstBlock();this.app.block.set(t,"start")}else s.remove({traverse:!0})}removeTable(){this.app.modal.close(),this.app.dropdown.close(),this.app.block.get().getBlock().closest("table").dataget("instance").remove({traverse:!0}),this.app.editor.isEmpty()&&this.app.editor.setEmpty()}cellSetting(t,e){let s=this.app.block.get(),i=this.app.create("stack");i.create("cell-setting",this.modals.cell),i.setData({width:s.getWidth(),nowrap:s.getNowrap()}),this.app.modal.open({name:"cell-setting",stack:i,focus:"width",button:e})}save(t){this.app.modal.close();let e=t.getData(),s=this.app.block.get();""!==e.width&&s.setWidth(e.width),s.setNowrap(e.nowrap),this.app.control.updatePosition()}_addColumn(t){this.app.modal.close(),this.app.dropdown.close();let e,s=this.app.block.get(),i=s.isType("cell")?s.getBlock():s.getClosest("cell").getBlock(),a=i.closest("table"),r=i.closest("tr"),o=i.get().cellIndex,n=r.get().rowIndex;if(a.find("tr").each(function(s,i){let a=s.find("td, th").get(o),r=this.dom(a),l=r.clone();l.removeClass("rx-block-focus").html(""),this.app.create("block.cell",l);let h=this.app.block.create();l.append(h.getBlock()),n===i&&(e=l),r[t](l)}.bind(this)),e){let t=e.dataget("instance");this.app.block.set(t.getFirstElement(),"start")}}_addRow(t){this.app.modal.close(),this.app.dropdown.close();let e="below"===t?"after":"before",s=this.app.block.get().getClosest("row").getBlock(),i=s.closest("tr"),a=s.closest("thead"),r=i.children("td, th").length,o=this._buildRow(i,r,"<td>");0!==a.length?a.after(o):i[e](o);let n=o.dataget("instance");this.app.block.set(n.getFirstElement(),"start")}_buildRow(t,e,s){let i,a;if(!1===t){t=this.dom("<tr>");for(let i=0;i<e;i++){let e=this.dom(s);this.app.create("block.cell",e),t.append(e)}}else(t=t.clone()).find("td, th").removeClass("rx-block-focus").html("");return this.app.create("block.row",t),t.find("td, th").each(function(t){i=this.app.create("block.cell",t),a=this.app.block.create(),i.getBlock().append(a.getBlock())}.bind(this)),t}}o.add("tool","checkbox",{mixins:["tool"],type:"checkbox",input:{tag:"input",type:"checkbox",classname:"-form-checkbox"},getValue(){return this.$input.val()},_buildInput(){if(this.$box=this.dom("<label>").addClass(this.prefix+"-form-checkbox-item"),this.$box.append(this.$input),this._has("text")){var t=this.dom("<span>").html(this.lang.parse(this.obj.text));this.$box.append(t)}this.$tool.append(this.$box)}}),o.add("tool","input",{mixins:["tool"],type:"input",input:{tag:"input",type:"text",classname:"-form-input"},_buildInput(){this.$tool.append(this.$input)}}),o.add("tool","number",{mixins:["tool"],type:"number",input:{tag:"input",type:"number",classname:"-form-input"},_buildInput(){this.$input.attr({min:0}).css("max-width","100px"),this.$tool.append(this.$input)}}),o.add("tool","segment",{mixins:["tool"],type:"segment",input:{tag:"input",type:"hidden",classname:"-form-input"},setValue(t){this.$segment.find("."+this.prefix+"-form-segment-item").removeClass("active"),this.$segment.find("[data-segment="+t+"]").addClass("active"),this.$input.val(t)},_buildInput(){this.$segment=this.dom("<div>").addClass(this.prefix+"-form-segment");var t=this.obj.segments;for(var[e,s]of Object.entries(t)){var i=this.dom("<span>").addClass(this.prefix+"-form-segment-item");i.attr("data-segment",e).on("click",this._catchSegment.bind(this)),s.icon?i.html(s.icon):i.html(s.name),this.$segment.append(i)}this.$segment.append(this.$input),this.$tool.append(this.$segment)},_catchSegment(t){t.preventDefault(),t.stopPropagation();var e=this.dom(t.target).closest("."+this.prefix+"-form-segment-item"),s=e.attr("data-segment");this.$segment.find("."+this.prefix+"-form-segment-item").removeClass("active"),e.addClass("active"),this.$input.val(s),this.app.api(this.setter,this.popup)}}),o.add("tool","select",{mixins:["tool"],type:"select",input:{tag:"select",classname:"-form-select"},_buildInput(){for(var t in this.obj.options)if(this.obj.options.hasOwnProperty(t)){var e=this.dom("<option>");e.val(t),e.html(this.lang.parse(this.obj.options[t])),this.$input.append(e)}this.$tool.append(this.$input)}}),o.add("tool","textarea",{mixins:["tool"],type:"textarea",input:{tag:"textarea",classname:"-form-textarea"},setFocus(){this.$input.focus(),this.$input.get().setSelectionRange(0,0),this.$input.scrollTop(0)},_buildInput(){this._has("rows")&&this.$input.attr("rows",this._get("rows")),this.$input.attr("data-gramm_editor",!1),this.$tool.append(this.$input)}}),o.add("tool","upload",{mixins:["tool"],type:"upload",input:{tag:"input",type:"hidden",classname:"-form-input"},setValue(t){t=t||"",this.upload&&this.upload.setImage(t),this.$input.val(t)},_buildInput(){this.$tool.append(this.$input),this._buildUpload()},_buildUpload(){this.$upload=this.dom("<input>").attr("type","file"),this.$tool.append(this.$upload);var t={};this._has("trigger")&&this._get("trigger")&&(t={instance:this,method:"trigger"}),this.upload=this.app.create("upload",this.$upload,this.obj.upload,t)}}),o.add("tool","color",{mixins:["tool"],type:"color",input:{tag:"input",type:"text",classname:"-form-input"},setValue(t){t||(t=""),this.$input.val(t),""===t&&(t="#ffffff"),this.$toggle.css("background-color",t)},_buildInput(){this.$item=this.dom('<div class="rx-form-color-container">'),this.$toggle=this.dom('<div class="rx-form-color-toggle">'),this.$item.append(this.$input),this.$item.append(this.$toggle),this.$input.on("keyup blur",this._changeColor.bind(this)),this.$toggle.on("click",this._toggleColorpicker.bind(this)),this.$tool.append(this.$item)},_changeColor(){let t=this.$input.val();t=this.app.create("utils").normalizeColor(t),5!==t.length&&t.length>3&&this.$toggle.css("background-color",t)},_setColor(t,e){e||this._closeColorpicker(),t=this.app.create("utils").normalizeColor(t),this.trigger(t)},_toggleColorpicker(t){if(t.preventDefault(),t.stopPropagation(),this.$colorpicker)return void this._closeColorpicker();let e=this.getValue(),s=this.app.create("colorpicker");this.$colorpicker=s.build({$toggle:this.$toggle,colors:this.opts.get("colors"),instant:!0,style:{color:e},method:function(t,e){this._setColor(t,e)}.bind(this)}),this.app.$doc.on("click.rx-colorpicker",this._closeColorpicker.bind(this))},_closeColorpicker(){this.app.$body.find(".rx-colorpicker-"+this.uuid).remove(),this.app.scroll.getTarget().off(".rx-colorpicker"),this.app.$doc.off(".rx-colorpicker"),this.$colorpicker=!1}}),o.add("block","address",{mixins:["block"],props:{type:"address",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.dom("<address>")},handleDelete(t,e,s){if(s.is("backspace")&&this.isCaretEnd()&&this._removeEmptyBrTags())return t.preventDefault(),!0},handleEnter(t){if(t.preventDefault(),!this.isEmpty()&&!this.isCaretEnd()||!this._removeEmptyBrTags())return this._insertBreakline();this._insertAfterEmptyBlock()},_removeEmptyBrTags(){const t=this.$block.children(),e=t.length,s=t.eq(e-1);let i=this.$block.html().trim();return i=this.app.create("utils").removeInvisibleChars(i),!(!i.endsWith("<br>")&&!i.endsWith("<br/>"))&&(s.remove(),!0)},_insertAfterEmptyBlock(){this.insertEmpty({position:"after",caret:"start",type:"input"})},_insertBreakline(){return this.app.create("insertion").insertBreakline(),!0}}),o.add("block","dlist",{mixins:["block"],props:{type:"dlist",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{items:{getter:"getItems"}},create(){return this.dom("<dl>").append(this.dom("<dt>").html("Term")).append(this.dom("<dd>").html("Description"))},build(){this._buildItems()},setCaret(t){const e=this.app.create("caret"),s="start"===t?this.getFirstItem():this.getLastItem();e.set(s,t)},getLastItem(){return this.$block.children().last()},getFirstItem(){return this.$block.children().first()},getItems(){const t=[];return this.$block.find("dt").each((e=>{const s=this.unparseInlineBlocks(e.clone()).html(),i=e.nextElement(),a=i&&i.tag("dd")?this.unparseInlineBlocks(i.clone()).html():"";t.push({term:s,desc:a})})),t},handleEnter(t){t.preventDefault();const e=this.app.create("insertion"),s=this.app.create("selection"),i=this.app.create("utils"),a=this.app.create("caret"),r=this.dom(s.getBlock()),o=r.tag();if(!a.is(r,"end")||this.isCaretEnd()){if(this.isEmpty()||this.isCaretEnd()){const t=i.isEmptyHtml(r.html());return"dt"===o&&t?(r.remove(),this.insertEmpty({position:"after",caret:"start",type:"input"}),!0):(this._insertCorrespondingTag(r,o,a),!0)}return this.isCaretStart()||e.insertBreakline(),!0}this._insertCorrespondingTag(r,o,a)},_insertCorrespondingTag(t,e,s){const i=this.dom("dt"===e?"<dd>":"<dt>");t.after(i),s.set(i,"start")},_buildItems(){const t=this.data.get("items");t&&(this.$block.html(""),t.forEach((t=>{this.$block.append(this.dom("<dt>").html(t.term)),this.$block.append(this.dom("<dd>").html(t.desc))})))}}),o.add("block","embed",{mixins:["block"],parser:!1,props:{type:"embed",focusable:!0,editable:!1,inline:!1,control:{embed:{position:{after:"add"}}}},defaults:{content:{getter:"getContent",setter:"setContent"},caption:{getter:"getCaption",setter:"setCaption"},responsive:{getter:"getResponsive",setter:"setResponsive"}},start(){this.embedClassname=this.opts.get("embed.classname"),this.responsiveClassname=this.opts.get("embed.responsiveClassname")},create(){return this.dom("<figure>")},parse(){this.$embed=this.embedClassname?this.$block.find("."+this.embedClassname):this.$block;let t=0===this.$embed.length?this._initializeEmbed():this.$embed.html();this.parseCaption(),this.setContent(t),this._handleResponsive()},build(){this.$embed=this._createEmbed(),this._handleResponsive()},getContent(){return decodeURI(this.$block.attr("data-embed-content")).trim()},getCaption(){return this.figcaption?this.figcaption.getContent():null},getResponsive(){return this.$embed.hasClass(this.responsiveClassname)||null},getVideoTitle(){return this.$embed.find("video").attr("title")},getVideoPoster(){return this.$embed.find("video").attr("poster")},isResponsive(){return this.getResponsive()},setContent(t){t=t.trim(),this.$embed.html(t),this.$block.attr("data-embed-content",encodeURI(t))},setCaption(t){this.figcaption?this.figcaption.setContent(t):this._buildCaption(t)},setResponsive(t){t&&this.$embed.addClass(this.responsiveClassname)},_initializeEmbed(){let t=this.$block.find("figcaption"),e=this.$block.clone();e.find("figcaption").remove();let s=e.html();return this.$embed=this._createEmbed(),0!==t.length&&this.$block.append(t),s},_handleResponsive(){this.opts.is("embed.responsive")&&this.$embed.addClass(this.responsiveClassname)},_createEmbed(){if(!this.embedClassname)return this.$block;let t=this.dom("<div>").addClass(this.embedClassname);return this.$block.html(""),this.$block.append(t),t}}),o.add("block","figcaption",{mixins:["block"],props:{type:"figcaption",editable:!0,inline:!1,control:!1},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.dom(this.opts.get("figcaption.template"))},parse(){this._buildPlaceholder()},build(){this._buildPlaceholder()},getFigure(){return this.$block.closest("figure").dataget("instance")},handleDelete(t,e,s){if(s.is("delete")&&this.isCaretEnd())return t.preventDefault(),!0},handleArrow(t,e,s){if(s.is("up+left")&&this.isCaretStart()||s.is("down+right")&&this.isCaretEnd())return t.preventDefault(),this.app.block.set(this.getFigure()),!0},handleTab(t){return t.preventDefault(),this.app.block.set(this.getFigure()),!0},handleEnter(t){if(t.preventDefault(),this.isEmpty()||this.isCaretEnd()||this.isCaretStart())return!0;return this.app.create("insertion").insertBreakline(),!0},_buildPlaceholder(){this.$block.attr("data-placeholder")||this.setPlaceholder(this.lang.get("placeholders.figcaption"))}}),o.add("block","heading",{mixins:["block"],props:{type:"heading",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"},level:{getter:"getLevel",setter:"setLevel"}},create(){return this.dom("<h"+(this.data.get("level")||2)+">")},setLevel(t){this.getLevel()!==Number(t)&&(this.$block=this.$block.replaceTag(`h${t}`))},getLevel(){return Number(this.getTag().replace("h",""))},handleEnter(t){if(t.preventDefault(),this.isEmpty()||this.isCaretEnd())this.insertEmpty({position:"after",caret:"start",remove:!1,type:"input"});else if(this.isCaretStart())this.insert({instance:this.duplicateEmpty(),position:"before",type:"input"});else{this.app.create("element").splitAtCaret(this.$block)}return!0}}),o.add("block","image",{mixins:["block"],props:{type:"image",focusable:!0,editable:!1,inline:!1,control:{image:{position:{after:"add"}},wrap:{position:{after:"image"}},outset:{position:{after:"image"}}}},defaults:{src:{getter:"getSrc",setter:"setSrc"},srcset:{getter:"getSrcset",setter:"setSrcset"},url:{getter:"getUrl",setter:"setUrl"},alt:{getter:"getAlt",setter:"setAlt"},width:{getter:"getWidth",setter:"setWidth"},height:{getter:"getHeight"},img:{getter:"getImageStyle"},target:{getter:"getTarget",setter:"setTarget"},caption:{getter:"getCaption",setter:"setCaption"},wrap:{getter:"getWrap"}},create(){return this.dom("<"+this.opts.get("image.tag")+">")},parse(){this._parseImage(),this._parseLink(),this.parseCaption()},build(){this._buildImageTag(),this._buildImage(),this._buildLink()},getLinkElement(){return this.$link},getSrc(){return this.$image.attr("src")},getAlt(){return this.$image.attr("alt")},getSrcset(){return this.$image.attr("srcset")},getUrl(){return this.$link?this.$link.attr("href"):null},getTarget(){return this.$link&&"_blank"===this.$link.attr("target")},getWrap(){let t=this.$block.tag();return t===this.opts.get("image.tag")?null:t},getCaption(){return this.figcaption?this.figcaption.getContent():null},getCaptionElement(){return this.figcaption?this.figcaption.getBlock():null},getWidth(){return this._getStyle("width")},getHeight(){return this._getStyle("height")},getImageStyle(){return this._getStyle()},getDataImage(){return this.$image.attr("data-image")},getImage(){return this.$image},setImage(t){this.$image.attr("src",t.url),t.id&&this.$image.attr("data-image",t.id),t.srcset&&this.$image.attr("srcset",t.srcset)},setAlt(t){this.$image.attr("alt",t.replace(/"/g,"'"))},setSrc(t){this.$image.attr("src",t)},setSrcset(t){this.$image.attr("srcset",t)},setWidth(t,e){if(""!==(t=t?t.trim():"")){const s=t.includes("%");let i=s?t:parseInt(t),a=0!==this.$image.width()&&this.$image.width()/this.$image.height();e=this._determineHeight(e,i,a),s?(this.$image.removeAttr("height"),this._setWidth(i)):(this._setWidth(i+"px"),this._setHeight(e))}else this._resetImageDimensions();this.app.create("cleaner").cacheElementStyle(this.$image),this.app.broadcast("image.position"),this.app.control.updatePosition()},setCaption(t){this.figcaption?this.figcaption.setContent(t):this._buildCaption(t)},setUrl(t){this.$link?""===t?(this.$link.unwrap(),this.$link=!1):this.$link.attr("href",t):""!==t&&this._createLink(t)},setTarget(t){this.$link&&(t&&""!==t?this.$link.attr("target","_blank"):this.$link.removeAttr("target"))},_determineHeight(t,e,s){return t=this.data.is("height")?!1===s?parseInt(this.data.get("height")):Math.round(e/s):!1!==s&&(t||Math.round(e/s))},_setWidth(t){this.$image.css({width:t}).attr({width:t.replace("px","")})},_setHeight(t){!1!==t&&this.$image.css({height:t+"px"}).attr({height:t})},_resetImageDimensions(){this.$image.removeAttr("width height"),this.$image.css({width:"",height:""}),""===this.$image.attr("style")&&this.$image.removeAttr("style")},_createLink(t){this.$link=this.dom("<a>"),this.$image.wrap(this.$link),this.$link.attr("href",t)},_getStyle(t){let e=this.app.create("utils").cssToObject(this.$image.attr("style"));return t?this._getStyleValue(e,t):this._getAllStyles(e)},_getStyleValue(t,e){let s=t[e]?t[e].replace("px",""):this.$image.attr(e);return s||null},_getAllStyles:t=>Object.keys(t).length>0?{style:t}:null,_parseImage(){let t=this.data.get("img");this.$image=this.$block.find("img"),t&&this._buildImageParams(t)},_parseLink(){let t=this.$block.find("a");0===t.closest("figcaption").length&&0!==t.length&&(this.$link=t)},_buildImageTag(){let t=this.getTag(),e=this.opts.get("image.tag"),s=this.data.get("wrap");if(t!==e||s&&t!==s){let t=s||e;this.$block=this.$block.replaceTag(t)}},_buildImage(){const t=this.data.getValues();this.$image=this.dom("<img>"),this.$block.append(this.$image),this._buildImageParams(t)},_buildImageParams(t){["src","alt","srcset"].forEach((e=>{t.hasOwnProperty(e)&&this.$image.attr(e,t[e])})),t.img&&t.img.style&&this.$image.css(t.img.style)},_buildLink(){const t=this.data.getValues();t.url&&(this.$link=this.dom("<a>").attr("href",t.url),this.$image.wrap(this.$link),t.target&&this.$link.attr("target","_blank"))}}),o.add("block","wrapper",{mixins:["block"],nested:!0,props:{type:"wrapper",focusable:!0,inline:!1,control:{unwrap:{position:{after:"add"}}}},defaults:{wrap:{getter:"getWrap",setter:"setWrap"},children:{getter:"getChildren"}},create(){let t=this.dom(this.opts.get("wrapper.template"));return this.app.has("email")&&t.addClass("email-wrapper"),t},build(){this.params.children||this.fillEmpty()},parse(){this.app.has("email")&&this.$block.addClass("email-wrapper")},setCaret(t){const e=this.getFirstBlock();0!==e.length&&e.dataget("instance")?this.app.block.set(e,t):this._focusAndCollapseSelection()},setWrap(t){this.$block=this.$block.replaceTag(t)},getWrap(){let t=this.$block.tag();return"div"===t?null:t},getFirstBlock(){return this.$block.children().first()},fillEmpty(){this.isEmpty()&&this.$block.append(this.app.block.create().getBlock())},_focusAndCollapseSelection(){const t=this.app.create("selection");this.app.scroll.save(),this.$block.attr("tabindex","-1").focus(),t.collapse(),setTimeout((()=>t.remove()),1),this.app.scroll.restore()}}),o.add("block","layout",{mixins:["block"],nested:!0,props:{type:"layout",focusable:!0,inline:!1,control:{unwrap:{position:{after:"add"}}}},defaults:{children:{getter:"getChildren"}},create(){const t=this.opts.get("layout.grid"),e=this.dom("<div>");return t?e.addClass(t):e.attr(this.opts.get("dataBlock"),"layout").addClass("rx-layout-grid")},parse(){const t=this.opts.get("layout.grid"),e=this.opts.get("layout.column");t?this._handleGridSetup(e):this.$block.addClass("rx-layout-grid")},build(){this.params.children||(this.params.pattern?this._buildFromPattern():(this._createAndAppendColumn("50%"),this._createAndAppendColumn("50%")))},setCaret(t){let e="start"===t?this.getFirstBlock():this.getLastBlock();this.app.block.set(e,t)},getFirstBlock(){return this.getFirstColumn().children().first()},getLastBlock(){return this.getLastColumn().children().last()},getFirstColumn(){return this.$block.find("[data-rx-type=column]").first()},getLastColumn(){return this.$block.find("[data-rx-type=column]").last()},getColumns(){return this.$block.find("[data-rx-type=column]").map((t=>this.dom(t).dataget("instance")))},_handleGridSetup(t){if(!t){this.$block.children().each((t=>{this.app.create("block.column",t)})),this.app.create("predefined").parse(this.$block)}},_buildFromPattern(){const t=this.params.pattern.split("|");this.params.grid&&this.$block.addClass(this.params.grid),t.forEach((t=>{const e=this._parsePatternPart(t),s=this.app.create("block.column",e);this.$block.append(s.getBlock())}))},_parsePatternPart:t=>t.includes("%")?{width:t}:"-"!==t?{classname:t}:{},_createAndAppendColumn(t){const e=this.app.create("block.column",{width:t});this.$block.append(e.getBlock())}}),o.add("block","column",{mixins:["block"],nested:!0,props:{type:"column",focusable:!0,inline:!1},defaults:{children:{getter:"getChildren"},width:{getter:"getWidth",setter:"setWidth"}},create(){const t=this.opts.get("layout.grid"),e=this.opts.get("layout.column"),s=this.dom("<div>");return t&&!e?s:e?s.addClass(e):s.attr(this.opts.get("dataBlock"),"column")},build(){if(!this.params.children&&this.isEmpty()){let t=this.app.block.create();this.$block.append(t.getBlock())}},getFirstBlock(){return this.$block.children().first()},getLastBlock(){return this.$block.children().last()},getFirstBlockInstance(){return this.getFirstBlock().dataget("instance")},getLastBlockInstance(){return this.getLastBlock().dataget("instance")},isLastElement(){return 0===this.$block.nextElement().length},setWidth(t){this.opts.get("layout.grid")||this.$block.css("flex-basis",t)},getWidth(){return this.opts.get("layout.grid")?null:this.$block.css("flex-basis")}}),o.add("block","line",{mixins:["block"],props:{type:"line",focusable:!0,editable:!1,inline:!1},create(){return this.dom(this.opts.get("line.template"))}}),o.add("block","list",{mixins:["block"],props:{type:"list",focusable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{numbered:{getter:"getNumbered"},items:{getter:"getItems"}},create(){return this.dom(`<${this._createTag()}>`).append(this.dom("<li>"))},parse(){this.parseItems("ul, ol","list"),this.parseItems("li","listitem")},build(){this._buildItems(),this.parseItems("ul, ol","list"),this.parseItems("li","listitem")},setCaret(t){let e="start"===t?this.getFirstItem():this.getLastItem();this.app.block.set(e,t)},getFirstItem(){return this.$block.find("li").first()},getFirstItemInstance(){return this.getFirstItem().dataget("instance")},getLastItem(){return this.$block.find("li").last()},getLastItemInstance(){return this.getLastItem().dataget("instance")},getNumbered(){return"ol"===this.getTag()},getItems(){return this.$block.children().all().map((t=>this.dom(t).dataget("instance").getContent()))},_createTag(){return this.data.get("numbered")?"ol":"ul"},_buildItems(){const t=this.data.get("items");t&&(this.$block.empty(),t.forEach((t=>this.$block.append(this.dom("<li>").html(t)))))}}),o.add("block","listitem",{mixins:["block"],props:{type:"listitem",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.dom("<li>")},isListEnd(){return this.getParent().isCaretEnd()},isListTopEnd(){return this.getParentTopInstance().isCaretEnd()},isFirstElement(){return 0===this.$block.prevElement().length},isLastElement(){return 0===this.$block.nextElement().length},hasParentList(){return 0!==this.$block.parent().closest("li").length},hasChild(){return 0!==this.$block.find("ul, ol").length},getChild(){return this.$block.find("ul, ol").first()},getParentTop(){return this.$block.parents("ul, ol").last()},getParentTopInstance(){return this.getParentTop().dataget("instance")},getParentItem(){return this.$block.parent().closest("li").dataget("instance")},getParent(){return this.$block.parent().closest(this._buildTraverseSelector("list")).dataget("instance")},getContent(t=!1){let e=this.$block.clone();return t?e.find("ul, ol").remove():e.find("ul, ol").before("<br>").unwrap(),e=this.unparseInlineBlocks(e),e.html().replace(/<\/?li[^>]*>/g,"\n").replace(/\s\s+/g," ").replace(/\t/g,"").trim()},handleArrow(t,e,s){return s.is("up+left")?this._traverse("prev",t,s):s.is("down+right")?this._traverse("next",t,s):void 0},handleDelete(t,e,s){return s.is("backspace")&&this.isCaretStart()&&this.isFirstElement()&&!this.hasParentList()?(t.preventDefault(),this._handleBackspaceDelete(),!0):s.is("delete")&&this.isListEnd()&&this.isLastElement()&&!this.hasParentList()?(t.preventDefault(),this._handleForwardDelete(),!0):void setTimeout((()=>{this.$block.find("span").not("[data-rx-style-cache]").unwrap(),this.$block.get().normalize()}),0)},handleTab(t){if(!this.opts.is("tab.spaces")||this.isCaretStart())return t.preventDefault(),this.app.list.indent(),!0},handleEnter(t){t.preventDefault();const e=this.app.create("caret").is(this.$block,"end",["ul","ol"]);return this.hasChild()&&e?this._handleEnterWithChildAtEnd():!this.hasChild()&&this.hasParentList()&&this.isListTopEnd()?this._handleEnterAtNestedEnd():this.isEmpty()||this.isCaretEnd()?this._handleEnterAtEmptyOrEnd():this.isCaretStart()?this._handleEnterAtStart():this._handleEnterInMiddle(),this.app.observer.observe(),!0},_handleEnterWithChildAtEnd(){const t=this.app.create("utils");let e=this.getChild(),s=this._createItem(),i=e.clone();e.remove(),this.app.block.set(s,"start"),s.getBlock().append(t.createInvisibleChar()),s.getBlock().append(i)},_handleEnterAtNestedEnd(){const t=this.app.create("selection").getBlockControlled(),e=!!t&&this.dom(t).dataget("instance");if(e&&e.isEmpty()){const t=this.app.create("block.listitem");e.getParent().insert({position:"append",instance:t,type:"input"}),e.remove()}else{const t=this._createItem();this.app.block.set(t,"start"),this.app.broadcast("list.item",{instance:t})}},_handleEnterAtEmptyOrEnd(){const t=this.app.create("selection").getBlockControlled(),e=!!t&&this.dom(t).dataget("instance");if(e&&!this.hasParentList()&&e.isEmpty()){const t=this.isListEnd()?"after":"split";this.getParent().insertEmpty({position:t,caret:"start",type:"input"}),e.remove()}else{const t=this._createItem();this.app.block.set(t,"start"),this.app.broadcast("list.item",{instance:t})}},_handleEnterAtStart(){this._createItem("before"),this.app.block.set(this)},_handleEnterInMiddle(){const t=this.app.create("element").split(this.$block),e=this._createItem();e.setContent(t.html()),t.remove(),this.app.block.set(e,"start"),this.app.broadcast("list.item",{instance:e})},_handleBackspaceDelete(){const t=this.getParent(),e=this.getContent(),s=this.app.block.create(e),i=this.getParent();this.remove(),t.getBlock().before(s.getBlock()),i.isEmpty(!0)&&i.remove(),this.app.block.set(s,"start")},_handleForwardDelete(){const t=this.getParent().getNext();if(t)if(t.isType("quote")){const e=t.getBlock().text();this._insertHtml(e),t.remove()}else if(t.isEditable()){const e=t.getHtml();this._insertHtml(e),t.remove()}else if(t.isType("todo")){const e=t.getFirstItem(),s=t.getFirstContent().html();e.remove(),this._insertHtml(s),t.isEmpty()&&t.remove()}else if(t.isType("list")){const e=t.getBlock().children();this.$block.append(e),t.remove()}else this.app.block.set(t,"start")},_traverse(t,e,s){if("prev"===t?!this.isFirstElement()||!this.isCaretStart():!this.isLastElement()||!this.isCaretEnd())return;e.preventDefault();let i=this.getParent();this.hasParentList()&&(i=this.getParentItem());const a="prev"===t?"getPrev":"getNext";let r=i[a]();if(r||(r=i[a+"Parent"]()),r)this.app.block.set(r,"prev"===t?"end":"start");else if(this.app.block.set(i),"prev"===t){this.app.create("caret").set(i.getChild(),"before")}return!0},_createItem(t){let e=this.app.create("block.listitem");return t=t||"after",this.$block[t](e.getBlock()),e}}),o.add("block","noneditable",{mixins:["block"],parser:!1,props:{type:"noneditable",focusable:!0,editable:!1,inline:!1},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.dom("<div>").attr(this.opts.get("dataBlock"),"noneditable")},handleDelete(t,e,s){if(!this.opts.is("noneditable.remove")&&(s.is("delete")||s.is("backspace")))return t.preventDefault(),!0}}),o.add("block","pre",{mixins:["block"],props:{type:"pre",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"},caption:{getter:"getCaption",setter:"setCaption"}},create(){return this.dom(this.opts.get("pre.template"))},parse(){this.parseCaption()},getPlainText(){return this._getPlainText(this._getCodeElement())},getContent(){return this._getCodeElement().html().trim()},getCaption(){return this.figcaption?this.figcaption.getContent():null},setContent(t){this._getCodeElement().html(t)},setCaption(t){this.figcaption?this.figcaption.setContent(t):this._buildCaption(t)},setCaret(t){this.app.create("caret").set(this._getCodeElement(),t)},handleArrow(t,e,s){if(!this.getNext()&&this.isCaretEnd()&&s.is("down")){t.preventDefault();let e=this.app.block.create();return this.insert({instance:e,position:"after",caret:"start",remove:!1,type:"input"}),!0}},handleTab(t){return t.preventDefault(),this._insertSpaces(this.opts.get("pre.spaces")),!0},handleEnter(t){return t.preventDefault(),this._insertNewlineIfNeeded(),!0},_insertNewlineIfNeeded(){let t=this.$block.html().search(/\n$/),e=this.app.create("insertion");this.isCaretEnd()&&-1===t?e.insertNewline("after",!0):e.insertNewline()},_insertSpaces(t){let e=document.createTextNode(" ".repeat(t));this.app.create("insertion").insertNode(e,"end"),this._fixDoubleNewlines()},_fixDoubleNewlines(){let t=this.app.create("selection").getCurrent().previousSibling,e=t&&t.textContent;e&&-1!==e.search(/\n\n/g)&&(t.textContent=e.replace(/\n\n/g,"\n"))},_getCodeElement(){const t=this.$block.find("code"),e=this.$block.find("pre");return t.length?t:e.length?e:this.$block}}),o.add("block","quote",{mixins:["block"],props:{type:"quote",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"},caption:{getter:"getCaption",setter:"setCaption"}},create(){return this.dom(this.opts.get("quote.template"))},parse(){this._parseItem(),this._parseCaption()},build(){this._parseItem(),this._parseCaption()},isEmpty(t){return this._isEmpty(this.getCurrentItem(),t)},getPlaceholder(){return this.getItem().attr("data-placeholder")},getCurrentItem(){let t=this.app.create("selection");return this._isCaption(t.getParent())?this.$quotecaption:this.$quoteitem},getItem(){return this.$quoteitem},setCaret(t){this.app.create("caret").set(this.$quoteitem,t)},setContent(t){this.$quoteitem.html(t)},setEmpty(){this.getCurrentItem().html("")},setPlaceholder(t){this._setAttr(this.getItem(),"data-placeholder",t)},setCaption(t){this.$quotecaption.html(t)},getContent(){return this.$quoteitem.html()},getCaption(){return this.$quotecaption?this.$quotecaption.html():null},handleDelete(t,e,s){let i=this.app.create("caret"),a=this.app.create("selection"),r=this.app.create("utils"),o=this._getItemFromSelection(a),n=this._getCaptionFromSelection(a),l=this.dom(n),h=this.getPrev();if(s.is("backspace")&&this._isCaption(n)&&i.is(n,"start")){if(r.isEmptyHtml(l.html())&&!l.attr("data-placehoder"))return t.preventDefault(),this.$quotecaption.remove(),!0;t.preventDefault(),this.$quotecaption.find("br").remove()}else s.is("delete")&&this._isCaption(n)&&i.is(n,"end")||s.is("delete")&&this._isItem(o)&&i.is(o,"end")?t.preventDefault():s.is("backspace")&&this._isItem(o)&&i.is(o,"start")&&h&&h.isEditable()&&(t.preventDefault(),this.app.block.set(h,"end"),this._insertHtml(this.getPlainText()),this.remove());return!0},handleArrow(t,e,s){if(!this.getNext()&&this.isCaretEnd()&&s.is("down"))return t.preventDefault(),this._createNewInputAfter(),!0},handleEnter(t){t.preventDefault();const e=this.app.create("selection"),s=this.app.create("insertion"),i=this.app.create("caret");let a=this._getCaptionFromSelection(e),r=i.is(a,"end");return this._isCaption(a)?r?(t.preventDefault(),this._createNewInputAfter()):this.$quotecaption.tag("cite")&&s.insertBreakline(!1,!1):s.insertBreakline(),!0},_createNewInputAfter(){let t=this.app.block.create();this.insert({instance:t,position:"after",caret:"start",remove:!1,type:"input"})},_isCaption(t){return t&&this.$quotecaption&&t===this.$quotecaption.get()},_isItem(t){return t&&t===this.$quoteitem.get()},_getItemFromSelection:t=>t.getBlock(),_getCaptionFromSelection(t){return this.$quotecaption&&this.$quotecaption.tag("cite")?t.getClosest("cite"):t.getParent()},_parseItem(){this.$quoteitem=this.$block.find("p").first()},_parseCaption(){let t=this.isFigure()?this.$block.find("figcaption"):this.$block.find("p").last(),e=t.find("cite");this.$quotecaption=e.length?e:!!t.length&&t}}),o.add("block","table",{mixins:["block"],nested:"td, th",props:{type:"table",focusable:!0,inline:!1,control:{table:{position:{after:"add"}}}},defaults:{head:{getter:"getHead"},foot:{getter:"getFoot"},items:{getter:"getItems"}},create(){return this.dom(this.opts.get("table.template"))},build(){this._buildItems(),this._parseAndBuild(),this.fillEmpty()},parse(){this._parseAndBuild()},setCaret(t){const e="start"===t?this.getFirstBlock():this.getLastBlock();this.app.block.set(e,t)},getFirstBlock(){return this.getFirstCell().children().first()},getFirstCell(){return this.$block.find("th, td").first()},getLastBlock(){return this.getLastCell().children().last()},getLastCell(){return this.$block.find("th, td").last()},getRows(){return this.$block.find("tr")},getCells(){return this.$block.find("th, td")},getHead(){return this.$block.find("thead").length>0},getFoot(){return this.$block.find("tfoot").length>0},getItems(){const t=this.opts.get("tags.block").join(","),e=this.$block.find("tr");let s=[];return e.each((e=>{let i=[];e.find("th, td").each((e=>{e=e.clone(),(e=this.unparseInlineBlocks(e)).find(t).unwrap(),i.push(e.html().trim())})),s.push(i)})),s},fillEmpty(){this.getCells().each(function(t){if(t.dataget("instance").isEmpty()){let e=this.app.block.create();t.append(e.getBlock())}}.bind(this))},_parseAndBuild(){this._buildNowrap(),this.parseItems("tr","row"),this.parseItems("td, th","cell")},_buildItems(){const t=this.data.get("items");if(!t)return;const e=this.data.get("head"),s=this.data.get("foot"),i=t.length,a=e?this.dom("<thead>"):null,r=this.dom("<tbody>"),o=s?this.dom("<tfoot>"):null;t.forEach(((t,n)=>{const l=0===n,h=n===i-1,p=this.dom("<tr>");l&&e?a.append(p):h&&s?o.append(p):r.append(p),t.forEach((t=>{const s=l&&e?"th":"td",i=this.dom(`<${s}>`),a=this.app.create("block.text",{table:!0});a.getBlock().html(t),i.append(a.getBlock()),p.append(i)}))})),this.$block.empty(),e&&this.$block.append(a),this.$block.append(r),s&&this.$block.append(o)},_buildNowrap(){let t=this.opts.get("table.nowrap");this.$block.find("th, td").filter("."+t).addClass("rx-nowrap")}}),o.add("block","cell",{mixins:["block"],props:{type:"cell",inline:!1,focusable:!0,reorder:!1,control:{table:{position:{after:"add"}}}},defaults:{content:{getter:"getContent",setter:"setContent"},width:{getter:"getWidth",setter:"setWidth"},nowrap:{getter:"getNowrap",setter:"setNowrap"}},create(){return this.dom("<td>")},getTable(){return this.getClosest("table")},getRow(){return this.getClosest("row")},getNextCell(){return this._getSiblingCell("getNext","getNextRow","getFirst")},getPrevCell(){return this._getSiblingCell("getPrev","getPrevRow","getLast")},getFirstElement(){return this.$block.find("[data-rx-type]").first()},getWidth(){return this.$block.attr("width")||""},getNowrap(){return this.$block.hasClass("rx-nowrap")},setWidth(t){this._applyToEachCell((e=>{(t=t.endsWith("%")?t:t.replace("px",""))?e.attr("width",t):e.removeAttr("width")}))},setNowrap(t){const e=this.opts.get("table.nowrap")+" rx-nowrap";this._applyToEachCell((s=>t?s.addClass(e):s.removeClass(e)))},setEmpty(){let t=this.app.block.create();this.$block.html(""),this.$block.append(t.getBlock())},setCaret(t){this.app.create("caret").set(this.getFirstElement(),t)},isLastElement(){const t=this.getTable().getBlock().find("th, td").last();return this.$block.get()===t.get()},handleTab(t){t.preventDefault();const e=this.getNextCell()||this.getClosest("table").getNext();return e&&this.app.block.set(e,"start"),!0},_getSiblingCell(t,e,s){let i=this[t]();if(!i){const t=this.getRow(),a=t&&t[e]();i=a&&a[s]("cell")}return i},_applyToEachCell(t){const e=this._getCellIndex();this.getTable().getBlock().find("tr").each(((s,i)=>{const a=this.dom(s.get().cells[e]);t(a)}))},_getCellIndex(){const t=this.$block.closest("tr").find("td, th").all();return Array.from(t).indexOf(this.$block.get())}}),o.add("block","row",{mixins:["block"],props:{type:"row",inline:!1,focusable:!0,control:!1},create(){return this.dom("<tr>")},setCaret(t){this.app.create("caret").set(this.getFirstElement(),t)},getTable(){return this.getClosest("table")},getFirstElement(){return this.$block.find("td, th").first().find("[data-rx-type]").first()},getLastElement(){return this.$block.find("td, th").last().find("[data-rx-type]").first()},getNextRow(){return this._getAdjacentRow("next")},getPrevRow(){return this._getAdjacentRow("prev")},_getAdjacentRow(t){let e=this["next"===t?"getNext":"getPrev"](),s=this.$block.parent();if(!e&&!s.tag("table")){e=s["next"===t?"nextElement":"prevElement"]().find("tr")["next"===t?"first":"last"]().dataget("instance")}return e}}),o.add("block","text",{mixins:["block"],props:{type:"text",editable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.params.table?this.dom('<div data-rx-tag="tbr">'):this.opts.is("breakline")?this.dom('<div data-rx-tag="br">'):this.dom(`<${this.opts.get("markup")}>`)},handleEnter(t){let e;if(t.preventDefault(),this.isEmpty()||this.isCaretEnd())e=this._createNewBlockForEnter(),this.insert({instance:e,position:"after",caret:"start",remove:!1,type:"input"});else if(this.isCaretStart())e=this.duplicateEmpty(),this.insert({instance:e,position:"before",type:"input"});else{let t=this.app.create("element"),e=this.getBlock(),s=t.split(e);this.app.block.set(s,"start")}return!0},_createNewBlockForEnter(){let t="tbr"===this.$block.attr("data-rx-tag")?this.app.create("block.text",{table:!0}):this.app.block.create();return this.opts.is("clean.enter")||(t=this.duplicateEmpty(),t.getBlock().removeAttr("id")),this.opts.is("clean.enterinline")&&(t=this._cloneInline(t)),t},_cloneInline(t){let e=this.app.create("selection"),s=this.app.create("element"),i=e.getInline();if(i){let e=s.getInlines(i),a=null;e.forEach(((t,e)=>{if("A"===t.tagName)return;let s=t.cloneNode();s.removeAttribute("id"),s.innerHTML="",a=0===e?s:a.appendChild(s)})),a&&(t=this.app.block.create(a.outerHTML))}return t}}),o.add("block","todo",{mixins:["block"],props:{type:"todo",focusable:!0,inline:!1,control:{format:{position:{after:"add",first:!0}}}},defaults:{items:{getter:"getItems"}},create(){let t=this.dom("<ul>");if(!this.data.get("items")){let e=this.app.create("block.todoitem");t.append(e.getBlock())}return t},parse(){this.parseItems("li","todoitem")},build(){this._buildItems(),this.parseItems("li","todoitem")},setCaret(t){let e="start"===t?this.getFirstItem():this.getLastItem();this.app.block.set(e,t)},getItems(){return this.$block.css("border","5px solid red"),this.$block.children().all().map((t=>{let e=this.dom(t).dataget("instance");return{content:e.getContent(),checked:e.getChecked()}}))},getFirstItem(){return this.$block.children().first()},getFirstItemInstance(){return this.getFirstItem().dataget("instance")},getFirstContent(){return this.getFirstItem().find("div").first()},getLastItem(){return this.$block.children().last()},getLastItemInstance(){return this.getLastItem().dataget("instance")},getLastContent(){let t=this.app.create("utils").findTodoItemTag();return this.getLastItem().find(t).last()},_buildItems(){let t=this.data.get("items");t&&t.forEach((t=>{let e=this.app.create("block.todoitem",t);this.$block.append(e.getBlock())}))}}),o.add("block","todoitem",{mixins:["block"],props:{type:"todoitem",inline:!1,editable:!0,control:{format:{position:{after:"add",first:!0}}}},defaults:{content:{setter:"setContent",getter:"getContent"},checked:{setter:"setChecked",getter:"getChecked"}},create(){return this.dom("<li>")},parse(){this._parse()},build(){this.$block.html(this.opts.get("todo.templateItem")),this._parse()},setCaret(t){this.app.create("caret").set(this.$content,t)},isFirstElement(){return 0===this.$block.prevElement().length},isLastElement(){return 0===this.$block.nextElement().length},isListEnd(){return this.getParent().isCaretEnd()},getContentItem(){return this.$content},getParent(){return this.$block.parent().closest(this._buildTraverseSelector("todo")).dataget("instance")},getContent(){return this.unparseInlineBlocks(this.$content.clone()).html().trim()},getChecked(){return"1"===this.$block.attr("data-checked")},setContent(t){this.$content.html(t)},setChecked(t){this.$input.attr("checked",t),this.$block.attr("data-checked",t?"1":"0")},setPlaceholder(t){this.$content.attr("data-placeholder",t)},setEmpty(){this.$content.html("")},handleArrow(t,e,s){return s.is("left")&&this.isCaretStart()||s.is("up")?this._traverse(t,"prev"):s.is("right")&&this.isCaretEnd()||s.is("down")?this._traverse(t,"next"):void 0},handleDelete(t,e,s){return s.is("delete")?this._handleDeleteForward(t):s.is("backspace")?this._handleDeleteBackward(t):void 0},handleTab(t){return this._traverse(t,"next")},handleEnter(t){return t.preventDefault(),this.isEmpty()||this.isCaretEnd()?this._handleEmptyOrEnd():this.isCaretStart()?this._createAndSetItem("before"):this._handleContentSplit(),!0},_handleDeleteForward(t){let e=this.getNext(),s=this.getParent();if(this.isCaretEnd()&&e&&e.isType("todoitem"))return t.preventDefault(),this._insertItem("delete",e),!0;if(this.isCaretEnd()&&this.isLastElement()&&(e=this.getNextParent(),e)){if(t.preventDefault(),e.isType("quote")){let t=e.getBlock().text();this._insertHtml(t,!1),e.remove()}else if(e.isEditable()){let t=e.getHtml();this._insertHtml(t,!1),e.remove()}else if(e.isType("todo")){let t=e.getBlock().children();s.getBlock().append(t),e.remove()}else if(e.isType("list")){let t=e.getBlock().children().first(),s=t.html();t.remove(),this._insertHtml(s,!1),e.isEmpty()&&e.remove()}else this.app.block.set(e,"start");return!0}},_handleDeleteBackward(t){let e=this.getNext(),s=this.getPrev(),i=this.getParent();if(this.isCaretStart()&&s&&s.isType("todoitem"))return t.preventDefault(),this._insertItem("backspace",s),!0;if(this.isCaretStart()&&this.isFirstElement()&&(e=this.getPrevParent(),e)){if(t.preventDefault(),e.isEditable()){let t=this.getContent();this.app.block.set(e,"end"),this._insertHtml(t),this.remove(),i.isEmpty()&&i.remove()}else if(e.isType("todo")){let t=i.getBlock().children();e.getBlock().append(t),this.app.block.set(t.first(),"start",!0),i.remove()}else if(e.isType("list")){let t=this.getContent(),s=e.getLastItem();this.app.block.set(s,"end"),this._insertHtml(t),this.remove(),i.isEmpty()&&i.remove()}else this.app.block.set(e,"start");return!0}},_insertItem(t,e){let s;"delete"===t?(s=e.getPlainText(),e.remove()):(s=this.getPlainText(),this.remove(),this.app.block.set(e,"end")),this._insertHtml(s,!1)},_handleEmptyOrEnd(){const t=this.app.create("selection").getBlockControlled(),e=!!t&&this.dom(t).dataget("instance");e&&this.isListEnd()&&e.isEmpty()?(this.getParent().insertEmpty({position:"after",caret:"start",type:"input"}),e.remove()):this._createAndSetItem()},_handleContentSplit(){const t=this.app.create("element").split(this.$content),e=this._createItem();e.setContent(t.html()),t.remove(),this.app.block.set(e,"start")},_createAndSetItem(t="after"){const e=this._createItem(t);this.app.block.set(e,"start")},_traverse(t,e){t.preventDefault();const s="next"===e,i=s?"getNext":"getPrev",a=s?"getNextParent":"getPrevParent",r=s?"start":"end";let o=this[s?"isLastElement":"isFirstElement"]()?this.getParent():this,n=o[i]();if(n)this.app.block.set(n,r);else{if(n=o[a](),!n)return!0;this.app.block.set(n,r)}},_createItem(t){let e=this.app.create("block.todoitem");return t=t||"after",this.$block[t](e.getBlock()),e},_parse(){let t=this.$block.html(),e=this.$block.attr("data-placeholder"),s=this.opts.get("todo.templateItem"),i=this.opts.get("todo.templateItemDone"),a=this.$block.find("input"),r=this.app.create("utils").findTodoItemTag(),o=this.$block.find(r);this.$input=0!==a.length?a:this.dom(this.opts.get("todo.templateInput")),this.$input.attr("tabindex","-1"),this.$content=0!==o.length?o:this.dom(this.opts.get("todo.templateContent")),this.$content.attr("contenteditable",!0),e&&this.setPlaceholder(e),this.opts.get("todo.template")&&(t=this._extractCheckboxContent(t,s,i)),this._updateItemState(t,a,o,s,i),this._appendNewElements(a,o),this.$input.on("click.rx-todo",this._clickInput.bind(this)),this.$input.on("pointerdown.rx-todo",this._clickInput.bind(this))},_updateItemState(t,e,s,i,a){let r=i.replace(/\s/g,"");t.startsWith(a)?(t=t.replace(a,""),this._setAttributes(!0,"1")):(t.startsWith(r)||t.startsWith(i))&&(t=t.replace(t.startsWith(r)?r:i,""),this._setAttributes(!1,"0")),0===e.length&&0===s.length&&(t=t.trim(),this.$content.html(t),this.$block.html(""))},_setAttributes(t,e){this.$input.attr("checked",t),this.$block.attr("data-checked",e)},_appendNewElements(t,e){0===t.length&&this.$block.append(this.$input),0===e.length&&this.$block.append(this.$content)},_clickInput(t){if(t.preventDefault(),t.stopPropagation(),this.app.event.isPaused())return;this.$input.get().checked=!this.$input.get().checked,this.app.block.set(this.$block);let e=this.$input.attr("checked")?"1":"0";this.$block.attr("data-checked",e)},_extractCheckboxContent(t,e,s){const i=this.app.create("utils"),a=document.createElement("div");a.innerHTML=t;const r=a.textContent||"",o=i.escapeRegExp(e),n=i.escapeRegExp(s),l=new RegExp("("+o+"|"+n+")\\s*(.*)","g").exec(r);return l?l[0].trim():t}}),o.add("block","mergetag",{mixins:["block"],props:{type:"mergetag",editable:!1,control:!1,inline:!0,context:!0},defaults:{content:{getter:"getContent",setter:"setContent"}},create(){return this.dom("<span>").attr(this.opts.get("dataBlock"),"mergetag")}}),window.Redactor=o,window.addEventListener("load",(function(){o("[data-redactor]")})),"object"==typeof module&&module.exports&&(module.exports=o,module.exports.Redactor=o)}();
export default Redactor;