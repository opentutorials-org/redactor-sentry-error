Redactor.add("plugin","mention",{translations:{en:{mention:{mention:"Mention"}}},defaults:{url:!1,start:1,trigger:"@"},subscribe:{"editor.keyup":function(t){this.opts.is("mention.url")&&this._handle(t)}},start(){this.handleLen=this.opts.get("mention.start")},stop(){this._hide()},_handle(t){var t=t.get("e"),e=t.which,t=t.ctrlKey||t.metaKey,i=this.app.keycodes;e===i.ESC?this.app.editor.restore():e===i.DELETE||e===i.ENTER||e===i.SHIFT||t||-1!==[37,38,39,40].indexOf(e)||(e===i.SPACE?(this.handleLen=this.opts.get("mention.start"),this._hide()):(e===i.BACKSPACE&&(this.handleLen=this.handleLen-2,this.handleLen<=this.opts.get("mention.start"))&&this._hide(),this._emit()))},_emit(){var e=this.app.block.get();if(e&&e.isEditable()){var i=this.app.create("selection"),s=(this.app.create("caret"),this.opts.get("mention.trigger")),e=i.getText("before",!0,e.getBlock());if(e){e===s&&(i=i.getInline(),a=this.dom(i),i)&&a.hasClass("rx-mention-link")&&(this.app.editor.save(),a.unwrap(),this.app.editor.restore());var i=e.lastIndexOf(s),a=e.substring(i+1);let t=e;var s=s+a,n=e.lastIndexOf(s);(""===(t=0<=n?e.substring(0,n)+""+e.substring(n+s.length):t)||-1!==t.search(/\s$/))&&-1!==i&&a.length>=this.opts.get("mention.start")&&(this.handleLen=a.length,this.handleStr=a,this._load())}}},_load(){this.ajax.post({url:this.opts.get("mention.url"),data:"mention="+this.handleStr,success:this._parse.bind(this)})},_parse(t){""===t||Array.isArray(t)&&0===t.length?this.app.panel.close():(t="object"==typeof t?t:JSON.parse(t),this._build(t))},_build(t){this.data=t,this.$panel=this.app.panel.build(this,"replace"),this._stopEvents(),this._startEvents();for(var[e,i]of Object.entries(t)){var s=this.dom("<div>").addClass("rx-panel-item");s.html(i.item),s.attr("data-key",e),s.on("click",this.replace.bind(this)),this.app.panel.getElement().append(s)}var t=this.app.page.getDoc().scrollTop(),a=this.app.create("selection").getPosition();this.app.panel.open({top:a.bottom+t,left:a.left}),this.app.editor.save()},replace(e,i){e.preventDefault(),e.stopPropagation(),this.app.editor.restore();i=(i||this.dom(e.target)).attr("data-key");let s=this.data[i].replacement;var e=this.app.create("element"),i=this.app.create("marker"),a=this.app.create("selection"),n=this.app.create("caret"),r=(i.insert("start"),i.find("start"));if(!1!==r){var h=this.dom(r),r=r.previousSibling;let t=r.textContent;var o=new RegExp(this.opts.get("mention.trigger")+this.handleStr+"$"),p=this.dom(s),e=e.is(p,"inline"),a=(e&&p.tag("a")&&(p.addClass("rx-mention-link"),s=p.outer()),a.getInline()),l=this.dom(a);e&&a&&p.tag()===l.tag()?(l.after(p),l.remove(),n.set(p,"after")):(t=t.replace(o,""),r.textContent=t,e&&(s+=this.opts.get("markerChar")),h.before(s),i.restore()),this._hide(),this._reset()}},_reset(){this.handleStr=!1,this.handleLen=this.opts.get("mention.start")},_hide(t){let e=!1;var i=t&&t.which,s=this.app.keycodes;(e=t&&"click"!==t.type&&i!==s.ESC&&i!==s.SPACE?e:!0)&&this._hideForce()},_hideForce(){this.app.panel.close(),this._reset(),this._stopEvents()},_startEvents(){var t="click.rx-plugin-mention keydown.rx-plugin-mention";this.app.page.getDoc().on(t,this._hide.bind(this)),this.app.editor.getEditor().on(t,this._hide.bind(this))},_stopEvents(){var t=".rx-plugin-mention";this.app.page.getDoc().off(t),this.app.editor.getEditor().off(t)}});